<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Track & Clock</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
<!-- Firebase + GIS loaded dynamically so app never freezes if CDN is slow -->
<script>
(function loadSDKs(){
  const FBVER='9.23.0';
  const urls=[
    'https://www.gstatic.com/firebasejs/'+FBVER+'/firebase-app-compat.js',
    'https://www.gstatic.com/firebasejs/'+FBVER+'/firebase-auth-compat.js',
    'https://www.gstatic.com/firebasejs/'+FBVER+'/firebase-firestore-compat.js',
    'https://www.gstatic.com/firebasejs/'+FBVER+'/firebase-storage-compat.js',
    'https://accounts.google.com/gsi/client'
  ];
  let i=0;
  function next(){
    if(i>=urls.length){window._sdkLoadDone=true;console.log('[SDK] All external scripts loaded');return;}
    const s=document.createElement('script');
    s.src=urls[i]; s.async=false;
    s.onload=()=>{i++;next();};
    s.onerror=()=>{console.warn('[SDK] Failed to load:',urls[i]);i++;next();};
    document.head.appendChild(s);
  }
  next();
})();
</script>
<style>
:root{
  --lav:#c9b3e8;--mint:#b8f0c8;--lilac:#d8c4f0;--white:#f8f6ff;
  --dark:#3d3260;--mid:#7a6fa0;--card:rgba(255,255,255,0.72);
  --shadow:0 8px 32px rgba(160,130,210,0.18);--accent:#8b5cf6;--accent2:#5eead4;
  --sidebar-w:268px;--bg1:#d4c8f0;--bg2:#c8ecd4;--bg3:#e0d0f8;
  --base-font:16px;--text-on-theme:var(--dark);--text-mid-theme:var(--mid);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Quicksand',sans-serif;font-size:var(--base-font);min-height:100vh;overflow:hidden;background:#e8e0f5;color:var(--text-on-theme);}

/* ===== ANIMATED BG ===== */
.bg-anim{position:fixed;inset:0;z-index:0;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3),#b8f0d4,var(--bg1));background-size:400% 400%;animation:bgShift 12s ease infinite;}
.blob{position:fixed;border-radius:60% 40% 70% 30%/50% 60% 40% 70%;filter:blur(60px);opacity:0.45;animation:blobMove 18s ease-in-out infinite;z-index:0;}
.blob1{width:500px;height:400px;background:var(--lav);top:-100px;left:-100px;}
.blob2{width:400px;height:350px;background:var(--mint);bottom:-80px;right:-80px;animation-delay:-6s;}
.blob3{width:350px;height:300px;background:var(--lilac);top:40%;left:40%;animation-delay:-3s;}
@keyframes bgShift{0%,100%{background-position:0% 50%;}50%{background-position:100% 50%;}}
@keyframes blobMove{0%,100%{border-radius:60% 40% 70% 30%/50% 60% 40% 70%;transform:translate(0,0);}33%{border-radius:40% 60% 30% 70%/60% 40% 70% 50%;transform:translate(30px,-20px);}66%{border-radius:70% 30% 60% 40%/40% 70% 30% 60%;transform:translate(-20px,30px);}}

/* ===== THEME DECORATIONS ===== */
.theme-deco{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;}
.deco-el{position:absolute;font-size:1.8rem;opacity:0.12;animation:decoFloat 8s ease-in-out infinite;user-select:none;}
@keyframes decoFloat{0%,100%{transform:translateY(0) rotate(0deg);}50%{transform:translateY(-18px) rotate(8deg);}}

/* ===== INTRO ===== */
@keyframes speakRipple{
  0%{transform:scale(1);opacity:0.7;}
  100%{transform:scale(1.5);opacity:0;}
}
#introScreen{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#d4c8f0,#c8ecd4,#e0d0f8);background-size:300% 300%;animation:bgShift 6s ease infinite;}
#introScreen.gone{display:none;}
.intro-clock{position:relative;width:200px;height:200px;animation:clockZoom 3.8s ease-in-out forwards;}
@keyframes clockZoom{0%{transform:scale(0.1) rotate(-720deg);opacity:0;}40%{transform:scale(1.18) rotate(0deg);opacity:1;}55%{transform:scale(0.9);}70%{transform:scale(1.1);}85%{transform:scale(0.96);}100%{transform:scale(1);}}
.intro-clock-body{width:176px;height:176px;border-radius:50%;background:linear-gradient(135deg,#d8c4f0,#c9b3e8);border:7px solid #b89fd4;position:absolute;top:12px;left:12px;box-shadow:0 12px 44px rgba(140,100,220,0.32);display:flex;align-items:center;justify-content:center;}
.intro-clock-face{width:142px;height:142px;border-radius:50%;background:rgba(255,255,255,0.9);position:relative;display:flex;align-items:center;justify-content:center;}
.clock-center{width:12px;height:12px;border-radius:50%;background:#5eead4;position:absolute;z-index:3;}
.hand-h{position:absolute;bottom:50%;left:50%;transform-origin:bottom center;width:5px;height:42px;border-radius:4px;background:#8b5cf6;transform:translateX(-50%);animation:spinH 3s linear infinite;}
.hand-m{position:absolute;bottom:50%;left:50%;transform-origin:bottom center;width:3.5px;height:54px;border-radius:3px;background:#5eead4;transform:translateX(-50%) rotate(90deg);animation:spinM 9s linear infinite;}
.hand-s{position:absolute;bottom:50%;left:50%;transform-origin:bottom center;width:2px;height:58px;border-radius:2px;background:#e87878;transform:translateX(-50%) rotate(180deg);animation:spinH 1s linear infinite;}
@keyframes spinH{to{transform:translateX(-50%) rotate(360deg);}}
@keyframes spinM{to{transform:translateX(-50%) rotate(360deg);}}
.clock-ring{position:absolute;width:200px;height:200px;border-radius:50%;border:3px solid rgba(200,180,240,0.5);top:0;left:0;animation:ringPulse 2s ease-in-out infinite;}
.clock-ring2{position:absolute;width:228px;height:228px;border-radius:50%;border:2px solid rgba(180,240,200,0.3);top:-14px;left:-14px;animation:ringPulse 2.6s ease-in-out infinite 0.5s;}
@keyframes ringPulse{0%,100%{transform:scale(1);opacity:0.6;}50%{transform:scale(1.08);opacity:0.12;}}
.intro-btn-top{position:absolute;top:3px;left:50%;transform:translateX(-50%);width:24px;height:14px;background:#5eead4;border-radius:5px;}
/* tick marks */
.tick{position:absolute;width:2px;background:#c9b3e8;border-radius:1px;top:6px;left:50%;transform-origin:bottom center;transform:translateX(-50%);}
.intro-brand{font-family:'Nunito',sans-serif;font-size:2.6rem;font-weight:900;background:linear-gradient(135deg,#8b5cf6,#5eead4,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:28px;opacity:0;animation:fadeUp 0.7s 3.2s ease forwards;}
.intro-subtitle{font-family:'Nunito',sans-serif;font-size:1.05rem;font-weight:700;color:#7a6fa0;opacity:0;animation:fadeUp 0.7s 3.8s ease forwards;margin-top:6px;}
.sparkle{position:absolute;font-size:1.4rem;animation:sparklePop 0.8s ease forwards;pointer-events:none;}
@keyframes sparklePop{0%{transform:scale(0);opacity:1;}100%{transform:scale(1.7);opacity:0;}}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:none;}}
@keyframes fadeDown{from{opacity:0;transform:translateY(-18px);}to{opacity:1;transform:none;}}
@keyframes cardPop{from{opacity:0;transform:scale(0.7) translateY(28px);}to{opacity:1;transform:none;}}

/* ===== MOBILE: simplified intro to prevent stalling ===== */
@media (max-width: 768px) {
  /* Simple fade+scale instead of 3.8s spin â€” much lighter */
  .intro-clock { animation: clockZoomMobile 0.8s ease-out forwards !important; }
  @keyframes clockZoomMobile {
    0%  { transform: scale(0.6); opacity: 0; }
    100%{ transform: scale(1);   opacity: 1; }
  }
  /* Stop the pulsing rings on mobile */
  .clock-ring, .clock-ring2 { animation: none !important; }
  /* Slow down second hand â€” 1s spin is heavy on mobile */
  .hand-s { animation: spinH 2s linear infinite !important; }
  /* Show brand and tagline sooner since clock appears faster */
  .intro-brand   { animation: fadeUp 0.6s 1.0s ease forwards !important; }
  .intro-subtitle{ animation: fadeUp 0.6s 1.6s ease forwards !important; }
  /* Stop intro bg animation */
  #introScreen { animation: none !important; background: linear-gradient(135deg,#d4c8f0,#c8ecd4,#e0d0f8) !important; }
}

/* ===== INVITE MODAL ===== */
.invite-modal-overlay{position:fixed;inset:0;z-index:220;background:rgba(60,40,100,0.35);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;transition:opacity 0.3s;}
.invite-modal-overlay.hidden{opacity:0;pointer-events:none;}
.invite-modal{background:rgba(255,255,255,0.97);border-radius:28px;padding:30px 28px 24px;width:420px;max-width:95vw;box-shadow:0 28px 70px rgba(100,80,150,0.26);border:2px solid rgba(200,180,240,0.45);animation:cardPop 0.38s cubic-bezier(.34,1.56,.64,1) both;display:flex;flex-direction:column;gap:0;}
.invite-modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.invite-modal-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.18rem;color:var(--dark);}
.invite-modal-close{width:32px;height:32px;border-radius:50%;border:none;background:rgba(200,180,240,0.3);cursor:pointer;font-size:1rem;color:var(--mid);display:flex;align-items:center;justify-content:center;transition:background 0.2s;}
.invite-modal-close:hover{background:rgba(200,180,240,0.6);}
.invite-group-badge{display:inline-flex;align-items:center;gap:7px;padding:7px 16px;border-radius:20px;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;margin-bottom:20px;margin-top:8px;border:2px solid rgba(200,180,240,0.3);}
.invite-field-label{font-size:0.74rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;margin-top:14px;}
.invite-field{width:100%;padding:12px 15px;border-radius:14px;border:2px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.85);font-family:'Quicksand',sans-serif;font-size:0.95rem;color:var(--dark);outline:none;transition:border 0.2s;}
.invite-field:focus{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.12);}
.invite-preview{background:linear-gradient(135deg,rgba(200,180,240,0.15),rgba(180,240,200,0.12));border:1.5px dashed rgba(200,180,240,0.5);border-radius:14px;padding:14px 16px;margin-top:14px;font-size:0.82rem;color:var(--mid);font-weight:600;line-height:1.7;display:none;}
.invite-preview.show{display:block;}
.invite-preview b{color:var(--dark);}
.invite-preview .invite-link-preview{font-size:0.73rem;color:#8b5cf6;word-break:break-all;margin-top:4px;}
.invite-actions{display:flex;gap:10px;margin-top:20px;}
.invite-send-btn{flex:1;padding:13px;border-radius:15px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:900;font-size:0.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform 0.15s,box-shadow 0.15s;box-shadow:0 4px 16px rgba(139,92,246,0.2);}
.invite-send-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(139,92,246,0.28);}
.invite-copy-btn{padding:13px 18px;border-radius:15px;border:2px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);color:var(--mid);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;cursor:pointer;transition:all 0.15s;}
.invite-copy-btn:hover{border-color:var(--lav);background:rgba(200,180,240,0.2);}
/* Members list inside chat header */
/* â”€â”€ MESSENGER LAYOUT â”€â”€ */
.msng-shell{display:flex;height:100%;min-height:0;background:rgba(255,255,255,0.55);border-radius:22px;overflow:hidden;box-shadow:0 8px 40px rgba(140,100,220,0.14);border:1.5px solid rgba(200,180,240,0.3);}
/* Left sidebar */
.msng-sidebar{width:300px;min-width:260px;display:flex;flex-direction:column;border-right:1.5px solid rgba(200,180,240,0.25);background:rgba(255,255,255,0.72);flex-shrink:0;}
.msng-sidebar-hdr{padding:18px 16px 10px;border-bottom:1px solid rgba(200,180,240,0.2);}
.msng-sidebar-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.1rem;color:var(--dark);margin-bottom:10px;}
.msng-search{width:100%;padding:8px 14px;border-radius:22px;border:1.5px solid rgba(200,180,240,0.35);background:rgba(240,235,255,0.6);font-family:'Quicksand',sans-serif;font-size:0.88rem;color:var(--dark);outline:none;}
.msng-search:focus{border-color:#8b5cf6;}
.msng-new-btn{width:100%;margin-top:8px;padding:9px;border-radius:13px;border:2px dashed rgba(139,92,246,0.35);background:rgba(200,180,240,0.12);color:#7a6fa0;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.82rem;cursor:pointer;transition:all 0.18s;display:flex;align-items:center;justify-content:center;gap:6px;}
.msng-new-btn:hover{background:rgba(200,180,240,0.28);border-color:#8b5cf6;color:var(--dark);}
.msng-convos{flex:1;overflow-y:auto;padding:6px 8px;}
.msng-convo{display:flex;align-items:center;gap:11px;padding:10px 10px;border-radius:14px;cursor:pointer;transition:background 0.15s;margin-bottom:2px;position:relative;}
.msng-convo:hover{background:rgba(200,180,240,0.18);}
.msng-convo.active{background:linear-gradient(135deg,rgba(200,180,240,0.38),rgba(180,240,200,0.22));}
.msng-convo-avatar{width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;font-weight:900;}
.msng-convo-info{flex:1;min-width:0;}
.msng-convo-name{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.9rem;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msng-convo-preview{font-size:0.75rem;color:var(--mid);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;font-weight:600;}
.msng-convo-time{font-size:0.68rem;color:var(--mid);flex-shrink:0;font-weight:600;}
.msng-unread-dot{width:9px;height:9px;border-radius:50%;background:#8b5cf6;position:absolute;right:12px;top:50%;transform:translateY(-50%);}
/* Right chat panel */
.msng-chat{flex:1;display:flex;flex-direction:column;min-width:0;background:rgba(250,248,255,0.6);}
.msng-chat-hdr{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1.5px solid rgba(200,180,240,0.22);background:rgba(255,255,255,0.8);flex-shrink:0;}
.msng-chat-hdr-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.msng-chat-hdr-info{flex:1;min-width:0;}
.msng-chat-hdr-name{font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;color:var(--dark);}
.msng-chat-hdr-members{font-size:0.73rem;color:var(--mid);font-weight:600;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msng-hdr-invite-btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:11px;border:2px solid rgba(139,92,246,0.3);background:linear-gradient(135deg,rgba(200,180,240,0.3),rgba(180,240,200,0.2));color:#5a3ea0;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.78rem;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.msng-hdr-invite-btn:hover{border-color:#8b5cf6;transform:scale(1.04);}
.msng-hdr-tasks-btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:11px;border:1.5px solid rgba(200,180,240,0.35);background:rgba(255,255,255,0.7);color:var(--mid);font-family:'Nunito',sans-serif;font-weight:700;font-size:0.78rem;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.msng-hdr-tasks-btn:hover{border-color:var(--lav);background:rgba(200,180,240,0.2);}
/* Messages area */
.msng-messages{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:4px;}
.msng-day-label{align-self:center;font-size:0.71rem;font-weight:700;color:var(--mid);background:rgba(200,180,240,0.18);padding:3px 12px;border-radius:20px;margin:8px 0;}
/* Message bubbles */
.msng-msg-group{display:flex;flex-direction:column;gap:2px;margin-bottom:4px;}
.msng-msg-group.me{align-items:flex-end;}
.msng-msg-group.other{align-items:flex-start;}
.msng-msg-sender{font-size:0.69rem;font-weight:800;color:var(--mid);margin-bottom:3px;padding:0 4px;}
.msng-bubble{max-width:68%;padding:10px 15px;border-radius:18px;font-size:0.9rem;line-height:1.5;word-break:break-word;position:relative;animation:msngPop 0.18s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes msngPop{from{opacity:0;transform:scale(0.88) translateY(6px);}to{opacity:1;transform:none;}}
.msng-msg-group.me .msng-bubble{background:linear-gradient(135deg,#a78bfa,#818cf8);color:#fff;border-bottom-right-radius:4px;box-shadow:0 3px 14px rgba(139,92,246,0.28);}
.msng-msg-group.other .msng-bubble{background:rgba(255,255,255,0.92);color:#3d3260;border-bottom-left-radius:4px;box-shadow:0 2px 8px rgba(160,130,210,0.12);}
.msng-bubble-time{font-size:0.62rem;opacity:0.7;margin-top:3px;display:block;text-align:right;}
.msng-msg-group.other .msng-bubble-time{text-align:left;color:var(--mid);}
/* Avatar stack for others */
.msng-msg-row{display:flex;align-items:flex-end;gap:8px;}
.msng-msg-row.me{flex-direction:row-reverse;}
.msng-msg-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:900;flex-shrink:0;color:var(--dark);}
.msng-msg-avatar.hidden-av{visibility:hidden;}
/* System messages */
.msng-sys{align-self:center;font-size:0.74rem;color:var(--mid);background:rgba(200,180,240,0.15);padding:4px 14px;border-radius:20px;font-weight:600;margin:4px 0;text-align:center;}
/* Typing */
.msng-typing{display:flex;align-items:center;gap:8px;padding:8px 20px 4px;font-size:0.77rem;color:var(--mid);font-weight:600;min-height:24px;}
.msng-typing-dots{display:flex;gap:3px;align-items:center;}
.msng-typing-dot{width:6px;height:6px;border-radius:50%;background:#c9b3e8;animation:typingBounce 1.2s ease infinite;}
.msng-typing-dot:nth-child(2){animation-delay:0.2s;}
.msng-typing-dot:nth-child(3){animation-delay:0.4s;}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-6px);}}
/* Input bar */
.msng-input-bar{display:flex;align-items:center;gap:10px;padding:12px 16px;border-top:1.5px solid rgba(200,180,240,0.22);background:rgba(255,255,255,0.8);flex-shrink:0;}
.msng-input{flex:1;padding:11px 18px;border-radius:24px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(245,242,255,0.9);font-family:'Quicksand',sans-serif;font-size:0.92rem;color:var(--dark);outline:none;transition:border 0.2s,box-shadow 0.2s;resize:none;max-height:120px;line-height:1.4;}
.msng-input:focus{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.1);}
.msng-send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform 0.15s,box-shadow 0.15s;box-shadow:0 4px 14px rgba(139,92,246,0.35);flex-shrink:0;}
.msng-send-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(139,92,246,0.45);}
.msng-send-btn:active{transform:scale(0.95);}
.msng-send-btn svg{width:18px;height:18px;}
.msng-attach-btn{width:38px;height:38px;border-radius:50%;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);color:var(--mid);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;flex-shrink:0;font-size:1.1rem;}
.msng-attach-btn:hover{background:rgba(200,180,240,0.3);color:var(--dark);}
/* Empty state */
.msng-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--mid);}
.msng-empty-icon{font-size:3rem;opacity:0.5;}
.msng-empty-text{font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;opacity:0.6;}
.msng-empty-sub{font-size:0.82rem;font-weight:600;opacity:0.5;text-align:center;max-width:220px;}
/* Tasks drawer */
.msng-tasks-drawer{width:260px;border-left:1.5px solid rgba(200,180,240,0.22);background:rgba(255,255,255,0.75);display:flex;flex-direction:column;flex-shrink:0;transition:width 0.25s ease,opacity 0.25s ease;}
.msng-tasks-drawer.hidden-drawer{width:0;opacity:0;overflow:hidden;}
.msng-tasks-hdr{padding:14px 16px 10px;border-bottom:1px solid rgba(200,180,240,0.2);font-family:'Nunito',sans-serif;font-weight:900;font-size:0.9rem;color:var(--dark);display:flex;align-items:center;justify-content:space-between;}
.msng-tasks-body{flex:1;overflow-y:auto;padding:10px 12px;}
.msng-task-item{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(200,180,240,0.12);}
.msng-task-item:last-child{border-bottom:none;}
.msng-task-item input[type=checkbox]{accent-color:#8b5cf6;width:15px;height:15px;flex-shrink:0;}
.msng-task-text{font-size:0.82rem;font-weight:700;color:var(--dark);flex:1;}
.msng-task-meta{font-size:0.68rem;color:var(--mid);font-weight:600;}
.msng-task-del{background:none;border:none;cursor:pointer;color:#c08080;font-size:0.78rem;padding:2px 4px;opacity:0.6;}
.msng-task-del:hover{opacity:1;}
.msng-add-task-row{display:flex;gap:6px;padding:10px 12px;border-top:1px solid rgba(200,180,240,0.15);}
.msng-add-task-inp{flex:1;padding:7px 10px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);font-family:'Quicksand',sans-serif;font-size:0.8rem;color:var(--dark);outline:none;}
.msng-add-task-btn{padding:7px 12px;border-radius:10px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.78rem;cursor:pointer;}
/* Create group input */
.msng-create-row{display:flex;gap:6px;padding:10px 12px;border-top:1px solid rgba(200,180,240,0.15);}
.msng-create-inp{flex:1;padding:8px 12px;border-radius:11px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);font-family:'Quicksand',sans-serif;font-size:0.82rem;color:var(--dark);outline:none;}
.msng-create-btn{padding:8px 12px;border-radius:11px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.78rem;cursor:pointer;}
/* Mobile responsive */
@media(max-width:768px){
  .msng-sidebar{width:72px;min-width:72px;}
  .msng-sidebar-hdr{padding:12px 8px 8px;}
  .msng-sidebar-title,.msng-search,.msng-convo-info,.msng-convo-time,.msng-new-btn span{display:none;}
  .msng-convo{padding:8px 0;justify-content:center;}
  .msng-convo-avatar{width:44px;height:44px;}
  .msng-create-row{flex-direction:column;}
  .msng-tasks-drawer{width:220px;}
  .msng-tasks-drawer.hidden-drawer{width:0;}
  .msng-messages{padding:10px 10px;}
  .msng-bubble{max-width:82%;}
  .msng-new-btn{padding:8px;justify-content:center;}
}
/* keep legacy .invite-btn for invite modal */
.invite-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:12px;border:2px solid rgba(139,92,246,0.3);background:linear-gradient(135deg,rgba(200,180,240,0.3),rgba(180,240,200,0.2));color:#5a3ea0;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.8rem;cursor:pointer;transition:all 0.18s;flex-shrink:0;}
.invite-btn:hover{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.55),rgba(180,240,200,0.4));transform:scale(1.04);}
/* Joined banner */
.join-banner{background:linear-gradient(135deg,rgba(180,240,200,0.4),rgba(200,180,240,0.3));border:2px solid rgba(94,234,212,0.4);border-radius:16px;padding:14px 18px;display:flex;align-items:center;gap:13px;animation:cardPop 0.4s ease both;margin-bottom:8px;}
.join-banner-icon{font-size:1.8rem;flex-shrink:0;}
.join-banner-text{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.92rem;color:var(--dark);}
.join-banner-sub{font-size:0.78rem;color:var(--mid);font-weight:600;margin-top:2px;}

/* ===== NOTIFICATION BELL ===== */
.notif-bell-btn{position:fixed;top:14px;right:68px;z-index:160;width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,255,255,0.82);backdrop-filter:blur(16px);box-shadow:0 4px 16px rgba(140,100,220,0.18);cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:transform 0.2s;}
.notif-bell-btn:hover{transform:scale(1.12);}
.notif-badge{position:absolute;top:6px;right:6px;width:16px;height:16px;border-radius:50%;background:#e05050;color:#fff;font-size:0.62rem;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid white;}
.notif-badge.hidden{display:none;}
.notif-panel{position:fixed;top:62px;right:18px;z-index:170;width:330px;max-height:calc(100vh - 80px);background:linear-gradient(160deg,rgba(200,180,240,0.88) 0%,rgba(180,230,210,0.82) 50%,rgba(200,180,240,0.85) 100%);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);border-radius:22px;box-shadow:0 12px 48px rgba(140,100,220,0.22);border:1.5px solid rgba(200,180,240,0.45);display:flex;flex-direction:column;overflow:hidden;transition:opacity 0.25s,transform 0.25s;transform-origin:top right;}
.notif-panel.hidden{opacity:0;pointer-events:none;transform:scale(0.92) translateY(-8px);}
.notif-panel-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;border-bottom:1px solid rgba(200,180,240,0.25);background:transparent;}
.notif-panel-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;color:var(--dark);}
.notif-clear-btn{font-size:0.72rem;font-weight:800;color:var(--mid);cursor:pointer;padding:4px 9px;border-radius:9px;border:none;background:rgba(200,180,240,0.25);}
.notif-list{flex:1;overflow-y:auto;padding:8px 10px;display:flex;flex-direction:column;gap:7px;background:transparent;}
.notif-item{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:14px;border:1.5px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.35);backdrop-filter:blur(8px);animation:cardPop 0.3s ease both;}
.notif-item.unread{background:linear-gradient(135deg,rgba(200,180,240,0.2),rgba(180,240,200,0.15));border-color:rgba(139,92,246,0.3);}
.notif-item.login{border-color:rgba(94,234,212,0.5);background:linear-gradient(135deg,rgba(180,240,200,0.2),rgba(200,240,255,0.15));}
.notif-item.warning{border-color:rgba(251,191,36,0.4);background:linear-gradient(135deg,rgba(255,240,180,0.25),rgba(255,220,150,0.15));}
.notif-icon{font-size:1.4rem;flex-shrink:0;margin-top:1px;}
.notif-body{flex:1;min-width:0;}
.notif-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.83rem;color:var(--dark);}
.notif-msg{font-size:0.75rem;color:var(--mid);font-weight:600;margin-top:2px;}
.notif-time{font-size:0.68rem;color:var(--mid);margin-top:4px;font-weight:600;}
.notif-dismiss{background:none;border:none;cursor:pointer;font-size:0.8rem;color:var(--mid);padding:2px;opacity:0.6;}
.notif-dismiss:hover{opacity:1;}
.notif-empty{text-align:center;padding:28px;font-size:0.88rem;color:var(--mid);font-weight:600;}
.notif-add-section{padding:10px 12px;border-top:1px solid rgba(200,180,240,0.2);}
.notif-add-title{font-size:0.72rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.notif-add-row{display:flex;flex-direction:column;gap:6px;}
.notif-input{padding:7px 10px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);font-family:'Quicksand',sans-serif;font-size:0.78rem;color:var(--dark);outline:none;width:100%;}
.notif-add-btn{padding:8px;border-radius:11px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.78rem;cursor:pointer;}
.toast-notif{position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:300;background:rgba(255,255,255,0.96);backdrop-filter:blur(20px);border-radius:18px;padding:14px 22px;box-shadow:0 8px 32px rgba(140,100,220,0.22);border:1.5px solid rgba(200,180,240,0.4);display:flex;align-items:center;gap:12px;min-width:280px;max-width:380px;animation:fadeDown 0.4s ease both;}
.toast-notif.hide{animation:fadeUp 0.3s ease forwards;opacity:0;}
.toast-notif-icon{font-size:1.6rem;flex-shrink:0;}
.toast-notif-body{flex:1;}
.toast-notif-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:0.88rem;color:var(--dark);}
.toast-notif-msg{font-size:0.78rem;color:var(--mid);font-weight:600;margin-top:2px;}
/* ===== AVATAR STYLE TEMPLATES ===== */
.style-chips{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:8px;}
.style-chip{display:flex;align-items:center;gap:5px;padding:7px 12px;border-radius:14px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.6);cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.77rem;color:var(--mid);transition:all 0.18s;}
.style-chip:hover{border-color:var(--lav);background:rgba(200,180,240,0.2);}
.style-chip.active{background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.4));border-color:#8b5cf6;color:var(--dark);transform:scale(1.04);}
.style-preview-box{background:rgba(255,255,255,0.6);border-radius:16px;border:1.5px solid rgba(200,180,240,0.3);padding:11px 14px;font-size:0.79rem;color:var(--dark);font-weight:600;line-height:1.75;display:none;margin-top:6px;}
.style-preview-box.show{display:block;}
.style-preview-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:0.88rem;color:var(--dark);margin-bottom:6px;}
/* MUSIC PLAYER */
#musicPlayer{position:fixed;bottom:18px;right:18px;z-index:150;background:rgba(255,255,255,0.86);backdrop-filter:blur(20px);border-radius:22px;padding:13px 16px;box-shadow:0 8px 28px rgba(140,100,220,0.18);border:1.5px solid rgba(200,180,240,0.35);width:305px;transition:all 0.3s;display:none;}
#musicPlayer.mini{width:auto!important;min-width:160px;}
#musicPlayer.mini .mp-full{display:none!important;}
.mp-header{display:flex;align-items:center;gap:9px;}
.mp-note{font-size:1.15rem;}
.mp-track-name{font-family:'Nunito',sans-serif;font-size:0.79rem;font-weight:800;color:var(--dark);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mp-min-btn{background:none;border:none;cursor:pointer;font-size:0.9rem;color:var(--mid);padding:2px 5px;border-radius:6px;}
.mp-min-btn:hover{background:rgba(200,180,240,0.3);}
.mp-full{margin-top:9px;display:flex;flex-direction:column;gap:8px;}
.mp-controls-row{display:flex;align-items:center;gap:7px;}
.mp-btn{width:30px;height:30px;border-radius:50%;border:none;background:rgba(200,180,240,0.35);cursor:pointer;font-size:0.88rem;display:flex;align-items:center;justify-content:center;transition:background 0.2s;color:var(--dark);}
.mp-btn:hover{background:var(--lav);}
.mp-vol{-webkit-appearance:none;width:72px;height:4px;border-radius:2px;background:rgba(200,180,240,0.4);cursor:pointer;outline:none;}
.mp-vol::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#8b5cf6;cursor:pointer;}
.mp-mood-row{display:flex;gap:5px;flex-wrap:wrap;}
.mp-mood-chip{padding:4px 10px;border-radius:12px;border:1.5px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-size:0.73rem;font-weight:700;color:var(--mid);transition:all 0.15s;font-family:'Nunito',sans-serif;}
.mp-mood-chip:hover,.mp-mood-chip.active{background:var(--lilac);border-color:var(--lav);color:var(--dark);}
.mp-search-row{display:flex;gap:6px;}
.mp-search-input{flex:1;padding:7px 10px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.79rem;color:var(--dark);outline:none;}
.mp-search-input::placeholder{color:rgba(120,100,160,0.5);}
.mp-search-btn{padding:7px 10px;border-radius:10px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.76rem;cursor:pointer;}
.mp-genre-row{display:flex;gap:5px;flex-wrap:wrap;margin-top:2px;}
.mp-genre-chip{padding:4px 9px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-size:0.7rem;font-weight:700;color:var(--mid);transition:all 0.15s;font-family:'Nunito',sans-serif;}
.mp-genre-chip:hover,.mp-genre-chip.active{background:var(--lilac);border-color:var(--lav);color:var(--dark);}
.mp-now-playing{display:flex;align-items:center;gap:8px;padding:8px 10px;background:linear-gradient(135deg,rgba(200,180,240,0.25),rgba(180,240,200,0.2));border-radius:12px;border:1.5px solid rgba(200,180,240,0.3);margin-top:4px;}
.mp-now-playing.hidden{display:none;}
.mp-np-art{width:38px;height:38px;border-radius:8px;object-fit:cover;background:var(--lilac);flex-shrink:0;}
.mp-np-info{flex:1;min-width:0;}
.mp-np-title{font-size:0.74rem;font-weight:800;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mp-np-artist{font-size:0.67rem;color:var(--mid);font-weight:600;}
.mp-np-stop{background:none;border:none;cursor:pointer;font-size:1rem;color:var(--mid);padding:2px;}
.mp-np-stop:hover{color:#e87878;}
.mp-results{max-height:120px;overflow-y:auto;display:flex;flex-direction:column;gap:4px;}
.mp-result-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:9px;cursor:pointer;transition:background 0.14s;}
.mp-result-item:hover{background:rgba(200,180,240,0.25);}
.mp-result-thumb{width:30px;height:30px;border-radius:6px;object-fit:cover;flex-shrink:0;background:var(--lilac);display:flex;align-items:center;justify-content:center;font-size:1rem;}
.mp-result-info{flex:1;min-width:0;}
.mp-result-title{font-size:0.75rem;font-weight:700;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mp-result-channel{font-size:0.67rem;color:var(--mid);font-weight:600;}
.mp-yt-player{margin-top:6px;border-radius:10px;overflow:hidden;display:none;}
.mp-yt-player iframe{width:100%;height:135px;border:none;border-radius:10px;}

/* ===== SCREENS ===== */
.screen{position:fixed;inset:0;z-index:5;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.45s,transform 0.45s;}
.screen.hidden{display:none!important;}

/* ===== LANDING ===== */
#landing{padding:18px;}
.logo-wrap{display:flex;align-items:center;gap:14px;margin-bottom:14px;animation:fadeDown 0.8s ease both;}
.brand-name{font-family:'Nunito',sans-serif;font-size:2.8rem;font-weight:900;background:linear-gradient(135deg,#8b5cf6,#5eead4,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-1px;}
.logo-img{width:72px;height:72px;border-radius:50%;background:var(--card);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;animation:spinIn 0.9s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes spinIn{from{opacity:0;transform:rotate(-180deg) scale(0.4);}to{opacity:1;transform:none;}}
.welcome-text{font-family:'Nunito',sans-serif;font-size:2rem;font-weight:800;color:var(--dark);animation:fadeDown 0.8s 0.12s ease both;text-align:center;}
.tagline{font-size:1rem;color:var(--mid);font-weight:600;margin-top:4px;margin-bottom:18px;animation:fadeDown 0.8s 0.22s ease both;text-align:center;}
.occ-label{font-size:0.96rem;font-weight:700;color:var(--mid);margin-bottom:10px;text-align:center;animation:fadeDown 0.8s 0.3s ease both;}
.occ-grid{display:flex;flex-wrap:wrap;gap:9px;justify-content:center;margin-bottom:20px;animation:fadeUp 0.8s 0.35s ease both;max-width:500px;}
.occ-btn{display:flex;flex-direction:column;align-items:center;gap:5px;padding:11px 16px;border-radius:18px;border:2.5px solid rgba(200,180,240,0.35);background:rgba(255,255,255,0.6);cursor:pointer;font-family:'Nunito',sans-serif;font-size:0.85rem;font-weight:700;color:var(--dark);transition:all 0.2s;backdrop-filter:blur(10px);min-width:88px;}
.occ-btn .occ-icon{font-size:1.7rem;}
.occ-btn:hover{border-color:var(--lav);background:rgba(200,180,240,0.3);transform:translateY(-2px);}
.occ-btn.active{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.45),rgba(180,240,200,0.3));transform:translateY(-3px);box-shadow:0 6px 20px rgba(139,92,246,0.18);}
.start-btn{padding:14px 44px;border-radius:50px;border:none;background:linear-gradient(135deg,#c9b3e8,#a3d9b1);color:var(--dark);font-family:'Nunito',sans-serif;font-size:1.12rem;font-weight:800;cursor:pointer;box-shadow:0 6px 24px rgba(160,130,210,0.30);transition:transform 0.2s,box-shadow 0.2s;animation:fadeUp 0.8s 0.45s ease both;}
.start-btn:hover{transform:translateY(-3px) scale(1.04);}

/* Google Sign-In */
.google-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:13px 28px;border-radius:50px;border:2px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);cursor:pointer;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:800;color:var(--dark);transition:all 0.2s;animation:fadeUp 0.8s 0.55s ease both;margin-top:10px;box-shadow:0 4px 16px rgba(0,0,0,0.08);}
.google-btn:hover{background:rgba(255,255,255,0.95);border-color:var(--lav);transform:translateY(-2px);}
.google-icon{width:22px;height:22px;}

/* ===== APP ===== */
#appLayout{position:fixed;inset:0;z-index:2;display:flex;transition:opacity 0.45s;}
#appLayout.hidden{display:none!important;}

/* ===== SIDEBAR ===== */
.sidebar{width:var(--sidebar-w);background:rgba(255,255,255,0.68);backdrop-filter:blur(24px);border-right:1.5px solid rgba(200,180,240,0.28);display:flex;flex-direction:column;z-index:10;transition:transform 0.3s;flex-shrink:0;}
.sidebar-logo{padding:18px 16px 12px;font-family:'Nunito',sans-serif;font-weight:900;font-size:1.2rem;background:linear-gradient(135deg,#8b5cf6,#5eead4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;border-bottom:1px solid rgba(200,180,240,0.2);display:flex;align-items:center;gap:9px;}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto;}
.nav-item{display:flex;align-items:center;gap:11px;padding:12px 18px;cursor:pointer;font-weight:700;font-size:0.92rem;color:var(--text-mid-theme);transition:all 0.2s;border-radius:0 22px 22px 0;margin-right:10px;}
.nav-item:hover{background:rgba(200,180,240,0.25);color:var(--text-on-theme);}
.nav-item.active{background:linear-gradient(135deg,rgba(200,180,240,0.4),rgba(180,240,200,0.3));color:var(--text-on-theme);font-weight:800;}
.nav-item .nav-icon{font-size:1.2rem;width:24px;text-align:center;}
.nav-section-label{padding:12px 18px 3px;font-size:0.68rem;font-weight:800;color:var(--text-mid-theme);text-transform:uppercase;letter-spacing:1.5px;}
.nav-divider{height:1px;background:rgba(200,180,240,0.2);margin:7px 14px;}
.sidebar-footer{padding:12px 16px;border-top:1px solid rgba(200,180,240,0.2);}
.sidebar-user{display:flex;align-items:center;gap:9px;cursor:pointer;padding:8px;border-radius:14px;transition:background 0.2s;margin-bottom:7px;}
.sidebar-user:hover{background:rgba(200,180,240,0.2);}
.sidebar-avatar{width:40px;height:40px;border-radius:50%;border:2.5px solid var(--lav);display:flex;align-items:center;justify-content:center;font-size:1.3rem;background:var(--white);flex-shrink:0;overflow:hidden;}
.sidebar-avatar img{width:100%;height:100%;object-fit:cover;}
.sidebar-username{font-weight:800;font-size:0.9rem;color:var(--text-on-theme);}
.sidebar-occ{font-size:0.7rem;color:#8b5cf6;font-weight:700;}
.sidebar-status{font-size:0.7rem;color:var(--text-mid-theme);}
.auth-btn{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:12px;border:none;background:transparent;cursor:pointer;font-family:'Quicksand',sans-serif;font-weight:700;font-size:0.86rem;color:var(--text-mid-theme);width:100%;transition:all 0.2s;}
.auth-btn:hover{background:rgba(200,180,240,0.25);color:var(--text-on-theme);}
.auth-btn.logout{color:#e05050;}
.auth-btn.logout:hover{background:rgba(220,80,80,0.1);}

/* ===== MAIN ===== */
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 22px;background:rgba(255,255,255,0.6);backdrop-filter:blur(18px);border-bottom:1px solid rgba(200,180,240,0.25);flex-shrink:0;}
.hamburger-btn{width:36px;height:36px;border-radius:10px;border:none;background:rgba(200,180,240,0.3);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;transition:background 0.2s;}
.hamburger-btn:hover{background:var(--lav);}
.hamburger-btn span{width:17px;height:2.5px;background:var(--text-on-theme);border-radius:2px;display:block;}
.top-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.15rem;color:var(--text-on-theme);}
.avatar-btn{width:42px;height:42px;border-radius:50%;border:2.5px solid var(--lav);cursor:pointer;background:var(--white);box-shadow:0 2px 12px rgba(160,130,210,0.25);display:flex;align-items:center;justify-content:center;font-size:1.4rem;transition:transform 0.2s;flex-shrink:0;overflow:hidden;}
.avatar-btn:hover{transform:scale(1.1);}


/* â”€â”€ Nav pro tag â”€â”€ */
.nav-pro-tag{font-size:0.65rem;margin-left:auto;background:linear-gradient(135deg,#8b5cf6,#5eead4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:900;display:none;}

/* â”€â”€ Pro badge pulse â”€â”€ */
@keyframes proBadgePulse{0%,100%{box-shadow:0 3px 14px rgba(139,92,246,0.35);}50%{box-shadow:0 3px 20px rgba(139,92,246,0.65),0 0 0 4px rgba(139,92,246,0.15);}}
/* â”€â”€ Pro style chips â”€â”€ */
.pro-chip { background: linear-gradient(135deg,rgba(139,92,246,0.12),rgba(201,179,232,0.18)) !important; border-color: rgba(139,92,246,0.35) !important; color: #6d28d9 !important; position: relative; }
.pro-chip::after { content: 'ðŸ‘‘'; font-size: 0.6rem; position: absolute; top: -4px; right: -4px; }
.pro-chip.locked::before { content: 'ðŸ”’'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); border-radius: inherit; font-size: 1rem; }

/* â”€â”€ App background photo overlay â”€â”€ */
#appBgPhotoLayer { position: fixed; inset: 0; z-index: 0; background-size: cover; background-position: center; background-repeat: no-repeat; pointer-events: none; transition: opacity 0.4s; }

.avatar-btn img{width:100%;height:100%;object-fit:cover;border-radius:50%;}

/* ===== DASHBOARD ===== */
#dashPanel{flex:1;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:20px;padding:22px;overflow-y:auto;}
.subsection-card{background:var(--card);backdrop-filter:blur(18px);border-radius:26px;width:225px;height:255px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;cursor:pointer;border:2px solid rgba(200,180,240,0.3);box-shadow:var(--shadow);transition:transform 0.25s,box-shadow 0.25s;animation:cardPop 0.5s cubic-bezier(.34,1.56,.64,1) both;}
.subsection-card:hover{transform:translateY(-7px) scale(1.03);box-shadow:0 20px 48px rgba(160,130,210,0.25);}
.card-icon{width:66px;height:66px;border-radius:19px;display:flex;align-items:center;justify-content:center;font-size:2.1rem;}
.card-title{font-family:'Nunito',sans-serif;font-size:1.15rem;font-weight:800;color:var(--text-on-theme);}
.card-desc{font-size:0.82rem;color:var(--text-mid-theme);text-align:center;padding:0 14px;font-weight:600;}

/* ===== FULL PANELS ===== */
.full-panel{position:fixed;inset:0;z-index:50;display:flex;flex-direction:column;transition:opacity 0.4s,transform 0.4s;}
.full-panel.hidden{opacity:0;pointer-events:none;transform:translateY(26px);}
.full-panel .fp-bg{position:absolute;inset:0;z-index:-1;}
.fp-bg .bg-anim{position:absolute;inset:0;}
.fp-header{display:flex;align-items:center;gap:13px;padding:13px 22px;background:rgba(255,255,255,0.68);backdrop-filter:blur(18px);border-bottom:1px solid rgba(200,180,240,0.25);flex-shrink:0;}
.back-btn{width:36px;height:36px;border-radius:50%;border:none;background:rgba(200,180,240,0.35);color:var(--text-on-theme);cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:background 0.2s,transform 0.2s;flex-shrink:0;}
.back-btn:hover{background:var(--lav);transform:scale(1.1);}
.fp-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.22rem;color:var(--text-on-theme);}
.fp-content{flex:1;overflow-y:auto;padding:22px;display:flex;flex-direction:column;gap:16px;}

/* CARDS */
.panel-card{background:var(--card);backdrop-filter:blur(18px);border-radius:20px;padding:20px;box-shadow:var(--shadow);border:1.5px solid rgba(200,180,240,0.25);}
.panel-card h3{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.05rem;margin-bottom:13px;color:var(--text-on-theme);}

/* ===== CALENDAR - SMALLER CELLS ===== */
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.cal-nav button{background:rgba(200,180,240,0.3);border:none;border-radius:10px;width:32px;height:32px;cursor:pointer;font-size:1.1rem;color:var(--text-on-theme);transition:background 0.2s;}
.cal-nav button:hover{background:var(--lav);}
.cal-month{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.08rem;color:var(--text-on-theme);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:0;border:1.5px solid rgba(200,180,240,0.35);border-radius:14px;overflow:hidden;}
.cal-day-name{text-align:center;font-size:0.8rem;font-weight:800;color:var(--text-mid-theme);padding:8px 0;background:rgba(200,180,240,0.14);border-bottom:1.5px solid rgba(200,180,240,0.28);}
.cal-day{
  min-height:46px;
  display:flex;align-items:center;justify-content:center;
  font-size:0.92rem;font-weight:700;cursor:pointer;
  transition:background 0.13s;
  position:relative;color:var(--text-on-theme);
  border-right:1px solid rgba(200,180,240,0.22);
  border-bottom:1px solid rgba(200,180,240,0.22);
}
.cal-day:nth-child(7n){border-right:none;}
.cal-day:hover{background:rgba(200,180,240,0.38);}
.cal-day.today{background:linear-gradient(135deg,rgba(200,176,232,0.5),rgba(184,240,200,0.5));font-weight:900;}
.cal-day.has-task::after{content:'';position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:#8b5cf6;}
.cal-day.other-month{color:rgba(120,100,160,0.3);}
.cal-day.selected{background:linear-gradient(135deg,#b89fd4,#a3d9b1)!important;color:#fff;font-weight:900;}

/* INPUTS */
.task-input-row{display:flex;gap:8px;margin-bottom:11px;}
.task-input{flex:1;padding:10px 14px;border-radius:13px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.93rem;color:var(--text-on-theme);outline:none;transition:border 0.2s;}
.task-input:focus{border-color:var(--lav);}
.add-btn{padding:10px 16px;border-radius:13px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;cursor:pointer;transition:transform 0.15s;font-size:0.88rem;}
.add-btn:hover{transform:scale(1.06);}
.task-item{display:flex;align-items:center;gap:9px;padding:10px 13px;background:rgba(255,255,255,0.5);border-radius:11px;margin-bottom:7px;animation:fadeUp 0.3s ease;}
.task-item input[type=checkbox]{accent-color:#8b5cf6;width:16px;height:16px;cursor:pointer;}
.task-item span{flex:1;font-size:0.92rem;font-weight:600;}
.task-item span.done{text-decoration:line-through;color:var(--text-mid-theme);}
.task-item .del-btn{background:none;border:none;color:#d0a0c0;cursor:pointer;font-size:0.95rem;}

/* CHAT */


/* GROUPS */
.gtask-badge{padding:3px 10px;border-radius:20px;font-size:0.73rem;font-weight:800;}
.gtask-badge.pending{background:#f0e0ff;color:#8b5cf6;}
.gtask-badge.done{background:#d4f5e0;color:#2d9c5e;}
.gtask-badge.late{background:#ffe0e0;color:#c05050;}
.gtask-item{display:flex;align-items:center;gap:11px;padding:11px 14px;background:var(--card);border-radius:13px;margin-bottom:7px;border:1.5px solid rgba(200,180,240,0.2);}


/* PROFILE */
.profile-hero{background:linear-gradient(135deg,#d8c4f0,#b8f0c8);border-radius:20px;padding:26px;text-align:center;}
.profile-avatar-big{width:88px;height:88px;border-radius:50%;border:4px solid rgba(255,255,255,0.7);margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:2.8rem;background:rgba(255,255,255,0.5);overflow:hidden;}
.profile-avatar-big img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.profile-name{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.4rem;color:#3d3260;}
.profile-tag{color:#7a6fa0;font-size:0.87rem;font-weight:600;margin-top:4px;}
.streak-badge{display:inline-flex;align-items:center;gap:7px;margin-top:11px;padding:7px 18px;background:rgba(255,255,255,0.6);border-radius:30px;font-weight:800;font-size:0.88rem;color:#3d3260;}
.info-row{display:flex;align-items:center;gap:13px;padding:12px 0;border-bottom:1px solid rgba(200,180,240,0.2);}
.info-row:last-child{border-bottom:none;}
.info-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.info-label{font-size:0.74rem;color:var(--text-mid-theme);font-weight:700;}
.info-val{font-size:0.93rem;font-weight:700;color:var(--text-on-theme);}
.group-chip{display:inline-flex;align-items:center;gap:5px;padding:5px 13px;background:linear-gradient(135deg,rgba(200,180,240,0.3),rgba(180,240,200,0.2));border-radius:20px;font-size:0.82rem;font-weight:700;margin:3px;}

/* ===== LEGAL DOCS ===== */
.legal-accordion{border-radius:16px;border:1.5px solid rgba(200,180,240,0.28);overflow:hidden;transition:box-shadow 0.2s;}
.legal-accordion:hover{box-shadow:0 4px 18px rgba(139,92,246,0.1);}
.legal-accordion-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;background:rgba(255,255,255,0.5);transition:background 0.2s;user-select:none;}
.legal-accordion-header:hover{background:rgba(200,180,240,0.15);}
.legal-chevron{font-size:1.3rem;color:var(--mid);transition:transform 0.3s;font-weight:700;line-height:1;}
.legal-chevron.open{transform:rotate(90deg);}
.legal-doc-body{display:none;border-top:1px solid rgba(200,180,240,0.2);background:rgba(255,255,255,0.35);}
.legal-doc-body.open{display:block;}
.legal-doc-scroll{max-height:420px;overflow-y:auto;padding:20px 22px;display:flex;flex-direction:column;gap:10px;scrollbar-width:thin;scrollbar-color:rgba(200,180,240,0.5) transparent;}
.legal-doc-scroll::-webkit-scrollbar{width:5px;}
.legal-doc-scroll::-webkit-scrollbar-track{background:transparent;}
.legal-doc-scroll::-webkit-scrollbar-thumb{background:rgba(200,180,240,0.55);border-radius:10px;}
.legal-doc-scroll p{font-size:0.86rem;color:var(--text-mid-theme);line-height:1.78;font-weight:600;margin:0;}
.legal-section-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:0.97rem;color:var(--dark);padding:10px 0 2px;border-bottom:1.5px solid rgba(200,180,240,0.25);margin-top:6px;}
.legal-section-title:first-child{margin-top:0;padding-top:0;}
.legal-subsection{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;color:var(--mid);margin-top:4px;}
.legal-list{padding-left:18px;display:flex;flex-direction:column;gap:5px;margin:0;}
.legal-list li{font-size:0.84rem;color:var(--text-mid-theme);line-height:1.65;font-weight:600;}
.legal-list li strong{color:var(--dark);}
.legal-disclaimer{background:rgba(200,180,240,0.15);border-left:3px solid rgba(139,92,246,0.4);border-radius:0 10px 10px 0;padding:12px 15px;font-size:0.8rem;color:var(--mid);font-weight:700;line-height:1.7;}
.legal-contact-badge{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;background:linear-gradient(135deg,rgba(200,180,240,0.3),rgba(180,240,200,0.2));border:1.5px solid rgba(200,180,240,0.4);border-radius:14px;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;color:var(--dark);margin-top:4px;cursor:pointer;transition:background 0.2s;}
.legal-contact-badge:hover{background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.35));}

/* SECURITY */
.sec-item{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:rgba(255,255,255,0.5);border-radius:13px;margin-bottom:8px;cursor:pointer;transition:background 0.2s;}
.sec-item:hover{background:rgba(200,180,240,0.2);}
.sec-item .sec-left{display:flex;align-items:center;gap:12px;}
.sec-item .sec-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;}
.sec-item .sec-title{font-weight:800;font-size:0.93rem;color:var(--text-on-theme);}
.sec-item .sec-sub{font-size:0.74rem;color:var(--text-mid-theme);font-weight:600;}
.sec-item .sec-arrow{color:var(--text-mid-theme);}

/* APPEARANCE */
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;}
.theme-opt{border-radius:15px;padding:14px;cursor:pointer;border:2.5px solid rgba(200,180,240,0.25);transition:all 0.22s;display:flex;flex-direction:column;align-items:center;gap:7px;position:relative;user-select:none;}
.theme-opt:hover{transform:scale(1.06);box-shadow:0 8px 22px rgba(139,92,246,0.2);border-color:rgba(139,92,246,0.4);}
.theme-opt.active{border-color:#8b5cf6;box-shadow:0 6px 20px rgba(139,92,246,0.3);transform:scale(1.04);}
.theme-opt.active::after{content:'âœ“';position:absolute;top:6px;right:8px;font-size:0.78rem;font-weight:900;color:#8b5cf6;background:rgba(255,255,255,0.9);width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.theme-preview{width:48px;height:36px;border-radius:9px;}
.theme-name{font-size:0.8rem;font-weight:800;}
.mood-btn{padding:10px 20px;border-radius:13px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-family:'Quicksand',sans-serif;font-weight:700;font-size:0.88rem;color:var(--text-on-theme);transition:all 0.2s;}
.mood-btn:hover,.mood-btn.active{border-color:var(--lav);background:var(--lilac);}
.font-btn{padding:10px 16px;border-radius:13px;border:2.5px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-family:'Quicksand',sans-serif;font-weight:700;color:var(--text-on-theme);transition:all 0.22s;line-height:1;}
.font-btn:hover{border-color:var(--lav);background:rgba(200,180,240,0.2);transform:scale(1.05);}
.font-btn.active{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.3));box-shadow:0 4px 14px rgba(139,92,246,0.2);}

/* ABOUT */
.about-hero{background:linear-gradient(135deg,#d8c4f0,#b8f0c8);border-radius:20px;padding:30px;text-align:center;}
.about-logo{font-size:3.6rem;margin-bottom:8px;}
.about-name{font-family:'Nunito',sans-serif;font-size:1.9rem;font-weight:900;background:linear-gradient(135deg,#8b5cf6,#5eead4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.about-tagline{color:#7a6fa0;margin-top:6px;font-size:0.92rem;font-weight:600;}
.feature-item{display:flex;gap:13px;align-items:flex-start;padding:13px 0;border-bottom:1px solid rgba(200,180,240,0.2);}
.feature-item:last-child{border-bottom:none;}
.feat-icon{width:40px;height:40px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.feat-title{font-weight:800;font-size:0.93rem;color:var(--text-on-theme);}
.feat-desc{font-size:0.82rem;color:var(--text-mid-theme);margin-top:3px;font-weight:600;}

/* ACTIVITY */
.score-card{background:linear-gradient(135deg,#d8c4f0,#b8f0c8);border-radius:19px;padding:22px;text-align:center;}
.score-num{font-family:'Nunito',sans-serif;font-size:3rem;font-weight:900;color:#3d3260;}
.score-label{font-size:0.87rem;color:#7a6fa0;font-weight:700;}
.private-toggle{display:flex;align-items:center;gap:8px;margin-top:10px;font-size:0.84rem;color:#7a6fa0;justify-content:center;font-weight:600;}
.private-toggle input{accent-color:#8b5cf6;}
.act-item{display:flex;align-items:center;gap:13px;padding:12px 0;border-bottom:1px solid rgba(200,180,240,0.18);}
.act-item:last-child{border-bottom:none;}
.act-icon{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.act-info .act-name{font-weight:800;font-size:0.93rem;color:var(--text-on-theme);}
.act-info .act-date{font-size:0.75rem;color:var(--text-mid-theme);font-weight:600;}
.act-score{font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;color:#8b5cf6;}

/* ===== LIBRARY ===== */
.lib-tabs{display:flex;gap:9px;margin-bottom:18px;}
.lib-tab{padding:9px 20px;border-radius:19px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;color:var(--text-mid-theme);transition:all 0.2s;}
.lib-tab.active{background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.3));color:var(--text-on-theme);border-color:var(--lav);}
.lib-upload-zone{border:2.5px dashed rgba(180,150,230,0.5);border-radius:18px;padding:32px;text-align:center;cursor:pointer;background:rgba(255,255,255,0.4);transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:11px;margin-bottom:16px;}
.lib-upload-zone:hover{border-color:var(--lav);background:rgba(200,180,240,0.15);}
.lib-upload-zone input[type=file]{display:none;}
.lib-upload-zone .up-icon{font-size:2.5rem;}
.lib-upload-zone .up-label{font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;color:var(--text-on-theme);}
.lib-upload-zone .up-sub{font-size:0.84rem;color:var(--text-mid-theme);font-weight:600;}
.lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:13px;}
.lib-item{background:rgba(255,255,255,0.65);border-radius:15px;padding:14px;border:1.5px solid rgba(200,180,240,0.25);display:flex;flex-direction:column;align-items:center;gap:9px;position:relative;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;animation:cardPop 0.33s ease;}
.lib-item:hover{transform:translateY(-3px);box-shadow:0 9px 26px rgba(160,130,210,0.18);}
.lib-thumb{width:100%;height:96px;object-fit:cover;border-radius:9px;background:linear-gradient(135deg,#d8c4f0,#b8f0c8);display:flex;align-items:center;justify-content:center;font-size:2.4rem;overflow:hidden;}
.lib-thumb img,.lib-thumb video{width:100%;height:100%;object-fit:cover;}
.lib-name{font-size:0.79rem;font-weight:700;color:var(--text-on-theme);text-align:center;word-break:break-word;max-width:100%;}
.lib-meta{font-size:0.7rem;color:var(--text-mid-theme);font-weight:600;}
.lib-del{position:absolute;top:7px;right:7px;width:22px;height:22px;border-radius:50%;border:none;background:rgba(220,80,80,0.15);color:#c05050;cursor:pointer;font-size:0.72rem;display:flex;align-items:center;justify-content:center;transition:background 0.15s;}
.lib-del:hover{background:rgba(220,80,80,0.3);}
.lib-empty{text-align:center;padding:38px;color:var(--text-mid-theme);font-size:0.92rem;font-weight:600;}
.lib-empty .lib-empty-icon{font-size:2.8rem;margin-bottom:11px;}

/* Undo toast */
.undo-toast{
  position:fixed;bottom:90px;left:50%;transform:translateX(-50%);
  background:rgba(60,40,100,0.88);color:#fff;
  padding:12px 22px;border-radius:30px;
  display:flex;align-items:center;gap:14px;
  font-size:0.9rem;font-weight:700;font-family:'Nunito',sans-serif;
  z-index:300;box-shadow:0 8px 28px rgba(60,40,100,0.3);
  animation:slideUp 0.3s ease;
  backdrop-filter:blur(10px);
}
.undo-toast.hide{animation:slideDown 0.3s ease forwards;}
.undo-btn-toast{background:rgba(255,255,255,0.22);border:1.5px solid rgba(255,255,255,0.4);color:#fff;padding:6px 16px;border-radius:20px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;transition:background 0.2s;}
.undo-btn-toast:hover{background:rgba(255,255,255,0.35);}
@keyframes slideUp{from{transform:translate(-50%,40px);opacity:0;}to{transform:translate(-50%,0);opacity:1;}}
@keyframes slideDown{from{transform:translate(-50%,0);opacity:1;}to{transform:translate(-50%,40px);opacity:0;}}

/* FILE PREVIEW */
.file-modal{position:fixed;inset:0;z-index:200;background:rgba(60,40,100,0.4);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;}
.file-modal.hidden{display:none;}
.file-modal-inner{background:rgba(255,255,255,0.94);border-radius:22px;padding:22px;max-width:85vw;max-height:88vh;display:flex;flex-direction:column;gap:13px;box-shadow:0 24px 60px rgba(100,80,150,0.22);}
.file-modal-inner img,.file-modal-inner video{max-width:100%;max-height:58vh;border-radius:11px;}

/* AVATAR */
.modal-overlay{position:fixed;inset:0;z-index:100;background:rgba(100,80,150,0.2);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;transition:opacity 0.3s;}
.modal-overlay.hidden{opacity:0;pointer-events:none;}
.avatar-modal{background:rgba(255,255,255,0.92);border-radius:26px;padding:22px;width:435px;max-width:95vw;max-height:92vh;overflow-y:auto;box-shadow:0 24px 60px rgba(100,80,150,0.22);border:2px solid rgba(200,180,240,0.4);animation:cardPop 0.4s cubic-bezier(.34,1.56,.64,1) both;}
.modal-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.12rem;margin-bottom:14px;color:#3d3260;}
.avatar-builder{display:flex;gap:16px;align-items:flex-start;}
.avatar-canvas{width:125px;height:180px;flex-shrink:0;border-radius:18px;border:2.5px solid rgba(200,180,240,0.4);position:relative;overflow:hidden;background:var(--white);}
.av-bg{position:absolute;inset:0;transition:background 0.3s;}
.avatar-options{flex:1;display:flex;flex-direction:column;gap:9px;}
.opt-group{display:flex;flex-direction:column;gap:5px;}
.opt-label{font-size:0.7rem;font-weight:800;color:#7a6fa0;text-transform:uppercase;letter-spacing:1px;}
.opt-row{display:flex;gap:5px;flex-wrap:wrap;}
.opt-btn{padding:6px 12px;border-radius:9px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.6);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:0.78rem;font-weight:700;color:#3d3260;transition:all 0.15s;}
.opt-btn:hover,.opt-btn.active{border-color:var(--lav);background:var(--lilac);transform:scale(1.04);}
.color-swatch{width:24px;height:24px;border-radius:50%;border:2.5px solid transparent;cursor:pointer;transition:transform 0.15s,border-color 0.15s;}
.color-swatch:hover,.color-swatch.active{transform:scale(1.25);border-color:#3d3260;}
.modal-close{width:100%;margin-top:12px;padding:11px;border-radius:13px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:#3d3260;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.96rem;cursor:pointer;transition:transform 0.15s;}
.modal-close:hover{transform:scale(1.02);}
.av-char{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:90px;height:160px;}

/* LOGIN */
.login-modal{background:rgba(255,255,255,0.94);border-radius:26px;padding:30px;width:375px;max-width:94vw;box-shadow:0 24px 60px rgba(100,80,150,0.22);border:2px solid rgba(200,180,240,0.4);animation:cardPop 0.4s cubic-bezier(.34,1.56,.64,1) both;}
.login-modal h2{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.45rem;margin-bottom:5px;color:#3d3260;text-align:center;}
.login-modal p{color:#7a6fa0;font-size:0.87rem;text-align:center;margin-bottom:20px;font-weight:600;}
.login-field{width:100%;padding:12px 15px;border-radius:13px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.96rem;color:#3d3260;outline:none;margin-bottom:11px;transition:border 0.2s;}
.login-field:focus{border-color:var(--lav);}
.login-btn{width:100%;padding:12px;border-radius:13px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:#3d3260;font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;transition:transform 0.15s;margin-top:3px;}
.login-btn:hover{transform:scale(1.02);}
.google-login-btn{width:100%;padding:12px;border-radius:13px;border:2px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);color:#3d3260;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.96rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:9px;margin-top:10px;}
.google-login-btn:hover{background:#fff;border-color:var(--lav);transform:scale(1.02);}
.login-divider{text-align:center;color:#7a6fa0;font-size:0.82rem;font-weight:700;margin:10px 0;position:relative;}
.login-divider::before,.login-divider::after{content:'';position:absolute;top:50%;width:38%;height:1px;background:rgba(200,180,240,0.4);}
.login-divider::before{left:0;}
.login-divider::after{right:0;}
.login-switch{text-align:center;margin-top:11px;font-size:0.85rem;color:#7a6fa0;font-weight:600;}
.login-switch span{color:#8b5cf6;cursor:pointer;font-weight:800;}
.login-switch span:hover{text-decoration:underline;}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:rgba(180,150,230,0.3);border-radius:10px;}
::-webkit-scrollbar-thumb:hover{background:rgba(180,150,230,0.6);}

/* OCCUPATION FLOATING ELEMENTS */
.occ-float-wrap{position:fixed;inset:0;pointer-events:none;z-index:2;overflow:hidden;}
.occ-float{position:absolute;font-size:2.8rem;opacity:0;filter:drop-shadow(0 4px 10px rgba(0,0,0,0.1));pointer-events:none;}
@keyframes floatIn{0%{opacity:0;transform:translateY(60px) scale(0.4) rotate(-15deg);}50%{opacity:0.9;transform:translateY(-10px) scale(1.08) rotate(4deg);}100%{opacity:0.72;transform:translateY(0) scale(1) rotate(0deg);}}
@keyframes floatBobble{0%,100%{transform:translateY(0) rotate(0deg);}40%{transform:translateY(-14px) rotate(6deg);}70%{transform:translateY(5px) rotate(-4deg);}}

/* AVATAR PHOTO + WIDER MODAL */
.avatar-modal{background:rgba(255,255,255,0.92);border-radius:26px;padding:22px;width:580px;max-width:97vw;max-height:92vh;overflow-y:auto;box-shadow:0 24px 60px rgba(100,80,150,0.22);border:2px solid rgba(200,180,240,0.4);animation:cardPop 0.4s cubic-bezier(.34,1.56,.64,1) both;}
.avatar-canvas{width:150px;height:200px;flex-shrink:0;border-radius:18px;border:2.5px solid rgba(200,180,240,0.4);position:relative;overflow:hidden;background:var(--white);}
.av-char{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:120px;height:195px;}
.photo-upload-zone{width:148px;margin-top:8px;padding:9px;border-radius:12px;border:2px dashed rgba(180,150,230,0.5);background:rgba(255,255,255,0.5);cursor:pointer;text-align:center;font-family:'Nunito',sans-serif;font-size:0.75rem;font-weight:700;color:var(--mid);transition:all 0.2s;}
.photo-upload-zone:hover{border-color:var(--lav);background:rgba(200,180,240,0.15);}
.photo-upload-zone input{display:none;}
.pose-selector{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;width:148px;}
.pose-btn{flex:1;min-width:35px;padding:5px 3px;border-radius:9px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.6);cursor:pointer;font-size:1rem;text-align:center;transition:all 0.15s;}
.pose-btn:hover,.pose-btn.active{border-color:var(--lav);background:var(--lilac);}

/* ===== PREMIUM / PRICING ===== */
.billing-btn{padding:7px 20px;border-radius:26px;border:none;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.86rem;cursor:pointer;transition:all 0.22s;background:transparent;color:var(--mid);}
.billing-btn.active{background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);box-shadow:0 3px 12px rgba(139,92,246,0.18);}
.plans-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;width:100%;max-width:820px;margin-top:22px;}
@media(max-width:680px){.plans-grid{grid-template-columns:1fr;max-width:360px;}}
.plan-card{background:var(--card);backdrop-filter:blur(18px);border-radius:26px;padding:28px 22px 22px;border:2px solid rgba(200,180,240,0.25);box-shadow:var(--shadow);display:flex;flex-direction:column;position:relative;transition:transform 0.22s,box-shadow 0.22s;animation:cardPop 0.4s ease both;}
.plan-card:hover{transform:translateY(-5px);box-shadow:0 22px 50px rgba(139,92,246,0.18);}
.plan-card.pro-highlight{border-color:#8b5cf6;box-shadow:0 8px 38px rgba(139,92,246,0.22);}
.plan-popular-tag{position:absolute;top:-13px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#8b5cf6,#c9b3e8);color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.74rem;padding:5px 18px;border-radius:20px;white-space:nowrap;box-shadow:0 4px 16px rgba(139,92,246,0.32);}
.plan-icon{font-size:2.2rem;margin-bottom:10px;}
.plan-name{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.12rem;color:var(--dark);}
.plan-desc{font-size:0.78rem;color:var(--mid);font-weight:600;margin-top:3px;}
.plan-price{font-family:'Nunito',sans-serif;font-weight:900;font-size:2.4rem;color:var(--dark);line-height:1;margin:14px 0 4px;}
.plan-price-period{font-size:0.8rem;color:var(--mid);font-weight:600;margin-top:2px;}
.plan-annual-note{font-size:0.72rem;color:#8b5cf6;font-weight:700;min-height:16px;margin-bottom:2px;}
.plan-divider{height:1px;background:rgba(200,180,240,0.22);margin:14px 0;}
.plan-features{display:flex;flex-direction:column;gap:8px;flex:1;margin-bottom:18px;}
.pf{display:flex;align-items:flex-start;gap:8px;font-size:0.82rem;font-weight:600;color:var(--text-mid-theme);line-height:1.45;}
.pf.dim{opacity:0.35;}
.plan-cta{width:100%;padding:13px;border-radius:15px;border:none;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.93rem;cursor:pointer;transition:all 0.2s;}
.cta-free{background:rgba(200,180,240,0.2);color:var(--dark);border:2px solid rgba(200,180,240,0.38);}
.cta-free:hover{background:rgba(200,180,240,0.4);}
.cta-pro{background:linear-gradient(135deg,#8b5cf6,#c9b3e8);color:#fff;box-shadow:0 6px 20px rgba(139,92,246,0.28);}
.cta-pro:hover{transform:scale(1.03);box-shadow:0 10px 28px rgba(139,92,246,0.4);}
.cta-team{background:linear-gradient(135deg,#1f2937,#4a3f6b);color:#fff;box-shadow:0 6px 20px rgba(30,20,70,0.22);}
.cta-team:hover{transform:scale(1.03);}
.cta-current{background:rgba(94,234,212,0.18);color:#0d9488;border:2px solid rgba(94,234,212,0.35);cursor:default;pointer-events:none;}
/* Pay modal */
.pay-overlay{position:fixed;inset:0;z-index:400;background:rgba(30,15,70,0.48);backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;transition:opacity 0.28s;}
.pay-overlay.hidden{opacity:0;pointer-events:none;}
.pay-modal{background:rgba(255,255,255,0.98);border-radius:28px;width:490px;max-width:96vw;max-height:96vh;overflow-y:auto;box-shadow:0 32px 80px rgba(80,40,160,0.28);border:2px solid rgba(200,180,240,0.4);animation:cardPop 0.38s cubic-bezier(.34,1.56,.64,1) both;scrollbar-width:thin;}
.pay-cycle-btn{padding:11px 10px;border-radius:13px;border:2px solid rgba(200,180,240,0.32);background:rgba(255,255,255,0.7);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.82rem;cursor:pointer;color:var(--mid);transition:all 0.18s;text-align:center;width:100%;}
.pay-cycle-btn.active{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.32),rgba(180,240,200,0.2));color:var(--dark);}
.pay-cycle-save{font-size:0.67rem;color:#8b5cf6;font-weight:700;display:block;margin-top:2px;}
.pay-method{border-radius:13px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.7);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;padding:11px 6px;transition:all 0.18s;}
.pay-method:hover{border-color:var(--lav);}
.pay-method.active{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.28),rgba(180,240,200,0.18));color:var(--dark);}
.pay-field{width:100%;padding:12px 14px;border-radius:13px;border:2px solid rgba(200,180,240,0.32);background:rgba(255,255,255,0.85);font-family:'Quicksand',sans-serif;font-size:0.92rem;color:var(--dark);outline:none;transition:border 0.2s;box-sizing:border-box;}
.pay-field:focus{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.1);}
.pay-submit{width:100%;padding:14px;border-radius:16px;border:none;background:linear-gradient(135deg,#8b5cf6,#c9b3e8,#5eead4);color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.98rem;cursor:pointer;box-shadow:0 8px 26px rgba(139,92,246,0.3);transition:all 0.22s;}
.pay-submit:hover{transform:translateY(-2px);box-shadow:0 14px 34px rgba(139,92,246,0.4);}

/* ===== MOBILE PERFORMANCE: disable all heavy GPU effects ===== */
@media (max-width: 768px) {

  /* Kill animated blobs entirely */
  .blob { display: none !important; }

  /* Stop background gradient animation - use static gradient instead */
  .bg-anim {
    animation: none !important;
    background: linear-gradient(135deg, #d4c8f0, #c8ecd4) !important;
    background-size: 100% 100% !important;
  }

  /* Stop floating emoji decorations */
  .deco-el { animation: none !important; }

  /* Replace all backdrop-filter blurs with solid semi-transparent backgrounds */
  .sidebar,
  .top-bar,
  .fp-header,
  .panel-card,
  .subsection-card,
  .notif-bell-btn,
  .notif-panel,
  .toast-notif,
  #musicPlayer,
  .occ-btn,
  .invite-modal-overlay,
  .file-modal,
  .modal-overlay,
  .pay-overlay,
  .plan-card,
  #sidebarOverlay {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Give them solid opaque backgrounds so they still look good */
  .sidebar { background: rgba(248, 246, 255, 0.98) !important; }
  .top-bar { background: rgba(245, 242, 255, 0.98) !important; }
  .fp-header { background: rgba(245, 242, 255, 0.98) !important; }
  .panel-card { background: rgba(255, 255, 255, 0.96) !important; }
  .subsection-card { background: rgba(255, 255, 255, 0.95) !important; }
  .notif-bell-btn { background: rgba(255, 255, 255, 0.95) !important; }
  .notif-panel { background: linear-gradient(145deg,rgba(212,200,240,0.92),rgba(200,236,212,0.88)) !important; }
  .toast-notif { background: rgba(255, 255, 255, 0.99) !important; }
  #musicPlayer { background: rgba(255, 255, 255, 0.97) !important; }

  /* Reduce card hover animations - simpler on mobile */
  .subsection-card { transition: transform 0.15s !important; }
  .subsection-card:hover { transform: none !important; box-shadow: var(--shadow) !important; }

  /* Disable card pop animations on dashboard to speed up rendering */
  .subsection-card { animation: none !important; }

  /* Simplify full panel transition */
  .full-panel { transition: opacity 0.2s !important; }

  /* Stop intro screen bg animation */
  #introScreen { animation: none !important; background: linear-gradient(135deg, #d4c8f0, #c8ecd4, #e0d0f8) !important; }

  /* Disable canvas theme bg */
  #themeBgCanvas { display: none !important; }

  /* Use will-change only on actively animating elements to hint GPU layers correctly */
  .sidebar { will-change: transform; }
  #musicPlayer { will-change: auto; }
}

#musicPlayer.intro-hidden,
.notif-bell-btn.intro-hidden,
#notifBellBtn.intro-hidden,
#notifPanel.intro-hidden{
  opacity:0!important;
  pointer-events:none!important;
  visibility:hidden!important;
}
.sidebar-hidden{transform:translateX(-100%)!important;margin-left:calc(-1 * var(--sidebar-w));}

/* ===== MOBILE OVERLAY (for closing sidebar by tapping outside) ===== */
#sidebarOverlay{display:none;position:fixed;inset:0;z-index:9;background:rgba(60,40,100,0.32);backdrop-filter:blur(2px);}
#sidebarOverlay.show{display:block;}

/* ===== RESPONSIVE: TABLET & MOBILE ===== */
@media (max-width: 768px) {

  /* Sidebar: hidden off-screen by default on mobile */
  .sidebar{
    position:fixed;
    left:0;top:0;bottom:0;
    transform:translateX(-100%);
    z-index:100;
    box-shadow:4px 0 32px rgba(140,100,220,0.22);
  }
  .sidebar.mobile-open{
    transform:translateX(0)!important;
  }
  /* Override desktop sidebar-hidden behaviour on mobile */
  .sidebar-hidden{
    transform:translateX(-100%)!important;
    margin-left:0!important;
  }

  /* Main area fills full width */
  #appLayout{flex-direction:column;}
  .main-area{width:100%;min-width:0;}

  /* Top bar */
  .top-bar{padding:10px 14px;}

  /* Dashboard cards: 2-per-row */
  #dashPanel{padding:14px;gap:12px;justify-content:center;}
  .subsection-card{width:calc(50% - 6px);height:auto;min-height:160px;padding:18px 10px;}
  .card-icon{width:52px;height:52px;font-size:1.7rem;}
  .card-title{font-size:1rem;}
  .card-desc{font-size:0.75rem;}

  /* Full panels */
  .fp-content{padding:14px;}
  .fp-header{padding:10px 14px;}

  /* Music player: full width */
  #musicPlayer{
    width:calc(100% - 28px);
    left:14px;
    right:14px;
    bottom:10px;
  }

  /* Notification panel: full width */
  .notif-panel{
    width:calc(100vw - 32px);
    right:16px;
    left:16px;
  }
  .notif-bell-btn{right:58px;}

  /* Modals */
  .invite-modal{width:95vw;max-height:90vh;overflow-y:auto;}
  .pay-modal{width:95vw;max-height:90vh;}

  /* Calendar: tighter */
  .cal-day{min-height:36px;font-size:0.8rem;}
  .cal-day-name{font-size:0.7rem;padding:6px 0;}

  /* Bigger touch targets */
  .mp-btn{width:40px;height:40px;}
  .back-btn{width:40px;height:40px;}
  .cal-nav button{width:38px;height:38px;}
  .nav-item{padding:14px 18px;}

  /* Landing screen */
  .brand-name{font-size:2rem;}
  .welcome-text{font-size:1.6rem;}
  .occ-btn{min-width:76px;padding:9px 12px;font-size:0.8rem;}

  /* Intro clock */
  .intro-brand{font-size:2rem;}
}

@media (max-width: 480px) {
  .brand-name{font-size:1.6rem;}
  .welcome-text{font-size:1.3rem;}
  .fp-title{font-size:1rem;}
  .intro-brand{font-size:1.7rem;}
  .subsection-card{width:calc(50% - 6px);}
  /* Stack dashboard to single column on very small screens */
  #dashPanel{gap:10px;}
}
</style>
</head>
<body>
<!-- App background photo layer -->
<div id="appBgPhotoLayer" style="opacity:0;"></div>
<!-- Mobile sidebar overlay -->
<div id="sidebarOverlay" onclick="closeSidebarMobile()"></div>
<!-- Google Sign-In overlay -->
<div id="_gisOverlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(60,40,100,0.45);backdrop-filter:blur(8px);align-items:center;justify-content:center;">
  <div style="background:rgba(255,255,255,0.97);border-radius:24px;padding:36px 32px;box-shadow:0 24px 60px rgba(100,80,150,0.25);display:flex;flex-direction:column;align-items:center;gap:18px;min-width:320px;">
    <div style="font-family:'Nunito',sans-serif;font-size:1.3rem;font-weight:900;color:#3d3260;">Sign in to Track & Clock</div>
    <div style="font-size:0.88rem;color:#7a6fa0;font-weight:600;text-align:center;">Choose your Google account to continue</div>
    <div id="_gisButtonContainer"></div>
    <button onclick="document.getElementById('_gisOverlay').style.display='none'" style="background:none;border:none;color:#7a6fa0;font-family:'Nunito',sans-serif;font-weight:700;font-size:0.85rem;cursor:pointer;margin-top:-6px;">Cancel</button>
  </div>
</div>
<!-- Animated theme scene canvas (renders behind everything) -->
<canvas id="themeBgCanvas" style="position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;opacity:0;transition:opacity 0.9s ease;"></canvas>
<div class="bg-anim" id="bgAnim"></div>
<div class="blob blob1" id="blob1"></div>
<div class="blob blob2" id="blob2"></div>
<div class="blob blob3" id="blob3"></div>
<div class="theme-deco" id="themeDeco"></div>
<div class="occ-float-wrap" id="occFloatWrap"></div>

<!-- ===== MUSIC PLAYER ===== -->
<div id="musicPlayer">
  <div class="mp-header">
    <span class="mp-note">ðŸŽµ</span>
    <span class="mp-track-name" id="mpTrack">Select mood or search a songâ€¦</span>
    <button class="mp-min-btn" onclick="toggleMiniPlayer()" title="Minimize/Expand">â€”</button>
  </div>
  <div class="mp-full" id="mpFull">
    <div class="mp-controls-row">
      <button class="mp-btn" id="mpPlayBtn" onclick="toggleMusic()">â–¶</button>
      <input type="range" class="mp-vol" id="mpVol" min="0" max="1" step="0.05" value="0.3" oninput="setVolume(this.value)" title="Volume"/>
      <span style="font-size:0.7rem;color:var(--mid);font-weight:700;">ðŸ”Š</span>
    </div>
    <div class="mp-mood-row">
      <div class="mp-mood-chip" onclick="setMoodChip('calm',this)">ðŸŒ¿ Calm</div>
      <div class="mp-mood-chip" onclick="setMoodChip('focus',this)">ðŸŽ¯ Focus</div>
      <div class="mp-mood-chip" onclick="setMoodChip('energetic',this)">âš¡ Energy</div>
      <div class="mp-mood-chip" onclick="setMoodChip('cozy',this)">ðŸ§¸ Cozy</div>
      <div class="mp-mood-chip" onclick="setMoodChip('nature',this)">ðŸŒ³ Nature</div>
      <div class="mp-mood-chip" onclick="setMoodChip('off',this)">ðŸ”‡ Off</div>
    </div>
    <div class="mp-search-row">
      <input class="mp-search-input" id="mpSearchInput" placeholder="Search any song or artistâ€¦ ðŸŽµ" onkeydown="if(event.key==='Enter')searchMusic()"/>
      <button class="mp-search-btn" onclick="searchMusic()">ðŸ”</button>
    </div>
    <div class="mp-genre-row">
      <button class="mp-genre-chip active" onclick="searchGenre('pop',this)">ðŸŽ¤ Pop</button>
      <button class="mp-genre-chip" onclick="searchGenre('k-pop',this)">ðŸ’œ K-Pop</button>
      <button class="mp-genre-chip" onclick="searchGenre('r&b',this)">ðŸŽ· R&amp;B</button>
      <button class="mp-genre-chip" onclick="searchGenre('hip-hop',this)">ðŸŽ¤ Hip-Hop</button>
      <button class="mp-genre-chip" onclick="searchGenre('lofi',this)">ðŸŽ§ Lofi</button>
      <button class="mp-genre-chip" onclick="searchGenre('classical',this)">ðŸŽ» Classical</button>
    </div>
    <div class="mp-results" id="mpResults"></div>
    <div class="mp-now-playing hidden" id="mpNowPlaying">
      <img class="mp-np-art" id="mpNpArt" src="" onerror="this.style.display='none'"/>
      <div class="mp-np-info">
        <div class="mp-np-title" id="mpNpTitle">â€”</div>
        <div class="mp-np-artist" id="mpNpArtist">â€”</div>
      </div>
      <button class="mp-np-stop" onclick="stopMusic2()" title="Stop">â¹</button>
    </div>
    <audio id="musicAudio" onended="onTrackEnded()"></audio>
  </div>
</div>

<!-- ===== SUBSCRIPTION BADGE ===== -->
<button id="subBadgeBtn" onclick="openFP('pricingPanel')" title="Your subscription" style="position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:160;display:none;align-items:center;gap:6px;background:linear-gradient(135deg,#8b5cf6,#5eead4);border:none;border-radius:20px;padding:6px 13px;cursor:pointer;box-shadow:0 3px 14px rgba(139,92,246,0.35);animation:proBadgePulse 3s ease infinite;">
  <span style="font-size:0.85rem;">ðŸ‘‘</span>
  <span style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.75rem;color:#fff;letter-spacing:0.3px;">PRO</span>
</button>

<!-- notif bell moved to top-bar -->

<!-- ===== NOTIFICATION PANEL ===== -->
<div class="notif-panel hidden" id="notifPanel">
  <div class="notif-panel-hdr">
    <span class="notif-panel-title">ðŸ”” Notifications</span>
    <button class="notif-clear-btn" onclick="clearAllNotifs()">Clear all</button>
  </div>
  <!-- Tabs -->
  <div style="display:flex;border-bottom:1px solid rgba(200,180,240,0.2);padding:0 8px;">
    <button id="notifTabNotifs" onclick="switchNotifTab('notifs')" style="flex:1;padding:8px 2px;border:none;background:none;font-family:'Nunito',sans-serif;font-size:0.78rem;font-weight:800;color:#8b5cf6;border-bottom:2.5px solid #8b5cf6;cursor:pointer;">ðŸ”” Notifs</button>
    <button id="notifTabInvites" onclick="switchNotifTab('invites')" style="flex:1;padding:8px 2px;border:none;background:none;font-family:'Nunito',sans-serif;font-size:0.78rem;font-weight:700;color:var(--mid);border-bottom:2.5px solid transparent;cursor:pointer;">ðŸ‘¥ Invites <span id="inviteBadge" class="hidden" style="background:#8b5cf6;color:white;border-radius:99px;padding:1px 5px;font-size:0.68rem;margin-left:1px;">0</span></button>
    <button id="notifTabSub" onclick="switchNotifTab('sub')" style="flex:1;padding:8px 2px;border:none;background:none;font-family:'Nunito',sans-serif;font-size:0.78rem;font-weight:700;color:var(--mid);border-bottom:2.5px solid transparent;cursor:pointer;">ðŸ‘‘ Plan</button>
  </div>
  <!-- Notifications list -->
  <div class="notif-list" id="notifList" style="display:block;">
    <div class="notif-empty" id="notifEmpty">No notifications yet âœ¨</div>
  </div>
  <!-- Group Invites list -->
  <div class="notif-list" id="inviteList" style="display:none;">
    <div class="notif-empty" id="inviteEmpty">No pending invites ðŸŽ‰</div>
  </div>
  <!-- Subscription tab -->
  <div id="subTabContent" style="display:none;padding:14px;flex-direction:column;gap:12px;">
    <!-- Pro badge hero -->
    <div style="background:linear-gradient(135deg,#8b5cf6,#5eead4);border-radius:16px;padding:18px;text-align:center;position:relative;overflow:hidden;">
      <div style="position:absolute;inset:0;opacity:0.15;background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(255,255,255,0.3) 10px,rgba(255,255,255,0.3) 20px);"></div>
      <div style="font-size:2rem;margin-bottom:4px;">ðŸ‘‘</div>
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.1rem;color:#fff;">Pro Member</div>
      <div style="font-size:0.78rem;color:rgba(255,255,255,0.85);font-weight:700;margin-top:2px;">All features unlocked âœ¨</div>
      <div style="margin-top:10px;background:rgba(255,255,255,0.2);border-radius:10px;padding:6px 12px;display:inline-block;">
        <span style="font-size:0.72rem;color:#fff;font-weight:800;">Active since Feb 2026</span>
      </div>
    </div>
    <!-- Pro features list -->
    <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.78rem;color:var(--mid);text-transform:uppercase;letter-spacing:1px;margin-top:2px;">Your Pro Benefits</div>
    <div style="display:flex;flex-direction:column;gap:7px;">
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.28);border-radius:10px;border:1px solid rgba(255,255,255,0.45);backdrop-filter:blur(4px);">
        <span>ðŸŽ¨</span><span style="font-size:0.8rem;font-weight:700;color:var(--dark);">Exclusive Pro avatar styles</span><span style="margin-left:auto;font-size:0.7rem;background:#34d399;color:#fff;padding:2px 8px;border-radius:99px;font-weight:800;">Active</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.28);border-radius:10px;border:1px solid rgba(255,255,255,0.45);backdrop-filter:blur(4px);">
        <span>ðŸŽ™ï¸</span><span style="font-size:0.8rem;font-weight:700;color:var(--dark);">Avatar voice & speech</span><span style="margin-left:auto;font-size:0.7rem;background:#34d399;color:#fff;padding:2px 8px;border-radius:99px;font-weight:800;">Active</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.28);border-radius:10px;border:1px solid rgba(255,255,255,0.45);backdrop-filter:blur(4px);">
        <span>ðŸ“š</span><span style="font-size:0.8rem;font-weight:700;color:var(--dark);">Library (5GB storage)</span><span style="margin-left:auto;font-size:0.7rem;background:#34d399;color:#fff;padding:2px 8px;border-radius:99px;font-weight:800;">Active</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.28);border-radius:10px;border:1px solid rgba(255,255,255,0.45);backdrop-filter:blur(4px);">
        <span>ðŸ¤–</span><span style="font-size:0.8rem;font-weight:700;color:var(--dark);">Tracker AI assistant</span><span style="margin-left:auto;font-size:0.7rem;background:#34d399;color:#fff;padding:2px 8px;border-radius:99px;font-weight:800;">Active</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.28);border-radius:10px;border:1px solid rgba(255,255,255,0.45);backdrop-filter:blur(4px);">
        <span>ðŸŽ­</span><span style="font-size:0.8rem;font-weight:700;color:var(--dark);">Custom app background photo</span><span style="margin-left:auto;font-size:0.7rem;background:#34d399;color:#fff;padding:2px 8px;border-radius:99px;font-weight:800;">Active</span>
      </div>
    </div>
  </div>
  <div class="notif-add-section" id="notifAddSection">
    <div class="notif-add-title">â° Set a Reminder</div>
    <div class="notif-add-row">
      <input class="notif-input" id="notifTaskName" placeholder="Task name or reminder..."/>
      <input class="notif-input" type="datetime-local" id="notifDateTime"/>
      <button class="notif-add-btn" onclick="addReminder()">+ Set Reminder</button>
    </div>
  </div>
</div>

<!-- ===== INTRO ===== -->
<div id="introScreen">
  <div style="position:relative;">
    <div class="clock-ring2"></div>
    <div class="clock-ring"></div>
    <div class="intro-clock">
      <div class="intro-clock-body">
        <div class="intro-clock-face" id="clockFace">
          <div class="hand-s"></div>
          <div class="hand-h"></div>
          <div class="hand-m"></div>
          <div class="clock-center"></div>
          <svg style="position:absolute;inset:0;width:100%;height:100%;" viewBox="0 0 142 142">
            <g fill="#c9b3e8">
              <rect x="69" y="6" width="4" height="12" rx="2"/>
              <rect x="69" y="124" width="4" height="12" rx="2"/>
              <rect x="6" y="69" width="12" height="4" rx="2"/>
              <rect x="124" y="69" width="12" height="4" rx="2"/>
              <rect x="24" y="20" width="3.5" height="9" rx="1.7" transform="rotate(-45 26 24)"/>
              <rect x="108" y="20" width="3.5" height="9" rx="1.7" transform="rotate(45 110 24)"/>
              <rect x="24" y="112" width="3.5" height="9" rx="1.7" transform="rotate(45 26 116)"/>
              <rect x="108" y="112" width="3.5" height="9" rx="1.7" transform="rotate(-45 110 116)"/>
            </g>
          </svg>
        </div>
      </div>
      <div class="intro-btn-top"></div>
    </div>
  </div>
  <div class="intro-brand">Track &amp; Clock</div>
  <div class="intro-subtitle">Your time. Your tasks. Your world. âœ¨</div>
  <div id="tapToSkip" style="margin-top:28px;font-size:0.75rem;color:rgba(100,80,160,0.5);font-weight:600;letter-spacing:1px;animation:fadeUp 1s 4.6s ease both;opacity:0;">tap anywhere to skip</div>
</div>

<!-- ===== LANDING ===== -->
<div class="screen hidden" id="landing">
  <div class="logo-wrap">
    <div class="logo-img">
      <svg viewBox="0 0 100 100" width="54" height="54">
        <circle cx="50" cy="52" r="36" fill="#d8c4f0" stroke="#c9b3e8" stroke-width="5"/>
        <circle cx="50" cy="52" r="28" fill="white" opacity="0.85"/>
        <rect x="48" y="30" width="3.5" height="16" rx="1.5" fill="#8b5cf6" transform="rotate(-30 50 52)"/>
        <rect x="48" y="30" width="3" height="20" rx="1.5" fill="#5eead4" transform="rotate(70 50 52)"/>
        <circle cx="50" cy="52" r="3.5" fill="#5eead4"/>
        <rect x="46" y="13" width="8" height="6" rx="2" fill="#5eead4"/>
      </svg>
    </div>
    <div class="brand-name">Track &amp; Clock</div>
  </div>
  <div class="welcome-text">Welcome Back, Tracker! ðŸ‘‹</div>
  <div class="tagline">Stay on time. Stay on track. Your tasks, your pace.</div>
  <div class="occ-label">I am a...</div>
  <div class="occ-grid">
    <button class="occ-btn" onclick="pickOcc('Student',this)"><span class="occ-icon">ðŸŽ’</span>Student</button>
    <button class="occ-btn" onclick="pickOcc('Teacher',this)"><span class="occ-icon">ðŸ‘©â€ðŸ«</span>Teacher</button>
    <button class="occ-btn" onclick="pickOcc('Office Worker',this)"><span class="occ-icon">ðŸ’¼</span>Office Worker</button>
    <button class="occ-btn" onclick="pickOcc('Organizer',this)"><span class="occ-icon">ðŸ“‹</span>Organizer</button>
    <button class="occ-btn" onclick="pickOcc('Freelancer',this)"><span class="occ-icon">ðŸ’»</span>Freelancer</button>
    <button class="occ-btn" onclick="pickOcc('Creator',this)"><span class="occ-icon">ðŸŽ¨</span>Creator</button>
    <button class="occ-btn" onclick="pickOcc('Healthcare',this)"><span class="occ-icon">ðŸ¥</span>Healthcare</button>
    <button class="occ-btn" onclick="pickOcc('Other',this)"><span class="occ-icon">âœ¨</span>Other</button>
  </div>
  <div id="googleSignInBtn" style="animation:fadeUp 0.8s 0.55s ease both;margin-top:10px;min-height:44px;display:flex;align-items:center;justify-content:center;"></div>
  <div style="margin-top:8px;font-size:0.8rem;color:var(--mid);font-weight:600;animation:fadeUp 0.8s 0.65s ease both;">or</div>
  <button class="start-btn" style="margin-top:6px;" onclick="goToApp()">Continue as Guest âœ¨</button>
</div>

<!-- ===== APP LAYOUT ===== -->
<div id="appLayout" class="hidden">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <svg width="26" height="26" viewBox="0 0 60 60"><circle cx="30" cy="32" r="22" fill="#d8c4f0" stroke="#c9b3e8" stroke-width="3"/><circle cx="30" cy="32" r="16" fill="white" opacity="0.85"/><rect x="29" y="18" width="2.5" height="10" rx="1.2" fill="#8b5cf6" transform="rotate(-30 30 32)"/><rect x="29" y="18" width="2" height="13" rx="1.2" fill="#5eead4" transform="rotate(70 30 32)"/><circle cx="30" cy="32" r="2.5" fill="#5eead4"/><rect x="27" y="8" width="6" height="4" rx="1.5" fill="#5eead4"/></svg>
      Track &amp; Clock
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-label">Main</div>
      <div class="nav-item active" onclick="setActiveNav(this)"><span class="nav-icon">ðŸ </span>Dashboard</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('calPanel')"><span class="nav-icon">ðŸ“…</span>Calendar</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('taskPanel')"><span class="nav-icon">âœ…</span>Task List</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('actPanel')"><span class="nav-icon">ðŸ“Š</span>Activity</div>
      <div class="nav-section-label">Resources</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('libraryPanel')"><span class="nav-icon">ðŸ“š</span>Library <span class="nav-pro-tag" id="libProTag">ðŸ‘‘</span></div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('trackerAiPanel')"><span class="nav-icon">ðŸ¤–</span>Tracker AI <span class="nav-pro-tag" id="aiProTag">ðŸ‘‘</span></div>
      <div class="nav-section-label">Social</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('groupsPanel')"><span class="nav-icon">ðŸ‘¥</span>Groups</div>
      <div class="nav-section-label">Account</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('profilePanel')"><span class="nav-icon">ðŸ‘¤</span>Profile</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('secPanel')"><span class="nav-icon">ðŸ”’</span>Security</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('appearPanel')"><span class="nav-icon">ðŸŽ¨</span>Appearance</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('aboutPanel')"><span class="nav-icon">â„¹ï¸</span>About</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('pricingPanel')"><span class="nav-icon">ðŸ‘‘</span>Plans &amp; Pricing</div>
    </div>
    <div id="sidebarProStrip" onclick="openFP('pricingPanel')" style="margin:6px 10px 4px;padding:11px 13px;background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(249,168,212,0.09));border-radius:14px;border:1.5px solid rgba(200,180,240,0.3);cursor:pointer;display:flex;align-items:center;gap:9px;transition:all 0.2s;">
      <span id="sidebarProIcon" style="font-size:1.25rem;">ðŸ‘‘</span>
      <div><div id="sidebarProTitle" style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.8rem;color:var(--dark);">Upgrade to Pro</div><div id="sidebarProSub" style="font-size:0.68rem;color:var(--mid);font-weight:600;margin-top:1px;">Unlock Library, AI tools &amp; more âœ¨</div></div>
    </div>
    <div class="sidebar-footer">
      <div class="sidebar-user" onclick="openFP('profilePanel')">
        <div class="sidebar-avatar" id="sidebarAvatar"><span id="sidebarAvatarInner">ðŸ£</span></div>
        <div>
          <div class="sidebar-username" id="sidebarName">Tracker</div>
          <div class="sidebar-occ" id="sidebarOcc">Student</div>
          <div class="sidebar-status" id="sidebarStreak">ðŸ”¥ Day 1 streak</div>
        </div>
      </div>
      <div class="nav-divider" style="height:1px;background:rgba(200,180,240,0.2);margin:7px 0;"></div>
      <button class="auth-btn" onclick="openLoginModal('switch')">ðŸ”„ &nbsp;Switch Account</button>
      <button class="auth-btn logout" onclick="handleLogout()">ðŸšª &nbsp;Log Out</button>
    </div>
  </div>

  <div class="main-area">
    <div class="top-bar">
      <button class="hamburger-btn" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
      <div class="top-title" id="topTitle">Dashboard</div>
      <div id="syncBadge" style="display:flex;align-items:center;gap:5px;font-size:0.7rem;font-weight:700;color:var(--mid);opacity:0;transition:opacity 0.5s;padding:4px 9px;border-radius:10px;background:rgba(255,255,255,0.5);"><span id="syncDot" style="width:6px;height:6px;border-radius:50%;background:#5eead4;flex-shrink:0;"></span><span id="syncLabel">Synced</span></div>
      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
        <button onclick="toggleMiniPlayer()" title="Music" style="width:38px;height:38px;border-radius:50%;border:none;background:rgba(200,180,240,0.3);cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:transform 0.2s;flex-shrink:0;" onmouseover="this.style.transform='scale(1.12)'" onmouseout="this.style.transform=''">ðŸŽµ</button>
        <button onclick="toggleNotifPanel()" id="notifBellBtn" title="Notifications" style="width:38px;height:38px;border-radius:50%;border:none;background:rgba(200,180,240,0.3);cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:transform 0.2s;flex-shrink:0;position:relative;" onmouseover="this.style.transform='scale(1.12)'" onmouseout="this.style.transform=''">
          ðŸ””
          <span class="notif-badge hidden" id="notifBadge">0</span>
        </button>
        <div class="avatar-btn" onclick="openAvatarModal()" id="avatarBtn"><span id="avatarBtnInner">ðŸ£</span></div>
      </div>
    </div>
    <div id="dashPanel">
      <div class="subsection-card" style="animation-delay:.05s" onclick="openFP('calPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#d8c4f0,#e8d8ff);">ðŸ“…</div><div class="card-title">Calendar</div><div class="card-desc">Manage tasks & deadlines</div></div>
      <div class="subsection-card" style="animation-delay:.12s" onclick="openFP('taskPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#b8f0c8,#d4f5e0);">âœ…</div><div class="card-title">Task List</div><div class="card-desc">Group tasks & team chat</div></div>
      <div class="subsection-card" style="animation-delay:.19s" onclick="openFP('actPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#c9b3e8,#ddd0f8);">ðŸ“Š</div><div class="card-title">Activity</div><div class="card-desc">Track progress & scores</div></div>
      <div class="subsection-card" style="animation-delay:.26s" onclick="openFP('libraryPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#fde68a,#fef3c7);">ðŸ“š</div><div class="card-title">Library</div><div class="card-desc">Upload study materials</div></div>
      <div class="subsection-card" style="animation-delay:.33s" onclick="openFP('groupsPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#ffd6e0,#ffecf3);">ðŸ‘¥</div><div class="card-title">Groups</div><div class="card-desc">Group chats & shared tasks</div></div>
      <div class="subsection-card" style="animation-delay:.40s;border:2px solid rgba(139,92,246,0.25);background:linear-gradient(135deg,rgba(200,180,240,0.35),rgba(180,240,200,0.2));position:relative;overflow:hidden;" onclick="openFP('pricingPanel')">
        <div style="position:absolute;top:9px;right:12px;font-family:'Nunito',sans-serif;font-size:0.6rem;font-weight:900;color:#8b5cf6;background:rgba(200,180,240,0.4);padding:2px 8px;border-radius:10px;">âœ¨ UPGRADE</div>
        <div class="card-icon" style="background:linear-gradient(135deg,#f9a8d4,#c9b3e8);">ðŸ‘‘</div>
        <div class="card-title">Go Pro</div>
        <div class="card-desc">Unlock all premium features</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PANELS ===== -->
<!-- CALENDAR -->
<div class="full-panel hidden" id="calPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('calPanel')">â†</button><span class="fp-title">ðŸ“… Calendar</span></div>
  <div class="fp-content">
    <div class="panel-card">
      <div class="cal-nav"><button onclick="changeMonth(-1)">â€¹</button><div class="cal-month" id="calMonthLabel"></div><button onclick="changeMonth(1)">â€º</button></div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
    <div class="panel-card"><h3 id="taskPanelTitle">Select a date to view tasks</h3>
      <div class="task-input-row" id="taskInputRow" style="display:none"><input class="task-input" id="calTaskInput" placeholder="Add task or deadline..." onkeydown="if(event.key==='Enter')addCalTask()"/><button class="add-btn" onclick="addCalTask()">+ Add</button></div>
      <div id="calTaskList"></div></div>
  </div>
</div>

<!-- TASK LIST -->
<div class="full-panel hidden" id="taskPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('taskPanel')">â†</button><span class="fp-title">âœ… All Tasks</span></div>
  <div class="fp-content">
    <div class="panel-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <h3 style="margin:0;">ðŸ“‹ Calendar Tasks</h3>
        <select id="taskFilterStatus" onchange="renderTaskPanel()" style="padding:6px 10px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.82rem;color:var(--dark);outline:none;">
          <option value="all">All</option><option value="pending">Pending</option><option value="done">Done</option>
        </select>
      </div>
      <div id="taskPanelList"><div style="color:var(--mid);font-size:0.88rem;font-weight:600;text-align:center;padding:22px 0;">No tasks yet â€” add them via Calendar ðŸ“…</div></div>
    </div>
    <div class="panel-card">
      <h3>ðŸ‘¥ My Group Tasks</h3>
      <div id="groupTaskList"></div>
      <div class="task-input-row" style="margin-top:9px;">
        <input class="task-input" id="gtaskInput" placeholder="Add a task..." onkeydown="if(event.key==='Enter')addGroupTask()"/>
        <select id="gtaskStatus" style="padding:9px 10px;border-radius:13px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.82rem;color:var(--dark);outline:none;">
          <option value="pending">Pending</option><option value="done">Done</option><option value="late">Late</option>
        </select>
        <button class="add-btn" onclick="addGroupTask()">+ Add</button>
      </div>
    </div>
    <div class="panel-card" style="display:flex;flex-direction:column;"><h3>ðŸ’¬ Team Chat</h3>
      <div class="chat-area" id="chatArea">
        <div class="msg other"><div class="sender">Alex ðŸ±</div>Hey team! Wireframes are ready ðŸŽ‰</div>
        <div class="msg me"><div class="sender">You</div>Great! I'll review them today.</div>
        <div class="msg other"><div class="sender">Sam ðŸ¸</div>Can we move the deadline to Friday?</div>
      </div>
      <div class="msg-input-row"><input class="msg-input" id="msgInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMsg()"/><button class="send-btn" onclick="sendMsg()">Send âž¤</button></div>
    </div>
  </div>
</div>

<!-- Add/Edit Score Modal -->
<div class="modal-overlay hidden" id="addScoreModal" onclick="if(event.target===this)closeAddScoreModal()">
  <div class="avatar-modal" style="max-width:370px;">
    <div class="modal-title" id="scoreModalTitle">âž• Add Activity Entry</div>
    <div style="display:flex;flex-direction:column;gap:9px;margin-top:10px;">
      <input class="task-input" id="scoreTaskName" placeholder="Task name..." style="width:100%;"/>
      <input class="task-input" id="scoreTaskDate" type="date" style="width:100%;"/>
      <select id="scoreTaskStatus" style="width:100%;padding:10px 14px;border-radius:13px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.92rem;color:var(--dark);outline:none;">
        <option value="Pending">Pending</option><option value="Submitted">Submitted</option><option value="Late">Late</option>
      </select>
      <input class="task-input" id="scoreTaskScore" placeholder="Score (e.g. 95/100) â€” optional" style="width:100%;"/>
    </div>
    <div style="display:flex;gap:9px;margin-top:13px;">
      <button class="add-btn" onclick="saveScoreEntry()" style="flex:1;">ðŸ’¾ Save</button>
      <button class="add-btn" onclick="closeAddScoreModal()" style="flex:1;background:rgba(200,180,240,0.3);color:var(--dark);">Cancel</button>
    </div>
  </div>
</div>

<!-- ACTIVITY -->
<div class="full-panel hidden" id="actPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('actPanel')">â†</button><span class="fp-title">ðŸ“Š Activity</span></div>
  <div class="fp-content">
    <div class="score-card"><div class="score-num" id="overallScore">â€”</div><div class="score-label">Overall Score</div><div class="private-toggle"><input type="checkbox" id="scorePrivate" onchange="togglePrivate()"/><label for="scorePrivate">Make my score private</label></div></div>
    <div class="panel-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;flex-wrap:wrap;gap:8px;">
        <h3 style="margin:0;">My Tasks &amp; Scores</h3>
        <button class="add-btn" onclick="openAddScoreModal()" style="font-size:0.8rem;">+ Add Entry</button>
      </div>
      <div id="activityList"><div style="color:var(--mid);font-size:0.88rem;font-weight:600;text-align:center;padding:22px 0;">No activity yet â€” tasks added from Calendar appear here ðŸ“Š</div></div>
    </div>
  </div>
</div>

<!-- LIBRARY -->
<div class="full-panel hidden" id="libraryPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('libraryPanel')">â†</button><span class="fp-title">ðŸ“š Library</span></div>
  <div class="fp-content">
    <div class="panel-card" style="position:relative;">
      <!-- Free trial / Pro gate -->
      <div id="libGate" style="display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px;text-align:center;">
        <div style="font-size:2.8rem;">ðŸ“š</div>
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.1rem;color:var(--dark);">Try Library Free â€” 1GB Included</div>
        <div style="font-size:0.84rem;color:var(--mid);font-weight:600;max-width:280px;line-height:1.65;">Upload photos, videos, and audio for your studies. Free users get <strong>1GB</strong> to try it out. Pro users get <strong>5GB</strong>.</div>
        <button onclick="activateLibrary()" style="padding:11px 28px;border-radius:28px;border:none;background:linear-gradient(135deg,#8b5cf6,#c9b3e8);color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.92rem;cursor:pointer;box-shadow:0 5px 18px rgba(139,92,246,0.28);">Start Free (1GB) ðŸŽ‰</button>
        <div style="font-size:0.74rem;color:var(--mid);font-weight:600;">or <span style="color:#8b5cf6;cursor:pointer;font-weight:800;" onclick="openFP('pricingPanel')">Upgrade to Pro for 5GB â†’</span></div>
      </div>
      <!-- Library content (hidden until activated) -->
      <div id="libContent" style="display:none;">
        <div style="margin-bottom:11px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
          <div><div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.15rem;color:var(--text-on-theme);">Your Study Library</div>
          <div style="color:var(--text-mid-theme);font-size:0.87rem;font-weight:600;margin-top:3px;" id="libStorageLabel2">Upload photos, videos, and audio ðŸ“–</div></div>
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:110px;height:7px;border-radius:10px;background:rgba(200,180,240,0.25);overflow:hidden;"><div id="libStorageFill" style="height:100%;width:0%;background:linear-gradient(90deg,#8b5cf6,#5eead4);border-radius:10px;transition:width 0.4s;"></div></div>
            <span id="libStorageLabel" style="font-size:0.72rem;color:var(--mid);font-weight:700;white-space:nowrap;">0 MB used</span>
          </div>
        </div>
        <div class="lib-tabs">
          <div class="lib-tab active" onclick="switchLibTab('all',this)">All Files</div>
          <div class="lib-tab" onclick="switchLibTab('image',this)">ðŸ“¸ Photos</div>
          <div class="lib-tab" onclick="switchLibTab('video',this)">ðŸŽ¬ Videos</div>
          <div class="lib-tab" onclick="switchLibTab('audio',this)">ðŸŽµ Audio</div>
        </div>
        <div class="lib-upload-zone" onclick="document.getElementById('libFileInput').click()">
          <div class="up-icon">â˜ï¸</div>
          <div class="up-label">Click to Upload Files</div>
          <div class="up-sub" id="libUploadSub">Images, Videos, Audio Â· 1GB Free</div>
          <input type="file" id="libFileInput" multiple accept="image/*,video/*,audio/*" onchange="handleLibUpload(event)"/>
        </div>
        <div id="libGrid" class="lib-grid"></div>
        <div id="libEmpty" class="lib-empty"><div class="lib-empty-icon">ðŸ“‚</div>No files yet. Upload something to get started!</div>
      </div>
    </div>
  </div>
</div>
<div class="file-modal hidden" id="fileModal" onclick="if(event.target===this)closeFileModal()">
  <div class="file-modal-inner"><div style="display:flex;align-items:center;justify-content:space-between;"><div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;color:#3d3260;" id="fileModalTitle">Preview</div><button onclick="closeFileModal()" style="border:none;background:rgba(200,180,240,0.3);border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:0.95rem;">âœ•</button></div><div id="fileModalContent"></div></div>
</div>

<!-- GROUPS â€” Messenger-style -->
<div class="full-panel hidden" id="groupsPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('groupsPanel')">â†</button><span class="fp-title">ðŸ’¬ Messages</span></div>
  <div class="fp-content" style="padding:0;overflow:hidden;">
    <div class="msng-shell">

      <!-- â”€â”€ LEFT SIDEBAR: conversation list â”€â”€ -->
      <div class="msng-sidebar">
        <div class="msng-sidebar-hdr">
          <div class="msng-sidebar-title">Messages</div>
          <input class="msng-search" id="msngSearch" placeholder="ðŸ” Search groups..." oninput="filterConvos(this.value)"/>
        </div>
        <div class="msng-convos" id="msngConvoList"></div>
        <div class="msng-create-row">
          <input class="msng-create-inp" id="newGroupInput" placeholder="New group name..." onkeydown="if(event.key==='Enter')createGroup()"/>
          <button class="msng-create-btn" onclick="createGroup()">+</button>
        </div>
      </div>

      <!-- â”€â”€ RIGHT: chat area â”€â”€ -->
      <div class="msng-chat" id="msngChatPanel">
        <!-- Empty state -->
        <div class="msng-empty" id="msngEmptyState">
          <div class="msng-empty-icon">ðŸ’¬</div>
          <div class="msng-empty-text">Your Messages</div>
          <div class="msng-empty-sub">Select a group to start chatting, or create a new one!</div>
        </div>

        <!-- Active chat (hidden until group selected) -->
        <div id="msngActiveChat" style="display:none;flex-direction:column;height:100%;min-height:0;">
          <!-- Header -->
          <div class="msng-chat-hdr">
            <div class="msng-chat-hdr-avatar" id="msngHdrAvatar">ðŸ’¬</div>
            <div class="msng-chat-hdr-info">
              <div class="msng-chat-hdr-name" id="msngHdrName">Group</div>
              <div class="msng-chat-hdr-members" id="msngHdrMembers"></div>
            </div>
            <button class="msng-hdr-tasks-btn" onclick="toggleTasksDrawer()" title="Toggle Tasks">
              ðŸ“‹ Tasks
            </button>
            <button class="msng-hdr-invite-btn" onclick="openInviteModal()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
              Invite
            </button>
          </div>

          <!-- Messages + tasks side by side -->
          <div style="display:flex;flex:1;min-height:0;overflow:hidden;">
            <!-- Messages column -->
            <div style="display:flex;flex-direction:column;flex:1;min-width:0;">
              <div class="msng-messages" id="groupChatArea"></div>
              <!-- Typing indicator -->
              <div class="msng-typing" id="groupTypingIndicator" style="opacity:0;transition:opacity 0.2s;"></div>
              <!-- Input bar -->
              <div class="msng-input-bar">
                <button class="msng-attach-btn" onclick="openInviteModal()" title="Invite someone">ðŸ‘¤</button>
                <textarea class="msng-input" id="groupMsgInput" placeholder="Aa" rows="1"
                  onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendGroupMsg();}"
                  oninput="handleGroupTyping();autoResizeInput(this)"></textarea>
                <button class="msng-send-btn" onclick="sendGroupMsg()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
              </div>
            </div>
            <!-- Tasks drawer -->
            <div class="msng-tasks-drawer hidden-drawer" id="msngTasksDrawer">
              <div class="msng-tasks-hdr">
                <span>ðŸ“‹ Tasks</span>
                <button onclick="toggleTasksDrawer()" style="background:none;border:none;cursor:pointer;color:var(--mid);font-size:1rem;">âœ•</button>
              </div>
              <div class="msng-tasks-body" id="msngTasksBody"></div>
              <div class="msng-add-task-row">
                <input class="msng-add-task-inp" id="msngAddTaskInp" placeholder="Add task..." onkeydown="if(event.key==='Enter')addGroupChatTask(currentGroup)"/>
                <button class="msng-add-task-btn" onclick="addGroupChatTask(currentGroup)">+</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- end msng-shell -->
  </div>
  <!-- legacy hidden elements for compatibility -->
  <div id="groupMembersRow" style="display:none;"></div>
  <div id="groupTasksDisplay" style="display:none;"></div>
</div>

<!-- ===== INVITE MODAL ===== -->
<div class="invite-modal-overlay hidden" id="inviteModal" onclick="if(event.target===this)closeInviteModal()">
  <div class="invite-modal">
    <div class="invite-modal-header">
      <span class="invite-modal-title">âœ‰ï¸ Invite to Group</span>
      <button class="invite-modal-close" onclick="closeInviteModal()">âœ•</button>
    </div>
    <div id="inviteGroupBadge" class="invite-group-badge"></div>
    <div class="invite-field-label">Invitee's Gmail Address</div>
    <input class="invite-field" id="inviteEmailInput" type="email" placeholder="friend@gmail.com" oninput="updateInvitePreview()"/>
    <div class="invite-field-label" style="margin-top:12px;">Personal Message <span style="font-weight:600;color:var(--mid);text-transform:none;font-size:0.72rem;">(optional)</span></div>
    <input class="invite-field" id="inviteMessageInput" type="text" placeholder="Hey! Join our study group ðŸŽ‰" oninput="updateInvitePreview()"/>
    <!-- Live preview -->
    <div class="invite-preview" id="invitePreview">
      <div style="margin-bottom:6px;">ðŸ“§ <b>Email preview:</b></div>
      <div id="invitePreviewBody"></div>
      <div class="invite-link-preview" id="invitePreviewLink"></div>
    </div>
    <div class="invite-actions">
      <button class="invite-send-btn" onclick="sendInviteEmail()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4 20-7z"/><path d="M22 2 11 13"/></svg>
        Open Gmail to Send
      </button>
      <button class="invite-copy-btn" onclick="copyInviteLink()" id="inviteCopyBtn">ðŸ”— Copy Link</button>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div class="full-panel hidden" id="profilePanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('profilePanel')">â†</button><span class="fp-title">ðŸ‘¤ Profile</span></div>
  <div class="fp-content">
    <!-- Profile Banner -->
    <div id="profileBanner" style="position:relative;border-radius:20px;overflow:hidden;margin-bottom:0;">
      <!-- Cover photo area -->
      <div id="profileCoverBg" style="height:130px;background:linear-gradient(135deg,#d8c4f0,#b8f0c8,#d8c4f0);background-size:200% 200%;animation:bgShift 8s ease infinite;position:relative;">
        <div style="position:absolute;inset:0;opacity:0.12;background:repeating-linear-gradient(45deg,transparent,transparent 12px,rgba(255,255,255,0.4) 12px,rgba(255,255,255,0.4) 24px);"></div>
        <!-- Floating deco emojis in cover -->
        <div style="position:absolute;top:12px;left:18px;font-size:1.4rem;opacity:0.35;animation:decoFloat 6s ease-in-out infinite;">âœ¨</div>
        <div style="position:absolute;top:20px;right:30px;font-size:1.2rem;opacity:0.3;animation:decoFloat 8s ease-in-out infinite 1s;">ðŸŒ¸</div>
        <div style="position:absolute;bottom:14px;left:40%;font-size:1rem;opacity:0.25;animation:decoFloat 7s ease-in-out infinite 2s;">ðŸ’«</div>
      </div>
      <!-- Avatar circle overlapping the cover -->
      <div style="position:relative;background:rgba(255,255,255,0.7);backdrop-filter:blur(12px);padding:0 20px 18px;border-radius:0 0 20px 20px;">
        <div style="display:flex;align-items:flex-end;gap:14px;margin-top:-46px;">
          <!-- Live SVG avatar preview -->
          <div id="profileAvatarBig" onclick="openAvatarModal()" title="Edit avatar" style="width:92px;height:92px;border-radius:50%;border:4px solid rgba(255,255,255,0.95);background:var(--white);box-shadow:0 4px 18px rgba(140,100,220,0.22);overflow:hidden;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;position:relative;">
            <div id="profileAvatarSvgWrap" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"></div>
            <div style="position:absolute;bottom:2px;right:2px;width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#5eead4);display:flex;align-items:center;justify-content:center;font-size:0.7rem;border:2px solid white;">âœï¸</div>
          </div>
          <div style="padding-bottom:6px;flex:1;min-width:0;">
            <div class="profile-name" id="profileNameDisplay" style="font-size:1.25rem;">Tracker</div>
            <div class="profile-tag" id="profileOccDisplay" style="margin-top:2px;">Student Â· Active Member</div>
          </div>
          <div style="padding-bottom:8px;">
            <div class="streak-badge">ðŸ”¥ <span id="streakCount">1</span> day streak</div>
          </div>
        </div>
      </div>
    </div>
    <div class="panel-card"><h3>Personal Info</h3>
      <div class="info-row"><div class="info-icon" style="background:#f0e8ff;">ðŸ‘¤</div><div><div class="info-label">Full Name</div><div class="info-val" id="profileNameVal">Tracker User</div></div></div>
      <div class="info-row"><div class="info-icon" style="background:#e0f8e8;">ðŸŽ’</div><div><div class="info-label">Occupation</div><div class="info-val" id="profileOccVal">Student</div></div></div>
      <div class="info-row"><div class="info-icon" style="background:#fff0e0;">ðŸ“§</div><div><div class="info-label">Email</div><div class="info-val" id="profileEmail">â€”</div></div></div>
      <div class="info-row"><div class="info-icon" style="background:#e8f0ff;">ðŸ“…</div><div><div class="info-label">Member Since</div><div class="info-val">February 19, 2026</div></div></div>
      <div class="info-row"><div class="info-icon" style="background:#f5f0ff;">ðŸ”¥</div><div><div class="info-label">Current Streak</div><div class="info-val"><span id="streakVal">1</span> day(s) active</div></div></div>
    </div>
    <div class="panel-card"><h3>My Groups</h3><div><span class="group-chip">ðŸ“˜ English Group</span><span class="group-chip">ðŸ“— Math Group</span><span class="group-chip">ðŸ”¬ Science Group</span></div></div>
    <div class="panel-card"><h3>Edit Profile</h3><div class="task-input-row"><input class="task-input" id="editNameInput" placeholder="Update display name..." value="Tracker"/><button class="add-btn" onclick="saveProfileName()">Save</button></div></div>
  </div>
</div>

<!-- SECURITY -->
<div class="full-panel hidden" id="secPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('secPanel')">â†</button><span class="fp-title">ðŸ”’ Security</span></div>
  <div class="fp-content">

    <!-- Account Security -->
    <div class="panel-card"><h3>Account Security</h3>
      <div class="sec-item"><div class="sec-left"><div class="sec-icon" style="background:#f0e8ff;">ðŸ”‘</div><div><div class="sec-title">Change Password</div><div class="sec-sub">Last changed: Never</div></div></div><span class="sec-arrow">â€º</span></div>
      <div class="sec-item"><div class="sec-left"><div class="sec-icon" style="background:#e0f8e8;">ðŸ“±</div><div><div class="sec-title">Two-Factor Authentication</div><div class="sec-sub">Add extra security via SMS or app</div></div></div><span class="sec-arrow">â€º</span></div>
      <div class="sec-item"><div class="sec-left"><div class="sec-icon" style="background:#fff0e0;">ðŸ”—</div><div><div class="sec-title">Linked Google Account</div><div class="sec-sub" id="googleLinkedStatus">Not linked</div></div></div><button onclick="signInWithGoogle()" style="padding:7px 14px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.8rem;color:#3d3260;">Link</button></div>
    </div>

    <!-- Update Password -->
    <div class="panel-card"><h3>Update Password</h3>
      <div style="display:flex;flex-direction:column;gap:9px;">
        <input class="task-input" placeholder="Current password..." type="password" style="width:100%"/>
        <input class="task-input" placeholder="New password..." type="password" style="width:100%"/>
        <input class="task-input" placeholder="Confirm new password..." type="password" style="width:100%"/>
        <button class="add-btn" style="width:100%;padding:12px;">Update Password</button>
      </div>
    </div>

    <!-- Privacy & Terms -->
    <div class="panel-card">
      <h3>Privacy &amp; Terms</h3>

      <!-- Privacy Policy accordion -->
      <div class="legal-accordion" id="privacyAccordion">
        <div class="legal-accordion-header" onclick="toggleLegal('privacyBody','privacyChevron')">
          <div class="sec-left">
            <div class="sec-icon" style="background:#e8f0ff;">ðŸ“„</div>
            <div>
              <div class="sec-title">Privacy Policy</div>
              <div class="sec-sub">Last Updated: February 21, 2026 Â· How we handle your data</div>
            </div>
          </div>
          <span class="legal-chevron" id="privacyChevron">â€º</span>
        </div>
        <div class="legal-doc-body" id="privacyBody">
          <div class="legal-doc-scroll">

            <div class="legal-section-title">1. Introduction</div>
            <p>Welcome to Track &amp; Clock. We are committed to protecting your privacy and ensuring the security of your personal information. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our task management and productivity platform.</p>
            <p>By accessing or using Track &amp; Clock, you agree to the terms of this Privacy Policy. If you do not agree with our policies and practices, please do not use our Service.</p>

            <div class="legal-section-title">2. Information We Collect</div>
            <div class="legal-subsection">2.1 Personal Information</div>
            <p>We may collect personal information that you voluntarily provide to us when you:</p>
            <ul class="legal-list">
              <li>Register for an account</li>
              <li>Create tasks, calendar events, or activity entries</li>
              <li>Use our chat and messaging features</li>
              <li>Upload files, photos, videos, or audio to the Library</li>
              <li>Contact our support team</li>
            </ul>
            <p>This information may include:</p>
            <ul class="legal-list">
              <li>Name and email address</li>
              <li>Profile information and preferences</li>
              <li>Task data, calendar entries, and productivity metrics</li>
              <li>Chat messages and group communications</li>
              <li>Files and media uploaded to your Library</li>
            </ul>
            <div class="legal-subsection">2.2 Automatically Collected Information</div>
            <p>When you access our Service, we automatically collect certain information about your device and usage, including:</p>
            <ul class="legal-list">
              <li>IP address and device identifiers</li>
              <li>Browser type and operating system</li>
              <li>Usage patterns and feature interactions</li>
              <li>Log data and error reports</li>
            </ul>

            <div class="legal-section-title">3. How We Use Your Information</div>
            <p>We use the information we collect to:</p>
            <ul class="legal-list">
              <li>Provide, maintain, and improve our Service</li>
              <li>Process and display your tasks, calendar events, and activity data</li>
              <li>Enable chat functionality and group communications</li>
              <li>Store and manage your files in the Library</li>
              <li>Send notifications and updates about your tasks</li>
              <li>Respond to your inquiries and provide customer support</li>
              <li>Analyze usage trends to enhance user experience</li>
              <li>Detect and prevent fraud, abuse, or security incidents</li>
            </ul>

            <div class="legal-section-title">4. Data Storage and Security</div>
            <p>We implement appropriate technical and organizational measures to protect your personal information:</p>
            <ul class="legal-list">
              <li>Encryption of data in transit (TLS/SSL) and at rest</li>
              <li>Regular security assessments and vulnerability testing</li>
              <li>Access controls and authentication mechanisms</li>
              <li>Secure data backup and disaster recovery procedures</li>
            </ul>
            <p>While we strive to protect your information, no method of transmission over the internet or electronic storage is 100% secure. We cannot guarantee absolute security.</p>

            <div class="legal-section-title">5. Data Sharing and Disclosure</div>
            <p>We do not sell your personal information. We may share your information only in the following circumstances:</p>
            <ul class="legal-list">
              <li>With your explicit consent</li>
              <li>With service providers who assist us in operating our Service</li>
              <li>To comply with legal obligations or court orders</li>
              <li>To protect our rights, property, or safety, or that of our users</li>
              <li>In connection with a merger, acquisition, or sale of assets</li>
            </ul>

            <div class="legal-section-title">6. Your Rights and Choices</div>
            <p>Depending on your location, you may have the following rights regarding your personal information:</p>
            <ul class="legal-list">
              <li><strong>Access:</strong> Request a copy of your personal data</li>
              <li><strong>Correction:</strong> Update or correct inaccurate information</li>
              <li><strong>Deletion:</strong> Request deletion of your personal data</li>
              <li><strong>Portability:</strong> Receive your data in a structured format</li>
              <li><strong>Restriction:</strong> Limit how we process your data</li>
            </ul>
            <p>To exercise these rights, please contact us using the information provided in Section 10.</p>

            <div class="legal-section-title">7. Chat and Communication Data</div>
            <p>Our Service includes chat functionality that allows you to communicate with other users and create groups. Please be aware that:</p>
            <ul class="legal-list">
              <li>Chat messages are stored on our servers to enable the service</li>
              <li>Group administrators may have access to group member information</li>
              <li>We do not monitor private conversations but may review reports of abuse</li>
              <li>You are responsible for the content you share in chats</li>
            </ul>

            <div class="legal-section-title">8. Library Content</div>
            <p>The Library feature allows you to upload and store files, photos, videos, and audio. Please note:</p>
            <ul class="legal-list">
              <li>You retain ownership of content you upload</li>
              <li>You grant us a license to store and display your content as necessary to provide the Service</li>
              <li>We may impose storage limits based on your account type</li>
              <li>Prohibited content will be removed and may result in account termination</li>
            </ul>

            <div class="legal-section-title">9. Cookies and Tracking Technologies</div>
            <p>We use cookies and similar tracking technologies to enhance your experience, remember your preferences, and analyze usage patterns. You can control cookie settings through your browser preferences.</p>

            <div class="legal-section-title">10. Children's Privacy</div>
            <p>Our Service is not intended for children under 13 years of age. We do not knowingly collect personal information from children under 13. If you believe we have collected information from a child under 13, please contact us immediately.</p>

            <div class="legal-section-title">11. Changes to This Privacy Policy</div>
            <p>We may update this Privacy Policy from time to time. We will notify you of any changes by posting the new policy on this page and updating the "Last Updated" date. Your continued use of the Service after such changes constitutes acceptance of the updated policy.</p>

            <div class="legal-section-title">12. Contact Us</div>
            <p>If you have any questions, concerns, or requests regarding this Privacy Policy or our data practices, please contact us at:</p>
            <div class="legal-contact-badge">ðŸ“§ <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6a1e180b09010b040e09060509012a0d070b030644090507">[email&#160;protected]</a></div>

          </div>
        </div>
      </div>

      <div style="height:10px;"></div>

      <!-- Terms of Service accordion -->
      <div class="legal-accordion" id="tosAccordion">
        <div class="legal-accordion-header" onclick="toggleLegal('tosBody','tosChevron')">
          <div class="sec-left">
            <div class="sec-icon" style="background:#f5e8ff;">ðŸ“‹</div>
            <div>
              <div class="sec-title">Terms of Service</div>
              <div class="sec-sub">Last Updated: February 21, 2026 Â· Rules for using Track &amp; Clock</div>
            </div>
          </div>
          <span class="legal-chevron" id="tosChevron">â€º</span>
        </div>
        <div class="legal-doc-body" id="tosBody">
          <div class="legal-doc-scroll">

            <div class="legal-section-title">1. Agreement to Terms</div>
            <p>Welcome to Track &amp; Clock. These Terms of Service constitute a legally binding agreement between you and Track &amp; Clock regarding your use of our task management and productivity platform.</p>
            <p>By accessing or using our Service, you agree to be bound by these Terms. If you do not agree to these Terms, you may not access or use the Service.</p>

            <div class="legal-section-title">2. Description of Service</div>
            <p>Track &amp; Clock is a productivity platform that provides the following features:</p>
            <div class="legal-subsection">2.1 Calendar</div>
            <p>A calendar feature that displays tasks and events you input, helping you organize and visualize your schedule.</p>
            <div class="legal-subsection">2.2 Task List</div>
            <p>A task management system that shows your list of tasks and tracks their progress status.</p>
            <div class="legal-subsection">2.3 Activity Tab</div>
            <p>A feature that displays task intensity and priority levels to help you focus on what matters most.</p>
            <div class="legal-subsection">2.4 Chat</div>
            <p>A messaging platform that allows you to communicate with other users and create groups for collaborative work.</p>
            <div class="legal-subsection">2.5 Library</div>
            <p>A storage system that compiles and organizes files, photos, videos, and audio that you upload.</p>

            <div class="legal-section-title">3. Account Registration</div>
            <p>To use certain features of the Service, you must create an account. You agree to:</p>
            <ul class="legal-list">
              <li>Provide accurate, current, and complete information during registration</li>
              <li>Maintain and promptly update your account information</li>
              <li>Keep your password secure and confidential</li>
              <li>Notify us immediately of any unauthorized access to your account</li>
              <li>Be responsible for all activities that occur under your account</li>
            </ul>

            <div class="legal-section-title">4. User Conduct</div>
            <p>You agree not to use the Service to:</p>
            <ul class="legal-list">
              <li>Violate any applicable laws or regulations</li>
              <li>Infringe upon the rights of others</li>
              <li>Upload or transmit viruses, malware, or harmful code</li>
              <li>Interfere with or disrupt the Service or servers</li>
              <li>Harvest or collect user information without consent</li>
              <li>Send unsolicited communications or spam</li>
              <li>Impersonate any person or entity</li>
              <li>Upload content that is illegal, harmful, threatening, or offensive</li>
            </ul>

            <div class="legal-section-title">5. Content and Intellectual Property</div>
            <div class="legal-subsection">5.1 Your Content</div>
            <p>You retain ownership of all content you create, upload, or store on the Service, including tasks, calendar entries, chat messages, and Library files. By using the Service, you grant us a limited license to use, store, and display your content solely for the purpose of providing and improving the Service.</p>
            <div class="legal-subsection">5.2 Prohibited Content</div>
            <p>You may not upload, store, or share content that:</p>
            <ul class="legal-list">
              <li>Infringes on intellectual property rights</li>
              <li>Contains malware or malicious code</li>
              <li>Is illegal, defamatory, or harassing</li>
              <li>Contains hate speech or promotes violence</li>
              <li>Is sexually explicit or pornographic</li>
            </ul>
            <div class="legal-subsection">5.3 Our Intellectual Property</div>
            <p>The Service and its original content, features, and functionality are owned by Track &amp; Clock and are protected by international copyright, trademark, and other intellectual property laws.</p>

            <div class="legal-section-title">6. Chat and Group Features</div>
            <p>When using our chat and group communication features:</p>
            <ul class="legal-list">
              <li>You are solely responsible for the content you share</li>
              <li>Group creators and administrators have additional responsibilities for managing group content</li>
              <li>We reserve the right to remove content that violates these Terms</li>
              <li>We may suspend or terminate accounts for repeated violations</li>
              <li>Chat messages may be retained as necessary for service operation</li>
            </ul>

            <div class="legal-section-title">7. Library Storage</div>
            <p>The Library feature is subject to the following terms:</p>
            <ul class="legal-list">
              <li>Storage limits may apply based on your account type</li>
              <li>We reserve the right to remove content that violates these Terms</li>
              <li>You are responsible for maintaining backups of important files</li>
              <li>We do not guarantee permanent storage of any content</li>
              <li>Large or inactive accounts may be subject to storage management policies</li>
            </ul>

            <div class="legal-section-title">8. Payment and Subscription</div>
            <p>Certain features of the Service may require payment. If you purchase a subscription:</p>
            <ul class="legal-list">
              <li>You agree to pay all applicable fees</li>
              <li>Subscriptions automatically renew unless cancelled</li>
              <li>Refunds are provided in accordance with our refund policy</li>
              <li>We may change pricing with advance notice</li>
            </ul>

            <div class="legal-section-title">9. Termination</div>
            <p>We may terminate or suspend your account immediately, without prior notice or liability, for any reason, including if you breach these Terms. Upon termination, your right to use the Service will immediately cease.</p>
            <p>You may terminate your account at any time by following the instructions in your account settings or contacting us.</p>

            <div class="legal-section-title">10. Disclaimer of Warranties</div>
            <div class="legal-disclaimer">THE SERVICE IS PROVIDED "AS IS" AND "AS AVAILABLE" WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. WE DO NOT WARRANT THAT THE SERVICE WILL BE UNINTERRUPTED, TIMELY, SECURE, OR ERROR-FREE, OR THAT ANY DEFECTS WILL BE CORRECTED.</div>

            <div class="legal-section-title">11. Limitation of Liability</div>
            <div class="legal-disclaimer">TO THE MAXIMUM EXTENT PERMITTED BY LAW, IN NO EVENT SHALL TRACK AND CLOCK BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES ARISING OUT OF OR RELATING TO YOUR USE OF THE SERVICE. OUR TOTAL LIABILITY FOR ANY CLAIM ARISING FROM OR RELATING TO THESE TERMS OR THE SERVICE SHALL NOT EXCEED THE AMOUNT YOU PAID US, IF ANY, DURING THE TWELVE (12) MONTHS PRIOR TO THE EVENT GIVING RISE TO LIABILITY.</div>

            <div class="legal-section-title">12. Indemnification</div>
            <p>You agree to indemnify, defend, and hold harmless Track &amp; Clock and its officers, directors, employees, and agents from and against any claims, liabilities, damages, losses, and expenses arising out of or in any way connected with your access to or use of the Service, your content, or your violation of these Terms.</p>

            <div class="legal-section-title">13. Governing Law</div>
            <p>These Terms shall be governed by and construed in accordance with applicable laws, without regard to conflict of law provisions. Any legal action arising out of these Terms shall be brought exclusively in the applicable courts of jurisdiction.</p>

            <div class="legal-section-title">14. Changes to Terms</div>
            <p>We reserve the right to modify or replace these Terms at any time. We will provide notice of significant changes by posting the updated Terms on our website and updating the "Last Updated" date. Your continued use of the Service after such changes constitutes acceptance of the updated Terms.</p>

            <div class="legal-section-title">15. Severability</div>
            <p>If any provision of these Terms is found to be unenforceable or invalid, that provision shall be limited or eliminated to the minimum extent necessary, and the remaining provisions shall remain in full force and effect.</p>

            <div class="legal-section-title">16. Entire Agreement</div>
            <p>These Terms constitute the entire agreement between you and Track &amp; Clock regarding the Service and supersede all prior agreements and understandings.</p>

            <div class="legal-section-title">17. Contact Us</div>
            <p>If you have any questions about these Terms, please contact us at:</p>
            <div class="legal-contact-badge">ðŸ“§ <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="77030516141c161913141b18141c37101a161e1b5914181a">[email&#160;protected]</a></div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- APPEARANCE -->
<div class="full-panel hidden" id="appearPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('appearPanel')">â†</button><span class="fp-title">ðŸŽ¨ Appearance</span></div>
  <div class="fp-content">
    <div class="panel-card"><h3>Choose a Theme</h3>
      <div class="theme-grid">
        <div class="theme-opt active" onclick="setTheme('lavender',this)" style="background:linear-gradient(135deg,#d4c8f0,#e8d8ff);"><div class="theme-preview" style="background:linear-gradient(135deg,#c9b3e8,#b8f0c8);"></div><div class="theme-name" style="color:#3d3260;">Lavender Dream</div></div>
        <div class="theme-opt" onclick="setTheme('ocean',this)" style="background:linear-gradient(135deg,#b3d8f0,#d8f0e8);"><div class="theme-preview" style="background:linear-gradient(135deg,#67b8e8,#5eead4);"></div><div class="theme-name" style="color:#1a4a6a;">Ocean Breeze</div></div>
        <div class="theme-opt" onclick="setTheme('sunset',this)" style="background:linear-gradient(135deg,#f0d4c8,#f0e8b3);"><div class="theme-preview" style="background:linear-gradient(135deg,#f8a4a4,#f8d48c);"></div><div class="theme-name" style="color:#6a2a1a;">Sunset Glow</div></div>
        <div class="theme-opt" onclick="setTheme('forest',this)" style="background:linear-gradient(135deg,#c8f0d4,#f0f0b3);"><div class="theme-preview" style="background:linear-gradient(135deg,#6dbf7e,#b8e868);"></div><div class="theme-name" style="color:#1a4a2a;">Forest Fresh</div></div>
        <div class="theme-opt" onclick="setTheme('rose',this)" style="background:linear-gradient(135deg,#f0c8d4,#f0c8f0);"><div class="theme-preview" style="background:linear-gradient(135deg,#f48fb1,#ce93d8);"></div><div class="theme-name" style="color:#5a1a3a;">Rose Garden</div></div>
        <div class="theme-opt" onclick="setTheme('night',this)" style="background:linear-gradient(135deg,#2a2540,#1a3a4a);"><div class="theme-preview" style="background:linear-gradient(135deg,#4a3f6b,#1a3a4a);"></div><div class="theme-name" style="color:#d0c8f0;">Midnight</div></div>
      </div>
    </div>
    <div class="panel-card"><h3>Mood / Vibe</h3>
      <div style="display:flex;gap:9px;flex-wrap:wrap;">
        <button class="mood-btn active" onclick="setMood(this)">ðŸ§¸ Cozy</button>
        <button class="mood-btn" onclick="setMood(this)">ðŸŽ¯ Focused</button>
        <button class="mood-btn" onclick="setMood(this)">ðŸŽ‰ Playful</button>
        <button class="mood-btn" onclick="setMood(this)">ðŸŒ¿ Calm</button>
        <button class="mood-btn" onclick="setMood(this)">âš¡ Energetic</button>
      </div>
    </div>
    <div class="panel-card"><h3>Font Size</h3>
      <div style="display:flex;gap:9px;align-items:center;">
        <button class="font-btn active" onclick="setFont('15px',this)" style="font-size:0.82rem;">Aa Small</button>
        <button class="font-btn" onclick="setFont('17px',this)" style="font-size:0.96rem;">Aa Medium</button>
        <button class="font-btn" onclick="setFont('20px',this)" style="font-size:1.12rem;">Aa Large</button>
        <button class="font-btn" onclick="setFont('23px',this)" style="font-size:1.3rem;">Aa Extra Large</button>
      </div>
      <div style="margin-top:11px;padding:11px 14px;background:rgba(200,180,240,0.15);border-radius:12px;font-weight:600;color:var(--text-on-theme);" id="fontPreviewText">
        This is a preview of how your text will look. Track &amp; Clock helps you stay on time! âœ¨
      </div>
    </div>
    <!-- Background Photo -->
    <div class="panel-card">
      <h3>ðŸ–¼ï¸ Custom Background Photo</h3>
      <p style="font-size:0.84rem;color:var(--text-mid-theme);font-weight:600;margin-bottom:14px;">Set your own photo as the app background. It will show behind all your panels.</p>
      <div id="bgPhotoPreviewWrap" style="display:none;margin-bottom:12px;border-radius:14px;overflow:hidden;max-height:160px;position:relative;">
        <img id="bgPhotoPreviewImg" src="" style="width:100%;height:160px;object-fit:cover;border-radius:14px;"/>
        <div style="position:absolute;inset:0;background:linear-gradient(to bottom,transparent 40%,rgba(60,40,100,0.4));border-radius:14px;"></div>
        <span style="position:absolute;bottom:10px;left:12px;color:#fff;font-size:0.78rem;font-weight:800;">Current background</span>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button onclick="document.getElementById('appBgPhotoInput').click()" style="padding:10px 20px;border-radius:12px;border:2px dashed rgba(200,180,240,0.5);background:rgba(200,180,240,0.1);color:var(--dark);font-weight:800;font-size:0.88rem;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.2s;">
          ðŸ“ Choose Photo
          <input type="file" id="appBgPhotoInput" accept="image/*" onchange="setAppBgPhoto(event)" style="display:none"/>
        </button>
        <button onclick="clearAppBgPhoto()" id="clearBgPhotoBtn" style="display:none;padding:10px 20px;border-radius:12px;border:none;background:rgba(239,68,68,0.1);color:#ef4444;font-weight:800;font-size:0.88rem;cursor:pointer;">ðŸ—‘ï¸ Remove</button>
      </div>
      <div style="margin-top:10px;">
        <label style="font-size:0.8rem;font-weight:700;color:var(--mid);">Background opacity</label>
        <input type="range" id="bgPhotoOpacity" min="10" max="100" value="60" oninput="updateBgPhotoOpacity(this.value)" style="width:100%;accent-color:#8b5cf6;margin-top:6px;"/>
        <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--mid);font-weight:700;"><span>Subtle</span><span>Full</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ABOUT -->
<div class="full-panel hidden" id="aboutPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('aboutPanel')">â†</button><span class="fp-title">â„¹ï¸ About</span></div>
  <div class="fp-content">
    <div class="about-hero"><div class="about-logo">â±</div><div class="about-name">Track &amp; Clock</div><div class="about-tagline">Stay on time. Stay on track. Your tasks, your pace.</div><div style="margin-top:13px;display:flex;justify-content:center;gap:13px;flex-wrap:wrap;"><span style="background:rgba(255,255,255,0.5);padding:5px 15px;border-radius:19px;font-size:0.82rem;font-weight:800;">Version 2.0</span><span style="background:rgba(255,255,255,0.5);padding:5px 15px;border-radius:19px;font-size:0.82rem;font-weight:800;">Feb 2026</span></div></div>
    <div class="panel-card"><h3>What is Track & Clock?</h3><p style="font-size:0.92rem;color:var(--text-mid-theme);line-height:1.75;font-weight:600;">Track & Clock is a collaborative productivity platform for students, teachers, and teams. Manage your time, coordinate group tasks, study with your own media library, and stay on top of deadlines â€” all in one customizable space.</p></div>
    <div class="panel-card"><h3>Features</h3>
      <div class="feature-item"><div class="feat-icon" style="background:#f0e8ff;">ðŸ“…</div><div><div class="feat-title">Smart Calendar</div><div class="feat-desc">Click any date to add tasks and deadlines.</div></div></div>
      <div class="feature-item"><div class="feat-icon" style="background:#e0f8e8;">âœ…</div><div><div class="feat-title">Task List & Team Chat</div><div class="feat-desc">Group tasks and real-time team communication.</div></div></div>
      <div class="feature-item"><div class="feat-icon" style="background:#fef3c7;">ðŸ“š</div><div><div class="feat-title">Library</div><div class="feat-desc">Upload photos, videos, and audio for studying.</div></div></div>
      <div class="feature-item"><div class="feat-icon" style="background:#e8f0ff;">ðŸ‘¥</div><div><div class="feat-title">Groups</div><div class="feat-desc">Create and join groups for shared tasks and chat.</div></div></div>
      <div class="feature-item"><div class="feat-icon" style="background:#f5e8ff;">ðŸŽ¨</div><div><div class="feat-title">Customization</div><div class="feat-desc">Themes, moods, avatars â€” make it yours.</div></div></div>
    </div>
    <div class="panel-card" style="text-align:center;"><div style="font-size:0.88rem;color:var(--text-mid-theme);font-weight:600;">Made with ðŸ’œ for productive people everywhere</div><div style="font-size:0.79rem;color:var(--text-mid-theme);margin-top:6px;font-weight:600;">Â© 2026 Track & Clock. All rights reserved.</div></div>
  </div>
</div>

<!-- ===== PRICING PANEL ===== -->
<div class="full-panel hidden" id="pricingPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('pricingPanel')">â†</button><span class="fp-title">ðŸ‘‘ Plans &amp; Pricing</span></div>
  <div class="fp-content" style="align-items:center;padding-bottom:40px;">
    <div style="text-align:center;max-width:620px;width:100%;padding:8px 0 4px;">
      <div style="font-size:0.74rem;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:var(--mid);margin-bottom:9px;">Simple, transparent pricing</div>
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:2rem;line-height:1.15;margin-bottom:9px;background:linear-gradient(135deg,#8b5cf6,#f9a8d4,#5eead4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Level up your productivity ðŸš€</div>
      <div style="font-size:0.92rem;color:var(--mid);font-weight:600;">Start free. Upgrade when you're ready. Cancel anytime.</div>
      <div style="display:flex;align-items:center;gap:10px;margin:18px auto 0;width:fit-content;">
        <div style="display:flex;background:rgba(255,255,255,0.55);border-radius:30px;padding:4px;border:1.5px solid rgba(200,180,240,0.3);gap:4px;">
          <button class="billing-btn active" id="billMonthly" onclick="setBilling('monthly')">Monthly</button>
          <button class="billing-btn" id="billAnnual" onclick="setBilling('annual')">Annual</button>
        </div>
        <span style="background:linear-gradient(135deg,#f9a8d4,#c9b3e8);color:#5a1a6a;padding:4px 11px;border-radius:20px;font-size:0.72rem;font-weight:900;font-family:'Nunito',sans-serif;">Save 20%</span>
      </div>
    </div>
    <div class="plans-grid">
      <!-- FREE -->
      <div class="plan-card" style="animation-delay:.05s">
        <div class="plan-icon">ðŸŒ±</div><div class="plan-name">Free</div><div class="plan-desc">Perfect to get started</div>
        <div class="plan-price">â‚±<span>0</span></div><div class="plan-price-period">forever free</div><div class="plan-annual-note"> </div>
        <div class="plan-divider"></div>
        <div class="plan-features">
          <div class="pf"><span>âœ…</span>Calendar & task management</div>
          <div class="pf"><span>âœ…</span>Task list & team chat</div>
          <div class="pf"><span>âœ…</span>Up to 10 groups</div>
          <div class="pf"><span>âœ…</span>Basic activity tracking</div>
          <div class="pf"><span>âœ…</span>Avatar customization</div>
          <div class="pf"><span>âœ…</span>Deadline notifications</div>
          <div class="pf"><span>âœ…</span>Library â€” 1GB free trial</div>
          <div class="pf dim"><span>ðŸ”’</span>AI study assistant</div>
          <div class="pf dim"><span>ðŸ”’</span>Advanced analytics</div>
          <div class="pf dim"><span>ðŸ”’</span>Unlimited groups</div>
        </div>
        <button class="plan-cta cta-current" id="freeCta">Current Plan</button>
      </div>
      <!-- PRO -->
      <div class="plan-card pro-highlight" style="animation-delay:.12s">
        <div class="plan-popular-tag">â­ Most Popular</div>
        <div class="plan-icon">âœ¨</div><div class="plan-name">Pro</div><div class="plan-desc">For serious students & teams</div>
        <div class="plan-price">â‚±<span id="proPrice">149</span></div><div class="plan-price-period">per month</div><div class="plan-annual-note" id="proAnnualNote"> </div>
        <div class="plan-divider"></div>
        <div class="plan-features">
          <div class="pf"><span>âœ…</span>Everything in Free</div>
          <div class="pf"><span>ðŸ“š</span>Library uploads â€” 5GB storage</div>
          <div class="pf"><span>ðŸ¤–</span>AI study assistant & quiz gen</div>
          <div class="pf"><span>ðŸ“Š</span>Advanced analytics dashboard</div>
          <div class="pf"><span>â°</span>Priority smart reminders</div>
          <div class="pf"><span>ðŸŽ¨</span>Exclusive Pro themes & avatars</div>
          <div class="pf"><span>ðŸ‘¥</span>Unlimited groups</div>
          <div class="pf"><span>ðŸ“…</span>Recurring tasks & templates</div>
          <div class="pf"><span>ðŸ“¤</span>Export tasks as PDF/CSV</div>
          <div class="pf"><span>ðŸ””</span>Cross-device push notifications</div>
        </div>
        <button class="plan-cta cta-pro" id="proCta" onclick="openPayModal('pro')">Get Pro âœ¨</button>
      </div>
      <!-- TEAM -->
      <div class="plan-card" style="animation-delay:.20s">
        <div class="plan-icon">ðŸ«</div><div class="plan-name">Team</div><div class="plan-desc">For classrooms & organizations</div>
        <div class="plan-price">â‚±<span id="teamPrice">399</span></div><div class="plan-price-period">per month Â· up to 30 users</div><div class="plan-annual-note" id="teamAnnualNote"> </div>
        <div class="plan-divider"></div>
        <div class="plan-features">
          <div class="pf"><span>âœ…</span>Everything in Pro</div>
          <div class="pf"><span>ðŸ«</span>Admin dashboard & controls</div>
          <div class="pf"><span>ðŸ‘‘</span>30GB shared team storage</div>
          <div class="pf"><span>ðŸ“‹</span>Assign tasks to members</div>
          <div class="pf"><span>ðŸ“ˆ</span>Team performance reports</div>
          <div class="pf"><span>ðŸ”’</span>Advanced privacy controls</div>
          <div class="pf"><span>ðŸ“ž</span>Priority support</div>
          <div class="pf"><span>ðŸ”—</span>LMS integrations</div>
          <div class="pf"><span>ðŸŽ“</span>Bulk invite students</div>
          <div class="pf"><span>ðŸ“Š</span>Grade & submission tracking</div>
        </div>
        <button class="plan-cta cta-team" id="teamCta" onclick="openPayModal('team')">Get Team ðŸ«</button>
      </div>
    </div>
    <!-- Payment methods row -->
    <div style="margin-top:28px;text-align:center;max-width:620px;width:100%;">
      <div style="font-size:0.72rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;">Accepted Payment Methods</div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <div style="background:rgba(255,255,255,0.7);border:1.5px solid rgba(200,180,240,0.3);border-radius:12px;padding:9px 16px;font-size:0.82rem;font-weight:800;color:var(--dark);">ðŸ’³ Credit / Debit Card</div>
        <div style="background:rgba(255,255,255,0.7);border:1.5px solid rgba(200,180,240,0.3);border-radius:12px;padding:9px 16px;font-size:0.82rem;font-weight:800;color:var(--dark);">ðŸ“± GCash</div>
        <div style="background:rgba(255,255,255,0.7);border:1.5px solid rgba(200,180,240,0.3);border-radius:12px;padding:9px 16px;font-size:0.82rem;font-weight:800;color:var(--dark);">ðŸ”µ Maya</div>
        <div style="background:rgba(255,255,255,0.7);border:1.5px solid rgba(200,180,240,0.3);border-radius:12px;padding:9px 16px;font-size:0.82rem;font-weight:800;color:var(--dark);">ðŸ¦ Bank Transfer</div>
      </div>
      <div style="margin-top:12px;font-size:0.78rem;color:var(--mid);font-weight:600;">ðŸ”’ Secure checkout Â· Cancel anytime Â· Philippine Peso (â‚±)</div>
    </div>
    <!-- FAQ -->
    <div class="panel-card" style="max-width:620px;width:100%;margin-top:6px;">
      <h3>Common Questions</h3>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div><div style="font-weight:800;font-size:0.88rem;color:var(--dark);">Can I cancel anytime?</div><div style="font-size:0.82rem;color:var(--mid);font-weight:600;margin-top:3px;">Yes! Cancel at any time. You keep your Pro features until the billing period ends.</div></div>
        <div style="height:1px;background:rgba(200,180,240,0.2);"></div>
        <div><div style="font-weight:800;font-size:0.88rem;color:var(--dark);">What happens to my Library files if I downgrade?</div><div style="font-size:0.82rem;color:var(--mid);font-weight:600;margin-top:3px;">Your files are kept safe for 60 days so you can download them.</div></div>
        <div style="height:1px;background:rgba(200,180,240,0.2);"></div>
        <div><div style="font-weight:800;font-size:0.88rem;color:var(--dark);">Is there a student discount?</div><div style="font-size:0.82rem;color:var(--mid);font-weight:600;margin-top:3px;">Yes! Students get 15% off. Email <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="67131506040c060903040b08040c27000a060e0b4904080a">[email&#160;protected]</a> with your school email.</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAYMENT MODAL ===== -->
<div class="pay-overlay hidden" id="payOverlay" onclick="if(event.target===this)closePayModal()">
  <div class="pay-modal">
    <div id="payFormSection">
      <div style="padding:24px 26px 0;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <span style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.18rem;color:var(--dark);">ðŸ’³ Checkout</span>
        <button onclick="closePayModal()" style="width:32px;height:32px;border-radius:50%;border:none;background:rgba(200,180,240,0.28);cursor:pointer;font-size:1rem;color:var(--mid);">âœ•</button>
      </div>
      <div style="padding:0 26px 26px;display:flex;flex-direction:column;gap:15px;">
        <!-- Summary -->
        <div style="background:linear-gradient(135deg,rgba(139,92,246,0.07),rgba(180,240,200,0.1));border:1.5px solid rgba(200,180,240,0.32);border-radius:16px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:11px;">
            <span id="paySummaryIcon" style="font-size:1.8rem;">âœ¨</span>
            <div><div id="paySummaryName" style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.95rem;color:var(--dark);">Pro Plan</div>
            <div id="paySummaryCycle" style="font-size:0.76rem;color:var(--mid);font-weight:600;margin-top:2px;">Monthly billing</div></div>
          </div>
          <div id="paySummaryPrice" style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.5rem;color:#8b5cf6;">â‚±149</div>
        </div>
        <!-- Billing -->
        <div>
          <div style="font-size:0.7rem;font-weight:900;color:var(--mid);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:7px;">Billing Cycle</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <button class="pay-cycle-btn active" id="cycleMonthly" onclick="selectCycle('monthly')">Monthly<span class="pay-cycle-save" id="payCycleMonthLabel">â‚±149/mo</span></button>
            <button class="pay-cycle-btn" id="cycleAnnual" onclick="selectCycle('annual')">Annual<span class="pay-cycle-save" id="payCycleAnnualLabel">â‚±119/mo Â· Save 20%</span></button>
          </div>
        </div>
        <!-- Payment method -->
        <div>
          <div style="font-size:0.7rem;font-weight:900;color:var(--mid);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:7px;">Payment Method</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
            <div class="pay-method active" onclick="selectPayMethod('card',this)"><span style="font-size:1.5rem;">ðŸ’³</span><span style="font-size:0.7rem;font-weight:800;">Card</span></div>
            <div class="pay-method" onclick="selectPayMethod('gcash',this)"><span style="font-size:1.5rem;">ðŸ“±</span><span style="font-size:0.7rem;font-weight:800;">GCash</span></div>
            <div class="pay-method" onclick="selectPayMethod('maya',this)"><span style="font-size:1.5rem;">ðŸ”µ</span><span style="font-size:0.7rem;font-weight:800;">Maya</span></div>
            <div class="pay-method" onclick="selectPayMethod('bank',this)"><span style="font-size:1.5rem;">ðŸ¦</span><span style="font-size:0.7rem;font-weight:800;">Bank</span></div>
          </div>
        </div>
        <!-- Fields -->
        <div id="payFieldsCard">
          <div style="font-size:0.7rem;font-weight:900;color:var(--mid);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:7px;">Card Details</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <input class="pay-field" placeholder="Cardholder Name" id="cardName"/>
            <input class="pay-field" placeholder="Card Number  â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢" maxlength="19" id="cardNum" oninput="formatCardNum(this)"/>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <input class="pay-field" placeholder="MM / YY" maxlength="7" id="cardExp" oninput="formatExpiry(this)"/>
              <input class="pay-field" placeholder="CVV" maxlength="4" type="password" id="cardCvv"/>
            </div>
          </div>
        </div>
        <div id="payFieldsGcash" style="display:none;background:rgba(0,180,100,0.06);border:1.5px dashed rgba(0,180,100,0.25);border-radius:13px;padding:14px 16px;font-size:0.83rem;color:var(--mid);font-weight:600;line-height:1.8;">
          <div style="text-align:center;font-size:2.5rem;margin-bottom:4px;">ðŸ“±</div>
          <b style="color:var(--dark);">Pay via GCash</b><br>GCash number: <b style="color:var(--dark);">0917-TRACK-CLK</b><br>Account name: <b style="color:var(--dark);">Track and Clock Inc.</b>
          <input class="pay-field" placeholder="Your GCash number (09xx-xxx-xxxx)" id="gcashNum" style="margin-top:10px;"/>
        </div>
        <div id="payFieldsMaya" style="display:none;background:rgba(0,100,220,0.06);border:1.5px dashed rgba(0,100,220,0.2);border-radius:13px;padding:14px 16px;font-size:0.83rem;color:var(--mid);font-weight:600;line-height:1.8;">
          <div style="text-align:center;font-size:2.5rem;margin-bottom:4px;">ðŸ”µ</div>
          <b style="color:var(--dark);">Pay via Maya</b><br>Maya number: <b style="color:var(--dark);">0915-TRACK-CLK</b><br>Account name: <b style="color:var(--dark);">Track and Clock Inc.</b>
          <input class="pay-field" placeholder="Your Maya number (09xx-xxx-xxxx)" id="mayaNum" style="margin-top:10px;"/>
        </div>
        <div id="payFieldsBank" style="display:none;background:rgba(139,92,246,0.05);border:1.5px dashed rgba(200,180,240,0.5);border-radius:13px;padding:14px 16px;font-size:0.83rem;color:var(--mid);font-weight:600;line-height:1.85;">
          <div style="text-align:center;font-size:2.5rem;margin-bottom:4px;">ðŸ¦</div>
          <b style="color:var(--dark);">BDO Bank Transfer</b><br>Account: <b style="color:var(--dark);">1234-5678-9012</b><br>Name: <b style="color:var(--dark);">Track and Clock Inc.</b><br>Ref: <b style="color:#8b5cf6;" id="bankRef">TC-0000</b>
          <input class="pay-field" placeholder="Transaction / Reference Number" id="bankTxn" style="margin-top:10px;"/>
        </div>
        <div style="text-align:center;font-size:0.74rem;color:var(--mid);font-weight:600;">ðŸ”’ Secured by 256-bit SSL Â· PCI DSS compliant</div>
        <button class="pay-submit" onclick="submitPayment()"><span id="paySubmitLabel">Complete Purchase â€” â‚±149</span></button>
      </div>
    </div>
    <!-- Success -->
    <div id="paySuccessSection" style="display:none;flex-direction:column;align-items:center;gap:14px;padding:40px 26px;text-align:center;">
      <div style="width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,#b8f0c8,#c9b3e8);display:flex;align-items:center;justify-content:center;font-size:2.8rem;animation:cardPop 0.5s cubic-bezier(.34,1.56,.64,1) both;box-shadow:0 10px 32px rgba(139,92,246,0.2);">ðŸŽ‰</div>
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.5rem;color:var(--dark);">You're now Pro! âœ¨</div>
      <div style="font-size:0.88rem;color:var(--mid);font-weight:600;line-height:1.7;max-width:320px;">All premium features are now unlocked. Welcome to Track & Clock Pro!</div>
      <div style="background:linear-gradient(135deg,rgba(200,180,240,0.18),rgba(180,240,200,0.14));border-radius:18px;padding:16px 18px;width:100%;text-align:left;border:1.5px solid rgba(200,180,240,0.28);">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.85rem;color:var(--dark);margin-bottom:10px;">ðŸŽ Your Pro Features</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);border-bottom:1px solid rgba(200,180,240,0.15);">ðŸ“š Library â€” 5GB storage</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);border-bottom:1px solid rgba(200,180,240,0.15);">ðŸ¤– AI study assistant</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);border-bottom:1px solid rgba(200,180,240,0.15);">ðŸ“Š Advanced analytics</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);border-bottom:1px solid rgba(200,180,240,0.15);">ðŸŽ¨ Exclusive Pro themes</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);">ðŸ‘¥ Unlimited groups</div>
      </div>
      <button onclick="closePayModal();closeFP('pricingPanel');" style="width:100%;padding:13px;border-radius:15px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:900;font-size:0.95rem;cursor:pointer;">Start Exploring Pro ðŸš€</button>
    </div>
  </div>
</div>

<!-- AVATAR MODAL (Enhanced Chibi with photo) -->
<div class="modal-overlay hidden" id="avatarModal" onclick="if(event.target===this)closeAvatarModal()">
  <div class="avatar-modal">
    <div class="modal-title">ðŸŽ¨ Build Your Chibi Avatar</div>
    <div class="avatar-builder">
      <!-- Left: canvas + photo + pose -->
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px;flex-shrink:0;">
        <div class="avatar-canvas" id="avatarCanvas">
          <div class="av-bg" id="avBg" style="background:radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0);"></div>
          <!-- Floor shadow -->
          <div style="position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:80px;height:10px;background:rgba(120,90,180,0.1);border-radius:50%;"></div>
          <svg class="av-char" viewBox="0 0 120 200" id="avSvg" style="filter:drop-shadow(0 6px 12px rgba(100,80,180,0.18));">
            <!-- Shoes -->
            <g id="avShoeGroup">
              <ellipse cx="38" cy="191" rx="17" ry="9" fill="#c9b3e8" id="avShoeL"/>
              <ellipse cx="78" cy="191" rx="17" ry="9" fill="#c9b3e8" id="avShoeR"/>
              <ellipse cx="36" cy="187" rx="14" ry="7" fill="#e0d0f8"/>
              <ellipse cx="80" cy="187" rx="14" ry="7" fill="#e0d0f8"/>
            </g>
            <!-- Legs -->
            <g id="avLegs">
              <rect x="37" y="152" width="20" height="40" rx="10" fill="#f5c9a0" id="avLegL"/>
              <rect x="63" y="152" width="20" height="40" rx="10" fill="#f5c9a0" id="avLegR"/>
            </g>
            <!-- Outfit/Bottom -->
            <g id="avBottom"><rect x="28" y="122" width="64" height="38" rx="14" fill="#7a6fa0" id="avBottomShape"/></g>
            <!-- Arms -->
            <ellipse cx="17" cy="112" rx="10" ry="24" fill="#f5c9a0" id="avArmL" transform="rotate(-18 17 112)"/>
            <ellipse cx="103" cy="112" rx="10" ry="24" fill="#f5c9a0" id="avArmR" transform="rotate(18 103 112)"/>
            <!-- Hands -->
            <circle cx="12" cy="130" r="8" fill="#f5c9a0"/>
            <circle cx="108" cy="130" r="8" fill="#f5c9a0"/>
            <!-- Body -->
            <g id="avShirt"><rect x="26" y="90" width="68" height="40" rx="16" fill="#c9b3e8" id="avShirtShape"/></g>
            <!-- Neck -->
            <rect x="50" y="76" width="20" height="18" rx="8" fill="#f5c9a0" id="avNeck"/>
            <!-- Ears -->
            <ellipse cx="20" cy="58" rx="9" ry="11" fill="#f5c9a0" id="avEarL"/>
            <ellipse cx="100" cy="58" rx="9" ry="11" fill="#f5c9a0" id="avEarR"/>
            <ellipse cx="20" cy="58" rx="6" ry="7.5" fill="#f0b090" opacity="0.45"/>
            <ellipse cx="100" cy="58" rx="6" ry="7.5" fill="#f0b090" opacity="0.45"/>
            <!-- Big chibi head -->
            <ellipse cx="60" cy="52" rx="40" ry="44" fill="#f5c9a0" id="avHead"/>
            <!-- Hair (on top of head) -->
            <g id="avHair">
              <ellipse cx="60" cy="18" rx="38" ry="28" fill="#5c3d2e"/>
              <ellipse cx="60" cy="13" rx="30" ry="16" fill="#5c3d2e"/>
              <rect x="20" y="18" width="16" height="44" rx="8" fill="#5c3d2e"/>
              <rect x="84" y="18" width="16" height="44" rx="8" fill="#5c3d2e"/>
              <circle cx="20" cy="16" r="15" fill="#5c3d2e"/>
              <circle cx="100" cy="16" r="15" fill="#5c3d2e"/>
            </g>
            <!-- Eyes (big sparkly chibi) -->
            <ellipse cx="44" cy="55" rx="11" ry="13" fill="white" id="avEyeWL"/>
            <ellipse cx="76" cy="55" rx="11" ry="13" fill="white" id="avEyeWR"/>
            <ellipse cx="45" cy="57" rx="8" ry="9.5" fill="#2d1f14" id="avIrisL"/>
            <ellipse cx="77" cy="57" rx="8" ry="9.5" fill="#2d1f14" id="avIrisR"/>
            <!-- Iris color overlay -->
            <ellipse cx="45" cy="57" rx="6" ry="7.5" fill="#5b8dee" id="avIrisColorL" opacity="0.7"/>
            <ellipse cx="77" cy="57" rx="6" ry="7.5" fill="#5b8dee" id="avIrisColorR" opacity="0.7"/>
            <!-- Eye shines -->
            <circle cx="50" cy="52" r="3.5" fill="white"/>
            <circle cx="82" cy="52" r="3.5" fill="white"/>
            <circle cx="41" cy="60" r="1.8" fill="white" opacity="0.75"/>
            <circle cx="73" cy="60" r="1.8" fill="white" opacity="0.75"/>
            <!-- Eyebrows -->
            <path d="M33 44 Q44 39 55 44" stroke="#5c3d2e" stroke-width="3" fill="none" stroke-linecap="round" id="avBrowL"/>
            <path d="M65 44 Q76 39 87 44" stroke="#5c3d2e" stroke-width="3" fill="none" stroke-linecap="round" id="avBrowR"/>
            <!-- Nose -->
            <ellipse cx="60" cy="67" rx="4" ry="3" fill="#e0a070" opacity="0.5"/>
            <!-- Mouth -->
            <path d="M50 76 Q60 85 70 76" stroke="#c07050" stroke-width="2.8" fill="none" stroke-linecap="round" id="avMouth"/>
            <!-- Blush -->
            <ellipse cx="30" cy="68" rx="11" ry="7" fill="#ff9eb5" opacity="0.35" id="avBlushL"/>
            <ellipse cx="90" cy="68" rx="11" ry="7" fill="#ff9eb5" opacity="0.35" id="avBlushR"/>
            <!-- Accessories -->
            <g id="avAccLayer"></g>
          </svg>
        </div>
        <!-- ðŸ”Š Speaker button -->
        <button id="avSpeakBtn" onclick="avatarSpeakGreeting()" title="Hear your avatar speak"
          style="margin-top:6px;width:56px;height:56px;border-radius:50%;border:none;
                 background:linear-gradient(135deg,#8b5cf6,#5eead4);
                 box-shadow:0 4px 16px rgba(139,92,246,0.4);
                 cursor:pointer;font-size:1.5rem;display:flex;align-items:center;
                 justify-content:center;transition:transform 0.15s,box-shadow 0.15s;
                 position:relative;"
          onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 22px rgba(139,92,246,0.55)'"
          onmouseout="this.style.transform='';this.style.boxShadow='0 4px 16px rgba(139,92,246,0.4)'">
          ðŸ”Š
          <!-- Ripple ring when speaking -->
          <span id="avSpeakRing" style="position:absolute;inset:-4px;border-radius:50%;
            border:3px solid rgba(139,92,246,0.5);opacity:0;pointer-events:none;"></span>
        </button>
        <!-- Background Photo upload -->
        <div class="photo-upload-zone" onclick="document.getElementById('avBgPhotoInput').click()" title="Set a custom background photo for your avatar">
          ðŸ–¼ï¸ Add Background Photo
          <input type="file" id="avBgPhotoInput" accept="image/*" onchange="loadAvatarBgPhoto(event)" style="display:none"/>
        </div>
        <div id="avBgPhotoPreview" style="display:none;margin-top:4px;width:100%;text-align:center;">
          <span style="font-size:0.68rem;color:var(--mid);font-weight:700;">Custom BG set âœ…</span>
          <button onclick="clearAvatarBgPhoto()" style="margin-left:6px;font-size:0.68rem;background:none;border:none;color:#ef4444;cursor:pointer;font-weight:800;">âœ• Remove</button>
        </div>
        <!-- Pose -->
        <div style="font-size:0.67rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:1px;margin-top:2px;">Pose</div>
        <div class="pose-selector">
          <button class="pose-btn active" onclick="setPose('stand',this)" title="Standing">ðŸ§</button>
          <button class="pose-btn" onclick="setPose('wave',this)" title="Waving">ðŸ‘‹</button>
          <button class="pose-btn" onclick="setPose('sit',this)" title="Sitting">ðŸª‘</button>
          <button class="pose-btn" onclick="setPose('peace',this)" title="Peace">âœŒï¸</button>
        </div>
      </div>
      <!-- Right: options -->
      <div class="avatar-options">
        <!-- STYLE TEMPLATES -->
        <div class="opt-group">
          <div class="opt-label">âœ¨ Style Template</div>
          <div class="style-chips" id="styleChipsRow">
            <button class="style-chip" onclick="applyStyle('coquette',this)">ðŸŽ€ Coquette</button>
            <button class="style-chip" onclick="applyStyle('y2k',this)">ðŸ’¿ Y2K</button>
            <button class="style-chip" onclick="applyStyle('emo',this)">ðŸ–¤ Emo</button>
            <button class="style-chip" onclick="applyStyle('cottagecore',this)">ðŸŒ¿ Cottagecore</button>
            <button class="style-chip" onclick="applyStyle('darkacademia',this)">ðŸ“– Dark Academia</button>
            <button class="style-chip" onclick="applyStyle('streetwear',this)">ðŸ§¢ Streetwear</button>
            <button class="style-chip" onclick="applyStyle('kawaii',this)">ðŸŒ¸ Kawaii</button>
            <button class="style-chip" onclick="applyStyle('baddie',this)">ðŸ’… Baddie</button>
            <button class="style-chip" onclick="applyStyle('boho',this)">ðŸ‚ Boho</button>
            <button class="style-chip" onclick="applyStyle('pastelgoth',this)">ðŸ•¸ï¸ Pastel Goth</button>
          </div>
          <!-- Pro-only styles -->
          <div style="margin-top:8px;display:flex;align-items:center;gap:6px;margin-bottom:4px;">
            <span style="font-size:0.68rem;font-weight:900;color:#8b5cf6;text-transform:uppercase;letter-spacing:1px;">ðŸ‘‘ Pro Exclusive</span>
          </div>
          <div class="style-chips" id="proStyleChipsRow">
            <button class="style-chip pro-chip" onclick="applyStyle('royalcore',this)">ðŸ‘‘ Royalcore</button>
            <button class="style-chip pro-chip" onclick="applyStyle('cyberpunk',this)">ðŸ¤– Cyberpunk</button>
            <button class="style-chip pro-chip" onclick="applyStyle('fairycore',this)">ðŸ§š Fairycore</button>
            <button class="style-chip pro-chip" onclick="applyStyle('angelcore',this)">ðŸ˜‡ Angelcore</button>
            <button class="style-chip pro-chip" onclick="applyStyle('darkfantasy',this)">ðŸ‰ Dark Fantasy</button>
            <button class="style-chip pro-chip" onclick="applyStyle('ethereal',this)">âœ¨ Ethereal</button>
            <button class="style-chip pro-chip" onclick="applyStyle('vaporwave',this)">ðŸŒŠ Vaporwave</button>
            <button class="style-chip pro-chip" onclick="applyStyle('witchcore',this)">ðŸ”® Witchcore</button>
          </div>
          <div class="style-preview-box" id="stylePreviewBox">
            <div class="style-preview-title" id="stylePreviewTitle"></div>
            <div id="stylePreviewDesc"></div>
          </div>
        </div>
        <div class="opt-group"><div class="opt-label">Skin Tone</div><div class="opt-row">
          <div class="color-swatch active" style="background:#f9e4d4;" onclick="setSkin('#f9e4d4',this)"></div>
          <div class="color-swatch" style="background:#f5c9a0;" onclick="setSkin('#f5c9a0',this)"></div>
          <div class="color-swatch" style="background:#e8a87c;" onclick="setSkin('#e8a87c',this)"></div>
          <div class="color-swatch" style="background:#c68642;" onclick="setSkin('#c68642',this)"></div>
          <div class="color-swatch" style="background:#8d5524;" onclick="setSkin('#8d5524',this)"></div>
          <div class="color-swatch" style="background:#5c3317;" onclick="setSkin('#5c3317',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Eye Color</div><div class="opt-row" id="eyeColorRow">
          <div class="color-swatch active" style="background:#5b8dee;" onclick="setEyeColor('#5b8dee',this)"></div>
          <div class="color-swatch" style="background:#4caf50;" onclick="setEyeColor('#4caf50',this)"></div>
          <div class="color-swatch" style="background:#a78bfa;" onclick="setEyeColor('#a78bfa',this)"></div>
          <div class="color-swatch" style="background:#f59e0b;" onclick="setEyeColor('#f59e0b',this)"></div>
          <div class="color-swatch" style="background:#ef4444;" onclick="setEyeColor('#ef4444',this)"></div>
          <div class="color-swatch" style="background:#2d1f14;" onclick="setEyeColor('#2d1f14',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Hair Style</div><div class="opt-row" id="hairStyleRow">
          <button class="opt-btn active" onclick="setHair('twin',this)">Twin Buns</button>
          <button class="opt-btn" onclick="setHair('short',this)">Short Bob</button>
          <button class="opt-btn" onclick="setHair('ponytail',this)">Ponytail</button>
          <button class="opt-btn" onclick="setHair('long',this)">Long Wavy</button>
          <button class="opt-btn" onclick="setHair('pixie',this)">Pixie</button>
          <button class="opt-btn" onclick="setHair('braids',this)">Braids</button>
          <button class="opt-btn" onclick="setHair('curly',this)">Curly</button>
          <button class="opt-btn" onclick="setHair('sidetail',this)">Side Tail</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Hair Color</div><div class="opt-row" id="hairColorRow">
          <div class="color-swatch active" style="background:#5c3d2e;" onclick="setHairColor('#5c3d2e',this)"></div>
          <div class="color-swatch" style="background:#1a1a2e;" onclick="setHairColor('#1a1a2e',this)"></div>
          <div class="color-swatch" style="background:#f5d060;" onclick="setHairColor('#f5d060',this)"></div>
          <div class="color-swatch" style="background:#e87878;" onclick="setHairColor('#e87878',this)"></div>
          <div class="color-swatch" style="background:#c9b3e8;" onclick="setHairColor('#c9b3e8',this)"></div>
          <div class="color-swatch" style="background:#b8f0c8;" onclick="setHairColor('#b8f0c8',this)"></div>
          <div class="color-swatch" style="background:#f97316;" onclick="setHairColor('#f97316',this)"></div>
          <div class="color-swatch" style="background:#e0e0e0;" onclick="setHairColor('#e0e0e0',this)"></div>
          <div class="color-swatch" style="background:#f9a8d4;" onclick="setHairColor('#f9a8d4',this)"></div>
          <div class="color-swatch" style="background:#67e8f9;" onclick="setHairColor('#67e8f9',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Top / Dress</div><div class="opt-row" id="shirtStyleRow">
          <button class="opt-btn active" onclick="setShirt('tshirt',this)">T-Shirt</button>
          <button class="opt-btn" onclick="setShirt('hoodie',this)">Hoodie</button>
          <button class="opt-btn" onclick="setShirt('uniform',this)">Uniform</button>
          <button class="opt-btn" onclick="setShirt('dress',this)">Dress</button>
          <button class="opt-btn" onclick="setShirt('sundress',this)">Sundress</button>
          <button class="opt-btn" onclick="setShirt('kitty',this)">ðŸ± Kitty</button>
          <button class="opt-btn" onclick="setShirt('bear',this)">ðŸ» Bear</button>
          <button class="opt-btn" onclick="setShirt('stripes',this)">Stripes</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Top Color</div><div class="opt-row" id="shirtColorRow">
          <div class="color-swatch active" style="background:#c9b3e8;" onclick="setShirtColor('#c9b3e8',this)"></div>
          <div class="color-swatch" style="background:#b8f0c8;" onclick="setShirtColor('#b8f0c8',this)"></div>
          <div class="color-swatch" style="background:#f9a8d4;" onclick="setShirtColor('#f9a8d4',this)"></div>
          <div class="color-swatch" style="background:#fde68a;" onclick="setShirtColor('#fde68a',this)"></div>
          <div class="color-swatch" style="background:#7dd3fc;" onclick="setShirtColor('#7dd3fc',this)"></div>
          <div class="color-swatch" style="background:#1f2937;" onclick="setShirtColor('#1f2937',this)"></div>
          <div class="color-swatch" style="background:#ffffff;" onclick="setShirtColor('#ffffff',this)"></div>
          <div class="color-swatch" style="background:#dc2626;" onclick="setShirtColor('#dc2626',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Bottom</div><div class="opt-row" id="pantsRow">
          <button class="opt-btn active" onclick="setPants('pants',this)">Pants</button>
          <button class="opt-btn" onclick="setPants('jeans',this)">Jeans</button>
          <button class="opt-btn" onclick="setPants('skirt',this)">Skirt</button>
          <button class="opt-btn" onclick="setPants('miniskirt',this)">Mini Skirt</button>
          <button class="opt-btn" onclick="setPants('shorts',this)">Shorts</button>
          <button class="opt-btn" onclick="setPants('plaid',this)">Plaid</button>
          <button class="opt-btn" onclick="setPants('leggings',this)">Leggings</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Shoes</div><div class="opt-row" id="shoeRow">
          <button class="opt-btn active" onclick="setShoes('sneakers',this)">Sneakers</button>
          <button class="opt-btn" onclick="setShoes('heels',this)">Heels</button>
          <button class="opt-btn" onclick="setShoes('boots',this)">Boots</button>
          <button class="opt-btn" onclick="setShoes('loafers',this)">Loafers</button>
          <button class="opt-btn" onclick="setShoes('barefoot',this)">Barefoot</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Shoe Color</div><div class="opt-row" id="shoeColorRow">
          <div class="color-swatch active" style="background:#c9b3e8;" onclick="setShoeColor('#c9b3e8',this)"></div>
          <div class="color-swatch" style="background:#1f2937;" onclick="setShoeColor('#1f2937',this)"></div>
          <div class="color-swatch" style="background:#ef4444;" onclick="setShoeColor('#ef4444',this)"></div>
          <div class="color-swatch" style="background:#ffffff;" onclick="setShoeColor('#ffffff',this)"></div>
          <div class="color-swatch" style="background:#92400e;" onclick="setShoeColor('#92400e',this)"></div>
          <div class="color-swatch" style="background:#fde68a;" onclick="setShoeColor('#fde68a',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Accessory</div><div class="opt-row" id="accRow">
          <button class="opt-btn active" onclick="setAcc('none',this)">None</button>
          <button class="opt-btn" onclick="setAcc('bow',this)">ðŸŽ€ Bow</button>
          <button class="opt-btn" onclick="setAcc('crown',this)">ðŸ‘‘ Crown</button>
          <button class="opt-btn" onclick="setAcc('catears',this)">ðŸ± Cat Ears</button>
          <button class="opt-btn" onclick="setAcc('flower',this)">ðŸŒ¸ Flower</button>
          <button class="opt-btn" onclick="setAcc('headphones',this)">ðŸŽ§ Phones</button>
          <button class="opt-btn" onclick="setAcc('halo',this)">ðŸ˜‡ Halo</button>
          <button class="opt-btn" onclick="setAcc('glasses',this)">ðŸ‘“ Glasses</button>
          <button class="opt-btn" onclick="setAcc('wings',this)">ðŸ¦‹ Wings</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Background</div><div class="opt-row" id="bgColorRow">
          <div class="color-swatch active" style="background:#d8c4f0;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0)',this)"></div>
          <div class="color-swatch" style="background:#b8f0c8;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#d0f8e8,#c0f0ff)',this)"></div>
          <div class="color-swatch" style="background:#ffd6e0;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#ffe8f0,#ffd6c8)',this)"></div>
          <div class="color-swatch" style="background:#ffe8b0;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#fff8d0,#ffe0a0)',this)"></div>
          <div class="color-swatch" style="background:#b0d8ff;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#c8e8ff,#d0f0ff)',this)"></div>
          <div class="color-swatch" style="background:#2d2050;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#3a2a70,#1a1040)',this)"></div>
        </div></div>
        <!-- Avatar Voice (Pro) -->
        <div class="opt-group" id="avatarVoiceGroup">
          <div class="opt-label">ðŸŽ™ï¸ Avatar Voice <span style="background:linear-gradient(135deg,#8b5cf6,#c9b3e8);color:#fff;font-size:0.6rem;padding:2px 7px;border-radius:10px;font-weight:900;vertical-align:middle;">PRO</span></div>
          <div id="avatarVoiceGate" style="display:none;padding:10px;background:rgba(139,92,246,0.08);border-radius:10px;text-align:center;border:1.5px dashed rgba(139,92,246,0.3);">
            <div style="font-size:0.78rem;font-weight:700;color:var(--mid);">ðŸ”’ Upgrade to Pro to give your avatar a voice!</div>
            <button onclick="openFP('pricingPanel')" style="margin-top:6px;padding:5px 14px;border-radius:20px;border:none;background:linear-gradient(135deg,#8b5cf6,#c9b3e8);color:#fff;font-weight:800;font-size:0.75rem;cursor:pointer;">Upgrade âœ¨</button>
          </div>
          <div id="avatarVoiceControls" style="display:none;flex-direction:column;gap:8px;">
            <div style="font-size:0.75rem;font-weight:700;color:var(--mid);margin-bottom:2px;">Choose your avatar's voice:</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;" id="voicePickerRow"></div>
            <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
              <input class="task-input" id="avatarSpeakText" placeholder="Type something for your avatar to say..." style="font-size:0.8rem;padding:7px 10px;flex:1;"/>
              <button onclick="avatarSpeak()" style="padding:7px 14px;border-radius:10px;border:none;background:linear-gradient(135deg,#8b5cf6,#5eead4);color:#fff;font-weight:800;font-size:0.8rem;cursor:pointer;white-space:nowrap;">â–¶ Speak</button>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              <label style="font-size:0.75rem;font-weight:700;color:var(--mid);">Auto-greet on open</label>
              <input type="checkbox" id="avatarAutoGreet" style="accent-color:#8b5cf6;width:16px;height:16px;"/>
            </div>
          </div>
        </div>
        <div class="opt-group"><div class="opt-label">Display Name</div>
          <input class="task-input" id="avatarNameInput" value="Tracker" style="font-size:0.84rem;padding:8px 11px;width:100%;"/>
        </div>
      </div>
    </div>
    <button class="modal-close" onclick="saveAvatar()">âœ“ Save My Look</button>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal-overlay hidden" id="loginModal" onclick="if(event.target===this)closeLoginModal()">
  <div class="login-modal">
    <div style="font-size:2.4rem;text-align:center;margin-bottom:11px;">â±</div>
    <h2 id="loginModalTitle">Welcome Back!</h2>
    <p id="loginModalSub">Log in to continue your tracking journey</p>
    <button class="google-login-btn" onclick="signInWithGoogle()">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <div class="login-divider">or email</div>
    <input class="login-field" type="text" placeholder="Username or Email" id="loginUsername"/>
    <input class="login-field" type="password" placeholder="Password" id="loginPassword"/>
    <div id="loginRegExtra" style="display:none;"><input class="login-field" type="password" placeholder="Confirm Password"/></div>
    <button class="login-btn" onclick="handleLogin()" id="loginSubmitBtn">Log In</button>
    <div class="login-switch" id="loginSwitchText">Don't have an account? <span onclick="toggleLoginMode()">Sign up</span></div>
    <button onclick="closeLoginModal()" style="width:100%;margin-top:9px;padding:10px;border-radius:11px;border:1.5px solid rgba(200,180,240,0.3);background:transparent;cursor:pointer;font-family:'Quicksand',sans-serif;font-weight:700;color:#7a6fa0;font-size:0.88rem;">Cancel</button>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
let occFloatEls=[];
// ===== FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyDw6A77JECtzvl6dITNcLRtet5Ce3c8sTA",
  authDomain: "track-and-clock.firebaseapp.com",
  databaseURL: "https://track-and-clock-default-rtdb.firebaseio.com",
  projectId: "track-and-clock",
  storageBucket: "track-and-clock.firebasestorage.app",
  messagingSenderId: "308165362298",
  appId: "1:308165362298:web:52c0183c3fd2480f31f1c3",
  measurementId: "G-FG10CRHQN8"
};
let db=null,auth=null,storage=null,firebaseReady=false;
let currentUserId=null;

// Wait for dynamically-loaded Firebase SDK then init
function _initFirebase(){
  if(typeof firebase === 'undefined'){
    console.warn('[Firebase] SDK not yet available, retrying...');
    setTimeout(_initFirebase, 200);
    return;
  }
  try{
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    auth=firebase.auth();
    db=firebase.firestore();
    storage=firebase.storage();
    firebaseReady=true;
    console.log('[Firebase] Connected âœ…');
    // Sign in anonymously so every visitor passes Firestore security rules
    auth.signInAnonymously()
      .then(()=>console.log('[Firebase] Anonymous auth OK'))
      .catch(e=>console.warn('[Firebase] Anonymous auth failed:',e));
    // If startSync was queued before Firebase was ready, run it now
    if(currentUserId) startSync();
    // handleInviteLink is triggered by onUserSignedIn â€” don't call here (no currentUserId yet)
  }catch(e){
    console.warn('[Firebase] Init failed:',e);
    setTimeout(_initFirebase, 500);
  }
}
// Start trying as soon as this script runs; SDK loads in parallel
setTimeout(_initFirebase, 100);

// ===== FIRESTORE SYNC LAYER =====
function _fsPath(sub){ return 'users/'+currentUserId+'/'+sub; }
function fsDoc(p){ return db.doc(_fsPath(p)); }
function fsColl(p){ return db.collection(_fsPath(p)); }

function fsSet(path,data){
  if(!firebaseReady||!currentUserId)return;
  fsDoc(path).set(data,{merge:true}).catch(e=>console.warn('fsSet',e));
}
function fsGet(path){
  if(!firebaseReady||!currentUserId)return Promise.resolve(null);
  return fsDoc(path).get().then(s=>s.exists?s.data():null).catch(()=>null);
}
function fsSetIn(coll,id,data){
  if(!firebaseReady||!currentUserId)return;
  fsColl(coll).doc(id).set(data,{merge:true}).catch(e=>console.warn('fsSetIn',e));
}
function fsDelFrom(coll,id){
  if(!firebaseReady||!currentUserId)return;
  fsColl(coll).doc(id).delete().catch(e=>console.warn('fsDelFrom',e));
}

// â”€â”€ Shared group helpers (top-level collection, not under any user path) â”€â”€
function fsSharedGroupDoc(gid){ return db.collection('shared_groups').doc(gid); }
function fsSaveSharedGroup(gid){
  const g=groupsData[gid]; if(!g||!firebaseReady)return;
  const msgs=(g.messages||[]).slice(-200);
  fsSharedGroupDoc(gid).set({...g,messages:msgs,tasks:g.tasks||[],members:g.members||[],updatedAt:Date.now()},{merge:true})
    .catch(e=>console.warn('fsSaveSharedGroup',e));
  // Also record this group ID in the user's personal list so they reconnect after reload
  if(currentUserId){
    db.doc('users/'+currentUserId+'/meta/myGroups').get().then(s=>{
      const ids=s.exists?(s.data().ids||[]):[];
      if(!ids.includes(gid)){
        ids.push(gid);
        db.doc('users/'+currentUserId+'/meta/myGroups').set({ids},{merge:true}).catch(()=>{});
      }
    }).catch(()=>{});
  }
}
// Track per-group message listeners so we don't double-subscribe
const _msgUnsubs = {};

function listenToSharedGroups(groupIds){
  if(!firebaseReady||!groupIds||!groupIds.length)return;
  groupIds.forEach(gid=>{
    // â”€â”€ 1. Listen to the group document (members, tasks, meta) â”€â”€
    const unsub=db.collection('shared_groups').doc(gid).onSnapshot(snap=>{
      if(!snap.exists)return;
      const g=snap.data();
      if(!g||!g.id)return;
      // Preserve messages already loaded from sub-collection
      const existingMsgs = (groupsData[g.id]||{}).messages || [];
      groupsData[g.id]={...g, messages: existingMsgs.length ? existingMsgs : (g.messages||[])};
      const gp=document.getElementById('groupsPanel');
      if(gp&&!gp.classList.contains('hidden')){
        renderGroupTabs();
        if(currentGroup===g.id) renderGroupChat(g.id);
      }
    },e=>console.warn('sharedGroup listener',gid,e));
    _unsubs.push(unsub);

    // â”€â”€ 2. Listen to the msgs sub-collection (real-time messages) â”€â”€
    if (!_msgUnsubs[gid]) {
      const msgUnsub = db.collection('shared_groups').doc(gid)
        .collection('msgs')
        .orderBy('ts','asc')
        .onSnapshot(snap=>{
          if (!groupsData[gid]) groupsData[gid] = {id:gid, messages:[], members:[], tasks:[]};
          // Rebuild messages from sub-collection
          const subMsgs = [];
          snap.forEach(doc => subMsgs.push(doc.data()));
          // Merge with any legacy messages stored directly on the doc (no id field = old format)
          const legacyMsgs = (groupsData[gid].messages||[]).filter(m=>!m.id || !subMsgs.find(s=>s.id===m.id));
          // Combine and sort by ts
          const allMsgs = [...legacyMsgs, ...subMsgs].sort((a,b)=>(a.ts||0)-(b.ts||0));
          groupsData[gid].messages = allMsgs;

          // Always refresh sidebar preview
          const gp=document.getElementById('groupsPanel');
          const panelVisible = gp && !gp.classList.contains('hidden');
          if(panelVisible) {
            renderGroupTabs();
            if(currentGroup===gid) renderGroupChat(gid);
          }

          // Toast for new messages from others in any group
          if(subMsgs.length > 0){
            const newest = subMsgs[subMsgs.length-1];
            const isNew = newest && newest.ts && (Date.now() - newest.ts < 8000);
            const notMe = newest && newest.senderId !== currentUserId;
            if(isNew && notMe){
              if(currentGroup !== gid || !panelVisible){
                // Other group or panel closed â€” show toast notification
                showToastNotif('ðŸ’¬', newest.sender || groupsData[gid]?.name, newest.text.length > 60 ? newest.text.slice(0,60)+'â€¦' : newest.text);
              }
              // If this IS the active group but panel was hidden, refresh when they open it
              // (renderGroupChat is called in openFP/initGroupsPanel)
            }
          }
        }, e=>console.warn('msgs sub-collection listener',gid,e));
      _msgUnsubs[gid] = msgUnsub;
      _unsubs.push(msgUnsub);
    }
  });
}

let _unsubs=[];
function stopSync(){
  _unsubs.forEach(u=>{try{u();}catch(e){}});
  _unsubs=[];
  // Also clear per-group message listeners
  Object.keys(_msgUnsubs).forEach(gid=>{try{_msgUnsubs[gid]();}catch(e){}});
  Object.keys(_msgUnsubs).forEach(gid=>delete _msgUnsubs[gid]);
}

function startSync(){
  if(!firebaseReady||!currentUserId)return;
  stopSync();
  setSyncBadge('syncing');

  // â”€â”€ profile/plan â”€â”€
  fsGet('meta/profile').then(d=>{
    if(!d)return;
    if(d.name)onUserSignedIn(d.name,d.email||null,d.photo||null);
    if(d.plan&&d.plan!=='free'){userPlan=d.plan;applyPlanUI();} else { userPlan='pro'; applyPlanUI(); }
    if(d.occ){selectedOcc=d.occ;}
  });

  // â”€â”€ calendar tasks (real-time) â”€â”€
  _unsubs.push(fsColl('tasks').onSnapshot(snap=>{
    const rebuilt={};
    const ae=[];
    snap.forEach(doc=>{
      const t=doc.data();
      if(!t.dateKey)return;
      if(!rebuilt[t.dateKey])rebuilt[t.dateKey]=[];
      rebuilt[t.dateKey].push({id:t.id,text:t.text,done:!!t.done});
      ae.push({id:t.id,name:t.text,date:t.dateLabel||t.dateKey,dateKey:t.dateKey,
        status:t.done?'Submitted':'Pending',score:t.score||'â€”',icon:t.icon||'ðŸ“'});
    });
    calTasks=rebuilt; activityEntries=ae;
    if(selectedDate)renderCalTasks();
    renderCalendar(); renderTaskPanel(); renderActivityPanel();
    setSyncBadge('synced');
  },e=>{ console.warn('tasks listener:',e); setSyncBadge('offline'); }));

  // â”€â”€ group tasks (real-time) â”€â”€
  _unsubs.push(fsColl('groupTasks').onSnapshot(snap=>{
    groupTasksStore=[];
    snap.forEach(doc=>groupTasksStore.push(doc.data()));
    renderGroupTaskList();
    setSyncBadge('synced');
  },e=>console.warn('groupTasks listener:',e)));

  // â”€â”€ activity extras (real-time) â”€â”€
  _unsubs.push(fsColl('activityExtra').onSnapshot(snap=>{
    snap.forEach(doc=>{
      const e=doc.data();
      if(!activityEntries.find(a=>a.id===e.id)) activityEntries.push(e);
      else { const i=activityEntries.findIndex(a=>a.id===e.id); if(i>=0) activityEntries[i]={...activityEntries[i],...e}; }
    });
    renderActivityPanel();
  },e=>console.warn('activityExtra listener:',e)));

  // â”€â”€ groups (shared, real-time) â”€â”€
  // Load the user's group ID list from their personal doc, then listen to each
  db.doc('users/'+currentUserId+'/meta/myGroups').get().then(s=>{
    const ids = s.exists ? (s.data().ids||[]) : [];
    if(ids.length > 0) listenToSharedGroups(ids);
    else renderGroupTabs(); // show empty state
  }).catch(()=>{ renderGroupTabs(); });

  // â”€â”€ library metadata (real-time) â”€â”€
  _unsubs.push(fsColl('library').onSnapshot(snap=>{
    libFiles=[];
    snap.forEach(doc=>{
      const m=doc.data();
      libFiles.push({id:m.id,name:m.name,type:m.type,mime:m.mime,
        size:m.size,bytes:m.bytes||0,date:m.date,data:m.cloudUrl||'',cloudUrl:m.cloudUrl||''});
    });
    renderLib(); updateLibStorageBar();
  },e=>console.warn('library listener:',e)));
}

// â”€â”€ sync badge in top bar â”€â”€
function setSyncBadge(state){
  const dot=document.getElementById('syncDot');
  const lbl=document.getElementById('syncLabel');
  const wrap=document.getElementById('syncBadge');
  if(!wrap)return;
  const map={synced:['#5eead4','â˜ï¸ Synced'],syncing:['#fbbf24','â³ Syncing...'],offline:['#f87171','âš ï¸ Offline']};
  const [col,text]=map[state]||map.synced;
  if(dot)dot.style.background=col;
  if(lbl)lbl.textContent=text;
  wrap.style.opacity='1';
  if(state==='synced') setTimeout(()=>{if(wrap)wrap.style.opacity='0';},3000);
}

// â”€â”€ save helpers â”€â”€
function fsSaveTask(id,text,done,dateKey){
  if(!firebaseReady||!currentUserId)return;
  const[y,m,d]=dateKey.split('-');
  fsSetIn('tasks',id,{id,text,done:!!done,dateKey,dateLabel:'Due '+m+'/'+d+'/'+y,icon:'ðŸ“',score:'â€”',updatedAt:Date.now()});
}
function fsDelTask(id){ fsDelFrom('tasks',id); fsDelFrom('activityExtra',id); }
function fsSaveGroupTask(t){ fsSetIn('groupTasks',t.id,{...t,updatedAt:Date.now()}); }
function fsDelGroupTask(id){ fsDelFrom('groupTasks',id); }
function fsSaveExtra(e){ fsSetIn('activityExtra',e.id,{...e,updatedAt:Date.now()}); }
function fsDelExtra(id){ fsDelFrom('activityExtra',id); fsDelFrom('tasks',id); }
function fsSaveProfile(){
  if(!firebaseReady||!currentUserId)return;
  const name=document.getElementById('sidebarName')?.textContent||'Tracker';
  const email=document.getElementById('profileEmail')?.textContent||'';
  fsSet('meta/profile',{name,email,occ:selectedOcc||'Student',plan:userPlan,streak:currentStreak||0,updatedAt:Date.now()});
}
function fsSaveGroup(gid){
  fsSaveSharedGroup(gid);
}

// ===== CAPTURE INVITE PARAM IMMEDIATELY ON LOAD =====
// Store it before anything else so it survives the intro/landing flow
const _inviteGroupId = new URLSearchParams(window.location.search).get('join') || null;
let _cachedInviteGroup = null; // populated by handleInviteLink for acceptGroupInvite to reuse

// Called after sign-in when an invite link (?join=GROUP_ID) is detected
function handleInviteLink() {
  if (!_inviteGroupId) return;

  // Retry until Firebase is ready and we have a userId
  if (!firebaseReady || !currentUserId) {
    setTimeout(handleInviteLink, 400);
    return;
  }

  // Also wait for anonymous auth to complete so Firestore rules pass
  const doFetch = () => {
    db.collection('shared_groups').doc(_inviteGroupId).get().then(snap => {
      if (!snap.exists) {
        showToast('âš ï¸ This invite link is no longer valid.', 3000);
        return;
      }
      const g = snap.data();
      _cachedInviteGroup = g;
      // Already a member? Just open the group
      const alreadyIn = (g.members||[]).some(m => m.uid === currentUserId);
      if (alreadyIn) {
        groupsData[g.id] = groupsData[g.id] || {...g, messages: g.messages||[]};
        listenToSharedGroups([g.id]);
        openFP('groupsPanel');
        setTimeout(() => { renderGroupTabs(); switchGroup(g.id, null); }, 400);
        showToast('You\'re already in ' + (g.emoji||'') + ' ' + g.name + '!', 2500);
        return;
      }
      // Add as pending invite and show banner â€” let addGroupInvite handle everything
      // (it manages pendingInvites, badge, toast, and the floating banner)
      addGroupInvite(g.id, g.name, g.emoji||'ðŸ’¬', g.inviterName || 'Someone');
    }).catch(e => {
      console.warn('[handleInviteLink]', e);
      // If it's a permissions error, anonymous auth may not have finished â€” retry once
      if (e.code === 'permission-denied' || e.message?.includes('permission')) {
        setTimeout(doFetch, 1200);
      } else {
        showToast('âš ï¸ Could not load invite. Check your connection.', 3000);
      }
    });
  };

  // Give anonymous auth a moment to complete before first fetch
  if (auth && auth.currentUser) {
    doFetch();
  } else if (auth) {
    const unsubscribe = auth.onAuthStateChanged(user => {
      unsubscribe();
      doFetch();
    });
  } else {
    // auth not ready yet â€” shouldn't reach here due to firebaseReady check above, but just in case
    setTimeout(handleInviteLink, 400);
  }
}

const GOOGLE_CLIENT_ID = '731869460805-5h6iernb17fnpi59151be85jaq3cubc1.apps.googleusercontent.com';
// Parse the JWT credential returned by Google
function parseJwt(token){
  try{
    const base64Url=token.split('.')[1];
    const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');
    const json=decodeURIComponent(atob(base64).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(json);
  }catch(e){return null;}
}

// Called by GIS after the user picks a Google account
function handleGoogleCredential(response){
  document.getElementById('_gisOverlay').style.display = 'none';
  const payload = parseJwt(response.credential);
  if(!payload){showToast('âŒ Google sign-in failed. Please try again.',3500);return;}
  const name  = payload.name  || payload.given_name || 'Tracker';
  const email = payload.email || '';
  const photo = payload.picture || null;
  localStorage.setItem('tc_google_user', JSON.stringify({name, email, photo}));
  // Clear any stale cached session so it never overwrites this fresh login
  window._pendingGoogleUser = null;
  onUserSignedIn(name, email, photo);
  closeLoginModal();
  // Go to app if on landing
  const wasOnLanding = !document.getElementById('landing').classList.contains('hidden');
  if(wasOnLanding) goToApp();
  showToast('âœ… Signed in as ' + name + '!', 3000);
  // Trigger invite handling â€” function self-retries until Firebase + auth are ready
  if(_inviteGroupId){
    handleInviteLink();
  }
  // Fire login notification
  setTimeout(()=>addNotification('login','âœ…','Signed In with Google',`Welcome back, ${name}! (${email})`),1200);
}

// Initialise GIS and render button directly on the landing page
function initGIS(){
  if(!window.google || !window.google.accounts) return false;
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleGoogleCredential,
    auto_select: false,
    cancel_on_tap_outside: true
  });
  // Render the real Google button directly into the landing page container
  const container = document.getElementById('googleSignInBtn');
  if(container){
    google.accounts.id.renderButton(container, {
      type: 'standard',
      theme: 'outline',
      size: 'large',
      text: 'continue_with',
      width: 280,
      logo_alignment: 'left'
    });
  }
  return true;
}
// Run immediately (script is synchronous) and again on window load as safety net
let _gisInited = initGIS();
window.addEventListener('load', ()=>{ if(!_gisInited) _gisInited = initGIS(); });

// signInWithGoogle kept for other buttons (login modal etc)
function signInWithGoogle(){
  if(!_gisInited) _gisInited = initGIS();
  if(!window.google || !window.google.accounts){
    showToast('â³ Google Sign-In is still loading, please try again.',3000);
    return;
  }
  const container = document.getElementById('_gisButtonContainer');
  container.innerHTML = '';
  google.accounts.id.renderButton(container, {
    type: 'standard',
    theme: 'outline',
    size: 'large',
    text: 'signin_with',
    width: 280,
    logo_alignment: 'left'
  });
  document.getElementById('_gisOverlay').style.display = 'flex';
}

// Restore Google session on page reload
(function restoreGoogleSession(){
  const saved = localStorage.getItem('tc_google_user');
  if(!saved) return;
  try{
    const u = JSON.parse(saved);
    // If opened via invite link â€” force fresh sign-in so correct account is used
    if(_inviteGroupId) return;
    window._pendingGoogleUser = u;
    // Show intro first, then auto-enter app (skip landing screen)
    window._autoJumpToApp = true; // flag for goToLanding to skip landing
    function jumpToApp(){
      var intro   = document.getElementById('introScreen');
      var landing = document.getElementById('landing');
      var app     = document.getElementById('appLayout');
      if(!intro || !landing || !app){ setTimeout(jumpToApp, 50); return; }
      // Intro is already showing â€” let it play, but mark it to skip landing
      // goToLanding will check _autoJumpToApp and call goToApp() directly
    }
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', jumpToApp);
    } else {
      jumpToApp();
    }
  }catch(e){}
})();

function simulateGoogleLogin(){onUserSignedIn('Demo Tracker','tracker@gmail.com',null);closeLoginModal();if(!document.getElementById('landing').classList.contains('hidden'))goToApp();}
function onUserSignedIn(name,email,photoURL){
  const n=name||'Tracker';
  document.getElementById('sidebarName').textContent=n;
  document.getElementById('profileNameDisplay').textContent=n;
  document.getElementById('profileNameVal').textContent=n;
  document.getElementById('profileEmail').textContent=email||'â€”';
  document.getElementById('editNameInput').value=n;
  document.getElementById('avatarNameInput').value=n;
  document.getElementById('googleLinkedStatus').textContent=email||'Linked';
  // Always reset avatars to emoji first so stale photos from a previous user are cleared
  ['avatarBtnInner','sidebarAvatarInner','profileAvatarInner'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){
      // Could be an <img> (outerHTML-replaced) or a <span> â€” normalise back to <span>
      if(el.tagName==='IMG'){
        const span=document.createElement('span');
        span.id=id;
        span.textContent='ðŸ£';
        el.parentNode.replaceChild(span,el);
      } else {
        el.textContent='ðŸ£';
      }
    }
  });
  if(photoURL){
    ['avatarBtnInner','sidebarAvatarInner','profileAvatarInner'].forEach(id=>{
      const el=document.getElementById(id);
      if(el)el.outerHTML=`<img src="${photoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" id="${id}">`;
    });
  }
  // Set userId â€” always prefer email so same Gmail = same data on any device
  if(firebaseReady && (email||name)){
    currentUserId = email
      ? email.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase()
      : name.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase();
    startSync();
  } else if(email||name) {
    // Firebase not ready yet â€” set userId and wait for Firebase
    currentUserId = email
      ? email.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase()
      : name.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase();
    const waitForFirebase = () => {
      if(firebaseReady){ startSync(); } else { setTimeout(waitForFirebase, 300); }
    };
    waitForFirebase();
  }
  // NOTE: handleInviteLink is NOT called here.
  // It is triggered once by handleGoogleCredential after goToApp() makes the appLayout visible.
  // Start listening for Firestore-delivered invites sent to this email
  if (email && email !== 'â€”') {
    setTimeout(() => listenForIncomingInvites(email), 1500);
  }
}

// Apply a restored Google session once the app is visible
function applyPendingGoogleUser(){
  // Only restore cached session if no fresh login has already set a currentUserId
  if(window._pendingGoogleUser && !currentUserId){
    const u=window._pendingGoogleUser;
    delete window._pendingGoogleUser;
    onUserSignedIn(u.name,u.email,u.photo);
  }
  window._pendingGoogleUser = null;
}

// ===== AUDIO CONTEXT =====
let audioCtx=null;
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}

// ===== VOICE INTRO (expressive, human-like) =====
function speakIntro(){
  if(!window.speechSynthesis)return;
  const loadVoicesAndSpeak=()=>{
    const voices=speechSynthesis.getVoices();
    // Warmly excited female voice phrases
    const phrases=[
      {text:"Oh my goodness â€” welcome!",rate:1.05,pitch:1.35,volume:1},
      {text:"You've arrived at Track and Clock.",rate:0.9,pitch:1.2,volume:0.95},
      {text:"Your ultimate hub for staying on time, on task, and totally in control.",rate:0.92,pitch:1.15,volume:0.9},
      {text:"Let's make today amazing!",rate:1.1,pitch:1.3,volume:1},
    ];
    const femaleVoice=voices.find(v=>
      /samantha|karen|victoria|zira|google us|ava|susan|fiona/i.test(v.name)
    )||voices.find(v=>v.lang==='en-US')||voices[0];
    let delay=1200;
    phrases.forEach((p,i)=>{
      setTimeout(()=>{
        if(!speechSynthesis.speaking||i===0){
          const u=new SpeechSynthesisUtterance(p.text);
          u.rate=p.rate;u.pitch=p.pitch;u.volume=p.volume;
          if(femaleVoice)u.voice=femaleVoice;
          speechSynthesis.speak(u);
        }
      },delay);
      delay+=p.text.length*75;
    });
  };
  if(speechSynthesis.getVoices().length===0)speechSynthesis.addEventListener('voiceschanged',loadVoicesAndSpeak,{once:true});
  else loadVoicesAndSpeak();
}

// ===== TICK SOUNDS =====
function playTickSounds(){
  try{
    const ctx=getAudioCtx();
    // Realistic clock tick: sharp transient attack, quick decay
    for(let i=0;i<12;i++){
      const buf=ctx.createBuffer(1,ctx.sampleRate*0.06,ctx.sampleRate);
      const data=buf.getChannelData(0);
      for(let s=0;s<data.length;s++){
        data[s]=(Math.random()*2-1)*Math.exp(-s/(ctx.sampleRate*0.008));
      }
      const src=ctx.createBufferSource();
      const g=ctx.createGain();
      const filter=ctx.createBiquadFilter();
      filter.type='bandpass';filter.frequency.value=2200+(i%2)*800;filter.Q.value=2;
      src.buffer=buf;
      src.connect(filter);filter.connect(g);g.connect(ctx.destination);
      const t=ctx.currentTime+0.42+i*0.42;
      g.gain.setValueAtTime(i%2===0?0.28:0.18,t);
      src.start(t);
    }
    // Chime fanfare when brand appears
    const chordNotes=[523.25,659.25,783.99,1046.5];
    chordNotes.forEach((f,i)=>{
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(ctx.destination);
      o.type='sine';o.frequency.value=f;
      const t=ctx.currentTime+3.6+i*0.09;
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(0.18,t+0.08);
      g.gain.exponentialRampToValueAtTime(0.001,t+2.2);
      o.start(t);o.stop(t+2.3);
    });
  }catch(e){}
}

// ===== MUSIC PLAYER =====
let musicInterval=null,musicOn=false,musicVol=0.3,currentMood='calm';
const moodDefs={
  calm:{notes:[261.6,293.6,329.6,392,440,349.2],tempo:2.0,type:'sine',vol:0.055,label:'ðŸŒ¿ Calm â€” Gentle Rain'},
  focus:{notes:[220,246.9,261.6,293.6,329.6,311.1],tempo:1.3,type:'triangle',vol:0.048,label:'ðŸŽ¯ Focus â€” Lo-Fi Study'},
  energetic:{notes:[392,440,523.3,587.3,659.3,783.9],tempo:0.6,type:'sawtooth',vol:0.038,label:'âš¡ Energetic â€” Upbeat'},
  cozy:{notes:[261.6,311.1,349.2,392,415.3,440],tempo:2.4,type:'sine',vol:0.052,label:'ðŸ§¸ Cozy â€” Warm Tones'},
  nature:{notes:[196,220,246.9,261.6,293.6,220],tempo:2.8,type:'sine',vol:0.042,label:'ðŸŒ³ Nature â€” Forest Calm'},
  off:{notes:[],tempo:1,type:'sine',vol:0,label:'ðŸ”‡ Music Off'}
};
function startMusic(mood){
  stopMusic();
  const d=moodDefs[mood]||moodDefs.calm;
  document.getElementById('mpTrack').textContent=d.label;
  if(mood==='off'||!d.notes.length)return;
  try{
    const ctx=getAudioCtx();let ni=0;
    const play=()=>{
      if(!musicOn)return;
      const o=ctx.createOscillator(),g1=ctx.createGain(),g2=ctx.createGain();
      o.connect(g1);g1.connect(g2);g2.connect(ctx.destination);
      o.type=d.type;o.frequency.value=d.notes[ni%d.notes.length];ni++;
      g2.gain.value=d.vol*musicVol*3.5;
      const t=ctx.currentTime;
      g1.gain.setValueAtTime(0,t);g1.gain.linearRampToValueAtTime(1,t+0.18);
      g1.gain.linearRampToValueAtTime(0,t+d.tempo*0.88);
      o.start(t);o.stop(t+d.tempo);
    };
    play();musicInterval=setInterval(play,d.tempo*1000);
  }catch(e){}
}
function stopMusic(){if(musicInterval){clearInterval(musicInterval);musicInterval=null;}}
function toggleMusic(){
  musicOn=!musicOn;
  document.getElementById('mpPlayBtn').textContent=musicOn?'â¸':'â–¶';
  if(musicOn)startMusic(currentMood);else stopMusic();
}
function setMoodChip(mood,btn){
  currentMood=mood;
  document.querySelectorAll('.mp-mood-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  if(musicOn)startMusic(mood);else document.getElementById('mpTrack').textContent=(moodDefs[mood]||moodDefs.calm).label;
  // Stop YouTube if switching to generated music
  if(mood!=='off'){const a=document.getElementById('musicAudio');if(a){a.pause();a.src='';}document.getElementById('mpNowPlaying').classList.add('hidden');}
}
function setVolume(v){musicVol=parseFloat(v);if(musicOn){stopMusic();startMusic(currentMood);}const a=document.getElementById('musicAudio');if(a&&a.src)a.volume=musicVol;}
function toggleMiniPlayer(){
  const p=document.getElementById('musicPlayer');
  if(!p) return;
  if(p.dataset.mpOpen==='1'){
    p.dataset.mpOpen='0';
    p.style.setProperty('display','none','important');
  } else {
    p.dataset.mpOpen='1';
    p.style.removeProperty('display');
    p.style.setProperty('display','block','important');
    p.classList.remove('mini');
    const f=document.getElementById('mpFull');
    if(f){ f.style.removeProperty('display'); f.style.display='flex'; }
  }
}

// ===== YOUTUBE SONG SEARCH =====
// ===== JAMENDO MUSIC API =====
// ===== iTunes Search API â€” finds ANY famous song, free, no key needed =====
let musicQueue=[],musicQueueIdx=0;

// iTunes Search â€” uses JSONP callback (works from local file:// with no CORS issues)
function iTunesFetch(term, limit=8){
  return new Promise((resolve)=>{
    const cbName='itcb_'+Date.now()+'_'+Math.floor(Math.random()*9999);
    const script=document.createElement('script');
    let done=false;
    window[cbName]=function(data){
      done=true;
      delete window[cbName];
      script.remove();
      resolve(data.results||[]);
    };
    // iTunes supports JSONP via the callback param
    script.src='https://itunes.apple.com/search?term='+encodeURIComponent(term)
      +'&media=music&limit='+limit+'&entity=song&callback='+cbName;
    script.onerror=function(){
      if(!done){done=true;delete window[cbName];script.remove();resolve([]);}
    };
    // Timeout after 8s
    setTimeout(function(){
      if(!done){done=true;delete window[cbName];script.remove();resolve([]);}
    },8000);
    document.head.appendChild(script);
  });
}

async function searchMusic(){
  const q=document.getElementById('mpSearchInput').value.trim();
  if(!q)return;
  document.getElementById('mpResults').innerHTML='<div style="padding:8px;font-size:0.75rem;color:var(--mid);font-weight:600;">ðŸ” Searchingâ€¦</div>';
  const results=await iTunesFetch(q);
  if(results.length){
    musicQueue=results;renderMusicResults(results);
  }else{
    document.getElementById('mpResults').innerHTML='<div style="padding:8px;font-size:0.75rem;color:var(--mid);font-weight:600;">No results. Check your connection and try again! ðŸŽµ</div>';
  }
}

async function searchGenre(genre,btn){
  document.querySelectorAll('.mp-genre-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('mpResults').innerHTML='<div style="padding:8px;font-size:0.75rem;color:var(--mid);font-weight:600;">ðŸŽµ Loading '+genre+' hitsâ€¦</div>';
  // Search top songs for each genre using representative artists/terms
  const genreTerms={
    'pop':'top pop hits 2024','k-pop':'BTS blackpink kpop','r&b':'r&b soul 2024',
    'hip-hop':'hip hop rap 2024','lofi':'lofi chill beats study','classical':'classical piano orchestra'
  };
  const results=await iTunesFetch(genreTerms[genre]||genre, 10);
  if(results.length){
    musicQueue=results;renderMusicResults(results);
  }else{
    document.getElementById('mpResults').innerHTML='<div style="padding:8px;font-size:0.75rem;color:var(--mid);">Could not load. Check your internet connection.</div>';
  }
}

function renderMusicResults(tracks){
  const el=document.getElementById('mpResults');
  el.innerHTML='';
  tracks.forEach((t,i)=>{
    const item=document.createElement('div');item.className='mp-result-item';
    const art=t.artworkUrl60||'';
    const thumb=art
      ? `<img class="mp-result-thumb" src="${art.replace('60x60','100x100')}" onerror="this.style.background='var(--lilac)'">`
      : `<div class="mp-result-thumb" style="display:flex;align-items:center;justify-content:center;background:var(--lilac);font-size:1.1rem;">ðŸŽµ</div>`;
    const dur=t.trackTimeMillis?Math.floor(t.trackTimeMillis/1000):0;
    const durStr=dur?Math.floor(dur/60)+':'+(dur%60<10?'0':'')+dur%60:'';
    item.innerHTML=`${thumb}<div class="mp-result-info"><div class="mp-result-title">${t.trackName||'Unknown'}</div><div class="mp-result-channel">${t.artistName||''} Â· ${t.collectionName||''}</div></div><div style="font-size:0.68rem;color:var(--mid);font-weight:700;flex-shrink:0;">${durStr}<br/>â–¶ 30s</div>`;
    item.onclick=()=>{musicQueueIdx=i;playTrack(t);};
    el.appendChild(item);
  });
}

function playTrack(track){
  stopMusic();musicOn=false;
  document.getElementById('mpPlayBtn').textContent='â–¶';
  const preview=track.previewUrl;
  if(!preview){showToast('No preview available for this track.',2200);return;}
  const audio=document.getElementById('musicAudio');
  audio.src=preview;audio.volume=musicVol;
  audio.play().catch(()=>showToast('Tap again to play â€” browser needs a click first.',2500));
  // Now playing bar
  const title=track.trackName||'Unknown';
  const artist=track.artistName||'';
  const art=track.artworkUrl100||(track.artworkUrl60||'').replace('60x60','100x100');
  document.getElementById('mpNpTitle').textContent=title;
  document.getElementById('mpNpArtist').textContent=artist;
  const artEl=document.getElementById('mpNpArt');
  if(art){artEl.src=art;artEl.style.display='block';}else{artEl.style.display='none';}
  document.getElementById('mpNowPlaying').classList.remove('hidden');
  document.getElementById('mpTrack').textContent=(title+' â€” '+artist).slice(0,36)+'â€¦';
  document.getElementById('mpResults').innerHTML='';
  document.getElementById('mpSearchInput').value='';
  showToast('ðŸŽµ '+title+' â€” '+artist,2200);
}

function stopMusic2(){
  const audio=document.getElementById('musicAudio');
  if(audio){audio.pause();audio.src='';}
  document.getElementById('mpNowPlaying').classList.add('hidden');
  document.getElementById('mpTrack').textContent='Search a song or artist ðŸŽµ';
}

function onTrackEnded(){
  if(musicQueue.length>1){
    musicQueueIdx=(musicQueueIdx+1)%musicQueue.length;
    playTrack(musicQueue[musicQueueIdx]);
  }else{
    document.getElementById('mpNowPlaying').classList.add('hidden');
    document.getElementById('mpTrack').textContent='Search a song or artist ðŸŽµ';
  }
}

// ===== INTRO â€” auto-redirect after animation =====================
function goToLanding(){
  var intro=document.getElementById('introScreen');
  var landing=document.getElementById('landing');
  if(!intro||!landing)return;
  if(intro.classList.contains('gone'))return;
  intro.classList.add('gone');
  var mp=document.getElementById('musicPlayer');
  var bell=document.getElementById('notifBellBtn');
  if(mp){mp.classList.remove('intro-hidden');}
  if(bell){bell.classList.remove('intro-hidden'); bell.style.opacity='1'; bell.style.visibility='visible'; bell.style.pointerEvents='auto';}
  // If user is already signed in, skip landing and go straight to app
  if(window._autoJumpToApp){
    window._autoJumpToApp = false;
    landing.classList.add('hidden');
    landing.style.display = 'none';
    goToApp();
    return;
  }
  landing.classList.remove('hidden');
  // If invite link â€” show a notice so User 2 knows to sign in with THEIR account
  if(_inviteGroupId){
    var existing = document.getElementById('inviteNotice');
    if(!existing){
      var notice = document.createElement('div');
      notice.id = 'inviteNotice';
      notice.style.cssText = 'background:linear-gradient(135deg,rgba(167,139,250,0.22),rgba(94,234,212,0.15));border:2px solid #c9b3e8;border-radius:18px;padding:16px 20px;margin:12px 0;font-size:0.9rem;font-weight:700;color:#6d3fa0;text-align:center;animation:fadeUp 0.5s ease both;box-shadow:0 4px 18px rgba(139,92,246,0.15);';
      notice.innerHTML = '<div style="font-size:1.5rem;margin-bottom:6px;">ðŸ”—</div>'
        + '<div style="font-family:\'Nunito\',sans-serif;font-size:1rem;font-weight:900;color:#4a2d8a;margin-bottom:4px;">You\'ve been invited to a group!</div>'
        + '<div style="font-weight:600;font-size:0.82rem;color:#8b6faa;margin-bottom:12px;">Sign in with Google below, then your invite will appear automatically âœ¨</div>'
        + '<div style="font-size:0.75rem;color:#a090c0;font-weight:600;">Group invite link detected Â· ' + window.location.search + '</div>';
      var welcomeText = landing.querySelector('.welcome-text');
      if(welcomeText) welcomeText.after(notice);
      else landing.prepend(notice);
    }
  }
}
// Run intro logic as soon as DOM is ready â€” don't wait for full page load
(function initIntro(){
  function run(){
    var intro=document.getElementById('introScreen');
    if(!intro){ setTimeout(run,50); return; }
    // Hide music/bell during intro
    var mp=document.getElementById('musicPlayer');
    var bell=document.getElementById('notifBellBtn');
    if(mp)mp.classList.add('intro-hidden');
    // bell is inside top-bar (appLayout hidden during intro) â€” no need to hide separately
    // Tap/click anywhere to skip
    intro.addEventListener('click', goToLanding);
    intro.addEventListener('touchend', function(e){ e.preventDefault(); goToLanding(); });
    // Mobile: short delay; Desktop: longer
    var delay = window.innerWidth <= 768 ? 3500 : 7000;
    setTimeout(goToLanding, delay);
    // Shorten "tap to skip" on mobile
    if(window.innerWidth<=768){
      var skip=document.getElementById('tapToSkip');
      if(skip) skip.style.animation='fadeUp 0.5s 1.8s ease both';
    }
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();

// ===== OCCUPATION =====
let selectedOcc='Student';
const occItems={
  Student:['ðŸ““','âœï¸','ðŸ“','ðŸŽ’','ðŸ“š','âœï¸','ðŸ“','ðŸ–Šï¸'],
  Teacher:['ðŸ«','ðŸ“‹','ðŸ“','ðŸ–Šï¸','ðŸ”­','ðŸ“Œ','ðŸŽ“','ðŸ“–'],
  'Office Worker':['ðŸ’¼','â˜•','ðŸ’»','ðŸ“Š','ðŸ“Ž','ðŸ–¥ï¸','ðŸ“','âŒ¨ï¸'],
  Organizer:['ðŸ“‹','ðŸ—‚ï¸','ðŸ“Œ','ðŸ—“ï¸','âœ…','ðŸ—ƒï¸','ðŸ“Š','ðŸ–Šï¸'],
  Freelancer:['ðŸ’»','ðŸŽ§','â˜•','ðŸ“±','ðŸ’¡','ðŸ–¥ï¸','âš¡','ðŸŒ'],
  Creator:['ðŸŽ¨','âœï¸','ðŸŽ¬','ðŸŽ¤','ðŸ–Œï¸','ðŸ“·','ðŸŽ­','ðŸŒˆ'],
  Healthcare:['ðŸ¥','ðŸ’Š','ðŸ©º','â¤ï¸','ðŸ’‰','ðŸ§¬','ðŸŒ¡ï¸','ðŸ©¹'],
  Other:['âœ¨','ðŸ’«','ðŸŒŸ','â­','ðŸŽ¯','ðŸ”‘','ðŸŒˆ','ðŸ’Ž'],
};

function pickOcc(occ,btn){
  selectedOcc=occ;
  document.querySelectorAll('.occ-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  spawnOccItems(occ,btn);
}
function spawnOccItems(occ,btn){
  occFloatEls.forEach(function(el){el.remove();});occFloatEls=[];
  // Skip floating elements entirely on mobile â€” too heavy
  if(window.innerWidth<=768) return;
  var container=document.getElementById('occFloatWrap');
  var icons=occItems[occ]||occItems.Other;
  var W=window.innerWidth, H=window.innerHeight;
  // Edge-only safe zones: 16 zones around the perimeter, away from center content
  var zones=[
    {x:[0.01,0.14],y:[0.03,0.20]},{x:[0.01,0.14],y:[0.22,0.42]},
    {x:[0.01,0.14],y:[0.55,0.75]},{x:[0.01,0.14],y:[0.78,0.95]},
    {x:[0.85,0.98],y:[0.03,0.20]},{x:[0.85,0.98],y:[0.22,0.42]},
    {x:[0.85,0.98],y:[0.55,0.75]},{x:[0.85,0.98],y:[0.78,0.95]},
    {x:[0.18,0.38],y:[0.02,0.12]},{x:[0.42,0.58],y:[0.02,0.12]},
    {x:[0.62,0.82],y:[0.02,0.12]},{x:[0.18,0.38],y:[0.88,0.97]},
    {x:[0.42,0.58],y:[0.88,0.97]},{x:[0.62,0.82],y:[0.88,0.97]},
    {x:[0.02,0.18],y:[0.44,0.54]},{x:[0.82,0.98],y:[0.44,0.54]}
  ];
  // Shuffle zones
  for(var i=zones.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=zones[i];zones[i]=zones[j];zones[j]=tmp;}
  // 2 copies per icon placed in separate zones
  icons.forEach(function(icon,ii){
    for(var copy=0;copy<2;copy++){
      var zone=zones[(ii*2+copy)%zones.length];
      var px=(zone.x[0]+Math.random()*(zone.x[1]-zone.x[0]))*W;
      var py=(zone.y[0]+Math.random()*(zone.y[1]-zone.y[0]))*H;
      var size=(1.8+Math.random()*1.2);
      var delay=(ii*2+copy)*0.08;
      var el=document.createElement('div');
      el.textContent=icon;
      el.style.cssText='position:absolute;left:'+px+'px;top:'+py+'px;font-size:'+size+'rem;opacity:0;pointer-events:none;z-index:1;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.10));';
      container.appendChild(el);
      occFloatEls.push(el);
      // Animate in then bobble
      (function(elem, d){
        setTimeout(function(){
          elem.style.transition='opacity 0.4s, transform 0.5s';
          elem.style.opacity='0.65';
          elem.style.transform='translateY(-8px) scale(1.05)';
          setTimeout(function(){
            elem.style.transition='';
            elem.style.transform='';
            // Bobble via keyframe-like loop
            var up=true;
            setInterval(function(){
              elem.style.transition='transform '+(1.5+Math.random())+'s ease-in-out';
              elem.style.transform=up?'translateY(-'+(6+Math.random()*6)+'px) rotate('+(Math.random()*6-3)+'deg)':'translateY(0) rotate(0deg)';
              up=!up;
            },2000+Math.random()*1500);
          },500);
        }, d*1000);
      })(el, delay);
    }
  });
}

// ===== NAV =====
function goToApp(){
  // Hide landing completely
  const landing=document.getElementById('landing');
  landing.classList.add('hidden');
  landing.style.display='none';
  // Clear all floating items
  occFloatEls.forEach(el=>el.remove());occFloatEls=[];
  document.getElementById('occFloatWrap').innerHTML='';
  // Show app
  const app=document.getElementById('appLayout');
  app.classList.remove('hidden');
  app.style.display='flex';
  app.style.opacity='1';
  app.style.pointerEvents='all';
  // Update occupation displays
  document.getElementById('sidebarOcc').textContent=selectedOcc;
  document.getElementById('profileOccDisplay').textContent=selectedOcc+' Â· Active Member';
  document.getElementById('profileOccVal').textContent=selectedOcc;
  renderCalendar();
  initStreak();
  // Apply restored Google session FIRST (sets currentUserId)
  applyPendingGoogleUser();
  // handleInviteLink is triggered by handleGoogleCredential (600ms after sign-in + goToApp).
  // Don't call it here â€” currentUserId may not be set yet.
}
function closeFP(id){document.getElementById(id).classList.add('hidden');}
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  if(window.innerWidth<=768){
    const isOpen=sb.classList.toggle('mobile-open');
    if(ov){ov.classList.toggle('show',isOpen);}
  } else {
    sb.classList.toggle('sidebar-hidden');
  }
}
function closeSidebarMobile(){
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  sb.classList.remove('mobile-open');
  if(ov)ov.classList.remove('show');
}
function setActiveNav(el){document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}

// ===== UNIFIED TASK SYSTEM =====
let _taskSeq = 1;
function _tid() { return 't'+(++_taskSeq); }
const TASK_ICONS = ['ðŸ“','ðŸŽ¨','ðŸ“Š','ðŸ’»','ðŸ“š','ðŸ”¬','ðŸŽ¯','âœï¸','ðŸ“','ðŸ–¥ï¸','ðŸ“‹','ðŸ†'];
let activityEntries = []; // {id, name, date, dateKey, status, score, icon}
let groupTasksStore = []; // {id, name, status}
let _editingScoreId = null;
let _libActivated = false; // free trial activated?
let _libMaxBytes = 1024*1024*1024; // 1GB default (free trial)

// ===== CALENDAR =====
let calDate=new Date(),selectedDate=null,calTasks={};
function renderCalendar(){
  const y=calDate.getFullYear(),m=calDate.getMonth();
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthLabel').textContent=months[m]+' '+y;
  const today=new Date(),grid=document.getElementById('calGrid');
  grid.innerHTML='';
  ['S','M','T','W','T','F','S'].forEach(d=>{const el=document.createElement('div');el.className='cal-day-name';el.textContent=d;grid.appendChild(el);});
  const firstDay=new Date(y,m,1).getDay(),daysInMonth=new Date(y,m+1,0).getDate(),prevDays=new Date(y,m,0).getDate();
  for(let i=0;i<firstDay;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=prevDays-firstDay+1+i;grid.appendChild(d);}
  for(let day=1;day<=daysInMonth;day++){
    const d=document.createElement('div');d.className='cal-day';d.textContent=day;
    const key=`${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    if(today.getFullYear()===y&&today.getMonth()===m&&today.getDate()===day)d.classList.add('today');
    if(calTasks[key]&&calTasks[key].length)d.classList.add('has-task');
    if(selectedDate===key)d.classList.add('selected');
    d.onclick=()=>selectDate(key);
    grid.appendChild(d);
  }
  const rem=(firstDay+daysInMonth)%7===0?0:7-(firstDay+daysInMonth)%7;
  for(let i=1;i<=rem;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=i;grid.appendChild(d);}
}
function changeMonth(dir){calDate.setMonth(calDate.getMonth()+dir);renderCalendar();}
function selectDate(key){
  selectedDate=key;const[y,m,d]=key.split('-');
  document.getElementById('taskPanelTitle').textContent=`Tasks for ${m}/${d}/${y}`;
  document.getElementById('taskInputRow').style.display='flex';
  renderCalTasks();renderCalendar();
}
function renderCalTasks(){
  if(!selectedDate)return;
  const list=document.getElementById('calTaskList');list.innerHTML='';
  const tasks=calTasks[selectedDate]||[];
  if(!tasks.length){list.innerHTML='<div style="color:var(--text-mid-theme);font-size:0.88rem;padding:6px 0;font-weight:600;">No tasks yet â€” add one above! ðŸ“Œ</div>';return;}
  tasks.forEach((t,i)=>{
    const el=document.createElement('div');el.className='task-item';
    el.innerHTML=`<input type="checkbox" ${t.done?'checked':''} onchange="toggleCalTask(${i})"/><span class="${t.done?'done':''}">${t.text}</span><button class="del-btn" onclick="delCalTask(${i})">âœ•</button>`;
    list.appendChild(el);
  });
}
function addCalTask(){
  if(!selectedDate)return;
  const inp=document.getElementById('calTaskInput');
  const v=inp.value.trim();if(!v)return;
  const id=_tid();
  if(!calTasks[selectedDate])calTasks[selectedDate]=[];
  calTasks[selectedDate].push({id,text:v,done:false});
  inp.value='';
  // Sync â†’ activity
  const[y,m,d]=selectedDate.split('-');
  activityEntries.push({id,name:v,date:`Due ${m}/${d}/${y}`,dateKey:selectedDate,status:'Pending',score:'â€”',icon:TASK_ICONS[activityEntries.length%TASK_ICONS.length]});
  fsSaveTask(id,v,false,selectedDate);
  renderCalTasks();renderCalendar();
  _refreshTaskActivity();
  showToast('ðŸ“Œ Task added to Calendar, Tasks & Activity!',1800);
}
function toggleCalTask(i){
  const t=calTasks[selectedDate][i]; t.done=!t.done;
  const entry=activityEntries.find(e=>e.id===t.id);
  if(entry)entry.status=t.done?'Submitted':'Pending';
  fsSaveTask(t.id,t.text,t.done,selectedDate);
  renderCalTasks();_refreshTaskActivity();
}
function delCalTask(i){
  const t=calTasks[selectedDate][i];
  activityEntries=activityEntries.filter(e=>e.id!==t.id);
  fsDelTask(t.id);
  calTasks[selectedDate].splice(i,1);
  if(!calTasks[selectedDate].length)delete calTasks[selectedDate];
  renderCalTasks();renderCalendar();_refreshTaskActivity();
}
function _refreshTaskActivity(){renderTaskPanel();renderActivityPanel();}

// ===== TASK PANEL â€” synced view =====
function renderTaskPanel(){
  const list=document.getElementById('taskPanelList');if(!list)return;
  const filter=(document.getElementById('taskFilterStatus')||{}).value||'all';
  let all=[];
  Object.entries(calTasks).forEach(([key,tasks])=>tasks.forEach((t,i)=>all.push({...t,dateKey:key,calIdx:i})));
  if(filter==='pending')all=all.filter(t=>!t.done);
  if(filter==='done')all=all.filter(t=>t.done);
  all.sort((a,b)=>a.dateKey.localeCompare(b.dateKey));
  if(!all.length){list.innerHTML='<div style="color:var(--mid);font-size:0.88rem;font-weight:600;text-align:center;padding:18px 0;">No tasks found ðŸ“­</div>';return;}
  list.innerHTML='';
  all.forEach(t=>{
    const[y,mo,d]=t.dateKey.split('-');
    const el=document.createElement('div');el.className='task-item';el.style.flexWrap='wrap';el.style.gap='6px';
    el.innerHTML=`<input type="checkbox" ${t.done?'checked':''} onchange="toggleTaskPanel('${t.dateKey}',${t.calIdx})"/>
      <span style="flex:1;min-width:100px;" class="${t.done?'done':''}">${t.text}</span>
      <span style="font-size:0.72rem;color:var(--mid);font-weight:700;">${mo}/${d}/${y}</span>
      <span class="gtask-badge ${t.done?'done':'pending'}">${t.done?'Done':'Pending'}</span>
      <button class="del-btn" onclick="delTaskPanel('${t.dateKey}',${t.calIdx})">âœ•</button>`;
    list.appendChild(el);
  });
}
function toggleTaskPanel(dateKey,idx){
  if(!calTasks[dateKey]||!calTasks[dateKey][idx])return;
  const t=calTasks[dateKey][idx];t.done=!t.done;
  const entry=activityEntries.find(e=>e.id===t.id);
  if(entry)entry.status=t.done?'Submitted':'Pending';
  fsSaveTask(t.id,t.text,t.done,dateKey);
  if(dateKey===selectedDate)renderCalTasks();
  renderCalendar();_refreshTaskActivity();
}
function delTaskPanel(dateKey,idx){
  if(!calTasks[dateKey]||!calTasks[dateKey][idx])return;
  const t=calTasks[dateKey][idx];
  activityEntries=activityEntries.filter(e=>e.id!==t.id);
  fsDelTask(t.id);
  calTasks[dateKey].splice(idx,1);
  if(!calTasks[dateKey].length)delete calTasks[dateKey];
  if(dateKey===selectedDate)renderCalTasks();
  renderCalendar();_refreshTaskActivity();
}

// ===== GROUP TASKS â€” editable =====
function renderGroupTaskList(){
  const list=document.getElementById('groupTaskList');if(!list)return;
  if(!groupTasksStore.length){
    list.innerHTML='<div style="color:var(--mid);font-size:0.85rem;font-weight:600;padding:8px 0;">No tasks yet!</div>';return;
  }
  list.innerHTML='';
  groupTasksStore.forEach((t,i)=>{
    const el=document.createElement('div');el.className='gtask-item';el.style.gap='7px';
    el.innerHTML=`<span style="flex:1;font-weight:700;font-size:0.9rem;">${t.name}</span>
      <select onchange="editGroupTaskStatus(${i},this.value)" style="padding:4px 7px;border-radius:8px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);font-size:0.77rem;color:var(--dark);outline:none;font-family:'Quicksand',sans-serif;">
        <option value="pending" ${t.status==='pending'?'selected':''}>Pending</option>
        <option value="done" ${t.status==='done'?'selected':''}>Done</option>
        <option value="late" ${t.status==='late'?'selected':''}>Late</option>
      </select>
      <button onclick="delGroupTask(${i})" style="background:none;border:none;color:#d0a0c0;cursor:pointer;font-size:0.88rem;">âœ•</button>`;
    list.appendChild(el);
  });
}
function addGroupTask(){
  const inp=document.getElementById('gtaskInput');
  const statusEl=document.getElementById('gtaskStatus');
  const v=inp.value.trim();if(!v)return;
  const id=_tid();const status=statusEl?statusEl.value:'pending';
  const _newgt={id,name:v,status};
  groupTasksStore.push(_newgt);
  fsSaveGroupTask(_newgt);
  inp.value='';
  // Sync to activity
  activityEntries.push({id:_tid(),name:v+' (Group)',date:'Group Task',dateKey:null,status:status==='done'?'Submitted':'Pending',score:'â€”',icon:'ðŸ‘¥'});
  renderGroupTaskList();renderActivityPanel();
}
function editGroupTaskStatus(i,status){groupTasksStore[i].status=status;fsSaveGroupTask(groupTasksStore[i]);}
function delGroupTask(i){const _gt=groupTasksStore[i];fsDelGroupTask(_gt.id);groupTasksStore.splice(i,1);renderGroupTaskList();}

// ===== ACTIVITY PANEL =====
function renderActivityPanel(){
  const list=document.getElementById('activityList');if(!list)return;
  if(!activityEntries.length){list.innerHTML='<div style="color:var(--mid);font-size:0.88rem;font-weight:600;text-align:center;padding:22px 0;">No activity yet â€” add a calendar task or click "+ Add Entry" ðŸ“Š</div>';updateOverallScore();return;}
  const iconBgs=['#f0e8ff','#e0f8e8','#fff0e0','#e8f0ff','#fef3c7','#ffd6e0'];
  list.innerHTML='';
  activityEntries.forEach((entry,i)=>{
    const el=document.createElement('div');el.className='act-item';el.style.flexWrap='wrap';el.style.alignItems='flex-start';
    el.innerHTML=`<div class="act-icon" style="background:${iconBgs[i%iconBgs.length]};flex-shrink:0;">${entry.icon||'ðŸ“'}</div>
      <div class="act-info" style="flex:1;min-width:110px;">
        <div class="act-name">${entry.name} <button onclick="editActivityEntry('${entry.id}')" style="background:none;border:none;cursor:pointer;font-size:0.72rem;color:var(--mid);" title="Edit">âœï¸</button></div>
        <div class="act-date">${entry.date} Â· ${entry.status}</div>
      </div>
      <div style="display:flex;align-items:center;gap:5px;flex-shrink:0;">
        <div class="act-score">${entry.score}</div>
        <button onclick="delActivityEntry('${entry.id}')" style="background:none;border:none;cursor:pointer;font-size:0.82rem;color:#d0a0c0;" title="Delete">âœ•</button>
      </div>`;
    list.appendChild(el);
  });
  updateOverallScore();
}
function updateOverallScore(){
  const el=document.getElementById('overallScore');if(!el)return;
  if(document.getElementById('scorePrivate').checked){el.textContent='ðŸ”’';return;}
  const scored=activityEntries.filter(e=>e.score&&e.score!=='â€”');
  if(!scored.length){el.textContent='â€”';return;}
  let total=0,count=0;
  scored.forEach(e=>{const m=String(e.score).match(/(\d+)/);if(m){total+=parseInt(m[1]);count++;}});
  el.textContent=count?Math.round(total/count):'â€”';
}
function togglePrivate(){updateOverallScore();}
function openAddScoreModal(){
  _editingScoreId=null;
  document.getElementById('scoreModalTitle').textContent='âž• Add Activity Entry';
  document.getElementById('scoreTaskName').value='';
  document.getElementById('scoreTaskDate').value='';
  document.getElementById('scoreTaskStatus').value='Pending';
  document.getElementById('scoreTaskScore').value='';
  document.getElementById('addScoreModal').classList.remove('hidden');
}
function closeAddScoreModal(){document.getElementById('addScoreModal').classList.add('hidden');}
function editActivityEntry(id){
  const entry=activityEntries.find(e=>e.id===id);if(!entry)return;
  _editingScoreId=id;
  document.getElementById('scoreModalTitle').textContent='âœï¸ Edit Activity Entry';
  document.getElementById('scoreTaskName').value=entry.name;
  document.getElementById('scoreTaskDate').value=entry.dateKey||'';
  document.getElementById('scoreTaskStatus').value=entry.status||'Pending';
  document.getElementById('scoreTaskScore').value=entry.score==='â€”'?'':entry.score;
  document.getElementById('addScoreModal').classList.remove('hidden');
}
function delActivityEntry(id){
  const entry=activityEntries.find(e=>e.id===id);
  if(entry&&entry.dateKey&&calTasks[entry.dateKey]){
    calTasks[entry.dateKey]=calTasks[entry.dateKey].filter(t=>t.id!==id);
    if(!calTasks[entry.dateKey].length)delete calTasks[entry.dateKey];
    if(selectedDate===entry.dateKey)renderCalTasks();
    renderCalendar();renderTaskPanel();
  }
  fsDelExtra(id);
  activityEntries=activityEntries.filter(e=>e.id!==id);
  renderActivityPanel();
}
function saveScoreEntry(){
  const name=document.getElementById('scoreTaskName').value.trim();
  if(!name){showToast('âš ï¸ Please enter a task name.',2000);return;}
  const dateVal=document.getElementById('scoreTaskDate').value;
  const status=document.getElementById('scoreTaskStatus').value;
  const score=document.getElementById('scoreTaskScore').value.trim()||'â€”';
  if(_editingScoreId){
    const entry=activityEntries.find(e=>e.id===_editingScoreId);
    if(entry){
      entry.name=name;entry.status=status;entry.score=score;
      if(dateVal){const[y,m,d]=dateVal.split('-');entry.date=`Due ${m}/${d}/${y}`;entry.dateKey=dateVal;}
      // Sync to cal task if linked
      if(entry.dateKey&&calTasks[entry.dateKey]){
        const ct=calTasks[entry.dateKey].find(t=>t.id===_editingScoreId);
        if(ct){ct.text=name;ct.done=status==='Submitted';}
        if(selectedDate===entry.dateKey)renderCalTasks();
        renderCalendar();renderTaskPanel();
      }
    }
  } else {
    const id=_tid();
    let dateStr='Manual entry',dk=null;
    if(dateVal){const[y,m,d]=dateVal.split('-');dateStr=`Due ${m}/${d}/${y}`;dk=dateVal;}
    activityEntries.push({id,name,date:dateStr,dateKey:dk,status,score,icon:TASK_ICONS[activityEntries.length%TASK_ICONS.length]});
    if(dk){
      if(!calTasks[dk])calTasks[dk]=[];
      calTasks[dk].push({id,text:name,done:status==='Submitted'});
      if(selectedDate===dk)renderCalTasks();
      renderCalendar();renderTaskPanel();
    }
  }
  closeAddScoreModal();renderActivityPanel();
  if(_editingScoreId){const _e=activityEntries.find(x=>x.id===_editingScoreId);if(_e)fsSaveExtra(_e);}
  else if(activityEntries.length){fsSaveExtra(activityEntries[activityEntries.length-1]);}
  showToast('âœ… Entry saved!',1800);
}

// ===== LIBRARY GATE (free trial / pro) =====
function applyLibraryGate(){
  const gate=document.getElementById('libGate');
  const content=document.getElementById('libContent');
  if(!gate||!content)return;
  const proUnlocked=typeof userPlan!=='undefined'&&(userPlan==='pro'||userPlan==='team');
  if(_libActivated||proUnlocked){
    gate.style.display='none';content.style.display='block';
    _libMaxBytes=proUnlocked?5*1024*1024*1024:1024*1024*1024;
    const subEl=document.getElementById('libUploadSub');
    if(subEl)subEl.textContent=proUnlocked?'Images, Videos, Audio Â· 5GB Pro':'Images, Videos, Audio Â· 1GB Free Trial';
    updateLibStorageBar();
  } else {gate.style.display='flex';content.style.display='none';}
}
function activateLibrary(){
  _libActivated=true;
  showToast('ðŸŽ‰ Library unlocked! 1GB free storage ready.',2500);
  applyLibraryGate();renderLib();
}
function updateLibStorageBar(){
  const totalBytes=libFiles.reduce((s,f)=>s+(f.bytes||0),0);
  const pct=Math.min((totalBytes/_libMaxBytes)*100,100);
  const fill=document.getElementById('libStorageFill');
  const label=document.getElementById('libStorageLabel');
  if(fill)fill.style.width=pct+'%';
  if(label){
    const used=totalBytes<1024*1024?(totalBytes/1024).toFixed(0)+' KB':(totalBytes/(1024*1024)).toFixed(1)+' MB';
    const max=_libMaxBytes>2e9?'5 GB':'1 GB';
    label.textContent=`${used} / ${max}`;
  }
  if(fill)fill.style.background=pct>85?'linear-gradient(90deg,#f59e0b,#ef4444)':'linear-gradient(90deg,#8b5cf6,#5eead4)';
}

// ===== CHAT =====
function sendMsg(){const inp=document.getElementById('msgInput');const v=inp.value.trim();if(!v)return;const myName=document.getElementById('sidebarName')?.textContent||'You';const c=document.getElementById('chatArea');const el=document.createElement('div');el.className='msg me';el.innerHTML=`<div class="sender">${myName}</div>${v}`;c.appendChild(el);c.scrollTop=c.scrollHeight;inp.value='';}
// ===== GROUPS SYSTEM =====
// Group data store
let groupsData = {};

let currentGroup = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSENGER-STYLE GROUP CHAT â€” complete reimplementation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/* â”€â”€ helpers â”€â”€ */
function _timeAgo(ts) {
  if (!ts) return '';
  const diff = Date.now() - ts;
  if (diff < 60000) return 'now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h';
  return Math.floor(diff/86400000) + 'd';
}
function _fmtTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}
function _initials(name) {
  return (name||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
}
function autoResizeInput(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

/* â”€â”€ SIDEBAR: conversation list â”€â”€ */
function renderGroupTabs() {
  const list = document.getElementById('msngConvoList');
  if (!list) return;
  list.innerHTML = '';
  const groups = Object.values(groupsData);
  if (groups.length === 0) {
    list.innerHTML = '<div style="padding:20px 12px;text-align:center;color:var(--mid);font-size:0.82rem;font-weight:600;">No groups yet.<br>Create one below! ðŸŽ‰</div>';
    showMsngEmpty();
    return;
  }
  // Sort by last message time desc
  groups.sort((a,b) => {
    const at = (a.messages && a.messages.length) ? a.messages[a.messages.length-1].ts||0 : 0;
    const bt = (b.messages && b.messages.length) ? b.messages[b.messages.length-1].ts||0 : 0;
    return bt - at;
  });
  groups.forEach(g => {
    const lastMsg = (g.messages && g.messages.length) ? g.messages[g.messages.length-1] : null;
    const preview = lastMsg ? (lastMsg.system ? 'ðŸ“¢ ' + lastMsg.text.replace(/<[^>]+>/g,'') : lastMsg.text) : 'No messages yet';
    const div = document.createElement('div');
    div.className = 'msng-convo' + (g.id === currentGroup ? ' active' : '');
    div.setAttribute('data-gid', g.id);
    div.innerHTML = `
      <div class="msng-convo-avatar" style="background:${g.accentBg||'rgba(200,180,240,0.3)'};color:${g.accentColor||'#6d28d9'}">${g.emoji||'ðŸ’¬'}</div>
      <div class="msng-convo-info">
        <div class="msng-convo-name">${g.name}</div>
        <div class="msng-convo-preview">${preview.slice(0,45)}${preview.length>45?'...':''}</div>
      </div>
      <div class="msng-convo-time">${lastMsg ? _timeAgo(lastMsg.ts) : ''}</div>
    `;
    div.onclick = () => switchGroup(g.id, div);
    list.appendChild(div);
  });
  if (!currentGroup || !groupsData[currentGroup]) {
    currentGroup = groups[0].id;
    renderGroupChat(currentGroup);
  }
}

function filterConvos(q) {
  const items = document.querySelectorAll('#msngConvoList .msng-convo');
  items.forEach(el => {
    const name = el.querySelector('.msng-convo-name')?.textContent||'';
    el.style.display = name.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
  });
}

function showMsngEmpty() {
  document.getElementById('msngEmptyState').style.display = '';
  const ac = document.getElementById('msngActiveChat');
  ac.style.display = 'none';
}

/* â”€â”€ MAIN CHAT AREA â”€â”€ */
function renderGroupChat(gid) {
  const g = groupsData[gid];
  if (!g) { showMsngEmpty(); return; }

  // Show active chat, hide empty state
  document.getElementById('msngEmptyState').style.display = 'none';
  const ac = document.getElementById('msngActiveChat');
  ac.style.display = 'flex';

  // Header
  document.getElementById('msngHdrAvatar').textContent = g.emoji || 'ðŸ’¬';
  document.getElementById('msngHdrAvatar').style.background = g.accentBg || 'rgba(200,180,240,0.3)';
  document.getElementById('msngHdrName').textContent = g.name;
  const memberNames = (g.members||[]).map(m=>m.name).join(', ');
  document.getElementById('msngHdrMembers').textContent = (g.members||[]).length + ' members Â· ' + memberNames;

  // Messages
  const area = document.getElementById('groupChatArea');
  const wasAtBottom = area.scrollHeight - area.scrollTop - area.clientHeight < 80;
  area.innerHTML = '';

  const msgs = g.messages || [];
  let lastSenderId = null;
  let lastDate = null;

  msgs.forEach((msg, idx) => {
    // Day separator
    if (msg.ts) {
      const d = new Date(msg.ts);
      const dateStr = d.toLocaleDateString([], {weekday:'long', month:'short', day:'numeric'});
      if (dateStr !== lastDate) {
        const sep = document.createElement('div');
        sep.className = 'msng-day-label';
        sep.textContent = dateStr;
        area.appendChild(sep);
        lastDate = dateStr;
      }
    }

    // System message
    if (msg.system) {
      const el = document.createElement('div');
      el.className = 'msng-sys';
      el.innerHTML = msg.text;
      area.appendChild(el);
      lastSenderId = null;
      return;
    }

    const isMe = msg.senderId ? msg.senderId === currentUserId : !!msg.me;
    const groupClass = isMe ? 'me' : 'other';
    const showAvatar = !isMe && msg.senderId !== lastSenderId;
    const showSender = !isMe && (lastSenderId !== msg.senderId);
    lastSenderId = msg.senderId || msg.sender;

    const row = document.createElement('div');
    row.className = 'msng-msg-row ' + groupClass;

    if (!isMe) {
      const av = document.createElement('div');
      av.className = 'msng-msg-avatar' + (showAvatar ? '' : ' hidden-av');
      av.style.background = g.accentBg || 'rgba(200,180,240,0.3)';
      av.style.color = g.accentColor || '#6d28d9';
      av.textContent = _initials(msg.sender);
      row.appendChild(av);
    }

    const group = document.createElement('div');
    group.className = 'msng-msg-group ' + groupClass;
    if (showSender && !isMe) {
      const snd = document.createElement('div');
      snd.className = 'msng-msg-sender';
      snd.textContent = msg.sender;
      group.appendChild(snd);
    }
    const bubble = document.createElement('div');
    bubble.className = 'msng-bubble';
    bubble.innerHTML = msg.text + '<span class="msng-bubble-time">' + _fmtTime(msg.ts) + '</span>';
    group.appendChild(bubble);
    row.appendChild(group);
    area.appendChild(row);
  });

  if (wasAtBottom || msgs.length <= 5) {
    requestAnimationFrame(() => { area.scrollTop = area.scrollHeight; });
  }

  // Tasks drawer
  renderTasksDrawer(gid);
}

/* â”€â”€ TASKS DRAWER â”€â”€ */
let _tasksDrawerOpen = false;
function toggleTasksDrawer() {
  _tasksDrawerOpen = !_tasksDrawerOpen;
  const drawer = document.getElementById('msngTasksDrawer');
  drawer.classList.toggle('hidden-drawer', !_tasksDrawerOpen);
}

function renderTasksDrawer(gid) {
  const g = groupsData[gid]; if (!g) return;
  const body = document.getElementById('msngTasksBody');
  if (!body) return;
  body.innerHTML = '';
  if (!g.tasks || g.tasks.length === 0) {
    body.innerHTML = '<div style="color:var(--mid);font-size:0.8rem;font-weight:600;padding:8px 0;text-align:center;">No tasks yet! Add one below ðŸ“</div>';
    return;
  }
  g.tasks.forEach((t, ti) => {
    const row = document.createElement('div');
    row.className = 'msng-task-item';
    row.innerHTML = `
      <input type="checkbox" ${t.done?'checked':''} onchange="toggleGroupTask('${gid}',${ti},this.checked)"/>
      <div style="flex:1;min-width:0;">
        <div class="msng-task-text" style="${t.done?'text-decoration:line-through;opacity:0.5':''}">${t.name}</div>
        <div class="msng-task-meta">${t.meta||''}</div>
      </div>
      <button class="msng-task-del" onclick="delGroupChatTask('${gid}',${ti})">âœ•</button>
    `;
    body.appendChild(row);
  });
}

function toggleGroupTask(gid, idx, done) {
  const g = groupsData[gid]; if (!g) return;
  g.tasks[idx].done = done;
  fsSaveGroup(gid);
  renderTasksDrawer(gid);
}

function addGroupChatTask(gid) {
  const g = groupsData[gid]; if (!g) return;
  const inp = document.getElementById('msngAddTaskInp');
  const v = inp ? inp.value.trim() : ''; if (!v) return;
  const myName = document.getElementById('sidebarName')?.textContent || 'You';
  const today = new Date();
  g.tasks.push({id:'gct_'+Date.now(), name:v, done:false, meta:`${myName} Â· ${today.getDate()}/${today.getMonth()+1}/${String(today.getFullYear()).slice(-2)}`});
  if (inp) inp.value = '';
  fsSaveGroup(gid);
  const sysId = 'msg_task_' + Date.now();
  const sysMsg = {id:sysId, sender:'Track & Clock', system:true, text:`ðŸ“‹ <b>${myName}</b> added task: "${v}"`, ts:Date.now()};
  if (!g.messages) g.messages = [];
  g.messages.push(sysMsg);
  if (firebaseReady) db.collection('shared_groups').doc(gid).collection('msgs').doc(sysId).set(sysMsg).catch(()=>{});
  if (currentGroup === gid) { renderGroupChat(gid); renderTasksDrawer(gid); }
}

function delGroupChatTask(gid, idx) {
  const g = groupsData[gid]; if (!g) return;
  const task = g.tasks[idx];
  g.tasks.splice(idx, 1);
  fsSaveGroup(gid);
  const sysId = 'msg_deltask_' + Date.now();
  const sysMsg = {id:sysId, sender:'Track & Clock', system:true, text:`ðŸ—‘ï¸ Task "${task.name}" removed.`, ts:Date.now()};
  if (!g.messages) g.messages = [];
  g.messages.push(sysMsg);
  if (firebaseReady) db.collection('shared_groups').doc(gid).collection('msgs').doc(sysId).set(sysMsg).catch(()=>{});
  if (currentGroup === gid) { renderGroupChat(gid); renderTasksDrawer(gid); }
}

/* â”€â”€ SWITCH GROUP â”€â”€ */
function switchGroup(gid, el) {
  clearGroupTyping();
  currentGroup = gid;
  document.querySelectorAll('.msng-convo').forEach(c => c.classList.remove('active'));
  if (el) el.classList.add('active');
  else {
    const found = document.querySelector(`.msng-convo[data-gid="${gid}"]`);
    if (found) found.classList.add('active');
  }
  renderGroupChat(gid);
  listenToTypingIndicator(gid);
  // Focus input
  setTimeout(() => { const inp = document.getElementById('groupMsgInput'); if(inp) inp.focus(); }, 100);
}

/* â”€â”€ SEND MESSAGE â”€â”€ */
function sendGroupMsg() {
  const inp = document.getElementById('groupMsgInput');
  const v = inp.value.trim(); if (!v) return;
  const myName = document.getElementById('sidebarName')?.textContent || 'You';
  const g = groupsData[currentGroup];
  if (!g) { showToast('âš ï¸ Select a group first.', 2000); return; }
  inp.value = '';
  inp.style.height = 'auto';
  clearTimeout(_typingTimeout);
  clearGroupTyping();

  const msgId = 'msg_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
  const msg = {id: msgId, sender: myName, senderId: currentUserId, text: v, ts: Date.now()};

  // Optimistic update
  if (!g.messages) g.messages = [];
  g.messages.push(msg);
  renderGroupChat(currentGroup);
  renderGroupTabs(); // update preview in sidebar

  if (firebaseReady) {
    db.collection('shared_groups').doc(currentGroup)
      .collection('msgs').doc(msgId).set(msg)
      .catch(e => console.warn('sendGroupMsg:', e));
    db.collection('shared_groups').doc(currentGroup)
      .set({updatedAt: Date.now(), lastMsg: {sender: myName, text: v, ts: msg.ts}}, {merge: true})
      .catch(()=>{});
  }
}

/* â”€â”€ CREATE GROUP â”€â”€ */
function createGroup() {
  const inp = document.getElementById('newGroupInput');
  const v = inp.value.trim(); if (!v) return;
  const groupCount = Object.keys(groupsData).length;
  const isPaid = typeof userPlan!=='undefined' && (userPlan==='pro'||userPlan==='team');
  if (groupCount >= (isPaid ? Infinity : 10)) {
    showToast('âš ï¸ Free plan: up to 10 groups. Upgrade for unlimited!', 3500);
    setTimeout(()=>openFP('pricingPanel'),1800); return;
  }
  const id = 'group_' + Date.now();
  const colors = ['#a78bfa','#5eead4','#f9a8d4','#fde68a','#67e8f9','#b8f0c8'];
  const accColors = ['#7c3aed','#0d9488','#be185d','#d97706','#0891b2','#2d9c5e'];
  const emojis = ['ðŸ’¬','ðŸŒŸ','ðŸŽ¯','ðŸ’¡','ðŸŒˆ','ðŸ”¥'];
  const myName = document.getElementById('sidebarName')?.textContent || 'You';
  const ci = Object.keys(groupsData).length % colors.length;
  const welcomeId = 'msg_welcome_' + Date.now();
  groupsData[id] = {
    id, name: v, dot: colors[ci], emoji: emojis[ci],
    accentBg: colors[ci]+'33', accentColor: accColors[ci],
    members: [{name: myName, emoji:'ðŸŒŸ', isMe:true, uid: currentUserId}],
    messages: [{id:welcomeId, sender:'Track & Clock', system:true, text:`ðŸŽ‰ <b>${myName}</b> created <b>${v}</b>. Invite friends to get started!`, ts:Date.now()}],
    tasks: []
  };
  inp.value = '';
  fsSaveGroup(id);
  if (firebaseReady) {
    listenToSharedGroups([id]);
    db.collection('shared_groups').doc(id).collection('msgs').doc(welcomeId)
      .set(groupsData[id].messages[0]).catch(()=>{});
  }
  renderGroupTabs();
  switchGroup(id, null);
  showToast(`âœ… Group "${v}" created!`, 2500);
}

/* â”€â”€ INIT â”€â”€ */
function initGroupsPanel() {
  renderGroupTabs();
  if (currentGroup) {
    renderGroupChat(currentGroup);
    listenToTypingIndicator(currentGroup);
  }
}

// ===== ACTIVITY =====
function togglePrivate(){document.getElementById('overallScore').textContent=document.getElementById('scorePrivate').checked?'ðŸ”’':'87';}

// ===== LIBRARY =====
let libFiles=[],libFilter='all',lastDeleted=null,undoTimer=null;
function switchLibTab(filter,btn){libFilter=filter;document.querySelectorAll('.lib-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderLib();}
function handleLibUpload(e){
  const curBytes=libFiles.reduce((s,f)=>s+(f.bytes||0),0);
  const maxB=typeof _libMaxBytes!=='undefined'?_libMaxBytes:1073741824;
  Array.from(e.target.files).forEach(file=>{
    if(curBytes+file.size>maxB){showToast('âš ï¸ Storage limit reached! Upgrade to Pro for more.',3000);return;}
    const r=new FileReader();
    r.onload=ev=>{
      const fid='lib_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
      const fobj={id:fid,name:file.name,type:file.type.split('/')[0],mime:file.type,
        data:ev.target.result,size:fmtSize(file.size),bytes:file.size,date:new Date().toLocaleDateString()};
      libFiles.push(fobj);renderLib();updateLibStorageBar();
      // Upload to Firebase Storage + save metadata
      if(firebaseReady&&currentUserId&&storage){
        const ref=storage.ref('users/'+currentUserId+'/library/'+fid);
        ref.put(file).then(s=>s.ref.getDownloadURL()).then(url=>{
          fobj.cloudUrl=url;fobj.data=url;
          fsSetIn('library',fid,{id:fid,name:file.name,type:fobj.type,mime:fobj.mime,
            size:fobj.size,bytes:file.size,date:fobj.date,cloudUrl:url,updatedAt:Date.now()});
          setSyncBadge('synced');
          showToast('â˜ï¸ "'+file.name+'" synced to cloud!',2000);
        }).catch(err=>console.warn('Storage upload:',err));
      }
    };
    r.readAsDataURL(file);
  });e.target.value='';
}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}
function renderLib(){
  const grid=document.getElementById('libGrid'),empty=document.getElementById('libEmpty');
  const filtered=libFilter==='all'?libFiles:libFiles.filter(f=>f.type===libFilter);
  grid.innerHTML='';
  if(!filtered.length){empty.style.display='block';return;}
  empty.style.display='none';
  filtered.forEach(f=>{
    const idx=libFiles.indexOf(f);
    const el=document.createElement('div');el.className='lib-item';
    let thumb=f.type==='image'?`<img src="${f.data}"/>`
      :f.type==='video'?`<video src="${f.data}" muted></video>`
      :`<div style="font-size:2.4rem;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${f.type==='audio'?'ðŸŽµ':'ðŸ“„'}</div>`;
    el.innerHTML=`<div class="lib-thumb">${thumb}</div><div class="lib-name">${f.name}</div><div class="lib-meta">${f.size} Â· ${f.date}</div><button class="lib-del" onclick="delLib(${idx},event)">âœ•</button>`;
    el.onclick=()=>previewFile(idx);grid.appendChild(el);
  });
}
function delLib(idx,e){
  e.stopPropagation();lastDeleted={file:libFiles[idx],idx};libFiles.splice(idx,1);renderLib();showUndoToast();
}
let toastEl=null;
function showUndoToast(){
  if(toastEl){toastEl.remove();if(undoTimer)clearTimeout(undoTimer);}
  toastEl=document.createElement('div');toastEl.className='undo-toast';
  toastEl.innerHTML='<span>ðŸ—‘ File removed</span><button class="undo-btn-toast" onclick="undoDelete()">â†© Undo</button>';
  document.body.appendChild(toastEl);
  undoTimer=setTimeout(()=>{if(toastEl){toastEl.classList.add('hide');setTimeout(()=>{if(toastEl){toastEl.remove();toastEl=null;}},300);}},5000);
}
function undoDelete(){
  if(lastDeleted){libFiles.splice(lastDeleted.idx,0,lastDeleted.file);lastDeleted=null;renderLib();if(toastEl){toastEl.remove();toastEl=null;}if(undoTimer)clearTimeout(undoTimer);showToast('âœ… File restored!',2000);}
}
function showToast(msg,dur=2500){const t=document.createElement('div');t.className='undo-toast';t.innerHTML=`<span>${msg}</span>`;document.body.appendChild(t);setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.remove(),300);},dur);}
function previewFile(idx){
  const f=libFiles[idx];document.getElementById('fileModalTitle').textContent=f.name;
  const c=document.getElementById('fileModalContent');
  if(f.type==='image')c.innerHTML=`<img src="${f.data}" style="max-width:100%;max-height:62vh;border-radius:11px;"/>`;
  else if(f.type==='video')c.innerHTML=`<video src="${f.data}" controls style="max-width:100%;max-height:62vh;border-radius:11px;"></video>`;
  else if(f.type==='audio')c.innerHTML=`<audio src="${f.data}" controls style="width:100%;margin-top:10px;"></audio>`;
  else c.innerHTML=`<div style="padding:20px;text-align:center;color:#7a6fa0;">No preview available</div>`;
  document.getElementById('fileModal').classList.remove('hidden');
}
function closeFileModal(){document.getElementById('fileModal').classList.add('hidden');}

// ===== PROFILE =====
function saveProfileName(){const v=document.getElementById('editNameInput').value.trim();if(!v)return;document.getElementById('profileNameDisplay').textContent=v;document.getElementById('profileNameVal').textContent=v;document.getElementById('sidebarName').textContent=v;}

// ===== STREAK =====
function initStreak(){
  const today=new Date().toDateString();let streak=parseInt(localStorage.getItem('tc_streak')||'1'),lastDay=localStorage.getItem('tc_lastday')||'';
  if(lastDay&&lastDay!==today){streak++;localStorage.setItem('tc_streak',streak);localStorage.setItem('tc_lastday',today);}
  else if(!lastDay)localStorage.setItem('tc_lastday',today);
  document.getElementById('streakCount').textContent=streak;document.getElementById('streakVal').textContent=streak;document.getElementById('sidebarStreak').textContent=`ðŸ”¥ Day ${streak} streak`;
}

// ===== THEMES =====
const themes={
  lavender:{bg1:'#d4c8f0',bg2:'#c8ecd4',bg3:'#e0d0f8',dark:'#3d3260',mid:'#7a6fa0',card:'rgba(255,255,255,0.72)',decos:['ðŸŒ¸','ðŸ’œ','ðŸŒ·','âœ¨','ðŸ¦‹','ðŸ’','ðŸŒº','ðŸ‡'],music:'cozy'},
  ocean:{bg1:'#b3d8f0',bg2:'#d8f0e8',bg3:'#c8ecf8',dark:'#1a3a5c',mid:'#3a6a8a',card:'rgba(235,248,255,0.72)',decos:['ðŸŒŠ','ðŸš','ðŸ ','ðŸ‹','â›µ','ðŸ¦€','ðŸ™','ðŸŒŠ'],music:'calm'},
  sunset:{bg1:'#f0d4c8',bg2:'#f0e8b3',bg3:'#f8d0c0',dark:'#5a2a18',mid:'#8a5a38',card:'rgba(255,248,235,0.72)',decos:['ðŸŒ…','ðŸŒ´','â˜€ï¸','ðŸŒ‡','ðŸ”¥','ðŸŠ','ðŸŒ»','ðŸ¦œ'],music:'energetic'},
  forest:{bg1:'#c8f0d4',bg2:'#e8f0c0',bg3:'#d8f8c8',dark:'#1a3a22',mid:'#3a6a42',card:'rgba(235,255,240,0.72)',decos:['ðŸŒ²','ðŸƒ','ðŸ¦‹','ðŸŒ¿','ðŸ„','ðŸŒ±','ðŸ¦”','ðŸŒ¾'],music:'nature'},
  rose:{bg1:'#f0c8d4',bg2:'#f0c8f0',bg3:'#f8d8e8',dark:'#5a1a3a',mid:'#8a4a6a',card:'rgba(255,235,245,0.72)',decos:['ðŸŒ¹','ðŸ’—','ðŸŒº','ðŸµï¸','ðŸ’','ðŸŒ¸','ðŸ¦¢','ðŸ’®'],music:'cozy'},
  night:{bg1:'#2a2540',bg2:'#1a3a4a',bg3:'#2a1a4a',dark:'#e0d8f8',mid:'#a090c0',card:'rgba(35,28,70,0.72)',decos:['ðŸŒ™','â­','ðŸ”®','âœ¨','ðŸŒŒ','ðŸ’«','ðŸŒ ','ðŸ¦‰'],music:'focus'}
};
function setTheme(name,btn){
  document.querySelectorAll('.theme-opt').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const t=themes[name];if(!t)return;
  const r=document.documentElement.style;
  r.setProperty('--bg1',t.bg1);r.setProperty('--bg2',t.bg2);r.setProperty('--bg3',t.bg3);
  r.setProperty('--dark',t.dark);r.setProperty('--mid',t.mid);r.setProperty('--card',t.card);
  r.setProperty('--text-on-theme',t.dark);r.setProperty('--text-mid-theme',t.mid);
  // Theme emoji decorations â€” skip on mobile
  const deco=document.getElementById('themeDeco');deco.innerHTML='';
  if(window.innerWidth>768){
    t.decos.forEach((icon,i)=>{
      const el=document.createElement('div');el.className='deco-el';el.textContent=icon;
      el.style.cssText=`left:${5+i*12+Math.random()*5}%;top:${4+Math.random()*86}%;animation-delay:${i*0.7}s;font-size:${1.4+Math.random()*1.3}rem;`;
      deco.appendChild(el);
    });
  }
  // Music
  if(t.music){document.querySelectorAll('.mp-mood-chip').forEach(c=>c.classList.remove('active'));const chip=document.querySelector(`.mp-mood-chip[onclick*="${t.music}"]`);if(chip)chip.classList.add('active');setMoodChip(t.music,chip||document.querySelector('.mp-mood-chip'));}
  // Canvas animated scene
  if(window.TC)TC.setScene(name);
}
function setMood(btn){document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function setFont(size,btn){
  // Only reset font-size buttons, not mood buttons
  document.querySelectorAll('.font-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.documentElement.style.setProperty('--base-font',size);
  // Apply font size visually to everything
  document.body.style.fontSize=size;
  // Update preview
  const prev=document.getElementById('fontPreviewText');
  if(prev)prev.style.fontSize=size;
}
(function initDecos(){
  if(window.innerWidth<=768) return; // skip on mobile
  const deco=document.getElementById('themeDeco');
  ['ðŸŒ¸','ðŸ’œ','ðŸŒ·','âœ¨','ðŸ¦‹','ðŸ’','ðŸŒº'].forEach((icon,i)=>{
    const el=document.createElement('div');el.className='deco-el';el.textContent=icon;
    el.style.cssText=`left:${5+i*13+Math.random()*5}%;top:${4+Math.random()*86}%;animation-delay:${i*0.7}s;font-size:${1.4+Math.random()*1.2}rem;`;
    deco.appendChild(el);
  });
})();

// ===== AUTH =====
let loginMode='login';
function openLoginModal(mode){
  loginMode=mode||'login';document.getElementById('loginModal').classList.remove('hidden');
  if(mode==='switch'){document.getElementById('loginModalTitle').textContent='Switch Account';document.getElementById('loginModalSub').textContent='Sign in with a different account';}
  else{document.getElementById('loginModalTitle').textContent='Welcome Back!';document.getElementById('loginModalSub').textContent='Log in to continue your journey';}
  document.getElementById('loginRegExtra').style.display='none';
  document.getElementById('loginSubmitBtn').textContent='Log In';
  document.getElementById('loginSwitchText').innerHTML="Don't have an account? <span onclick='toggleLoginMode()'>Sign up</span>";
}
function closeLoginModal(){document.getElementById('loginModal').classList.add('hidden');}
function toggleLoginMode(){
  if(loginMode==='login'){loginMode='register';document.getElementById('loginModalTitle').textContent='Create Account';document.getElementById('loginModalSub').textContent='Join Track & Clock today';document.getElementById('loginRegExtra').style.display='block';document.getElementById('loginSubmitBtn').textContent='Sign Up';document.getElementById('loginSwitchText').innerHTML="Already have an account? <span onclick='toggleLoginMode()'>Log in</span>";}
  else{loginMode='login';document.getElementById('loginModalTitle').textContent='Welcome Back!';document.getElementById('loginModalSub').textContent='';document.getElementById('loginRegExtra').style.display='none';document.getElementById('loginSubmitBtn').textContent='Log In';document.getElementById('loginSwitchText').innerHTML="Don't have an account? <span onclick='toggleLoginMode()'>Sign up</span>";}
}
function handleLogin(){const v=document.getElementById('loginUsername').value.trim();if(v)onUserSignedIn(v,null,null);closeLoginModal();}
function handleLogout(){if(confirm('Are you sure you want to log out?')){
  stopSync();currentUserId=null;
  calTasks={};activityEntries=[];groupTasksStore=[];libFiles=[];selectedDate=null;
  if(firebaseReady&&auth)auth.signOut().catch(()=>{});
  localStorage.removeItem('tc_google_user');
  if(window.google&&window.google.accounts)google.accounts.id.revoke('',()=>{});
  // Reset all avatar/name UI so previous user's data never bleeds into next session
  ['avatarBtnInner','sidebarAvatarInner','profileAvatarInner'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    if(el.tagName==='IMG'){const s=document.createElement('span');s.id=id;s.textContent='ðŸ£';el.parentNode.replaceChild(s,el);}
    else el.textContent='ðŸ£';
  });
  document.getElementById('sidebarName').textContent='Tracker';
  document.getElementById('profileNameDisplay').textContent='Tracker';
  document.getElementById('profileNameVal').textContent='Tracker User';
  document.getElementById('profileEmail').textContent='â€”';
  document.getElementById('googleLinkedStatus').textContent='Not linked';
  document.getElementById('appLayout').classList.add('hidden');
  document.getElementById('landing').classList.remove('hidden');
}}

// ===== LEGAL DOC TOGGLES =====
function toggleLegal(bodyId, chevronId) {
  const body = document.getElementById(bodyId);
  const chevron = document.getElementById(chevronId);
  const isOpen = body.classList.contains('open');
  // Close all others first
  document.querySelectorAll('.legal-doc-body').forEach(b => b.classList.remove('open'));
  document.querySelectorAll('.legal-chevron').forEach(c => c.classList.remove('open'));
  // Toggle the clicked one
  if (!isOpen) {
    body.classList.add('open');
    chevron.classList.add('open');
    // Smooth scroll to it
    setTimeout(() => body.scrollIntoView({behavior:'smooth', block:'nearest'}), 60);
  }
}

// ===== AVATAR =====
let avState={skin:'#f5c9a0',eyeColor:'#5b8dee',hair:'twin',hairColor:'#5c3d2e',shirt:'tshirt',shirtColor:'#c9b3e8',pants:'pants',shoes:'sneakers',shoeColor:'#c9b3e8',acc:'none',bg:'radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0)',pose:'stand'};
function _syncProfileAvatarSvg(){
  const wrap = document.getElementById('profileAvatarSvgWrap');
  const src = document.getElementById('avSvg');
  if(!wrap || !src) return;
  // Clone the live SVG into the profile avatar circle
  const clone = src.cloneNode(true);
  clone.removeAttribute('id');
  clone.style.width = '100%';
  clone.style.height = '100%';
  clone.style.display = 'block';
  wrap.innerHTML = '';
  wrap.appendChild(clone);
  // Also sync the cover bg
  const coverBg = document.getElementById('profileCoverBg');
  if(coverBg && avState && avState.bg) {
    coverBg.style.background = avState.bg;
    coverBg.style.backgroundSize = '200% 200%';
  }
}
// Sync profile avatar whenever profile panel opens
const _origOpenFP = window.openFP || function(){};
function openFP(id){
  document.querySelectorAll('.full-panel').forEach(p=>p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='calPanel') renderCalendar();
  if(id==='libraryPanel'){applyLibraryGate();renderLib();}
  if(id==='groupsPanel') initGroupsPanel();
  if(id==='taskPanel'){renderTaskPanel();renderGroupTaskList();}
  if(id==='actPanel') renderActivityPanel();
  if(id==='profilePanel') setTimeout(_syncProfileAvatarSvg, 50);
}
function openAvatarModal(){document.getElementById('avatarModal').classList.remove('hidden');}
function closeAvatarModal(){document.getElementById('avatarModal').classList.add('hidden');}
function clearRow(id){document.querySelectorAll('#'+id+' .opt-btn,.opt-btn.active').forEach(b=>{if(b.closest('#'+id))b.classList.remove('active');});}
function clearSwatches(row){document.querySelectorAll('.'+row+' .color-swatch').forEach(s=>s.classList.remove('active'));}
function setSkin(c,sw){avState.skin=c;document.querySelectorAll('#avHead,#avNeck,#avEarL,#avEarR,#avArmL,#avArmR,#avLegL,#avLegR').forEach(el=>{if(el)el.setAttribute('fill',c);});document.querySelectorAll('[id="avShoeGroup"] ellipse:not(:nth-child(-n+2)),circle').forEach(el=>{const id=el.id;if(!id&&el.closest('#avShoeGroup'))return;if(['avHead','avNeck','avEarL','avEarR'].includes(id))el.setAttribute('fill',c);});document.getElementById('avSvg').querySelectorAll('circle[fill="#f5c9a0"],circle[fill="#f9e4d4"],circle[fill="#e8a87c"],circle[fill="#c68642"],circle[fill="#8d5524"],circle[fill="#5c3317"]').forEach(el=>el.setAttribute('fill',c));sw.classList.add('active');updateAvatar();}
function setEyeColor(c,sw){avState.eyeColor=c;['avIrisColorL','avIrisColorR'].forEach(id=>{const el=document.getElementById(id);if(el)el.setAttribute('fill',c);});sw.classList.add('active');}
function setHair(s,btn){avState.hair=s;document.querySelectorAll('#hairStyleRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setHairColor(c,sw){avState.hairColor=c;document.querySelectorAll('#hairColorRow .color-swatch').forEach(s=>s.classList.remove('active'));sw.classList.add('active');updateAvatar();}
function setShirt(s,btn){avState.shirt=s;document.querySelectorAll('#shirtStyleRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setShirtColor(c,sw){avState.shirtColor=c;document.querySelectorAll('#shirtColorRow .color-swatch').forEach(s=>s.classList.remove('active'));sw.classList.add('active');updateAvatar();}
function setPants(s,btn){avState.pants=s;document.querySelectorAll('#pantsRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setShoes(s,btn){avState.shoes=s;document.querySelectorAll('#shoeRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setShoeColor(c,sw){avState.shoeColor=c;document.querySelectorAll('#shoeColorRow .color-swatch').forEach(s=>s.classList.remove('active'));sw.classList.add('active');updateAvatar();}
function setAcc(a,btn){avState.acc=a;document.querySelectorAll('#accRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setAvBg(g,sw){avState.bg=g;document.getElementById('avBg').style.background=g;document.querySelectorAll('#bgColorRow .color-swatch').forEach(s=>s.classList.remove('active'));sw.classList.add('active');}
function setPose(p,btn){avState.pose=p;document.querySelectorAll('.pose-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}

function loadAvatarPhoto(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    // Show photo as face overlay hint
    showToast('ðŸ“¸ Photo loaded! We used your skin tone & style as inspiration.',3000);
    // Simple: set the canvas bg to a blurred version of the photo
    const img=new Image();img.onload=()=>{
      const canvas=document.createElement('canvas');canvas.width=150;canvas.height=200;
      const ctx=canvas.getContext('2d');ctx.filter='blur(8px) opacity(0.25)';
      ctx.drawImage(img,0,0,150,200);
      const dataUrl=canvas.toDataURL();
      document.getElementById('avBg').style.background=`url(${dataUrl}) center/cover`;
    };img.src=ev.target.result;
  };r.readAsDataURL(file);
}

function updateAvatar(){
  // Directly write SVG parts - no svg.getElementById, no fragile lookups
  const s = avState;
  const hc = s.hairColor || '#5c3d2e';
  const sc = s.shirtColor || '#c9b3e8';
  const pc = s.pantsColor || '#7a6fa0';
  const shc = s.shoeColor || '#c9b3e8';

  const hairMap = {
    twin:`<ellipse cx="60" cy="18" rx="38" ry="28" fill="${hc}"/><ellipse cx="60" cy="13" rx="30" ry="16" fill="${hc}"/><rect x="20" y="18" width="16" height="44" rx="8" fill="${hc}"/><rect x="84" y="18" width="16" height="44" rx="8" fill="${hc}"/><circle cx="20" cy="16" r="15" fill="${hc}"/><circle cx="100" cy="16" r="15" fill="${hc}"/>`,
    short:`<ellipse cx="60" cy="22" rx="40" ry="24" fill="${hc}"/><rect x="18" y="28" width="14" height="26" rx="7" fill="${hc}"/><rect x="88" y="28" width="14" height="26" rx="7" fill="${hc}"/>`,
    ponytail:`<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><ellipse cx="60" cy="12" rx="28" ry="14" fill="${hc}"/><rect x="80" y="8" width="12" height="55" rx="6" fill="${hc}"/><ellipse cx="86" cy="64" rx="10" ry="7" fill="${hc}"/>`,
    long:`<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><rect x="18" y="22" width="15" height="72" rx="7" fill="${hc}"/><rect x="87" y="22" width="15" height="72" rx="7" fill="${hc}"/>`,
    pixie:`<ellipse cx="60" cy="18" rx="38" ry="22" fill="${hc}"/><ellipse cx="60" cy="8" rx="26" ry="12" fill="${hc}"/><rect x="19" y="24" width="12" height="18" rx="6" fill="${hc}"/>`,
    braids:`<ellipse cx="60" cy="16" rx="37" ry="25" fill="${hc}"/><rect x="16" y="24" width="12" height="80" rx="6" fill="${hc}"/><rect x="92" y="24" width="12" height="80" rx="6" fill="${hc}"/><ellipse cx="22" cy="108" rx="9" ry="7" fill="${hc}"/><ellipse cx="98" cy="108" rx="9" ry="7" fill="${hc}"/>`,
    curly:`<ellipse cx="60" cy="14" rx="42" ry="28" fill="${hc}"/><circle cx="18" cy="42" r="14" fill="${hc}"/><circle cx="102" cy="42" r="14" fill="${hc}"/><circle cx="24" cy="18" r="12" fill="${hc}"/><circle cx="96" cy="18" r="12" fill="${hc}"/><circle cx="60" cy="6" r="12" fill="${hc}"/>`,
    sidetail:`<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><rect x="90" y="14" width="14" height="70" rx="7" fill="${hc}"/><ellipse cx="97" cy="86" rx="11" ry="8" fill="${hc}"/><rect x="18" y="22" width="12" height="22" rx="6" fill="${hc}"/>`
  };
  const shirtMap = {
    tshirt:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}"/>`,
    hoodie:`<rect x="24" y="88" width="72" height="44" rx="18" fill="${sc}"/><rect x="44" y="88" width="32" height="16" rx="6" fill="rgba(0,0,0,0.12)" opacity="0.6"/>`,
    uniform:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}"/><rect x="54" y="90" width="12" height="40" fill="rgba(255,255,255,0.25)"/>`,
    dress:`<rect x="26" y="90" width="68" height="50" rx="16" fill="${sc}"/><path d="M26 120 Q60 148 94 120 L94 140 Q60 165 26 140Z" fill="${sc}" opacity="0.8"/>`,
    sundress:`<rect x="28" y="90" width="64" height="48" rx="18" fill="${sc}"/><path d="M22 118 Q60 152 98 118 L98 148 Q60 178 22 148Z" fill="${sc}"/>`,
    kitty:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}"/><text x="60" y="116" text-anchor="middle" font-size="18">ðŸ±</text>`,
    bear:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}"/><text x="60" y="116" text-anchor="middle" font-size="18">ðŸ»</text>`,
    stripes:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}"/><line x1="26" y1="98" x2="94" y2="98" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="108" x2="94" y2="108" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="118" x2="94" y2="118" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="128" x2="94" y2="128" stroke="rgba(255,255,255,0.35)" stroke-width="4"/>`
  };
  const pantsMap = {
    pants:`<rect x="28" y="122" width="64" height="38" rx="14" fill="${pc}"/>`,
    jeans:`<rect x="28" y="122" width="64" height="38" rx="14" fill="#4a74a8"/><line x1="60" y1="122" x2="60" y2="160" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>`,
    skirt:`<path d="M22 122 Q60 162 98 122Z" fill="${pc}"/><rect x="28" y="118" width="64" height="12" rx="6" fill="${pc}" opacity="0.8"/>`,
    miniskirt:`<path d="M26 122 Q60 148 94 122Z" fill="${pc}"/><rect x="28" y="118" width="64" height="10" rx="5" fill="${pc}" opacity="0.8"/>`,
    shorts:`<rect x="28" y="122" width="28" height="22" rx="10" fill="${pc}"/><rect x="64" y="122" width="28" height="22" rx="10" fill="${pc}"/>`,
    plaid:`<rect x="28" y="122" width="64" height="38" rx="14" fill="${pc}"/><line x1="36" y1="122" x2="36" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="48" y1="122" x2="48" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="72" y1="122" x2="72" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="28" y1="132" x2="92" y2="132" stroke="rgba(255,255,255,0.3)" stroke-width="2"/><line x1="28" y1="144" x2="92" y2="144" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>`,
    leggings:`<rect x="37" y="122" width="20" height="48" rx="10" fill="${pc}"/><rect x="63" y="122" width="20" height="48" rx="10" fill="${pc}"/>`
  };
  const shoeMap = {
    sneakers:`<ellipse cx="38" cy="191" rx="17" ry="9" fill="${shc}"/><ellipse cx="78" cy="191" rx="17" ry="9" fill="${shc}"/><ellipse cx="36" cy="187" rx="14" ry="7" fill="rgba(255,255,255,0.4)"/><ellipse cx="80" cy="187" rx="14" ry="7" fill="rgba(255,255,255,0.4)"/>`,
    heels:`<ellipse cx="40" cy="190" rx="14" ry="7" fill="${shc}"/><ellipse cx="76" cy="190" rx="14" ry="7" fill="${shc}"/><rect x="44" y="191" width="4" height="10" rx="2" fill="${shc}"/><rect x="72" y="191" width="4" height="10" rx="2" fill="${shc}"/>`,
    boots:`<rect x="24" y="176" width="24" height="20" rx="8" fill="${shc}"/><rect x="72" y="176" width="24" height="20" rx="8" fill="${shc}"/><ellipse cx="36" cy="196" rx="14" ry="6" fill="${shc}"/><ellipse cx="84" cy="196" rx="14" ry="6" fill="${shc}"/>`,
    loafers:`<ellipse cx="38" cy="191" rx="17" ry="8" fill="${shc}"/><ellipse cx="78" cy="191" rx="17" ry="8" fill="${shc}"/><rect x="26" y="184" width="22" height="7" rx="3" fill="${shc}" opacity="0.7"/><rect x="72" y="184" width="22" height="7" rx="3" fill="${shc}" opacity="0.7"/>`,
    barefoot:`<ellipse cx="38" cy="191" rx="14" ry="7" fill="${s.skin||'#f5c9a0'}"/><ellipse cx="78" cy="191" rx="14" ry="7" fill="${s.skin||'#f5c9a0'}"/>`
  };
  const accMap = {
    none:'',
    bow:`<ellipse cx="36" cy="28" rx="12" ry="7" fill="#f9a8d4" transform="rotate(-25 36 28)"/><ellipse cx="62" cy="22" rx="12" ry="7" fill="#f9a8d4" transform="rotate(15 62 22)"/><circle cx="48" cy="25" r="6" fill="#f9a8d4"/>`,
    crown:`<polygon points="20,42 30,20 48,32 66,20 80,42" fill="#ffd700" stroke="#f0a500" stroke-width="1.5"/><circle cx="30" cy="22" r="4" fill="#ff6b6b"/><circle cx="48" cy="32" r="4" fill="#6bcfff"/><circle cx="66" cy="22" r="4" fill="#98f59a"/>`,
    catears:`<polygon points="16,50 20,28 34,44" fill="${hc}"/><polygon points="86,44 100,28 104,50" fill="${hc}"/><polygon points="18,48 21,34 31,44" fill="#ffd6e7" opacity="0.7"/><polygon points="89,44 99,34 102,48" fill="#ffd6e7" opacity="0.7"/>`,
    flower:`<circle cx="72" cy="30" r="10" fill="#f9a8d4" opacity="0.8"/><circle cx="80" cy="22" r="8" fill="#fde68a" opacity="0.8"/><circle cx="64" cy="22" r="8" fill="#f9a8d4" opacity="0.8"/><circle cx="72" cy="30" r="5" fill="#fde68a"/>`,
    headphones:`<rect x="14" y="50" width="10" height="20" rx="5" fill="#2d2050"/><rect x="96" y="50" width="10" height="20" rx="5" fill="#2d2050"/><path d="M19 55 Q60 30 101 55" stroke="#2d2050" stroke-width="5" fill="none"/><rect x="12" y="54" width="14" height="20" rx="7" fill="${hc}"/><rect x="94" y="54" width="14" height="20" rx="7" fill="${hc}"/>`,
    halo:`<ellipse cx="60" cy="5" rx="26" ry="8" fill="none" stroke="#ffd700" stroke-width="4" opacity="0.85"/>`,
    glasses:`<circle cx="44" cy="58" r="12" fill="none" stroke="#5c3d2e" stroke-width="3"/><circle cx="76" cy="58" r="12" fill="none" stroke="#5c3d2e" stroke-width="3"/><line x1="56" y1="58" x2="64" y2="58" stroke="#5c3d2e" stroke-width="3"/><line x1="20" y1="56" x2="32" y2="57" stroke="#5c3d2e" stroke-width="2.5"/><line x1="88" y1="57" x2="100" y2="56" stroke="#5c3d2e" stroke-width="2.5"/>`,
    wings:`<path d="M14 100 Q-10 80 5 60 Q20 50 30 72Z" fill="${hc}" opacity="0.7"/><path d="M106 100 Q130 80 115 60 Q100 50 90 72Z" fill="${hc}" opacity="0.7"/>`
  };

  const hair = document.getElementById('avHair');
  const shirt = document.getElementById('avShirt');
  const bottom = document.getElementById('avBottom');
  const shoes = document.getElementById('avShoeGroup');
  const acc = document.getElementById('avAccLayer');

  if(hair) hair.innerHTML = hairMap[s.hair] || hairMap.twin;
  if(shirt) shirt.innerHTML = shirtMap[s.shirt] || shirtMap.tshirt;
  if(bottom) bottom.innerHTML = pantsMap[s.pants] || pantsMap.pants;
  if(shoes) shoes.innerHTML = shoeMap[s.shoes] || shoeMap.sneakers;
  if(acc) acc.innerHTML = accMap[s.acc] || '';

  // Eye colors
  const iL = document.getElementById('avIrisColorL');
  const iR = document.getElementById('avIrisColorR');
  if(iL) iL.setAttribute('fill', s.eyeColor || '#5b8dee');
  if(iR) iR.setAttribute('fill', s.eyeColor || '#5b8dee');

  // Skin tone
  document.querySelectorAll('#avHead,#avNeck,#avEarL,#avEarR,#avArmL,#avArmR,#avLegL,#avLegR').forEach(el=>{
    if(el) el.setAttribute('fill', s.skin || '#f5c9a0');
  });

  // Pose
  const armR = document.getElementById('avArmR');
  const legL = document.getElementById('avLegL');
  const legR = document.getElementById('avLegR');
  if(s.pose==='wave' && armR){armR.setAttribute('transform','rotate(-55 103 90)');armR.setAttribute('ry','22');}
  else if(s.pose==='sit'){if(legL)legL.setAttribute('transform','rotate(75 47 152)');if(legR)legR.setAttribute('transform','rotate(-75 73 152)');}
  else if(s.pose==='peace' && armR){armR.setAttribute('transform','rotate(-45 103 95)');}
  else{if(armR){armR.setAttribute('transform','rotate(18 103 112)');armR.setAttribute('ry','24');}if(legL)legL.removeAttribute('transform');if(legR)legR.removeAttribute('transform');}

  // Update avatar bg
  const avBg = document.getElementById('avBg');
  if(avBg && s.bg) avBg.style.background = s.bg;
}

function saveAvatar(){
  const name=document.getElementById('avatarNameInput').value||'Tracker';
  // Sync profile cover with avatar background
  const coverBg = document.getElementById('profileCoverBg');
  if(coverBg && avState.bg) coverBg.style.background = avState.bg;
  // Sync live SVG into profile banner
  _syncProfileAvatarSvg();
  const em={'twin':'ðŸ£','short':'ðŸ±','ponytail':'ðŸ¦Š','long':'ðŸ‘§','pixie':'ðŸŒŸ','braids':'ðŸ‘±','curly':'ðŸ’«','sidetail':'ðŸŒ¸'}[avState.hair]||'ðŸ£';
  ['avatarBtnInner','sidebarAvatarInner','profileAvatarInner'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=em;});
  document.getElementById('sidebarName').textContent=name;
  document.getElementById('profileNameDisplay').textContent=name;
  document.getElementById('editNameInput').value=name;
  closeAvatarModal();showToast('ðŸ’œ Avatar saved!',2000);
}

renderCalendar();

// ===================================================
// NOTIFICATION SYSTEM
// ===================================================
let notifications=[];let reminders=[];let notifPanelOpen=false;let unreadCount=0;

function addNotification(type,icon,title,msg){
  const now=new Date();const timeStr=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const notif={id:Date.now()+Math.random(),type,icon,title,msg,time:timeStr,read:false};
  notifications.unshift(notif);unreadCount++;updateNotifBadge();renderNotifList();showToastNotif(icon,title,msg);
}
function updateNotifBadge(){
  const badge=document.getElementById('notifBadge');if(!badge)return;
  if(unreadCount>0){badge.textContent=unreadCount>9?'9+':unreadCount;badge.classList.remove('hidden');
    const btn=document.getElementById('notifBellBtn');if(btn){btn.style.animation='none';setTimeout(()=>{btn.style.animation='bellShake 0.5s ease';},10);}
  }else{badge.classList.add('hidden');}
}
function renderNotifList(){
  const list=document.getElementById('notifList');if(!list)return;list.innerHTML='';
  if(!notifications.length){list.innerHTML='<div class="notif-empty">No notifications yet âœ¨</div>';return;}
  notifications.forEach(n=>{
    const el=document.createElement('div');el.className=`notif-item ${n.type} ${n.read?'':'unread'}`;
    el.innerHTML=`<span class="notif-icon">${n.icon}</span><div class="notif-body"><div class="notif-title">${n.title}</div><div class="notif-msg">${n.msg}</div><div class="notif-time">${n.time}</div></div><button class="notif-dismiss" onclick="dismissNotif('${n.id}')">âœ•</button>`;
    list.appendChild(el);
  });
}
function dismissNotif(id){
  const idx=notifications.findIndex(n=>String(n.id)===String(id));
  if(idx!==-1){if(!notifications[idx].read)unreadCount=Math.max(0,unreadCount-1);notifications.splice(idx,1);}
  updateNotifBadge();renderNotifList();
}
function clearAllNotifs(){notifications=[];unreadCount=0;updateNotifBadge();renderNotifList();}

// â”€â”€ Notif panel tabs â”€â”€
let _notifTab = 'notifs';
function switchNotifTab(tab){
  _notifTab = tab;
  document.getElementById('notifList').style.display = tab==='notifs' ? 'block' : 'none';
  document.getElementById('inviteList').style.display = tab==='invites' ? 'block' : 'none';
  const subTabEl = document.getElementById('subTabContent');
  if(subTabEl) subTabEl.style.display = tab==='sub' ? 'flex' : 'none';
  const notifAddSec = document.getElementById('notifAddSection');
  if(notifAddSec) notifAddSec.style.display = tab==='notifs' ? 'block' : 'none';
  const tN = document.getElementById('notifTabNotifs');
  const tI = document.getElementById('notifTabInvites');
  const tS = document.getElementById('notifTabSub');
  if(tN){tN.style.color=tab==='notifs'?'#8b5cf6':'var(--mid)';tN.style.borderBottom=tab==='notifs'?'2.5px solid #8b5cf6':'2.5px solid transparent';tN.style.fontWeight=tab==='notifs'?'800':'700';}
  if(tI){tI.style.color=tab==='invites'?'#8b5cf6':'var(--mid)';tI.style.borderBottom=tab==='invites'?'2.5px solid #8b5cf6':'2.5px solid transparent';tI.style.fontWeight=tab==='invites'?'800':'700';}
  if(tS){tS.style.color=tab==='sub'?'#8b5cf6':'var(--mid)';tS.style.borderBottom=tab==='sub'?'2.5px solid #8b5cf6':'2.5px solid transparent';tS.style.fontWeight=tab==='sub'?'800':'700';}
}

// â”€â”€ Group Invites â”€â”€
let pendingInvites = []; // {groupId, groupName, groupEmoji, inviterName, ts}

function addGroupInvite(groupId, groupName, groupEmoji, inviterName){
  // Don't add duplicate
  if(pendingInvites.some(i=>i.groupId===groupId)) return;
  pendingInvites.push({groupId, groupName, groupEmoji, inviterName, ts: Date.now()});
  updateInviteBadge();
  renderInviteList();
  // Also flash the bell
  showToastNotif('ðŸ‘¥', 'Group Invite!', `${inviterName} invited you to join ${groupEmoji} ${groupName}`);

  // Show an unmissable floating banner so User 2 doesn't have to find the bell icon
  const existing = document.getElementById('inviteAppBanner');
  if (existing) existing.remove();
  const banner = document.createElement('div');
  banner.id = 'inviteAppBanner';
  banner.style.cssText = 'position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:280;background:linear-gradient(135deg,rgba(255,255,255,0.97),rgba(245,240,255,0.97));backdrop-filter:blur(20px);border:2px solid #c9b3e8;border-radius:22px;padding:16px 22px;box-shadow:0 12px 40px rgba(139,92,246,0.28);display:flex;align-items:center;gap:14px;min-width:280px;max-width:92vw;animation:fadeDown 0.4s ease both;';
  banner.innerHTML = `
    <div style="font-size:2rem;flex-shrink:0;">ðŸ‘¥</div>
    <div style="flex:1;min-width:0;">
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.95rem;color:#3d3260;">Group invite from ${inviterName}!</div>
      <div style="font-size:0.8rem;color:#7a6fa0;font-weight:600;margin-top:2px;">${groupEmoji} <b>${groupName}</b></div>
    </div>
    <button onclick="(function(idx){const inv=pendingInvites[idx];if(inv){document.getElementById('inviteAppBanner').remove();acceptGroupInvite(idx);}})(pendingInvites.length-1)" style="padding:8px 14px;border-radius:12px;border:none;background:linear-gradient(135deg,#8b5cf6,#5eead4);color:white;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.82rem;cursor:pointer;white-space:nowrap;flex-shrink:0;">âœ… Join</button>
    <button onclick="document.getElementById('inviteAppBanner').remove()" style="background:none;border:none;cursor:pointer;font-size:1rem;color:#a090c0;padding:4px 2px;flex-shrink:0;">âœ•</button>
  `;
  document.body.appendChild(banner);
  // Auto-dismiss after 20 seconds
  setTimeout(() => { const b=document.getElementById('inviteAppBanner'); if(b)b.remove(); }, 20000);
}

function updateInviteBadge(){
  const badge = document.getElementById('inviteBadge');
  if(!badge) return;
  if(pendingInvites.length > 0){
    badge.textContent = pendingInvites.length;
    badge.classList.remove('hidden');
    // Also update main notif badge
    const mainBadge = document.getElementById('notifBadge');
    if(mainBadge){ mainBadge.textContent = (unreadCount + pendingInvites.length); mainBadge.classList.remove('hidden'); }
  } else {
    badge.classList.add('hidden');
  }
}

function renderInviteList(){
  const list = document.getElementById('inviteList');
  const empty = document.getElementById('inviteEmpty');
  if(!list) return;
  // Clear except empty state
  Array.from(list.children).forEach(c=>{ if(c.id!=='inviteEmpty') c.remove(); });
  if(pendingInvites.length === 0){
    if(empty) empty.style.display = 'block';
    return;
  }
  if(empty) empty.style.display = 'none';
  pendingInvites.forEach((inv, idx) => {
    const el = document.createElement('div');
    el.className = 'notif-item unread';
    el.style.cssText = 'flex-direction:column;gap:8px;';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:1.5rem;">${inv.groupEmoji||'ðŸ‘¥'}</span>
        <div style="flex:1;">
          <div class="notif-title">${inv.groupName}</div>
          <div class="notif-msg">Invited by ${inv.inviterName||'Someone'}</div>
          <div class="notif-time">${new Date(inv.ts).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="acceptGroupInvite(${idx})" style="flex:1;padding:8px;border:none;border-radius:10px;background:linear-gradient(135deg,#8b5cf6,#5eead4);color:white;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.82rem;cursor:pointer;">âœ… Join Group</button>
        <button onclick="declineGroupInvite(${idx})" style="flex:1;padding:8px;border:1.5px solid rgba(200,180,240,0.4);border-radius:10px;background:none;color:var(--mid);font-family:'Nunito',sans-serif;font-weight:700;font-size:0.82rem;cursor:pointer;">âœ• Decline</button>
      </div>
    `;
    list.appendChild(el);
  });
}

function acceptGroupInvite(idx){
  const inv = pendingInvites[idx];
  if(!inv) return;

  // Must be signed in to join
  if(!currentUserId){
    showToast('âš ï¸ Please sign in with Google first, then tap Join again.', 3500);
    // Show login modal
    if(typeof openLoginModal === 'function') openLoginModal();
    return;
  }
  if(!firebaseReady){
    showToast('âš ï¸ Still connecting to server, please wait...', 2500);
    return;
  }

  const myName = document.getElementById('sidebarName')?.textContent || 'New Member';

  // Use cached group data if available (from handleInviteLink), else fetch
  const doJoin = (g) => {
    const alreadyIn = (g.members||[]).some(m => m.uid && m.uid === currentUserId);
    if(!alreadyIn){
      const updatedMeta = {
        members:[...(g.members||[]),{name:myName, emoji:'âœ¨', uid:currentUserId}],
        updatedAt:Date.now()
      };
      db.collection('shared_groups').doc(g.id).set(updatedMeta,{merge:true})
        .catch(e=>console.warn('[Join] set members error:', e));

      const joinMsgId = 'msg_join_' + currentUserId + '_' + Date.now();
      db.collection('shared_groups').doc(g.id).collection('msgs').doc(joinMsgId).set({
        id:joinMsgId, sender:'Track & Clock', system:true,
        text:'ðŸŽ‰ <b>'+myName+'</b> joined the group!', ts:Date.now()
      }).catch(()=>{});

      groupsData[g.id] = {...g, ...updatedMeta, messages: g.messages||[]};
    } else {
      groupsData[g.id] = {...g, messages: g.messages||[]};
    }
    // Register group in user's personal list
    db.doc('users/'+currentUserId+'/meta/myGroups').get().then(s=>{
      const ids = s.exists?(s.data().ids||[]):[];
      if(!ids.includes(g.id)){ ids.push(g.id); db.doc('users/'+currentUserId+'/meta/myGroups').set({ids},{merge:true}); }
    }).catch(()=>{});

    listenToSharedGroups([g.id]);
    // Clean up Firestore invite doc
    if (inv._firestoreId && inv._firestoreEmail) {
      db.collection('invites').doc(inv._firestoreEmail).collection('pending').doc(inv._firestoreId)
        .delete().catch(()=>{});
    }
    pendingInvites.splice(idx,1);
    updateInviteBadge();
    renderInviteList();
    const b = document.getElementById('inviteAppBanner'); if(b) b.remove();
    showToast('ðŸŽ‰ Joined ' + (g.emoji||'') + ' ' + g.name + '!', 3000);
    const panel = document.getElementById('notifPanel');
    if(panel) panel.classList.add('hidden');
    notifPanelOpen = false;
    openFP('groupsPanel');
    setTimeout(()=>{ renderGroupTabs(); switchGroup(g.id,null); },400);
  };

  // Use cached group if we already fetched it
  if(_cachedInviteGroup && _cachedInviteGroup.id === inv.groupId){
    doJoin(_cachedInviteGroup);
  } else {
    db.collection('shared_groups').doc(inv.groupId).get().then(snap=>{
      if(!snap.exists){ showToast('âš ï¸ Group no longer exists.', 3000); return; }
      doJoin(snap.data());
    }).catch(e=>{
      console.warn('[Join] fetch error:', e);
      showToast('âš ï¸ Could not load group. Check your connection.', 3000);
    });
  }
}

function declineGroupInvite(idx){
  const inv = pendingInvites[idx] || {};
  pendingInvites.splice(idx,1);
  updateInviteBadge();
  renderInviteList();
  // Mark as declined in Firestore so it doesn't reappear
  if (firebaseReady && inv._firestoreId) {
    db.collection('invites').doc(inv._firestoreEmail).collection('pending').doc(inv._firestoreId)
      .delete().catch(()=>{});
  }
  showToast('Invite declined.', 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVITE MODAL â€” send by Gmail + Firestore push notification
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function _emailToKey(email) {
  // Firestore doc IDs can't contain '.' â€” replace with comma
  return email.toLowerCase().trim().replace(/\./g, ',');
}

function openInviteModal() {
  if (!currentGroup) { showToast('âš ï¸ Select a group first!', 2000); return; }
  const g = groupsData[currentGroup];
  if (!g) return;
  const modal = document.getElementById('inviteModal');
  const badge = document.getElementById('inviteGroupBadge');
  badge.style.background = g.accentBg || 'rgba(200,180,240,0.3)';
  badge.style.color = g.accentColor || '#6d28d9';
  badge.innerHTML = (g.emoji || 'ðŸ’¬') + ' <span style="font-weight:900;">' + g.name + '</span>';
  document.getElementById('inviteEmailInput').value = '';
  document.getElementById('inviteMessageInput').value = '';
  document.getElementById('invitePreview').classList.remove('show');
  modal.classList.remove('hidden');
  setTimeout(() => document.getElementById('inviteEmailInput').focus(), 120);
}

function closeInviteModal() {
  document.getElementById('inviteModal').classList.add('hidden');
}

function _buildInviteLink() {
  const base = window.location.href.split('?')[0];
  return base + '?join=' + encodeURIComponent(currentGroup);
}

function updateInvitePreview() {
  const email = document.getElementById('inviteEmailInput').value.trim();
  const msg   = document.getElementById('inviteMessageInput').value.trim();
  const preview = document.getElementById('invitePreview');
  const body    = document.getElementById('invitePreviewBody');
  const linkEl  = document.getElementById('invitePreviewLink');
  if (!email) { preview.classList.remove('show'); return; }
  const g = groupsData[currentGroup] || {};
  const myName = document.getElementById('sidebarName')?.textContent || 'Someone';
  body.innerHTML = (msg ? '<b>"' + msg + '"</b><br>' : '') +
    myName + ' invited you to join <b>' + (g.emoji||'ðŸ’¬') + ' ' + (g.name||'a group') + '</b> on Track &amp; Clock!';
  linkEl.textContent = _buildInviteLink();
  preview.classList.add('show');
}

function sendInviteEmail() {
  const email = document.getElementById('inviteEmailInput').value.trim();
  if (!email || !email.includes('@')) { showToast('âš ï¸ Enter a valid email address.', 2500); return; }
  if (!currentGroup) { showToast('âš ï¸ No group selected.', 2000); return; }

  const g = groupsData[currentGroup] || {};
  const myName = document.getElementById('sidebarName')?.textContent || 'Someone';
  const myEmail = document.getElementById('profileEmail')?.textContent || '';
  const personalMsg = document.getElementById('inviteMessageInput').value.trim();
  const link = _buildInviteLink();

  // 1. Write invite record to Firestore so the recipient sees it in-app on next login
  if (firebaseReady) {
    const inviteDoc = {
      groupId:     currentGroup,
      groupName:   g.name || 'Group',
      groupEmoji:  g.emoji || 'ðŸ’¬',
      inviterName: myName,
      inviterEmail: myEmail,
      message:     personalMsg,
      link:        link,
      ts:          Date.now(),
      status:      'pending'
    };
    const emailKey = _emailToKey(email);
    const inviteRef = db.collection('invites').doc(emailKey).collection('pending').doc();
    inviteRef.set(inviteDoc).then(() => {
      showToast('ðŸ“© Invite saved â€” they\'ll see it when they sign in!', 3000);
    }).catch(e => console.warn('[sendInvite Firestore]', e));
  }

  // 2. Open Gmail compose with a pre-filled email
  const subject = encodeURIComponent(myName + ' invited you to ' + (g.emoji||'ðŸ’¬') + ' ' + (g.name||'a group') + ' on Track & Clock!');
  const body = encodeURIComponent(
    (personalMsg ? personalMsg + '\n\n' : '') +
    'Hey! ' + myName + ' has invited you to join their group "' + (g.name||'group') + '" on Track & Clock ðŸŽ‰\n\n' +
    'âœ¨ Click the link below to join:\n' + link + '\n\n' +
    'â€” Track & Clock'
  );
  const gmailUrl = 'https://mail.google.com/mail/?view=cm&to=' + encodeURIComponent(email) +
    '&su=' + subject + '&body=' + body;
  window.open(gmailUrl, '_blank');

  closeInviteModal();
  showToast('ðŸ“§ Gmail opened! Send the email to complete the invite.', 3500);
}

function copyInviteLink() {
  if (!currentGroup) { showToast('âš ï¸ No group selected.', 2000); return; }
  const link = _buildInviteLink();
  navigator.clipboard.writeText(link).then(() => {
    const btn = document.getElementById('inviteCopyBtn');
    if (btn) { btn.textContent = 'âœ… Copied!'; setTimeout(() => { btn.textContent = 'ðŸ”— Copy Link'; }, 2200); }
    showToast('ðŸ”— Invite link copied!', 2200);
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = link; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    showToast('ðŸ”— Invite link copied!', 2200);
  });
}

// â”€â”€ Listen for in-app invites sent to this user's email via Firestore â”€â”€
let _inviteListener = null;
function listenForIncomingInvites(email) {
  if (!firebaseReady || !email || email === 'â€”') return;
  if (_inviteListener) { try { _inviteListener(); } catch(e) {} }
  const emailKey = _emailToKey(email);
  _inviteListener = db.collection('invites').doc(emailKey).collection('pending')
    .where('status', '==', 'pending')
    .onSnapshot(snap => {
      snap.docChanges().forEach(change => {
        if (change.type === 'added') {
          const inv = change.doc.data();
          const docId = change.doc.id;
          // Don't show our own invites
          const myEmail = document.getElementById('profileEmail')?.textContent || '';
          if (inv.inviterEmail && inv.inviterEmail === myEmail) return;
          // Don't re-add if already pending
          if (pendingInvites.some(p => p.groupId === inv.groupId)) return;
          // Use addGroupInvite which handles pendingInvites push, badge, toast and banner
          // Attach Firestore metadata after so accept/decline can clean up the doc
          addGroupInvite(inv.groupId, inv.groupName, inv.groupEmoji||'ðŸ’¬', inv.inviterName||'Someone');
          // Attach Firestore cleanup metadata to the entry that was just pushed
          const entry = pendingInvites.find(p => p.groupId === inv.groupId);
          if (entry) { entry._firestoreId = docId; entry._firestoreEmail = emailKey; }
          // Mark as delivered so we don't show it again on next load
          change.doc.ref.update({status: 'delivered'}).catch(()=>{});
        }
      });
    }, e => console.warn('[inviteListener]', e));
}

function toggleNotifPanel(){
  notifPanelOpen=!notifPanelOpen;
  document.getElementById('notifPanel').classList.toggle('hidden',!notifPanelOpen);
  if(notifPanelOpen){
    notifications.forEach(n=>n.read=true);
    unreadCount=0;
    updateNotifBadge();
    renderNotifList();
    renderInviteList();
    updateInviteBadge();
  }
}
document.addEventListener('click',function(e){
  if(notifPanelOpen&&!e.target.closest('#notifPanel')&&!e.target.closest('#notifBellBtn')){
    notifPanelOpen=false;document.getElementById('notifPanel').classList.add('hidden');
  }
});
function showToastNotif(icon,title,msg){
  const t=document.createElement('div');t.className='toast-notif';
  t.innerHTML=`<span class="toast-notif-icon">${icon}</span><div class="toast-notif-body"><div class="toast-notif-title">${title}</div><div class="toast-notif-msg">${msg}</div></div>`;
  document.body.appendChild(t);
  setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.remove(),350);},4500);
}
function addReminder(){
  const name=document.getElementById('notifTaskName').value.trim();
  const dt=document.getElementById('notifDateTime').value;
  if(!name||!dt){showToast('âš ï¸ Please enter a task name and date/time.',2500);return;}
  const fireAt=new Date(dt).getTime();const now2=Date.now();
  if(fireAt<=now2){showToast('âš ï¸ Please pick a future date and time!',2500);return;}
  const delay=fireAt-now2;
  const label=new Date(dt).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
  reminders.push({name,dt,timer:setTimeout(()=>{addNotification('warning','â°','Task Reminder!',`Time to work on: "${name}"`);},delay)});
  document.getElementById('notifTaskName').value='';document.getElementById('notifDateTime').value='';
  showToast(`â° Reminder set for ${label}!`,3000);
  addNotification('unread','ðŸ“Œ','Reminder Scheduled',`"${name}" â€” ${label}`);
}
function checkDeadlineAlerts(){
  const now=new Date();const tomorrow=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1);
  const tKey=`${tomorrow.getFullYear()}-${String(tomorrow.getMonth()+1).padStart(2,'0')}-${String(tomorrow.getDate()).padStart(2,'0')}`;
  if(calTasks[tKey]&&calTasks[tKey].length){
    const pending=calTasks[tKey].filter(t=>!t.done);
    if(pending.length)addNotification('warning','âš ï¸','Deadline Tomorrow!',`You have ${pending.length} task(s) due tomorrow. Don't forget!`);
  }
}
setTimeout(checkDeadlineAlerts,3000);setInterval(checkDeadlineAlerts,3600000);
const bellStyle=document.createElement('style');
bellStyle.textContent=`@keyframes bellShake{0%,100%{transform:rotate(0)}20%{transform:rotate(-15deg) scale(1.15)}40%{transform:rotate(15deg)}60%{transform:rotate(-10deg)}80%{transform:rotate(8deg)}}`;
document.head.appendChild(bellStyle);

// ===================================================
// AVATAR STYLE TEMPLATES
// ===================================================
const styleTemplates={
  coquette:{label:'ðŸŽ€ Coquette',greeting:"Oh darling, isn't everything just a little more beautiful today?",desc:'ðŸŽ€ <b>Coquette</b> â€” Soft, romantic & feminine.<br>ðŸ’— Sundress Â· Mini Skirt Â· Ballet Heels Â· Bow Â· Long Wavy hair',state:{shirt:'sundress',shirtColor:'#ffd6e0',pants:'miniskirt',pantsColor:'#f9a8d4',shoes:'heels',shoeColor:'#ffd6e0',acc:'bow',hair:'long',hairColor:'#f5d060',eyeColor:'#5b8dee',bg:'radial-gradient(circle at 50% 70%,#ffe8f0,#ffd6c8)'}},
  y2k:{label:'ðŸ’¿ Y2K',greeting:"It's giving two thousand and fabulous. Let's go!",desc:'ðŸ’¿ <b>Y2K</b> â€” Chrome, bold & futuristic 2000s energy.<br>âœ¨ Stripes Â· Mini Skirt Â· White Sneakers Â· Headphones Â· Twin Buns',state:{shirt:'stripes',shirtColor:'#e0e0e0',pants:'miniskirt',pantsColor:'#c9b3e8',shoes:'sneakers',shoeColor:'#ffffff',acc:'headphones',hair:'twin',hairColor:'#e0e0e0',eyeColor:'#67e8f9',bg:'radial-gradient(circle at 50% 70%,#c8e8ff,#d0f0ff)'}},
  emo:{label:'ðŸ–¤ Emo',greeting:"Nobody understands me... and honestly? I love that.",desc:'ðŸ–¤ <b>Emo</b> â€” Dark, expressive & unapologetically emotional.<br>ðŸ–¤ Black Hoodie Â· Plaid Â· Combat Boots Â· Wings Â· Sidetail',state:{shirt:'hoodie',shirtColor:'#1f2937',pants:'plaid',pantsColor:'#1f2937',shoes:'boots',shoeColor:'#1f2937',acc:'wings',hair:'sidetail',hairColor:'#1a1a2e',eyeColor:'#a78bfa',bg:'radial-gradient(circle at 50% 70%,#3a2a70,#1a1040)'}},
  cottagecore:{label:'ðŸŒ¿ Cottagecore',greeting:"Come sit with me in the meadow. I made lavender scones.",desc:'ðŸŒ¿ <b>Cottagecore</b> â€” Dreamy, nature-inspired & cozy.<br>ðŸŒ¸ Sundress Â· Long Skirt Â· Loafers Â· Flower Crown Â· Braids',state:{shirt:'sundress',shirtColor:'#b8f0c8',pants:'skirt',pantsColor:'#fde68a',shoes:'loafers',shoeColor:'#92400e',acc:'flower',hair:'braids',hairColor:'#e87878',eyeColor:'#4caf50',bg:'radial-gradient(circle at 50% 70%,#d0f8e8,#c0f0ff)'}},
  darkacademia:{label:'ðŸ“– Dark Academia',greeting:"The pursuit of knowledge is the only true romance.",desc:'ðŸ“– <b>Dark Academia</b> â€” Scholarly, moody & intellectual.<br>ðŸ“š Uniform Â· Plaid Â· Loafers Â· Glasses Â· Short Bob',state:{shirt:'uniform',shirtColor:'#92400e',pants:'plaid',pantsColor:'#5c3d2e',shoes:'loafers',shoeColor:'#5c3d2e',acc:'glasses',hair:'short',hairColor:'#5c3d2e',eyeColor:'#f59e0b',bg:'radial-gradient(circle at 50% 70%,#fff8d0,#ffe0a0)'}},
  streetwear:{label:'ðŸ§¢ Streetwear',greeting:"Drip too hard, they might slip. Stay fresh.",desc:'ðŸ§¢ <b>Streetwear</b> â€” Urban, bold & effortlessly cool.<br>ðŸ”¥ Hoodie Â· Jeans Â· Chunky Sneakers Â· Headphones Â· Curly hair',state:{shirt:'hoodie',shirtColor:'#1f2937',pants:'jeans',pantsColor:'#4a74a8',shoes:'sneakers',shoeColor:'#ffffff',acc:'headphones',hair:'curly',hairColor:'#1a1a2e',eyeColor:'#2d1f14',bg:'radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0)'}},
  kawaii:{label:'ðŸŒ¸ Kawaii',greeting:"Hii~! You're so cute for picking me! Yay yay yay!",desc:'ðŸŒ¸ <b>Kawaii</b> â€” Super cute, pastel & adorable overload!<br>ðŸ“ Bear Top Â· Mini Skirt Â· Mary Janes Â· Cat Ears Â· Pink Twin Buns',state:{shirt:'bear',shirtColor:'#f9a8d4',pants:'miniskirt',pantsColor:'#c9b3e8',shoes:'heels',shoeColor:'#ffd6e0',acc:'catears',hair:'twin',hairColor:'#f9a8d4',eyeColor:'#a78bfa',bg:'radial-gradient(circle at 50% 70%,#ffe8f0,#ffd6c8)'}},
  baddie:{label:'ðŸ’… Baddie',greeting:"I don't chase. I attract. Big difference.",desc:'ðŸ’… <b>Baddie</b> â€” Confident, fierce & glamorous.<br>ðŸ”¥ Crop Top Â· Leggings Â· Stilettos Â· Crown Â· Sleek Ponytail',state:{shirt:'tshirt',shirtColor:'#dc2626',pants:'leggings',pantsColor:'#1f2937',shoes:'heels',shoeColor:'#1f2937',acc:'crown',hair:'ponytail',hairColor:'#1a1a2e',eyeColor:'#ef4444',bg:'radial-gradient(circle at 50% 70%,#3a2a70,#1a1040)'}},
  boho:{label:'ðŸ‚ Boho',greeting:"Free your soul, let the wind decide. I'm here for it.",desc:'ðŸ‚ <b>Boho</b> â€” Free-spirited, earthy & effortlessly chic.<br>ðŸŒ» Sundress Â· Flowy Skirt Â· Barefoot Â· Flower Â· Wavy Auburn hair',state:{shirt:'sundress',shirtColor:'#f97316',pants:'skirt',pantsColor:'#92400e',shoes:'barefoot',shoeColor:'#e8a87c',acc:'flower',hair:'long',hairColor:'#e87878',eyeColor:'#f59e0b',bg:'radial-gradient(circle at 50% 70%,#fff8d0,#ffe0a0)'}},
  pastelgoth:{label:'ðŸ•¸ï¸ Pastel Goth',greeting:"Soft on the outside, dark on the inside... that's just my vibe.",desc:'ðŸ•¸ï¸ <b>Pastel Goth</b> â€” Soft meets dark, adorably edgy.<br>ðŸ’œ Stripes Â· Purple Plaid Â· Platform Boots Â· Wings Â· Lavender Bob',state:{shirt:'stripes',shirtColor:'#c9b3e8',pants:'plaid',pantsColor:'#a78bfa',shoes:'boots',shoeColor:'#c9b3e8',acc:'wings',hair:'short',hairColor:'#c9b3e8',eyeColor:'#a78bfa',bg:'radial-gradient(circle at 50% 70%,#3a2a70,#1a1040)'}},
  royalcore:{label:'ðŸ‘‘ Royalcore',greeting:"Your royal highness has arrived. The court may now rejoice.",desc:'ðŸ‘‘ <b>Royalcore</b> â€” Regal, opulent & majestic.<br>âœ¨ Sundress Â· Skirt Â· Heels Â· Crown Â· Golden hair',state:{shirt:'sundress',shirtColor:'#8b5cf6',pants:'skirt',pantsColor:'#6d28d9',shoes:'heels',shoeColor:'#fde68a',acc:'crown',hair:'long',hairColor:'#f5d060',eyeColor:'#a78bfa',bg:'radial-gradient(circle at 50% 70%,#3a1a6e,#6d28d9)'}},
  cyberpunk:{label:'ðŸ¤– Cyberpunk',greeting:"System online. Neural link established. Ready to dominate.",desc:'ðŸ¤– <b>Cyberpunk</b> â€” Neon, edgy & futuristic.<br>ðŸ’™ Hoodie Â· Leggings Â· Boots Â· Glasses Â· Cyan hair',state:{shirt:'hoodie',shirtColor:'#1f2937',pants:'leggings',pantsColor:'#1f2937',shoes:'boots',shoeColor:'#f59e0b',acc:'glasses',hair:'short',hairColor:'#67e8f9',eyeColor:'#67e8f9',bg:'radial-gradient(circle at 50% 70%,#0f172a,#1e1b4b)'}},
  fairycore:{label:'ðŸ§š Fairycore',greeting:"I'm sprinkling a little magic dust on your day. You're welcome!",desc:'ðŸ§š <b>Fairycore</b> â€” Magical, whimsical & dreamy.<br>ðŸŒ¸ Sundress Â· Skirt Â· Heels Â· Wings Â· Pink hair',state:{shirt:'sundress',shirtColor:'#fce7f3',pants:'skirt',pantsColor:'#fbcfe8',shoes:'heels',shoeColor:'#f9a8d4',acc:'wings',hair:'long',hairColor:'#f9a8d4',eyeColor:'#5b8dee',bg:'radial-gradient(circle at 50% 70%,#fdf2f8,#e0f2fe)'}},
  angelcore:{label:'ðŸ˜‡ Angelcore',greeting:"Heaven sent, just for you. Be good today, okay?",desc:'ðŸ˜‡ <b>Angelcore</b> â€” Pure, soft & heavenly.<br>ðŸ¤ Uniform Â· Pants Â· Heels Â· Halo Â· Silver hair',state:{shirt:'uniform',shirtColor:'#ffffff',pants:'pants',pantsColor:'#f0f0f0',shoes:'heels',shoeColor:'#ffffff',acc:'halo',hair:'long',hairColor:'#e0e0e0',eyeColor:'#b8f0c8',bg:'radial-gradient(circle at 50% 70%,#fffbeb,#fef3c7)'}},
  darkfantasy:{label:'ðŸ‰ Dark Fantasy',greeting:"The dragon awakens... and she's wearing boots.",desc:'ðŸ‰ <b>Dark Fantasy</b> â€” Mysterious, dark & epic.<br>ðŸ–¤ Hoodie Â· Leggings Â· Boots Â· Wings Â· Dark hair',state:{shirt:'hoodie',shirtColor:'#1f2937',pants:'leggings',pantsColor:'#111827',shoes:'boots',shoeColor:'#1f2937',acc:'wings',hair:'long',hairColor:'#1a1a2e',eyeColor:'#a78bfa',bg:'radial-gradient(circle at 50% 70%,#1a0a2e,#0d0d1a)'}},
  ethereal:{label:'âœ¨ Ethereal',greeting:"I'm floating between worlds right now. It's actually quite nice.",desc:'âœ¨ <b>Ethereal</b> â€” Soft, glowing & otherworldly.<br>ðŸ’œ Sundress Â· Skirt Â· Heels Â· Halo Â· Lavender hair',state:{shirt:'sundress',shirtColor:'#e0d0f8',pants:'skirt',pantsColor:'#d8c4f0',shoes:'heels',shoeColor:'#c9b3e8',acc:'halo',hair:'long',hairColor:'#c9b3e8',eyeColor:'#c9b3e8',bg:'radial-gradient(circle at 50% 70%,#f3e8ff,#e0f2fe)'}},
  vaporwave:{label:'ðŸŒŠ Vaporwave',greeting:"Aesthetic loading... retrowave activated. Feel the vibes.",desc:'ðŸŒŠ <b>Vaporwave</b> â€” Retro, aesthetic & dreamy 80s vibes.<br>ðŸ’œ Stripes Â· Leggings Â· Sneakers Â· Headphones Â· Pink hair',state:{shirt:'stripes',shirtColor:'#a78bfa',pants:'leggings',pantsColor:'#7c3aed',shoes:'sneakers',shoeColor:'#ec4899',acc:'headphones',hair:'twin',hairColor:'#f9a8d4',eyeColor:'#67e8f9',bg:'radial-gradient(circle at 50% 70%,#4c1d95,#1e1b4b)'}},
  witchcore:{label:'ðŸ”® Witchcore',greeting:"The cauldron is bubbling... your spell has been cast.",desc:'ðŸ”® <b>Witchcore</b> â€” Mystical, moody & spellbinding.<br>ðŸ–¤ Hoodie Â· Skirt Â· Boots Â· Cat Ears Â· Dark hair',state:{shirt:'hoodie',shirtColor:'#1f2937',pants:'skirt',pantsColor:'#111827',shoes:'boots',shoeColor:'#5c3d2e',acc:'catears',hair:'long',hairColor:'#1a1a2e',eyeColor:'#8b5cf6',bg:'radial-gradient(circle at 50% 70%,#2d1b4e,#1a0a2e)'}}
};

function applyStyle(styleName,btn){
  const s=styleTemplates[styleName];if(!s)return;
  currentStyleName = styleName;
  document.querySelectorAll('.style-chip').forEach(c=>c.classList.remove('active'));btn.classList.add('active');
  const box=document.getElementById('stylePreviewBox');
  document.getElementById('stylePreviewDesc').innerHTML=s.desc;box.classList.add('show');
  const st=s.state;avState={...avState,...st};
  if(st.shirt)document.querySelectorAll('#shirtStyleRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.shirt}'`)));
  if(st.pants)document.querySelectorAll('#pantsRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.pants}'`)));
  if(st.shoes)document.querySelectorAll('#shoeRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.shoes}'`)));
  if(st.acc)document.querySelectorAll('#accRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.acc}'`)));
  if(st.hair)document.querySelectorAll('#hairStyleRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.hair}'`)));
  if(st.bg)document.getElementById('avBg').style.background=st.bg;
  if(st.eyeColor){avState.eyeColor=st.eyeColor;['avIrisColorL','avIrisColorR'].forEach(id=>{const el=document.getElementById(id);if(el)el.setAttribute('fill',st.eyeColor);});}
  updateAvatar();showToast(`${s.label} style applied! âœ¨`,2200);
  // Speak greeting only for pro styles
  if(s.greeting && isProStyle(styleName)){
    setTimeout(()=>speakText(s.greeting), 350);
  }
}

// ===================================================
// ANIMATED THEME BACKGROUND CANVAS ENGINE
// ===================================================
const TC = window.themePainter = (() => {
  const canvas = document.getElementById('themeBgCanvas');
  const ctx = canvas.getContext('2d');
  let W, H, frame = 0, animId = null, currentScene = null;

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // ---- Shared helpers ----
  function lerp(a,b,t){return a+(b-a)*t;}
  function easeInOut(t){return t<0.5?2*t*t:1-Math.pow(-2*t+2,2)/2;}
  function rand(a,b){return a+Math.random()*(b-a);}
  function hsl(h,s,l,a=1){return `hsla(${h},${s}%,${l}%,${a})`;}

  // ---- Star helper ----
  function drawStar(x,y,r,t,col){
    ctx.save();ctx.beginPath();ctx.arc(x,y,r*(0.7+0.3*Math.sin(t)),0,Math.PI*2);
    ctx.fillStyle=col||'rgba(255,255,255,0.9)';ctx.shadowBlur=r*4;ctx.shadowColor=col||'white';ctx.fill();ctx.restore();
  }

  // ============================================================
  // SCENES
  // ============================================================

  // ------ LAVENDER DREAM: rolling lavender hills, floating petals, soft auroras ------
  const lavScene = (()=>{
    const petals = Array.from({length:28},(_,i)=>({x:rand(0,1),y:rand(0,1),r:rand(0.5,1.4),a:rand(0,Math.PI*2),va:rand(-0.01,0.01),vx:rand(-0.00015,0.00015),vy:rand(0.00008,0.00022),op:rand(0.35,0.75)}));
    const fireflies = Array.from({length:18},(_,i)=>({x:rand(0.2,0.8),y:rand(0.3,0.7),px:rand(0.2,0.8),py:rand(0.3,0.7),ph:rand(0,1),sp:rand(0.002,0.006)}));
    return function(){
      const t = frame/160;
      // Sky gradient â€” soft dusk lavender
      const sky = ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(270,45,82));sky.addColorStop(0.5,hsl(280,50,75));sky.addColorStop(1,hsl(290,40,65));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Aurora wisps
      for(let i=0;i<3;i++){
        const ax=W*(0.2+i*0.3+0.04*Math.sin(t*0.7+i));const aw=W*(0.28+0.08*Math.sin(t*0.5+i));
        const ag=ctx.createLinearGradient(ax-aw/2,0,ax+aw/2,0);
        ag.addColorStop(0,'transparent');ag.addColorStop(0.5,hsl(280+i*15,60,80,0.12));ag.addColorStop(1,'transparent');
        ctx.fillStyle=ag;ctx.fillRect(ax-aw/2,H*0.05,aw,H*0.5);
      }

      // Rolling hills
      [[hsl(280,35,58),0.72],[hsl(285,40,52),0.82],[hsl(275,45,62),0.88]].forEach(([col,hy],i)=>{
        ctx.beginPath();ctx.moveTo(0,H);
        for(let x=0;x<=W;x+=4){
          const wv = Math.sin(x/W*Math.PI*3+t*0.3+i*1.2)*H*0.035+Math.sin(x/W*Math.PI*5+t*0.2+i)*H*0.018;
          ctx.lineTo(x,H*hy+wv);
        }
        ctx.lineTo(W,H);ctx.closePath();ctx.fillStyle=col;ctx.fill();
      });

      // Lavender flower patches on hills
      for(let i=0;i<40;i++){
        const px=(i/40+0.01*Math.sin(t*0.5+i))*W;
        const py=H*0.83+Math.sin(px/W*Math.PI*4+t*0.3)*H*0.03;
        const bob=Math.sin(t*2+i)*2;
        ctx.fillStyle=hsl(280,60,68,0.7);
        ctx.beginPath();ctx.arc(px,py+bob,3.5,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(px,py+bob-7,2.5,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle=hsl(300,20,45,0.5);ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(px,py+bob+3);ctx.lineTo(px,py+bob+11);ctx.stroke();
      }

      // Floating petals
      petals.forEach(p=>{
        p.x+=p.vx;p.y+=p.vy;p.a+=p.va;
        if(p.y>1.05)p.y=-.05;if(p.x<-.05)p.x=1.05;if(p.x>1.05)p.x=-.05;
        ctx.save();ctx.translate(p.x*W,p.y*H);ctx.rotate(p.a);
        ctx.fillStyle=hsl(300,60,82,p.op);
        ctx.beginPath();ctx.ellipse(0,0,p.r*6,p.r*10,0,0,Math.PI*2);ctx.fill();
        ctx.restore();
      });

      // Fireflies
      fireflies.forEach(f=>{
        f.ph+=f.sp;
        const fx=lerp(f.px,f.x,easeInOut(f.ph));const fy=lerp(f.py,f.y,easeInOut(f.ph));
        if(f.ph>=1){f.px=f.x;f.py=f.y;f.x=rand(0.1,0.9);f.y=rand(0.3,0.75);f.ph=0;f.sp=rand(0.002,0.006);}
        const glow=0.4+0.6*Math.sin(frame*0.08+f.px*10);
        drawStar(fx*W,fy*H,2.2,frame*0.07,hsl(60,100,85,glow));
      });
    };
  })();

  // ------ OCEAN BREEZE: deep sea with waves, fish, bubbles, caustic light ------
  const oceanScene = (()=>{
    const bubbles = Array.from({length:30},()=>({x:rand(0,1),y:rand(0,1),r:rand(1.5,4.5),sp:rand(0.0004,0.0014)}));
    const fish = Array.from({length:12},()=>({x:rand(0,1),y:rand(0.3,0.75),sp:rand(0.0005,0.0018),dir:Math.random()>0.5?1:-1,vy:rand(-.0003,.0003),col:['#ffa07a','#ffec8b','#f0a8d0','#a0d8ef'][Math.floor(rand(0,4))]}));
    const caustics = Array.from({length:18},()=>({x:rand(0,1),y:rand(0.1,0.6),r:rand(20,60),t:rand(0,Math.PI*2)}));
    return function(){
      const t=frame/120;
      // Ocean gradient
      const sky=ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(200,70,55));sky.addColorStop(0.35,hsl(200,65,42));sky.addColorStop(0.65,hsl(210,70,30));sky.addColorStop(1,hsl(220,70,18));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Sun/moon reflection on water surface
      const sunX=W*0.62;const sunY=H*0.13;
      const sunGrad=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,80);
      sunGrad.addColorStop(0,hsl(50,100,92,0.95));sunGrad.addColorStop(0.3,hsl(45,90,72,0.6));sunGrad.addColorStop(1,'transparent');
      ctx.fillStyle=sunGrad;ctx.fillRect(0,0,W,H);

      // Sun shimmer on horizon
      const refl=ctx.createLinearGradient(sunX-80,H*0.36,sunX+80,H*0.36);
      refl.addColorStop(0,'transparent');refl.addColorStop(0.5,hsl(50,90,80,0.35+0.15*Math.sin(t*1.8)));refl.addColorStop(1,'transparent');
      ctx.fillStyle=refl;ctx.fillRect(sunX-W*0.15,H*0.34,W*0.3,H*0.35);

      // Caustic light patches
      caustics.forEach(c=>{
        c.t+=0.018;const cx=c.x*W+30*Math.sin(c.t);const cy=c.y*H+20*Math.cos(c.t*0.7);
        const cg=ctx.createRadialGradient(cx,cy,0,cx,cy,c.r);
        cg.addColorStop(0,hsl(190,70,80,0.06+0.04*Math.sin(c.t)));cg.addColorStop(1,'transparent');
        ctx.fillStyle=cg;ctx.fillRect(cx-c.r,cy-c.r,c.r*2,c.r*2);
      });

      // Bubbles
      bubbles.forEach(b=>{
        b.y-=b.sp;b.x+=Math.sin(b.y*50+t)*0.0004;
        if(b.y<-.02){b.y=1.05;b.x=rand(0,1);}
        ctx.save();ctx.globalAlpha=0.35;ctx.strokeStyle='rgba(180,230,255,0.8)';ctx.lineWidth=1.2;
        ctx.beginPath();ctx.arc(b.x*W,b.y*H,b.r,0,Math.PI*2);ctx.stroke();
        ctx.restore();
      });

      // Fish
      fish.forEach(f=>{
        f.x+=f.sp*f.dir;f.y+=f.vy;
        if(f.x>1.08){f.x=-.08;f.dir=1;}if(f.x<-.08){f.x=1.08;f.dir=-1;}
        if(f.y<.2)f.vy=Math.abs(f.vy);if(f.y>.8)f.vy=-Math.abs(f.vy);
        const fx=f.x*W,fy=f.y*H;
        ctx.save();ctx.translate(fx,fy);ctx.scale(f.dir,1);
        ctx.fillStyle=f.col;ctx.beginPath();ctx.ellipse(0,0,14,7,0,0,Math.PI*2);ctx.fill();
        ctx.fillStyle=f.col;ctx.beginPath();ctx.moveTo(-12,0);ctx.lineTo(-20,-6);ctx.lineTo(-20,6);ctx.closePath();ctx.fill();
        ctx.fillStyle='rgba(0,0,0,0.6)';ctx.beginPath();ctx.arc(10,0,2,0,Math.PI*2);ctx.fill();
        ctx.restore();
      });

      // Wave layers at surface
      [[hsl(200,65,45,0.6),0.36],[hsl(195,70,38,0.7),0.38],[hsl(190,60,30,0.8),0.4]].forEach(([col,hy],i)=>{
        ctx.beginPath();ctx.moveTo(0,H);
        for(let x=0;x<=W;x+=6){
          const w=Math.sin(x/W*Math.PI*4+t*1.2+i*1.4)*H*0.012+Math.sin(x/W*Math.PI*7+t*0.8)*H*0.006;
          ctx.lineTo(x,H*hy+w);
        }
        ctx.lineTo(W,H);ctx.closePath();ctx.fillStyle=col;ctx.fill();
      });

      // Kelp/seaweed at bottom
      for(let i=0;i<16;i++){
        const kx=W*(0.04+i*0.062);const kh=H*(0.12+Math.random()*0.06);
        ctx.strokeStyle=hsl(155,50,25,0.65);ctx.lineWidth=3;
        ctx.beginPath();ctx.moveTo(kx,H);
        for(let j=0;j<6;j++){const jy=H-j*(kh/6);ctx.quadraticCurveTo(kx+15*Math.sin(t*1.2+i+j),jy-kh/12,kx,jy);}
        ctx.stroke();
      }
    };
  })();

  // ------ SUNSET SEA: golden sun sinking into ocean, waves, birds ------
  const sunsetScene = (()=>{
    const birds = Array.from({length:9},(_,i)=>({x:rand(0,1),y:rand(0.1,0.35),sp:rand(0.0006,0.0014),fl:rand(0,Math.PI*2),flsp:rand(0.04,0.09)}));
    const waves = Array.from({length:7},(_,i)=>({phase:rand(0,Math.PI*2),speed:rand(0.3,0.9),amp:rand(0.008,0.022),freq:rand(2.5,5)}));
    const clouds = Array.from({length:5},(_,i)=>({x:rand(0.05,0.9),y:rand(0.05,0.28),w:rand(0.12,0.25),spd:rand(0.00008,0.0002)}));
    return function(){
      const t=frame/100;
      const sunY=0.38+0.04*Math.sin(t*0.08); // slowly rising/setting

      // Sky gradient â€” warm sunset oranges/pinks
      const sky=ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(225,60,28));
      sky.addColorStop(0.25,hsl(270,50,45));
      sky.addColorStop(0.45,hsl(15,85,60));
      sky.addColorStop(0.55,hsl(35,95,62));
      sky.addColorStop(0.7,hsl(40,90,55));
      sky.addColorStop(1,hsl(200,60,35));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Atmospheric haze bands
      [[hsl(330,70,55,0.12),0.3,0.08],[hsl(20,80,60,0.1),0.42,0.06]].forEach(([col,cy,h])=>{
        ctx.fillStyle=col;ctx.fillRect(0,H*(cy-h/2),W,H*h);
      });

      // Sun
      const sunX=W*0.52;const sy=H*sunY;
      const suns=ctx.createRadialGradient(sunX,sy,0,sunX,sy,W*0.12);
      suns.addColorStop(0,hsl(50,100,96));suns.addColorStop(0.3,hsl(40,100,72));suns.addColorStop(0.7,hsl(20,90,55,0.5));suns.addColorStop(1,'transparent');
      ctx.fillStyle=suns;ctx.fillRect(0,0,W,H);
      // Sun disk
      ctx.fillStyle=hsl(48,100,88);ctx.shadowBlur=60;ctx.shadowColor=hsl(45,100,70);
      ctx.beginPath();ctx.arc(sunX,sy,W*0.038,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;

      // Clouds tinted orange/pink
      clouds.forEach(c=>{
        c.x+=c.spd;if(c.x>1.15)c.x=-.15;
        const cx=c.x*W,cy=c.y*H,cw=c.w*W;
        ctx.save();ctx.globalAlpha=0.55;
        [[0,0,cw*0.5,cw*0.18],[cw*0.25,-cw*0.12,cw*0.4,cw*0.16],[-cw*0.2,-cw*0.06,cw*0.38,cw*0.14]].forEach(([ox,oy,rx,ry])=>{
          const cg=ctx.createRadialGradient(cx+ox,cy+oy,0,cx+ox,cy+oy,Math.max(rx,ry));
          cg.addColorStop(0,hsl(15,90,78));cg.addColorStop(0.6,hsl(340,70,65));cg.addColorStop(1,'transparent');
          ctx.fillStyle=cg;ctx.beginPath();ctx.ellipse(cx+ox,cy+oy,rx,ry,0,0,Math.PI*2);ctx.fill();
        });
        ctx.restore();
      });

      // Sun reflection on water â€” golden caustic column
      const reflGrad=ctx.createLinearGradient(sunX-W*0.12,H*0.52,sunX+W*0.12,H*0.52);
      reflGrad.addColorStop(0,'transparent');reflGrad.addColorStop(0.5,hsl(45,100,65,0.5+0.15*Math.sin(t)));reflGrad.addColorStop(1,'transparent');
      ctx.fillStyle=reflGrad;
      for(let row=0;row<30;row++){
        const rowY=H*(0.52+row*0.016);const rowW=W*(0.04+row*0.007);
        const ro=0.85-row*0.025;if(ro<=0)break;
        ctx.globalAlpha=ro;ctx.fillRect(sunX-rowW/2,rowY,rowW,H*0.018);
      }
      ctx.globalAlpha=1;

      // Ocean waves
      const horizonY=H*0.55;
      const ocean=ctx.createLinearGradient(0,horizonY,0,H);
      ocean.addColorStop(0,hsl(210,60,35));ocean.addColorStop(0.4,hsl(215,65,28));ocean.addColorStop(1,hsl(220,55,18));
      ctx.fillStyle=ocean;ctx.fillRect(0,horizonY,W,H);

      waves.forEach((wv,i)=>{
        const wOpacity=0.15+i*0.04;
        ctx.save();ctx.globalAlpha=wOpacity;
        ctx.beginPath();ctx.moveTo(0,H);
        for(let x=0;x<=W;x+=5){
          const y=horizonY+H*(0.04+i*0.06)+Math.sin(x/W*Math.PI*wv.freq+t*wv.speed+wv.phase)*H*wv.amp;
          ctx.lineTo(x,y);
        }
        ctx.lineTo(W,H);ctx.closePath();
        ctx.fillStyle=hsl(210,55,28+i*4);ctx.fill();
        ctx.restore();
        // Wave crest foam
        ctx.save();ctx.globalAlpha=0.18;ctx.strokeStyle='rgba(255,255,255,0.7)';ctx.lineWidth=1.5;
        ctx.beginPath();
        for(let x=0;x<=W;x+=5){
          const y=horizonY+H*(0.04+i*0.06)+Math.sin(x/W*Math.PI*wv.freq+t*wv.speed+wv.phase)*H*wv.amp;
          x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        }ctx.stroke();ctx.restore();
      });

      // Silhouette coastline
      ctx.beginPath();ctx.moveTo(0,H);
      ctx.lineTo(0,H*0.82);ctx.quadraticCurveTo(W*0.08,H*0.78,W*0.15,H*0.80);
      ctx.quadraticCurveTo(W*0.22,H*0.83,W*0.28,H*0.79);
      ctx.lineTo(W*0.3,H*0.62);ctx.lineTo(W*0.33,H*0.6);ctx.lineTo(W*0.36,H*0.62);ctx.lineTo(W*0.38,H*0.81);
      ctx.quadraticCurveTo(W*0.5,H*0.84,W*0.62,H*0.83);ctx.lineTo(W,H*0.85);ctx.lineTo(W,H);ctx.closePath();
      ctx.fillStyle='rgba(20,10,5,0.7)';ctx.fill();

      // Palm tree silhouettes
      [[0.28,0.62],[0.33,0.60],[0.36,0.62]].forEach(([px,py])=>{
        const tx=W*px,ty=H*py;
        ctx.save();ctx.strokeStyle='rgba(15,8,3,0.85)';ctx.lineWidth=3;
        // Trunk
        ctx.beginPath();ctx.moveTo(tx,ty);
        ctx.quadraticCurveTo(tx+8,ty-H*0.12,tx+5,ty-H*0.22);ctx.stroke();
        // Fronds
        [[-40,-15,30,-50],[-20,-10,45,-38],[10,-5,50,-30],[-50,-20,-10,-55],[20,-8,60,-25]].forEach(([bx,by,ex,ey])=>{
          ctx.beginPath();ctx.moveTo(tx+5,ty-H*0.22);ctx.quadraticCurveTo(tx+bx,ty-H*0.22+by,tx+ex,ty-H*0.22+ey);ctx.lineWidth=2.5;ctx.stroke();
        });
        ctx.restore();
      });

      // Birds
      birds.forEach(b=>{
        b.x+=b.sp;b.fl+=b.flsp;if(b.x>1.1)b.x=-.1;
        const bx=b.x*W,by=b.y*H,fw=Math.sin(b.fl)*5;
        ctx.save();ctx.strokeStyle='rgba(20,10,5,0.72)';ctx.lineWidth=2;
        ctx.beginPath();ctx.moveTo(bx-10,by);ctx.quadraticCurveTo(bx-5,by-fw,bx,by);ctx.quadraticCurveTo(bx+5,by-fw,bx+10,by);ctx.stroke();
        ctx.restore();
      });
    };
  })();

  // ------ FOREST: misty woodland, fireflies, shafts of light, rain ------
  const forestScene = (()=>{
    const fireflies = Array.from({length:22},()=>({x:rand(0.05,0.95),y:rand(0.35,0.8),tx:rand(0.05,0.95),ty:rand(0.35,0.8),p:0,sp:rand(0.003,0.007)}));
    const leaves = Array.from({length:20},()=>({x:rand(0,1),y:rand(-.1,1),vx:rand(-.0006,.0006),vy:rand(.0003,.0010),a:rand(0,Math.PI*2),va:rand(-.02,.02),op:rand(0.4,.8)}));
    return function(){
      const t=frame/130;
      // Sky through canopy
      const sky=ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(125,40,22));sky.addColorStop(0.4,hsl(130,45,32));sky.addColorStop(0.7,hsl(120,50,38));sky.addColorStop(1,hsl(115,45,28));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Mist layers
      for(let i=0;i<4;i++){
        const my=H*(0.55+i*0.12);const mg=ctx.createLinearGradient(0,my,0,my+H*0.1);
        mg.addColorStop(0,'transparent');mg.addColorStop(0.5,hsl(130,30,75,0.07+0.03*Math.sin(t*0.5+i)));mg.addColorStop(1,'transparent');
        ctx.fillStyle=mg;ctx.fillRect(0,my,W,H*0.1);
      }

      // Light shafts from canopy
      for(let i=0;i<6;i++){
        const sx=W*(0.1+i*0.16+0.04*Math.sin(t*0.3+i));
        ctx.save();ctx.globalAlpha=0.04+0.025*Math.sin(t*0.6+i);
        ctx.fillStyle=hsl(80,60,85);
        ctx.beginPath();ctx.moveTo(sx-20,0);ctx.lineTo(sx+20,0);ctx.lineTo(sx+60,H*0.7);ctx.lineTo(sx-60,H*0.7);ctx.closePath();ctx.fill();
        ctx.restore();
      }

      // Ground + undergrowth
      ctx.fillStyle=hsl(120,40,18);ctx.fillRect(0,H*0.82,W,H*0.18);
      for(let i=0;i<50;i++){
        const gx=W*(i/50);const gy=H*0.82;const gh=H*(0.04+0.02*Math.sin(i*3.7+t*1.5));
        ctx.strokeStyle=hsl(120,50,28,0.6);ctx.lineWidth=2;
        ctx.beginPath();ctx.moveTo(gx,gy);ctx.quadraticCurveTo(gx+5*Math.sin(t+i),gy-gh/2,gx,gy-gh);ctx.stroke();
      }

      // Tree trunks (back to front)
      const treePositions=[0.05,0.14,0.22,0.36,0.48,0.58,0.7,0.81,0.9,0.97];
      treePositions.forEach((tx2,i)=>{
        const txx=W*tx2;const tw=W*(0.028+0.012*(i%3));const th=H*(0.6+0.15*(i%4));
        const bark=ctx.createLinearGradient(txx-tw/2,0,txx+tw/2,0);
        bark.addColorStop(0,hsl(30,30,14));bark.addColorStop(0.4,hsl(30,35,22));bark.addColorStop(0.7,hsl(30,28,16));bark.addColorStop(1,hsl(30,30,12));
        ctx.fillStyle=bark;ctx.fillRect(txx-tw/2,H-th,tw,th);
        // Moss
        ctx.fillStyle=hsl(120,40,25,0.5);ctx.fillRect(txx-tw/2,H-th,tw*0.3,th*0.6);
      });

      // Foliage canopy
      treePositions.forEach((tx2,i)=>{
        const txx=W*tx2;const fy=H*(0.14+0.06*(i%3));const fr=W*(0.09+0.04*(i%4));
        const sway=5*Math.sin(t*0.8+i);
        ctx.save();ctx.globalAlpha=0.88;
        [[0,0,fr,fr],[sway-fr*0.5,-fr*0.2,fr*0.85,fr*0.85],[sway+fr*0.4,-fr*0.15,fr*0.8,fr*0.8]].forEach(([ox,oy,rr,rrr])=>{
          const fg=ctx.createRadialGradient(txx+ox,fy+oy,0,txx+ox,fy+oy,rr);
          fg.addColorStop(0,hsl(125,55,30));fg.addColorStop(0.6,hsl(120,50,22));fg.addColorStop(1,'transparent');
          ctx.fillStyle=fg;ctx.beginPath();ctx.ellipse(txx+ox,fy+oy,rr,rrr*0.75,0,0,Math.PI*2);ctx.fill();
        });
        ctx.restore();
      });

      // Falling leaves
      leaves.forEach(l=>{
        l.x+=l.vx+0.0003*Math.sin(t+l.y*5);l.y+=l.vy;l.a+=l.va;
        if(l.y>1.05){l.y=-.05;l.x=rand(0,1);}
        ctx.save();ctx.translate(l.x*W,l.y*H);ctx.rotate(l.a);ctx.globalAlpha=l.op;
        ctx.fillStyle=hsl(110+rand(-15,15),50,35);
        ctx.beginPath();ctx.ellipse(0,0,6,3,0,0,Math.PI*2);ctx.fill();
        ctx.restore();
      });

      // Fireflies
      fireflies.forEach(f=>{
        f.p+=f.sp;if(f.p>=1){f.tx=rand(0.05,0.95);f.ty=rand(0.35,0.8);f.p=0;}
        const fx=lerp(f.x,f.tx,f.p)*W;const fy=lerp(f.y,f.ty,f.p)*H;
        const glow=0.3+0.7*Math.sin(frame*0.06+f.x*8);
        drawStar(fx,fy,2.8,frame*0.05,hsl(65,100,75,glow));
      });
    };
  })();

  // ------ ROSE GARDEN: blooming roses, petals, morning light, butterflies ------
  const roseScene = (()=>{
    const petals2 = Array.from({length:35},()=>({x:rand(0,1),y:rand(0,1),vx:rand(-.0003,.0003),vy:rand(.00015,.0006),a:rand(0,Math.PI*2),va:rand(-.018,.018),h:rand(330,360),op:rand(.4,.8)}));
    const butterflies = Array.from({length:6},()=>({x:rand(0.2,0.8),y:rand(0.2,0.6),vx:rand(-.0005,.0005),vy:rand(-.0003,.0003),fl:rand(0,Math.PI*2),flsp:rand(0.06,0.1),col:[hsl(280,60,70),hsl(320,60,68),hsl(20,70,65)][Math.floor(rand(0,3))]}));
    return function(){
      const t=frame/110;
      // Rosy sky
      const sky=ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(300,45,72));sky.addColorStop(0.4,hsl(330,55,68));sky.addColorStop(0.65,hsl(350,50,62));sky.addColorStop(1,hsl(15,55,60));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Soft morning light bloom
      const bloom=ctx.createRadialGradient(W*0.45,H*0.2,0,W*0.45,H*0.2,W*0.5);
      bloom.addColorStop(0,hsl(50,100,90,0.3));bloom.addColorStop(0.4,hsl(30,80,75,0.12));bloom.addColorStop(1,'transparent');
      ctx.fillStyle=bloom;ctx.fillRect(0,0,W,H);

      // Garden ground
      ctx.fillStyle=hsl(120,30,22);ctx.fillRect(0,H*0.75,W,H*0.25);
      // Garden path (stone)
      ctx.fillStyle=hsl(25,15,50,0.4);
      ctx.beginPath();ctx.ellipse(W*0.5,H*0.95,W*0.12,H*0.12,0,0,Math.PI*2);ctx.fill();

      // Rose bushes
      const bushes=[0.1,0.25,0.42,0.58,0.72,0.88];
      bushes.forEach((bx,i)=>{
        const by=H*(0.72+0.04*(i%2));
        ctx.strokeStyle=hsl(120,35,22,0.7);ctx.lineWidth=3;
        ctx.beginPath();ctx.moveTo(bx*W,by);ctx.quadraticCurveTo(bx*W+15*Math.sin(t+i),by-H*0.16,bx*W+8*Math.sin(t*0.7+i),by-H*0.26);ctx.stroke();
        // Leaves
        [[8,-H*0.1],[-10,-H*0.15]].forEach(([lx,ly])=>{
          ctx.fillStyle=hsl(125,45,28,0.7);ctx.beginPath();ctx.ellipse(bx*W+lx,by+ly,10,5,0.4,0,Math.PI*2);ctx.fill();
        });
        // Rose blooms
        const roseColors=[hsl(345,75,55),hsl(350,80,62),hsl(5,70,55),hsl(320,65,60)];
        const rc=roseColors[i%4];
        [0,1,2].forEach(ring=>{
          const rRad=H*(0.018+ring*0.009);
          for(let p=0;p<5+ring;p++){
            const pa=(p/(5+ring))*Math.PI*2+ring*0.3+t*0.2;
            const px2=bx*W+8*Math.sin(t*0.7+i)+Math.cos(pa)*rRad*0.9;
            const py2=by-H*0.26+Math.sin(pa)*rRad*0.6;
            ctx.fillStyle=ring===0?hsl(50,80,65):rc;
            ctx.beginPath();ctx.ellipse(px2,py2,rRad*(0.9-ring*0.15),rRad*(0.65-ring*0.1),pa,0,Math.PI*2);ctx.fill();
          }
        });
      });

      // Falling petals
      petals2.forEach(p=>{
        p.x+=p.vx+0.0002*Math.sin(t+p.y*6);p.y+=p.vy;p.a+=p.va;
        if(p.y>1.05){p.y=-.05;p.x=rand(0,1);}
        ctx.save();ctx.translate(p.x*W,p.y*H);ctx.rotate(p.a);ctx.globalAlpha=p.op;
        ctx.fillStyle=hsl(p.h,65,70);ctx.beginPath();ctx.ellipse(0,0,5,8,0,0,Math.PI*2);ctx.fill();
        ctx.restore();
      });

      // Butterflies
      butterflies.forEach(b=>{
        b.x+=b.vx;b.y+=b.vy;b.fl+=b.flsp;
        if(b.x<0.05||b.x>0.95)b.vx*=-1;if(b.y<0.1||b.y>0.7)b.vy*=-1;
        const bx2=b.x*W,by2=b.y*H,fw=Math.sin(b.fl)*12;
        ctx.save();ctx.fillStyle=b.col;ctx.globalAlpha=0.75;
        ctx.beginPath();ctx.ellipse(bx2-fw/2,by2-3,Math.abs(fw)*0.6,5,-.3,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.ellipse(bx2+fw/2,by2-3,Math.abs(fw)*0.6,5,.3,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle='rgba(100,20,60,0.4)';ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(bx2,by2-8);ctx.lineTo(bx2,by2+5);ctx.stroke();
        ctx.restore();
      });
    };
  })();

  // ------ MIDNIGHT: deep space, shooting stars, aurora borealis, city silhouette ------
  const nightScene = (()=>{
    const stars2 = Array.from({length:160},()=>({x:rand(0,1),y:rand(0,.7),r:rand(.5,2.2),t:rand(0,Math.PI*2),ts:rand(.01,.05)}));
    const shootingStars = Array.from({length:4},()=>({x:rand(0,1),y:rand(0,.4),vx:rand(-.008,-.002),vy:rand(.002,.005),len:rand(60,140),life:0,maxLife:rand(60,110),wait:rand(0,200)}));
    const auroraPoints = Array.from({length:8},()=>rand(0,1));
    return function(){
      const t=frame/100;
      // Deep space gradient
      const space=ctx.createLinearGradient(0,0,0,H);
      space.addColorStop(0,'hsl(240,60%,6%)');space.addColorStop(0.3,'hsl(250,55%,10%)');
      space.addColorStop(0.6,'hsl(260,50%,14%)');space.addColorStop(1,'hsl(220,40%,8%)');
      ctx.fillStyle=space;ctx.fillRect(0,0,W,H);

      // Milky way glow
      const mw=ctx.createLinearGradient(0,H*0.05,W,H*0.6);
      mw.addColorStop(0,'transparent');mw.addColorStop(0.3,'hsla(220,50%,50%,0.04)');mw.addColorStop(0.5,'hsla(240,60%,60%,0.07)');mw.addColorStop(0.7,'hsla(280,50%,50%,0.04)');mw.addColorStop(1,'transparent');
      ctx.fillStyle=mw;ctx.fillRect(0,0,W,H*0.7);

      // Aurora borealis
      for(let layer=0;layer<3;layer++){
        ctx.save();ctx.globalAlpha=0.12+0.06*Math.sin(t*0.4+layer);
        const aurora=ctx.createLinearGradient(0,H*0.05,0,H*0.4);
        const hues=[170,200,280];
        aurora.addColorStop(0,'transparent');
        aurora.addColorStop(0.3,hsl(hues[layer],80,65,0.6));
        aurora.addColorStop(0.6,hsl(hues[(layer+1)%3],70,55,0.4));
        aurora.addColorStop(1,'transparent');
        ctx.fillStyle=aurora;
        ctx.beginPath();ctx.moveTo(0,H*0.4);
        for(let x=0;x<=W;x+=20){
          const ay=H*(0.1+0.08*Math.sin(x/W*Math.PI*(3+layer)+t*(0.5+layer*0.2)+layer*2));
          ctx.lineTo(x,ay);
        }
        ctx.lineTo(W,H*0.4);ctx.lineTo(0,H*0.4);ctx.closePath();
        ctx.fill();ctx.restore();
      }

      // Stars
      stars2.forEach(s=>{
        s.t+=s.ts;
        const blink=0.5+0.5*Math.sin(s.t);
        drawStar(s.x*W,s.y*H,s.r,s.t,'rgba(200,210,255,'+(0.4+0.6*blink)+')');
      });

      // Shooting stars
      shootingStars.forEach(ss=>{
        if(ss.wait>0){ss.wait--;return;}
        ss.life++;ss.x+=ss.vx;ss.y+=ss.vy;
        if(ss.life>ss.maxLife){ss.x=rand(0.2,1);ss.y=rand(0,0.35);ss.vx=rand(-.008,-.003);ss.vy=rand(.002,.005);ss.life=0;ss.wait=rand(80,250);}
        const progress=ss.life/ss.maxLife;const alpha=Math.sin(progress*Math.PI);
        ctx.save();
        const sg=ctx.createLinearGradient(ss.x*W,ss.y*H,(ss.x-ss.vx*ss.len)*W,(ss.y-ss.vy*ss.len)*H);
        sg.addColorStop(0,'rgba(255,255,255,'+alpha+')');sg.addColorStop(1,'transparent');
        ctx.strokeStyle=sg;ctx.lineWidth=1.8;
        ctx.beginPath();ctx.moveTo(ss.x*W,ss.y*H);ctx.lineTo((ss.x-ss.vx*ss.len)*W,(ss.y-ss.vy*ss.len)*H);ctx.stroke();
        ctx.restore();
      });

      // Moon
      const moonX=W*0.78,moonY=H*0.14;
      const moonGlow=ctx.createRadialGradient(moonX,moonY,0,moonX,moonY,90);
      moonGlow.addColorStop(0,'rgba(200,210,255,0.15)');moonGlow.addColorStop(1,'transparent');
      ctx.fillStyle=moonGlow;ctx.fillRect(moonX-90,moonY-90,180,180);
      ctx.fillStyle='hsl(230,30%,88%)';ctx.shadowBlur=18;ctx.shadowColor='rgba(180,200,255,0.5)';
      ctx.beginPath();ctx.arc(moonX,moonY,W*0.033,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
      ctx.fillStyle='hsl(230,20%,75%)';
      [[-.4,-.3,.12],[.2,.2,.1],[-.1,.4,.08]].forEach(([ox,oy,r])=>{
        ctx.beginPath();ctx.arc(moonX+ox*W*0.033*2,moonY+oy*H*0.033,r*W*0.033,0,Math.PI*2);ctx.fill();
      });

      // City silhouette
      ctx.fillStyle='rgba(4,4,15,0.92)';
      ctx.beginPath();ctx.moveTo(0,H);
      // Random but seeded skyline
      const buildings=[{x:0,w:0.07,h:.22},{x:.06,w:.05,h:.3},{x:.1,w:.08,h:.18},{x:.17,w:.04,h:.35},{x:.2,w:.06,h:.26},{x:.25,w:.1,h:.16},{x:.34,w:.06,h:.28},{x:.39,w:.05,h:.38},{x:.43,w:.08,h:.22},{x:.5,w:.06,h:.3},{x:.55,w:.04,h:.42},{x:.58,w:.07,h:.2},{x:.64,w:.06,h:.32},{x:.69,w:.05,h:.18},{x:.73,w:.09,h:.36},{x:.81,w:.06,h:.24},{x:.86,w:.05,h:.28},{x:.9,w:.07,h:.16},{x:.96,w:.04,h:.22}];
      buildings.forEach(b=>{ctx.lineTo(b.x*W,H*(1-b.h));ctx.lineTo((b.x+b.w/2)*W,H*(1-b.h));ctx.lineTo((b.x+b.w/2)*W,H*(1-b.h-0.015));ctx.lineTo((b.x+b.w)*W,H*(1-b.h));});
      ctx.lineTo(W,H);ctx.closePath();ctx.fill();

      // City lights (windows)
      buildings.forEach(b=>{
        for(let wy=0;wy<6;wy++){for(let wx=0;wx<3;wx++){
          if(Math.random()>0.55){
            ctx.fillStyle=`rgba(255,${200+Math.floor(rand(0,55))},${100+Math.floor(rand(0,80))},${0.5+Math.random()*0.4})`;
            ctx.fillRect((b.x+wx*b.w/3+0.005)*W,H*(1-b.h+wy*b.h/7+0.02),W*b.w*0.18,H*b.h*0.1);
          }
        }}
      });
    };
  })();

  const scenes = {lavender:lavScene, ocean:oceanScene, sunset:sunsetScene, forest:forestScene, rose:roseScene, night:nightScene};

  function loop(){
    if(!currentScene)return;
    frame++;
    ctx.clearRect(0,0,W,H);
    scenes[currentScene]();
    animId=requestAnimationFrame(loop);
  }

  return {
    setScene(name){
      const cvs=document.getElementById('themeBgCanvas');
      if(animId)cancelAnimationFrame(animId);
      if(!name||!scenes[name]){
        currentScene=null;cvs.style.opacity='0';
        // Restore blobs + bg-anim
        ['bgAnim','blob1','blob2','blob3'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='';});
        return;
      }
      currentScene=name;frame=0;
      // Hide gradient blobs when canvas is showing
      ['bgAnim','blob1','blob2','blob3'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
      cvs.style.opacity='1';
      loop();
    }
  };
})();

// ===================================================
// ===== PREMIUM / PAYMENT SYSTEM ===================
// ===================================================
let userPlan = 'pro'; // ðŸŒŸ Premium activated
let payCurrentPlan = 'pro';
let payCycle = 'monthly';
let payMethod = 'card';
const PRICES = { pro:{monthly:149,annual:119}, team:{monthly:399,annual:319} };

function isPro(){ return true; } // ðŸŒŸ Always Pro

function applyPlanUI(){
  // Sidebar strip
  const icon=document.getElementById('sidebarProIcon');
  const title=document.getElementById('sidebarProTitle');
  const sub=document.getElementById('sidebarProSub');
  const strip=document.getElementById('sidebarProStrip');
  if(strip&&isPro()){
    if(icon)icon.textContent='ðŸ‘‘';
    if(title)title.textContent="You're on Pro!";
    if(sub)sub.textContent='All features unlocked ðŸŽ‰';
    strip.style.background='linear-gradient(135deg,rgba(139,92,246,0.18),rgba(94,234,212,0.15))';
    strip.style.borderColor='rgba(139,92,246,0.4)';
    strip.onclick=()=>openFP('pricingPanel');
  }
  // Show PRO badge in top bar
  const subBtn=document.getElementById('subBadgeBtn');
  if(subBtn) subBtn.style.display=isPro()?'flex':'none';
  // Show pro markers on nav items
  document.querySelectorAll('.nav-pro-tag').forEach(t=>{ t.style.display=isPro()?'inline':'none'; });
  // Add crown to avatar border when pro
  const avBtn=document.getElementById('avatarBtn');
  if(avBtn&&isPro()){avBtn.style.border='2.5px solid #8b5cf6';avBtn.style.boxShadow='0 0 0 3px rgba(139,92,246,0.25),0 2px 12px rgba(160,130,210,0.25)';}
  // Pricing CTAs
  const freeCta=document.getElementById('freeCta');
  const proCta=document.getElementById('proCta');
  const teamCta=document.getElementById('teamCta');
  if(freeCta){freeCta.className='plan-cta '+(userPlan==='free'?'cta-current':'cta-free');freeCta.textContent=userPlan==='free'?'Current Plan':'Downgrade';}
  if(proCta){proCta.className='plan-cta '+(userPlan==='pro'?'cta-current':'cta-pro');proCta.textContent=userPlan==='pro'?'âœ… Current Plan':'Get Pro âœ¨';if(userPlan!=='pro')proCta.onclick=()=>openPayModal('pro');}
  if(teamCta){teamCta.className='plan-cta '+(userPlan==='team'?'cta-current':'cta-team');teamCta.textContent=userPlan==='team'?'âœ… Current Plan':'Get Team ðŸ«';if(userPlan!=='team')teamCta.onclick=()=>openPayModal('team');}
  // Update library gate
  if(_libActivated||isPro())applyLibraryGate();
}

function setBilling(mode){
  payCycle=mode;
  document.getElementById('billMonthly').classList.toggle('active',mode==='monthly');
  document.getElementById('billAnnual').classList.toggle('active',mode==='annual');
  document.getElementById('proPrice').textContent=mode==='monthly'?'149':'119';
  document.getElementById('teamPrice').textContent=mode==='monthly'?'399':'319';
  const pn=document.getElementById('proAnnualNote');const tn=document.getElementById('teamAnnualNote');
  if(pn)pn.textContent=mode==='annual'?'Billed â‚±1,428/year Â· Save â‚±360':'';
  if(tn)tn.textContent=mode==='annual'?'Billed â‚±3,828/year Â· Save â‚±960':'';
}

function openPayModal(plan){
  payCurrentPlan=plan;payCycle='monthly';payMethod='card';
  document.getElementById('payFormSection').style.display='';
  document.getElementById('paySuccessSection').style.display='none';
  const icon=plan==='pro'?'âœ¨':'ðŸ«';const name=plan==='pro'?'Pro Plan':'Team Plan';
  document.getElementById('paySummaryIcon').textContent=icon;
  document.getElementById('paySummaryName').textContent=name;
  document.getElementById('paySummaryCycle').textContent='Monthly billing';
  document.getElementById('paySummaryPrice').textContent='â‚±'+PRICES[plan].monthly;
  document.getElementById('payCycleMonthLabel').textContent='â‚±'+PRICES[plan].monthly+'/mo';
  document.getElementById('payCycleAnnualLabel').textContent='â‚±'+PRICES[plan].annual+'/mo Â· Save 20%';
  document.getElementById('cycleMonthly').classList.add('active');
  document.getElementById('cycleAnnual').classList.remove('active');
  document.querySelectorAll('.pay-method').forEach(m=>m.classList.remove('active'));
  document.querySelector('.pay-method').classList.add('active');
  showPayFields('card');
  document.getElementById('bankRef').textContent='TC-'+Math.floor(1000+Math.random()*9000);
  document.getElementById('paySubmitLabel').textContent='Complete Purchase â€” â‚±'+PRICES[plan].monthly;
  document.getElementById('payOverlay').classList.remove('hidden');
}
function closePayModal(){document.getElementById('payOverlay').classList.add('hidden');}
function selectCycle(cycle){
  payCycle=cycle;const price=PRICES[payCurrentPlan][cycle];
  document.getElementById('cycleMonthly').classList.toggle('active',cycle==='monthly');
  document.getElementById('cycleAnnual').classList.toggle('active',cycle==='annual');
  document.getElementById('paySummaryCycle').textContent=cycle==='monthly'?'Monthly billing':'Annual billing (20% off)';
  document.getElementById('paySummaryPrice').textContent='â‚±'+price;
  document.getElementById('paySubmitLabel').textContent='Complete Purchase â€” â‚±'+price;
}
function selectPayMethod(method,el){
  payMethod=method;
  document.querySelectorAll('.pay-method').forEach(m=>m.classList.remove('active'));
  el.classList.add('active');showPayFields(method);
}
function showPayFields(method){
  ['payFieldsCard','payFieldsGcash','payFieldsMaya','payFieldsBank'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
  const map={card:'payFieldsCard',gcash:'payFieldsGcash',maya:'payFieldsMaya',bank:'payFieldsBank'};
  const el=document.getElementById(map[method]);if(el)el.style.display='';
}
function formatCardNum(input){let v=input.value.replace(/\D/g,'').substring(0,16);input.value=v.replace(/(.{4})/g,'$1 ').trim();}
function formatExpiry(input){let v=input.value.replace(/\D/g,'');if(v.length>=2)v=v.substring(0,2)+' / '+v.substring(2,4);input.value=v;}
function submitPayment(){
  if(payMethod==='card'){
    const n=document.getElementById('cardName').value.trim();
    const num=document.getElementById('cardNum').value.replace(/\s/g,'');
    const exp=document.getElementById('cardExp').value.trim();
    const cvv=document.getElementById('cardCvv').value.trim();
    if(!n||num.length<15||exp.length<4||cvv.length<3){showToast('âš ï¸ Please fill in all card details.',2500);return;}
  } else if(payMethod==='gcash'){if(!document.getElementById('gcashNum').value.trim()){showToast('âš ï¸ Please enter your GCash number.',2500);return;}
  } else if(payMethod==='maya'){if(!document.getElementById('mayaNum').value.trim()){showToast('âš ï¸ Please enter your Maya number.',2500);return;}
  } else if(payMethod==='bank'){if(!document.getElementById('bankTxn').value.trim()){showToast('âš ï¸ Please enter your reference number.',2500);return;}}
  const btn=document.querySelector('.pay-submit');
  btn.textContent='â³ Processing...';btn.style.opacity='0.7';btn.disabled=true;
  setTimeout(()=>{
    btn.textContent=document.getElementById('paySubmitLabel').textContent;
    btn.style.opacity='';btn.disabled=false;
    userPlan=payCurrentPlan;
    document.getElementById('payFormSection').style.display='none';
    document.getElementById('paySuccessSection').style.display='flex';
    applyPlanUI();applyLibraryGate();fsSaveProfile();
    addNotification('login','ðŸ‘‘','You\'renow on '+(payCurrentPlan==='pro'?'Pro':'Team')+'!','All premium features are now unlocked âœ¨');
    showToast('ðŸŽ‰ Welcome to Pro! All features unlocked.',3500);
  },2000);
}
setTimeout(applyPlanUI,600);

</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TRACKER AI â€” STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<style>
/* â”€â”€ Shell layout â”€â”€ */
.tai-shell{display:flex;height:100%;overflow:hidden;position:relative;z-index:1;}

/* â”€â”€ Sidebar â”€â”€ */
.tai-sidebar{width:220px;flex-shrink:0;display:flex;flex-direction:column;background:rgba(255,255,255,0.18);backdrop-filter:blur(20px);border-right:1px solid rgba(200,180,240,0.25);padding:14px 0;}
.tai-sidebar-hdr{padding:0 14px 14px;border-bottom:1px solid rgba(200,180,240,0.2);}
.tai-ai-badge{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.tai-ai-orb{font-size:2rem;width:46px;height:46px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.4));border-radius:50%;border:2px solid rgba(200,180,240,0.4);}
.tai-ai-name{font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;color:var(--dark);}
.tai-ai-status{font-size:0.7rem;font-weight:700;color:var(--mid);display:flex;align-items:center;gap:4px;}
.tai-status-dot{width:7px;height:7px;border-radius:50%;background:#34d399;display:inline-block;animation:taiStatusPulse 2s infinite;}
@keyframes taiStatusPulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.tai-new-btn{width:100%;padding:9px;border-radius:10px;border:1.5px dashed rgba(200,180,240,0.5);background:transparent;color:var(--mid);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.82rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;}
.tai-new-btn:hover{background:rgba(200,180,240,0.2);color:var(--dark);}

/* â”€â”€ Thread list â”€â”€ */
.tai-threads{flex:1;overflow-y:auto;padding:10px 8px;display:flex;flex-direction:column;gap:4px;}
.tai-thread{padding:9px 10px;border-radius:10px;cursor:pointer;font-size:0.8rem;font-weight:700;color:var(--mid);transition:all 0.18s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:7px;}
.tai-thread:hover{background:rgba(200,180,240,0.2);color:var(--dark);}
.tai-thread.active{background:linear-gradient(135deg,rgba(200,180,240,0.4),rgba(180,240,200,0.3));color:var(--dark);}
.tai-thread-icon{font-size:0.9rem;flex-shrink:0;}
.tai-thread-empty{padding:18px 10px;text-align:center;font-size:0.78rem;color:var(--mid);font-weight:600;opacity:0.7;}

/* â”€â”€ Sidebar footer / API key â”€â”€ */
.tai-sidebar-footer{padding:10px 14px;border-top:1px solid rgba(200,180,240,0.2);}
.tai-apikey-btn{display:flex;align-items:center;gap:6px;background:rgba(139,92,246,0.1);border:1.5px solid rgba(139,92,246,0.25);color:var(--accent);border-radius:10px;padding:8px 12px;font-size:0.75rem;font-weight:800;cursor:pointer;width:100%;font-family:'Nunito',sans-serif;transition:background 0.2s;}
.tai-apikey-btn:hover{background:rgba(139,92,246,0.18);}

/* â”€â”€ Main chat area â”€â”€ */
.tai-main{flex:1;display:flex;flex-direction:column;min-width:0;min-height:0;}
.tai-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;}

/* â”€â”€ Welcome screen â”€â”€ */
.tai-welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:40px 20px;gap:10px;}
.tai-welcome-orb{font-size:3.5rem;width:80px;height:80px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.4));border-radius:50%;border:2px solid rgba(200,180,240,0.4);margin-bottom:6px;}
.tai-welcome-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.4rem;color:var(--dark);}
.tai-welcome-sub{font-size:0.88rem;color:var(--mid);font-weight:600;max-width:300px;line-height:1.6;}
.tai-suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px;max-width:480px;}
.tai-suggestion{padding:8px 16px;border-radius:20px;background:rgba(255,255,255,0.6);border:1.5px solid rgba(200,180,240,0.35);font-size:0.8rem;font-weight:700;color:var(--dark);cursor:pointer;transition:all 0.18s;backdrop-filter:blur(8px);}
.tai-suggestion:hover{background:rgba(200,180,240,0.3);transform:translateY(-2px);}

/* â”€â”€ Messages â”€â”€ */
.tai-msg{display:flex;gap:10px;animation:taiMsgIn 0.25s ease both;}
@keyframes taiMsgIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}
.tai-msg.user{flex-direction:row-reverse;}
.tai-msg-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.4));border:1.5px solid rgba(200,180,240,0.35);}
.tai-msg.user .tai-msg-avatar{background:linear-gradient(135deg,#8b5cf6,#5eead4);}
.tai-msg-bubble{max-width:72%;padding:11px 15px;border-radius:18px;font-size:0.88rem;font-weight:600;line-height:1.6;color:var(--dark);}
.tai-msg.ai .tai-msg-bubble{background:rgba(255,255,255,0.72);backdrop-filter:blur(12px);border:1px solid rgba(200,180,240,0.25);border-radius:4px 18px 18px 18px;}
.tai-msg.user .tai-msg-bubble{background:linear-gradient(135deg,rgba(139,92,246,0.18),rgba(94,234,212,0.15));border:1.5px solid rgba(139,92,246,0.2);border-radius:18px 4px 18px 18px;text-align:right;}
.tai-msg-error .tai-msg-bubble{background:rgba(255,100,100,0.1);border-color:rgba(255,100,100,0.25);color:#c0392b;}

/* â”€â”€ Typing indicator â”€â”€ */
.tai-typing-wrap{display:flex;gap:10px;align-items:flex-end;}
.tai-typing-bubble{background:rgba(255,255,255,0.72);backdrop-filter:blur(12px);border:1px solid rgba(200,180,240,0.25);border-radius:4px 18px 18px 18px;padding:12px 16px;display:flex;gap:5px;align-items:center;}
.tai-dot{width:7px;height:7px;border-radius:50%;background:var(--mid);animation:taiDotBounce 1.2s infinite;}
.tai-dot:nth-child(2){animation-delay:0.2s;}
.tai-dot:nth-child(3){animation-delay:0.4s;}
@keyframes taiDotBounce{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-7px);}}

/* â”€â”€ Input bar â”€â”€ */
.tai-input-bar{padding:14px 16px;border-top:1px solid rgba(200,180,240,0.2);background:rgba(255,255,255,0.18);backdrop-filter:blur(16px);display:flex;gap:10px;align-items:flex-end;}
.tai-input-wrap{flex:1;background:rgba(255,255,255,0.65);border:1.5px solid rgba(200,180,240,0.35);border-radius:16px;padding:10px 14px;backdrop-filter:blur(12px);}
.tai-input{width:100%;background:transparent;border:none;outline:none;font-family:'Quicksand',sans-serif;font-size:0.92rem;font-weight:600;color:var(--dark);resize:none;max-height:120px;line-height:1.5;}
.tai-input::placeholder{color:var(--mid);}
.tai-send-btn{width:42px;height:42px;border-radius:50%;border:none;background:linear-gradient(135deg,#8b5cf6,#5eead4);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform 0.18s,box-shadow 0.18s;box-shadow:0 4px 14px rgba(139,92,246,0.3);}
.tai-send-btn:hover{transform:scale(1.08);}
.tai-send-btn svg{width:18px;height:18px;}

/* â”€â”€ API key modal â”€â”€ */
.tai-key-modal{display:none;position:fixed;inset:0;background:rgba(60,40,100,0.45);backdrop-filter:blur(10px);z-index:9999;align-items:center;justify-content:center;}
.tai-key-modal.show{display:flex;}
.tai-key-box{background:rgba(255,255,255,0.97);border-radius:20px;padding:30px 26px;max-width:380px;width:90%;box-shadow:0 20px 60px rgba(139,92,246,0.2);border:1.5px solid rgba(200,180,240,0.4);}
.tai-key-box h3{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.15rem;color:var(--dark);margin-bottom:6px;}
.tai-key-box p{font-size:0.82rem;color:var(--mid);font-weight:600;margin-bottom:16px;line-height:1.6;}
.tai-key-inp{width:100%;background:rgba(200,180,240,0.1);border:1.5px solid rgba(200,180,240,0.4);border-radius:10px;padding:11px 13px;color:var(--dark);font-size:0.88rem;font-family:'Quicksand',sans-serif;font-weight:600;box-sizing:border-box;margin-bottom:6px;}
.tai-key-inp:focus{outline:none;border-color:var(--accent);}
.tai-key-hint{font-size:0.72rem;color:var(--mid);font-weight:600;margin-bottom:16px;}
.tai-key-hint a{color:var(--accent);font-weight:800;text-decoration:none;}
.tai-key-actions{display:flex;gap:8px;justify-content:flex-end;}
.tai-key-cancel{background:transparent;color:var(--mid);border:1.5px solid rgba(200,180,240,0.4);border-radius:10px;padding:9px 18px;font-weight:700;cursor:pointer;font-family:'Quicksand',sans-serif;font-size:0.85rem;}
.tai-key-save{background:linear-gradient(135deg,#8b5cf6,#5eead4);color:#fff;border:none;border-radius:10px;padding:9px 20px;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif;font-size:0.88rem;}

/* â”€â”€ Mobile â”€â”€ */
@media(max-width:600px){
  .tai-sidebar{width:180px;}
  .tai-msg-bubble{max-width:85%;}
}
@media(max-width:480px){
  .tai-sidebar{display:none;}
}
</style>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TRACKER AI â€” PANEL HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="full-panel hidden" id="trackerAiPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header">
    <button class="back-btn" onclick="closeFP('trackerAiPanel')">â†</button>
    <span class="fp-title">ðŸ¤– Tracker AI</span>
    <span style="margin-left:auto;font-size:0.72rem;background:rgba(52,211,153,0.15);color:#059669;padding:3px 12px;border-radius:20px;font-weight:800;border:1.5px solid rgba(52,211,153,0.3);">â— Powered by Groq âš¡</span>
  </div>
  <div class="fp-content" style="padding:0;overflow:hidden;">
    <div class="tai-shell">

      <!-- Sidebar -->
      <div class="tai-sidebar">
        <div class="tai-sidebar-hdr">
          <div class="tai-ai-badge">
            <div class="tai-ai-orb">ðŸ¤–</div>
            <div>
              <div class="tai-ai-name">Tracker</div>
              <div class="tai-ai-status"><span class="tai-status-dot"></span>Always online</div>
            </div>
          </div>
          <button class="tai-new-btn" onclick="taiNewChat()">âœï¸ New Chat</button>
        </div>
        <div class="tai-threads" id="taiThreadList"></div>
        <div class="tai-sidebar-footer">
          <button class="tai-apikey-btn" id="taiKeyBtn" onclick="taiOpenKeyModal()">ðŸ”‘ Set API Key</button>
        </div>
      </div>

      <!-- Main chat -->
      <div class="tai-main">
        <div class="tai-messages" id="taiMessages">
          <div class="tai-welcome" id="taiWelcome">
            <div class="tai-welcome-orb">ðŸ¤–</div>
            <div class="tai-welcome-title">Hey, I'm Tracker!</div>
            <div class="tai-welcome-sub">Your personal AI study buddy. Ask me anything â€” tasks, concepts, motivation, or just chat! ðŸŒŸ</div>
            <div class="tai-suggestions">
              <div class="tai-suggestion" onclick="taiSuggest(this)">Help me study for an exam ðŸ“š</div>
              <div class="tai-suggestion" onclick="taiSuggest(this)">Make me a study schedule ðŸ“…</div>
              <div class="tai-suggestion" onclick="taiSuggest(this)">Explain a concept simply ðŸ’¡</div>
              <div class="tai-suggestion" onclick="taiSuggest(this)">I need motivation ðŸ”¥</div>
              <div class="tai-suggestion" onclick="taiSuggest(this)">Quiz me on a topic ðŸ§ </div>
              <div class="tai-suggestion" onclick="taiSuggest(this)">Help me manage my tasks ðŸ“‹</div>
            </div>
          </div>
        </div>
        <div class="tai-input-bar">
          <div class="tai-input-wrap">
            <textarea class="tai-input" id="taiInput" placeholder="Message Tracker..." rows="1"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();taiSend();}"
              oninput="taiResizeInput(this)"></textarea>
          </div>
          <button class="tai-send-btn" onclick="taiSend()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Tracker AI â€” API Key Modal -->
<div class="tai-key-modal" id="taiKeyModal">
  <div class="tai-key-box">
    <h3>ðŸ”‘ Connect Tracker AI</h3>
    <p>Paste your Anthropic API key to power Tracker AI with Claude. Your key is stored only on your device and only sent to Anthropic's servers.</p>
    <input class="tai-key-inp" id="taiKeyInp" type="password" placeholder="gsk_..." />
    <div class="tai-key-hint">Get your free key at <a href='https://console.groq.com' target='_blank'>console.groq.com</a> â†’ Get API Key (it's free!)</div>
    <div class="tai-key-actions">
      <button class="tai-key-cancel" onclick="taiCloseKeyModal()">Cancel</button>
      <button class="tai-key-save" onclick="taiSaveKey()">Save & Connect âœ¨</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TRACKER AI â€” JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
const TAI_MODEL = 'llama-3.3-70b-versatile';

let taiApiKey = localStorage.getItem('tai_api_key') || '';
let taiThreads = [];
let taiCurrentThread = null;

// â”€â”€ Load threads from storage â”€â”€
function taiLoadThreads() {
  try { taiThreads = JSON.parse(localStorage.getItem('tai_threads') || '[]'); } catch(e) { taiThreads = []; }
}

function taiSaveThreads() {
  const trimmed = taiThreads.slice(-20).map(t => ({...t, messages: t.messages.slice(-40)}));
  try { localStorage.setItem('tai_threads', JSON.stringify(trimmed)); } catch(e) {}
}

function taiGetThread() {
  return taiThreads.find(t => t.id === taiCurrentThread) || null;
}

// â”€â”€ New chat â”€â”€
function taiNewChat() {
  const id = 'tai_' + Date.now();
  taiThreads.push({ id, title: 'New Chat', messages: [] });
  taiCurrentThread = id;
  taiSaveThreads();
  taiRenderThreadList();
  taiRenderMessages();
}

// â”€â”€ Render thread list â”€â”€
function taiRenderThreadList() {
  const el = document.getElementById('taiThreadList');
  if (!el) return;
  if (taiThreads.length === 0) {
    el.innerHTML = '<div class="tai-thread-empty">No chats yet.<br>Start a new one! âœ¨</div>';
    return;
  }
  el.innerHTML = '';
  [...taiThreads].reverse().forEach(t => {
    const div = document.createElement('div');
    div.className = 'tai-thread' + (t.id === taiCurrentThread ? ' active' : '');
    div.innerHTML = '<span class="tai-thread-icon">ðŸ’¬</span>' + (t.title || 'New Chat');
    div.title = t.title || 'New Chat';
    div.onclick = () => { taiCurrentThread = t.id; taiRenderThreadList(); taiRenderMessages(); };
    el.appendChild(div);
  });
}

// â”€â”€ Render messages â”€â”€
function taiRenderMessages() {
  const el = document.getElementById('taiMessages');
  if (!el) return;
  const thread = taiGetThread();
  if (!thread || thread.messages.length === 0) {
    el.innerHTML = document.getElementById('taiWelcome') ? '' : '';
    // Show welcome
    el.innerHTML = `
      <div class="tai-welcome" id="taiWelcome">
        <div class="tai-welcome-orb">ðŸ¤–</div>
        <div class="tai-welcome-title">Hey, I'm Tracker!</div>
        <div class="tai-welcome-sub">Your personal AI study buddy. Ask me anything â€” tasks, concepts, motivation, or just chat! ðŸŒŸ</div>
        <div class="tai-suggestions">
          <div class="tai-suggestion" onclick="taiSuggest(this)">Help me study for an exam ðŸ“š</div>
          <div class="tai-suggestion" onclick="taiSuggest(this)">Make me a study schedule ðŸ“…</div>
          <div class="tai-suggestion" onclick="taiSuggest(this)">Explain a concept simply ðŸ’¡</div>
          <div class="tai-suggestion" onclick="taiSuggest(this)">I need motivation ðŸ”¥</div>
          <div class="tai-suggestion" onclick="taiSuggest(this)">Quiz me on a topic ðŸ§ </div>
          <div class="tai-suggestion" onclick="taiSuggest(this)">Help me manage my tasks ðŸ“‹</div>
        </div>
      </div>`;
    return;
  }
  el.innerHTML = '';
  thread.messages.forEach(m => taiAppendMsg(m.role, m.content, false));
  el.scrollTop = el.scrollHeight;
}

// â”€â”€ Append a single message bubble â”€â”€
function taiAppendMsg(role, content, scroll = true) {
  const el = document.getElementById('taiMessages');
  if (!el) return;
  // Remove welcome screen if present
  const welcome = document.getElementById('taiWelcome');
  if (welcome) welcome.remove();

  const wrap = document.createElement('div');
  wrap.className = 'tai-msg ' + (role === 'user' ? 'user' : 'ai');
  const avatarEmoji = role === 'user' ? (document.getElementById('sidebarAvatarInner')?.textContent || 'ðŸ‘¤') : 'ðŸ¤–';
  wrap.innerHTML = `
    <div class="tai-msg-avatar">${avatarEmoji}</div>
    <div class="tai-msg-bubble">${taiEscape(content)}</div>`;
  el.appendChild(wrap);
  if (scroll) el.scrollTop = el.scrollHeight;
}

function taiEscape(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\n/g,'<br>');
}

// â”€â”€ Typing indicator â”€â”€
function taiShowTyping() {
  const el = document.getElementById('taiMessages');
  if (!el) return;
  const welcome = document.getElementById('taiWelcome');
  if (welcome) welcome.remove();
  const wrap = document.createElement('div');
  wrap.id = 'taiTyping';
  wrap.className = 'tai-typing-wrap';
  wrap.innerHTML = `<div class="tai-msg-avatar">ðŸ¤–</div><div class="tai-typing-bubble"><div class="tai-dot"></div><div class="tai-dot"></div><div class="tai-dot"></div></div>`;
  el.appendChild(wrap);
  el.scrollTop = el.scrollHeight;
}

function taiHideTyping() {
  const t = document.getElementById('taiTyping');
  if (t) t.remove();
}

// â”€â”€ Suggestion click â”€â”€
function taiSuggest(el) {
  const inp = document.getElementById('taiInput');
  if (inp) { inp.value = el.textContent; taiSend(); }
}

// â”€â”€ Resize textarea â”€â”€
function taiResizeInput(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// â”€â”€ Send message â”€â”€
async function taiSend() {
  const inp = document.getElementById('taiInput');
  const text = inp ? inp.value.trim() : '';
  if (!text) return;
  inp.value = '';
  inp.style.height = 'auto';

  if (!taiCurrentThread) taiNewChat();
  const thread = taiGetThread();
  if (!thread) return;

  const userName = document.getElementById('sidebarName')?.textContent || 'User';
  thread.messages.push({ role: 'user', content: text });
  if (thread.messages.filter(m => m.role === 'user').length === 1) {
    thread.title = text.slice(0, 38) + (text.length > 38 ? 'â€¦' : '');
  }
  taiSaveThreads();
  taiAppendMsg('user', text);
  taiRenderThreadList();
  taiShowTyping();

  if (!taiApiKey) {
    taiHideTyping();
    taiShowError('âš ï¸ No API key set yet! Click the ðŸ”‘ button in the sidebar to add your Anthropic API key.');
    return;
  }

  const systemPrompt = `You are Tracker, a friendly, smart, and encouraging AI assistant built into the Track & Clock productivity app. You help students and learners with studying, task management, scheduling, motivation, explanations, and general questions. The user's name is ${userName}. Be warm, concise, and genuinely helpful. Use emojis naturally but not excessively. Never break character â€” you are Tracker, not Claude or any other AI.`;

  const apiMessages = thread.messages
    .filter(m => m.role === 'user' || m.role === 'assistant')
    .map(m => ({ role: m.role, content: m.content }));

  // Build Groq / OpenAI-compatible messages
  const groqMessages = [
    { role: 'system', content: systemPrompt },
    ...apiMessages
  ];

  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + taiApiKey
      },
      body: JSON.stringify({
        model: TAI_MODEL,
        messages: groqMessages,
        max_tokens: 1024,
        temperature: 0.75
      })
    });

    taiHideTyping();

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      taiShowError('âŒ ' + (err?.error?.message || 'API error ' + res.status) + '. Check your API key.');
      return;
    }

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || "Sorry, I couldn't generate a response.";
    thread.messages.push({ role: 'assistant', content: reply });
    taiSaveThreads();
    taiAppendMsg('assistant', reply);
    taiRenderThreadList();

  } catch(e) {
    taiHideTyping();
    taiShowError('ðŸŒ Connection error. Check your internet and try again.');
    console.error('[Tracker AI]', e);
  }
}

function taiShowError(msg) {
  const el = document.getElementById('taiMessages');
  if (!el) return;
  const wrap = document.createElement('div');
  wrap.className = 'tai-msg ai tai-msg-error';
  wrap.innerHTML = `<div class="tai-msg-avatar">ðŸ¤–</div><div class="tai-msg-bubble">${msg}</div>`;
  el.appendChild(wrap);
  el.scrollTop = el.scrollHeight;
}

// â”€â”€ API key modal â”€â”€
function taiOpenKeyModal() {
  document.getElementById('taiKeyInp').value = taiApiKey || '';
  document.getElementById('taiKeyModal').classList.add('show');
  setTimeout(() => document.getElementById('taiKeyInp').focus(), 100);
}
function taiCloseKeyModal() {
  document.getElementById('taiKeyModal').classList.remove('show');
}
function taiSaveKey() {
  const val = document.getElementById('taiKeyInp').value.trim();
  taiApiKey = val;
  if (val) localStorage.setItem('tai_api_key', val);
  else localStorage.removeItem('tai_api_key');
  taiCloseKeyModal();
  const btn = document.getElementById('taiKeyBtn');
  if (btn) btn.innerHTML = val ? 'ðŸŸ¢ API Key Connected' : 'ðŸ”‘ Set API Key';
  if (val) showToast('âœ… Tracker AI connected! Start chatting ðŸ¤–', 3000);
}

// â”€â”€ Init â”€â”€
taiLoadThreads();
if (taiThreads.length > 0) {
  taiCurrentThread = taiThreads[taiThreads.length - 1].id;
}
// Update button label if key exists
window.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('taiKeyBtn');
  if (btn && taiApiKey) btn.innerHTML = 'ðŸŸ¢ API Key Connected';
});
taiRenderThreadList();
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AVATAR BACKGROUND PHOTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadAvatarBgPhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const dataUrl = ev.target.result;
    const bg = document.getElementById('avBg');
    if (bg) {
      bg.style.backgroundImage = `url(${dataUrl})`;
      bg.style.backgroundSize = 'cover';
      bg.style.backgroundPosition = 'center';
      bg.style.background = '';
      bg.dataset.customBg = dataUrl;
    }
    document.getElementById('avBgPhotoPreview').style.display = 'block';
    localStorage.setItem('av_custom_bg', dataUrl);
  };
  reader.readAsDataURL(file);
}

function clearAvatarBgPhoto() {
  const bg = document.getElementById('avBg');
  if (bg) {
    bg.style.backgroundImage = '';
    bg.style.background = 'radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0)';
    delete bg.dataset.customBg;
  }
  document.getElementById('avBgPhotoPreview').style.display = 'none';
  localStorage.removeItem('av_custom_bg');
}

// Restore avatar custom bg on load
(function restoreAvatarBg() {
  const saved = localStorage.getItem('av_custom_bg');
  if (saved) {
    window.addEventListener('DOMContentLoaded', () => {
      const bg = document.getElementById('avBg');
      if (bg) {
        bg.style.backgroundImage = `url(${saved})`;
        bg.style.backgroundSize = 'cover';
        bg.style.backgroundPosition = 'center';
        bg.style.background = '';
      }
      const preview = document.getElementById('avBgPhotoPreview');
      if (preview) preview.style.display = 'block';
    });
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP BACKGROUND PHOTO (Appearance Panel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setAppBgPhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const dataUrl = ev.target.result;
    applyAppBgPhoto(dataUrl);
    localStorage.setItem('app_bg_photo', dataUrl);
    localStorage.setItem('app_bg_opacity', document.getElementById('bgPhotoOpacity').value);
  };
  reader.readAsDataURL(file);
}

function applyAppBgPhoto(dataUrl) {
  const layer = document.getElementById('appBgPhotoLayer');
  if (!layer) return;
  const opacity = (document.getElementById('bgPhotoOpacity')?.value || 60) / 100;
  layer.style.backgroundImage = `url(${dataUrl})`;
  layer.style.opacity = opacity;
  // Show preview
  const preview = document.getElementById('bgPhotoPreviewWrap');
  const img = document.getElementById('bgPhotoPreviewImg');
  const clearBtn = document.getElementById('clearBgPhotoBtn');
  if (preview) preview.style.display = 'block';
  if (img) img.src = dataUrl;
  if (clearBtn) clearBtn.style.display = 'inline-flex';
}

function clearAppBgPhoto() {
  const layer = document.getElementById('appBgPhotoLayer');
  if (layer) { layer.style.backgroundImage = ''; layer.style.opacity = 0; }
  const preview = document.getElementById('bgPhotoPreviewWrap');
  const clearBtn = document.getElementById('clearBgPhotoBtn');
  if (preview) preview.style.display = 'none';
  if (clearBtn) clearBtn.style.display = 'none';
  localStorage.removeItem('app_bg_photo');
  localStorage.removeItem('app_bg_opacity');
}

function updateBgPhotoOpacity(val) {
  const layer = document.getElementById('appBgPhotoLayer');
  if (layer && layer.style.backgroundImage) {
    layer.style.opacity = val / 100;
    localStorage.setItem('app_bg_opacity', val);
  }
}

// Restore app bg photo on load
(function restoreAppBgPhoto() {
  const saved = localStorage.getItem('app_bg_photo');
  if (!saved) return;
  window.addEventListener('DOMContentLoaded', () => {
    const savedOpacity = localStorage.getItem('app_bg_opacity') || '60';
    const slider = document.getElementById('bgPhotoOpacity');
    if (slider) slider.value = savedOpacity;
    applyAppBgPhoto(saved);
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRO AVATAR STYLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const proStyles = {
  royalcore: {
    greeting:'Your royal highness has arrived! ðŸ‘‘',
    state:{ hair:'long', hairColor:'#f5d060', shirt:'sundress', shirtColor:'#8b5cf6', pants:'skirt', pantsColor:'#6d28d9', shoes:'heels', shoeColor:'#fde68a', acc:'crown', eyeColor:'#a78bfa', bg:'radial-gradient(circle at 50% 70%,#3a1a6e,#6d28d9)' }
  },
  cyberpunk: {
    greeting:'System online. Ready to dominate. ðŸ¤–',
    state:{ hair:'short', hairColor:'#67e8f9', shirt:'hoodie', shirtColor:'#1f2937', pants:'leggings', pantsColor:'#1f2937', shoes:'boots', shoeColor:'#f59e0b', acc:'glasses', eyeColor:'#67e8f9', bg:'radial-gradient(circle at 50% 70%,#0f172a,#1e1b4b)' }
  },
  fairycore: {
    greeting:'Sprinkling a little magic on your day! ðŸ§š',
    state:{ hair:'long', hairColor:'#f9a8d4', shirt:'sundress', shirtColor:'#fce7f3', pants:'skirt', pantsColor:'#fbcfe8', shoes:'heels', shoeColor:'#f9a8d4', acc:'wings', eyeColor:'#5b8dee', bg:'radial-gradient(circle at 50% 70%,#fdf2f8,#e0f2fe)' }
  },
  angelcore: {
    greeting:'Heaven sent, just for you ðŸ˜‡',
    state:{ hair:'long', hairColor:'#e0e0e0', shirt:'uniform', shirtColor:'#ffffff', pants:'pants', pantsColor:'#f0f0f0', shoes:'heels', shoeColor:'#ffffff', acc:'halo', eyeColor:'#b8f0c8', bg:'radial-gradient(circle at 50% 70%,#fffbeb,#fef3c7)' }
  },
  darkfantasy: {
    greeting:'The dragon awakens... ðŸ‰',
    state:{ hair:'long', hairColor:'#1a1a2e', shirt:'hoodie', shirtColor:'#1f2937', pants:'leggings', pantsColor:'#111827', shoes:'boots', shoeColor:'#1f2937', acc:'wings', eyeColor:'#a78bfa', bg:'radial-gradient(circle at 50% 70%,#1a0a2e,#0d0d1a)' }
  },
  ethereal: {
    greeting:'Floating in clouds, thinking of you âœ¨',
    state:{ hair:'long', hairColor:'#c9b3e8', shirt:'sundress', shirtColor:'#e0d0f8', pants:'skirt', pantsColor:'#d8c4f0', shoes:'heels', shoeColor:'#c9b3e8', acc:'halo', eyeColor:'#c9b3e8', bg:'radial-gradient(circle at 50% 70%,#f3e8ff,#e0f2fe)' }
  },
  vaporwave: {
    greeting:'Retrowave activated. Aesthetic unlocked ðŸŒŠ',
    state:{ hair:'twin', hairColor:'#f9a8d4', shirt:'stripes', shirtColor:'#a78bfa', pants:'leggings', pantsColor:'#7c3aed', shoes:'sneakers', shoeColor:'#ec4899', acc:'headphones', eyeColor:'#67e8f9', bg:'radial-gradient(circle at 50% 70%,#4c1d95,#1e1b4b)' }
  },
  witchcore: {
    greeting:'The cauldron is bubbling... your spell is cast ðŸ”®',
    state:{ hair:'long', hairColor:'#1a1a2e', shirt:'hoodie', shirtColor:'#1f2937', pants:'skirt', pantsColor:'#111827', shoes:'boots', shoeColor:'#5c3d2e', acc:'catears', eyeColor:'#8b5cf6', bg:'radial-gradient(circle at 50% 70%,#2d1b4e,#1a0a2e)' }
  }
};

function applyProStyle(styleName, btn) {
  if (!isPro()) {
    showToast('ðŸ‘‘ Upgrade to Pro to use exclusive styles!', 3000);
    openFP('pricingPanel');
    return;
  }
  const s = proStyles[styleName];
  if (!s) { showToast('Style not found: ' + styleName, 2000); return; }
  currentStyleName = styleName;
  const st = s.state;

  // Highlight active button
  document.querySelectorAll('.style-chip, .pro-chip').forEach(c => c.classList.remove('active'));
  if (btn) btn.classList.add('active');

  // Merge into avState
  avState = Object.assign({}, avState, st);

  // Apply background
  const avBgEl = document.getElementById('avBg');
  if (avBgEl && st.bg) avBgEl.style.background = st.bg;

  // Apply eye color directly to SVG
  if (st.eyeColor) {
    const iL = document.getElementById('avIrisColorL');
    const iR = document.getElementById('avIrisColorR');
    if (iL) iL.setAttribute('fill', st.eyeColor);
    if (iR) iR.setAttribute('fill', st.eyeColor);
  }

  // Rebuild the avatar SVG directly
  _rebuildAvatarFromState();

  // Sync UI selectors
  if (st.shirt) document.querySelectorAll('#shirtStyleRow .opt-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick')?.includes("'"+st.shirt+"'")));
  if (st.pants) document.querySelectorAll('#pantsRow .opt-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick')?.includes("'"+st.pants+"'")));
  if (st.shoes) document.querySelectorAll('#shoeRow .opt-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick')?.includes("'"+st.shoes+"'")));
  if (st.acc)   document.querySelectorAll('#accRow .opt-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick')?.includes("'"+st.acc+"'")));
  if (st.hair)  document.querySelectorAll('#hairStyleRow .opt-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick')?.includes("'"+st.hair+"'")));

  showToast((styleName.charAt(0).toUpperCase()+styleName.slice(1)) + ' style applied! âœ¨', 2200);
  if (s.greeting && document.getElementById('avatarAutoGreet')?.checked) {
    setTimeout(() => speakText(s.greeting), 400);
  }
}

function _rebuildAvatarFromState() {
  try {
    const s = avState;
    const hc = s.hairColor || '#5c3d2e';
    const sc = s.shirtColor || '#c9b3e8';
    const pc = s.pantsColor || '#7a6fa0';
    const shc = s.shoeColor || '#c9b3e8';

    const hairMap = {
      twin: `<ellipse cx="60" cy="18" rx="38" ry="28" fill="${hc}"/><ellipse cx="60" cy="13" rx="30" ry="16" fill="${hc}"/><rect x="20" y="18" width="16" height="44" rx="8" fill="${hc}"/><rect x="84" y="18" width="16" height="44" rx="8" fill="${hc}"/><circle cx="20" cy="16" r="15" fill="${hc}"/><circle cx="100" cy="16" r="15" fill="${hc}"/>`,
      short: `<ellipse cx="60" cy="22" rx="40" ry="24" fill="${hc}"/><rect x="18" y="28" width="14" height="26" rx="7" fill="${hc}"/><rect x="88" y="28" width="14" height="26" rx="7" fill="${hc}"/>`,
      ponytail: `<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><ellipse cx="60" cy="12" rx="28" ry="14" fill="${hc}"/><rect x="80" y="8" width="12" height="55" rx="6" fill="${hc}"/><ellipse cx="86" cy="64" rx="10" ry="7" fill="${hc}"/>`,
      long: `<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><rect x="18" y="22" width="15" height="72" rx="7" fill="${hc}"/><rect x="87" y="22" width="15" height="72" rx="7" fill="${hc}"/>`,
      pixie: `<ellipse cx="60" cy="18" rx="38" ry="22" fill="${hc}"/><ellipse cx="60" cy="8" rx="26" ry="12" fill="${hc}"/><rect x="19" y="24" width="12" height="18" rx="6" fill="${hc}"/>`,
      braids: `<ellipse cx="60" cy="16" rx="37" ry="25" fill="${hc}"/><rect x="16" y="24" width="12" height="80" rx="6" fill="${hc}"/><rect x="92" y="24" width="12" height="80" rx="6" fill="${hc}"/><ellipse cx="22" cy="108" rx="9" ry="7" fill="${hc}"/><ellipse cx="98" cy="108" rx="9" ry="7" fill="${hc}"/>`,
      curly: `<ellipse cx="60" cy="14" rx="42" ry="28" fill="${hc}"/><circle cx="18" cy="42" r="14" fill="${hc}"/><circle cx="102" cy="42" r="14" fill="${hc}"/><circle cx="24" cy="18" r="12" fill="${hc}"/><circle cx="96" cy="18" r="12" fill="${hc}"/><circle cx="60" cy="6" r="12" fill="${hc}"/>`,
      sidetail: `<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><rect x="90" y="14" width="14" height="70" rx="7" fill="${hc}"/><ellipse cx="97" cy="86" rx="11" ry="8" fill="${hc}"/><rect x="18" y="22" width="12" height="22" rx="6" fill="${hc}"/>`,
    };
    const shirtMap = {
      tshirt: `<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/>`,
      hoodie: `<rect x="24" y="88" width="72" height="44" rx="18" fill="${sc}" id="avShirtShape"/><rect x="44" y="88" width="32" height="16" rx="6" fill="${sc==='#1f2937'?'#374151':'rgba(0,0,0,0.12)'}" opacity="0.6"/>`,
      uniform: `<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/><rect x="54" y="90" width="12" height="40" fill="rgba(255,255,255,0.25)"/>`,
      dress: `<rect x="26" y="90" width="68" height="50" rx="16" fill="${sc}" id="avShirtShape"/><path d="M26 120 Q60 148 94 120 L94 140 Q60 165 26 140Z" fill="${sc}" opacity="0.8"/>`,
      sundress: `<rect x="28" y="90" width="64" height="48" rx="18" fill="${sc}" id="avShirtShape"/><path d="M22 118 Q60 152 98 118 L98 148 Q60 178 22 148Z" fill="${sc}"/>`,
      kitty: `<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/><text x="60" y="116" text-anchor="middle" font-size="18">ðŸ±</text>`,
      bear: `<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/><text x="60" y="116" text-anchor="middle" font-size="18">ðŸ»</text>`,
      stripes: `<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/><line x1="26" y1="98" x2="94" y2="98" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="108" x2="94" y2="108" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="118" x2="94" y2="118" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="128" x2="94" y2="128" stroke="rgba(255,255,255,0.35)" stroke-width="4"/>`,
    };
    const pantsMap = {
      pants: `<rect x="28" y="122" width="64" height="38" rx="14" fill="${pc}" id="avBottomShape"/>`,
      jeans: `<rect x="28" y="122" width="64" height="38" rx="14" fill="#4a74a8" id="avBottomShape"/><line x1="60" y1="122" x2="60" y2="160" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>`,
      skirt: `<path d="M22 122 Q60 162 98 122Z" fill="${pc}" id="avBottomShape"/><rect x="28" y="118" width="64" height="12" rx="6" fill="${pc}" opacity="0.8"/>`,
      miniskirt: `<path d="M26 122 Q60 148 94 122Z" fill="${pc}" id="avBottomShape"/><rect x="28" y="118" width="64" height="10" rx="5" fill="${pc}" opacity="0.8"/>`,
      shorts: `<rect x="28" y="122" width="28" height="22" rx="10" fill="${pc}" id="avBottomShape"/><rect x="64" y="122" width="28" height="22" rx="10" fill="${pc}"/>`,
      plaid: `<rect x="28" y="122" width="64" height="38" rx="14" fill="${pc}" id="avBottomShape"/><line x1="36" y1="122" x2="36" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="48" y1="122" x2="48" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="72" y1="122" x2="72" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="28" y1="132" x2="92" y2="132" stroke="rgba(255,255,255,0.3)" stroke-width="2"/><line x1="28" y1="144" x2="92" y2="144" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>`,
      leggings: `<rect x="37" y="122" width="20" height="48" rx="10" fill="${pc}" id="avBottomShape"/><rect x="63" y="122" width="20" height="48" rx="10" fill="${pc}"/>`,
    };
    const shoeMap = {
      sneakers: `<ellipse cx="38" cy="191" rx="17" ry="9" fill="${shc}" id="avShoeL"/><ellipse cx="78" cy="191" rx="17" ry="9" fill="${shc}" id="avShoeR"/><ellipse cx="36" cy="187" rx="14" ry="7" fill="rgba(255,255,255,0.4)"/><ellipse cx="80" cy="187" rx="14" ry="7" fill="rgba(255,255,255,0.4)"/>`,
      heels: `<ellipse cx="40" cy="190" rx="14" ry="7" fill="${shc}"/><ellipse cx="76" cy="190" rx="14" ry="7" fill="${shc}"/><rect x="44" y="191" width="4" height="10" rx="2" fill="${shc}"/><rect x="72" y="191" width="4" height="10" rx="2" fill="${shc}"/>`,
      boots: `<rect x="24" y="176" width="24" height="20" rx="8" fill="${shc}"/><rect x="72" y="176" width="24" height="20" rx="8" fill="${shc}"/><ellipse cx="36" cy="196" rx="14" ry="6" fill="${shc}"/><ellipse cx="84" cy="196" rx="14" ry="6" fill="${shc}"/>`,
      loafers: `<ellipse cx="38" cy="191" rx="17" ry="8" fill="${shc}"/><ellipse cx="78" cy="191" rx="17" ry="8" fill="${shc}"/><rect x="26" y="184" width="22" height="7" rx="3" fill="${shc}" opacity="0.7"/><rect x="72" y="184" width="22" height="7" rx="3" fill="${shc}" opacity="0.7"/>`,
      barefoot: `<ellipse cx="38" cy="191" rx="14" ry="7" fill="${s.skin}"/><ellipse cx="78" cy="191" rx="14" ry="7" fill="${s.skin}"/>`,
    };
    const accMap = {
      none: '',
      bow: `<ellipse cx="36" cy="28" rx="12" ry="7" fill="#f9a8d4" transform="rotate(-25 36 28)"/><ellipse cx="62" cy="22" rx="12" ry="7" fill="#f9a8d4" transform="rotate(15 62 22)"/><circle cx="48" cy="25" r="6" fill="#f9a8d4"/>`,
      crown: `<polygon points="20,42 30,20 48,32 66,20 80,42" fill="#ffd700" stroke="#f0a500" stroke-width="1.5"/><circle cx="30" cy="22" r="4" fill="#ff6b6b"/><circle cx="48" cy="32" r="4" fill="#6bcfff"/><circle cx="66" cy="22" r="4" fill="#98f59a"/>`,
      catears: `<polygon points="16,50 20,28 34,44" fill="${hc}"/><polygon points="86,44 100,28 104,50" fill="${hc}"/><polygon points="18,48 21,34 31,44" fill="#ffd6e7" opacity="0.7"/><polygon points="89,44 99,34 102,48" fill="#ffd6e7" opacity="0.7"/>`,
      flower: `<circle cx="72" cy="30" r="10" fill="#f9a8d4" opacity="0.8"/><circle cx="80" cy="22" r="8" fill="#fde68a" opacity="0.8"/><circle cx="64" cy="22" r="8" fill="#f9a8d4" opacity="0.8"/><circle cx="72" cy="30" r="5" fill="#fde68a"/>`,
      headphones: `<rect x="14" y="50" width="10" height="20" rx="5" fill="#2d2050"/><rect x="96" y="50" width="10" height="20" rx="5" fill="#2d2050"/><path d="M19 55 Q60 30 101 55" stroke="#2d2050" stroke-width="5" fill="none"/><rect x="12" y="54" width="14" height="20" rx="7" fill="${hc}"/><rect x="94" y="54" width="14" height="20" rx="7" fill="${hc}"/>`,
      halo: `<ellipse cx="60" cy="5" rx="26" ry="8" fill="none" stroke="#ffd700" stroke-width="4" opacity="0.85"/>`,
      glasses: `<circle cx="44" cy="58" r="12" fill="none" stroke="#5c3d2e" stroke-width="3"/><circle cx="76" cy="58" r="12" fill="none" stroke="#5c3d2e" stroke-width="3"/><line x1="56" y1="58" x2="64" y2="58" stroke="#5c3d2e" stroke-width="3"/><line x1="20" y1="56" x2="32" y2="57" stroke="#5c3d2e" stroke-width="2.5"/><line x1="88" y1="57" x2="100" y2="56" stroke="#5c3d2e" stroke-width="2.5"/>`,
      wings: `<path d="M14 100 Q-10 80 5 60 Q20 50 30 72Z" fill="${hc}" opacity="0.7"/><path d="M106 100 Q130 80 115 60 Q100 50 90 72Z" fill="${hc}" opacity="0.7"/>`,
    };

    const hair = document.getElementById('avHair');
    const shirt = document.getElementById('avShirt');
    const bottom = document.getElementById('avBottom');
    const shoes = document.getElementById('avShoeGroup');
    const acc = document.getElementById('avAccLayer');

    if (hair) hair.innerHTML = hairMap[s.hair] || hairMap.twin;
    if (shirt) shirt.innerHTML = shirtMap[s.shirt] || shirtMap.tshirt;
    if (bottom) bottom.innerHTML = pantsMap[s.pants] || pantsMap.pants;
    if (shoes) shoes.innerHTML = shoeMap[s.shoes] || shoeMap.sneakers;
    if (acc) acc.innerHTML = accMap[s.acc] || '';

    // Update skin on body parts
    const skinEls = document.querySelectorAll('#avHead,#avNeck,#avEarL,#avEarR,#avArmL,#avArmR,#avLegL,#avLegR');
    skinEls.forEach(el => { if (el) el.setAttribute('fill', s.skin || '#f5c9a0'); });
  } catch(e) {
    console.error('Avatar rebuild error:', e);
    // Fallback to original updateAvatar
    try { updateAvatar(); } catch(e2) {}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AVATAR VOICE (Pro)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedVoiceIndex = 0;
let voicesLoaded = false;
let currentStyleName = null; // tracks the active style for voice matching

// Only these pro styles have voice enabled
const PRO_VOICE_STYLES = new Set([
  'royalcore','cyberpunk','fairycore','angelcore','darkfantasy','ethereal','vaporwave','witchcore'
]);

function isProStyle(name) {
  return PRO_VOICE_STYLES.has(name);
}

// Voice personality per pro style: rate, pitch, preferred voice gender keywords
const styleVoicePersonality = {
  // Royalcore â€” very slow, very regal, medium-high, UK accent
  royalcore:     { rate: 0.72, pitch: 1.12, prefer: ['google uk english female','aria','samantha','zira','jenny'] },
  // Cyberpunk â€” fast, robotic-flat, low
  cyberpunk:     { rate: 1.10, pitch: 0.80, prefer: ['male','david','guy','google uk english male','reed'] },
  // Fairycore â€” fast, whimsical, very high
  fairycore:     { rate: 1.08, pitch: 1.50, prefer: ['samantha','zira','aria','jenny','google us english female'] },
  // Angelcore â€” slow, pure, high and gentle, UK lilt
  angelcore:     { rate: 0.80, pitch: 1.35, prefer: ['google uk english female','aria','samantha','jenny'] },
  // Dark Fantasy â€” slow, deep, dramatic
  darkfantasy:   { rate: 0.76, pitch: 0.78, prefer: ['male','david','guy','google uk english male','reed'] },
  // Ethereal â€” very slow, floaty, airy high
  ethereal:      { rate: 0.75, pitch: 1.28, prefer: ['google uk english female','aria','samantha','jenny'] },
  // Vaporwave â€” drawling, dreamy, medium
  vaporwave:     { rate: 0.88, pitch: 1.05, prefer: ['samantha','zira','aria','jenny','google us english female'] },
  // Witchcore â€” slow, low, mysterious
  witchcore:     { rate: 0.80, pitch: 0.85, prefer: ['samantha','zira','aria','jenny','google us english female'] },
};

function getStyleVoiceParams() {
  const p = currentStyleName && styleVoicePersonality[currentStyleName];
  return p || { rate: 0.92, pitch: 1.15, prefer: [] };
}

function pickVoiceForStyle(voices, styleParams) {
  // If user manually picked a voice, respect it â€” but still adjust rate/pitch
  if (selectedVoiceIndex > 0 && voices[selectedVoiceIndex]) return voices[selectedVoiceIndex];
  // Try to find a preferred voice
  const prefs = styleParams.prefer || [];
  for (const keyword of prefs) {
    const match = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes(keyword.toLowerCase()));
    if (match) return match;
  }
  // Fallback: any English voice
  return voices.find(v => v.lang.startsWith('en')) || voices[0];
}

function initAvatarVoice() {
  const gate = document.getElementById('avatarVoiceGate');
  const controls = document.getElementById('avatarVoiceControls');
  if (!gate || !controls) return;
  gate.style.display = 'none';
  controls.style.display = 'flex';
  populateVoicePicker();
}

function populateVoicePicker() {
  const row = document.getElementById('voicePickerRow');
  if (!row) return;
  const voices = speechSynthesis.getVoices();
  if (!voices.length) {
    speechSynthesis.onvoiceschanged = populateVoicePicker;
    return;
  }
  const preferred = voices.filter(v =>
    v.lang.startsWith('en') &&
    (v.name.includes('Female') || v.name.includes('Male') ||
     v.name.includes('Samantha') || v.name.includes('Google') ||
     v.name.includes('Microsoft') || v.name.includes('Zira') ||
     v.name.includes('David') || v.name.includes('Aria') ||
     v.name.includes('Jenny') || v.name.includes('Guy') ||
     v.name.includes('Reed') || v.name.includes('Nicky'))
  ).slice(0, 8);
  const display = preferred.length ? preferred : voices.slice(0, 6);
  row.innerHTML = '';
  display.forEach((v, i) => {
    const btn = document.createElement('button');
    btn.className = 'opt-btn' + (i === 0 ? ' active' : '');
    btn.textContent = v.name.replace('Microsoft ','').replace(' Online (Natural)','').split(' ')[0];
    btn.title = v.name;
    btn.onclick = () => {
      selectedVoiceIndex = voices.indexOf(v);
      row.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      speakText("Hi! I'm your avatar!", voices.indexOf(v));
    };
    row.appendChild(btn);
  });
  voicesLoaded = true;
}

function speakText(text, forceVoiceIdx) {
  if (!('speechSynthesis' in window)) return;
  // Voice is a pro-style-only feature
  if (!isProStyle(currentStyleName)) {
    showToast('ðŸ‘‘ Voice is available with Pro styles â€” try Royalcore, Fairycore, Witchcore and more!', 3000);
    return;
  }
  speechSynthesis.cancel();
  setTimeout(() => {
    const styleParams = getStyleVoiceParams();
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate  = styleParams.rate;
    utter.pitch = styleParams.pitch;
    const trySpeak = () => {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        if (forceVoiceIdx !== undefined && voices[forceVoiceIdx]) {
          utter.voice = voices[forceVoiceIdx];
        } else {
          utter.voice = pickVoiceForStyle(voices, styleParams);
        }
      }
      speechSynthesis.speak(utter);
    };
    if (speechSynthesis.getVoices().length > 0) { trySpeak(); }
    else { speechSynthesis.onvoiceschanged = () => { speechSynthesis.onvoiceschanged = null; trySpeak(); }; trySpeak(); }
  }, 50);
}

function avatarSpeakGreeting() {
  // Resolve greeting from active style
  let greeting = null;
  let styleName = currentStyleName;
  if (styleName) {
    const s = styleTemplates[styleName] || (typeof proStyles !== 'undefined' && proStyles[styleName]);
    if (s && s.greeting) greeting = s.greeting;
  }
  if (!greeting) {
    // Try reading from active chip as fallback
    const activeChip = document.querySelector('.style-chip.active, .pro-chip.active');
    if (activeChip) {
      const onclick = activeChip.getAttribute('onclick') || '';
      const match = onclick.match(/(?:applyStyle|applyProStyle)\('([^']+)'/);
      if (match) {
        styleName = match[1];
        const s = styleTemplates[styleName] || (typeof proStyles !== 'undefined' && proStyles[styleName]);
        if (s && s.greeting) greeting = s.greeting;
      }
    }
  }
  if (!greeting) {
    const greetings = [
      "Hi there! I'm your avatar â€” let's get things done today!",
      "Hey! Ready to track, plan, and conquer? Let's go!",
      "Hello! Your productivity partner is here. What are we tackling?",
      "Hi! I'm here to keep you on track. You've got this!",
    ];
    greeting = greetings[Math.floor(Math.random() * greetings.length)];
  }
  // Animate the button
  const btn = document.getElementById('avSpeakBtn');
  const ring = document.getElementById('avSpeakRing');
  if (btn) btn.textContent = 'ðŸ”ˆ';
  if (ring) { ring.style.opacity = '1'; ring.style.animation = 'speakRipple 0.8s ease-out infinite'; }
  speakText(greeting);
  const duration = Math.max(1800, greeting.length * 75);
  setTimeout(() => {
    if (btn) btn.innerHTML = 'ðŸ”Š<span id="avSpeakRing" style="position:absolute;inset:-4px;border-radius:50%;border:3px solid rgba(139,92,246,0.5);opacity:0;pointer-events:none;"></span>';
  }, duration);
}

function avatarSpeak() {
  const text = document.getElementById('avatarSpeakText')?.value?.trim();
  if (!text) { showToast('Type something for your avatar to say!', 2000); return; }
  speakText(text);
}

// Hook into openAvatarModal to init voice
const _origOpenAvatarModal = window.openAvatarModal;
window.openAvatarModal = function() {
  if (_origOpenAvatarModal) _origOpenAvatarModal();
  setTimeout(initAvatarVoice, 100);
  // Restore custom bg
  const savedBg = localStorage.getItem('av_custom_bg');
  if (savedBg) {
    const bg = document.getElementById('avBg');
    if (bg) {
      bg.style.backgroundImage = `url(${savedBg})`;
      bg.style.backgroundSize = 'cover';
      bg.style.backgroundPosition = 'center';
      bg.style.background = '';
    }
    const preview = document.getElementById('avBgPhotoPreview');
    if (preview) preview.style.display = 'block';
  }
};
</script>

<script>
// ===== TYPING INDICATOR =====
let _typingTimeout = null;
let _typingListenerUnsub = null;

function handleGroupTyping() {
  if (!firebaseReady || !currentGroup || !currentUserId) return;
  const myName = document.getElementById('sidebarName')?.textContent || 'Someone';
  db.collection('shared_groups').doc(currentGroup)
    .collection('typing').doc(currentUserId)
    .set({name: myName, ts: Date.now()}, {merge: true})
    .catch(()=>{});
  clearTimeout(_typingTimeout);
  _typingTimeout = setTimeout(clearGroupTyping, 3000);
}

function clearGroupTyping() {
  if (!firebaseReady || !currentGroup || !currentUserId) return;
  db.collection('shared_groups').doc(currentGroup)
    .collection('typing').doc(currentUserId)
    .delete().catch(()=>{});
}

function listenToTypingIndicator(gid) {
  if (_typingListenerUnsub) { try{_typingListenerUnsub();}catch(e){} _typingListenerUnsub=null; }
  if (!firebaseReady || !gid) return;
  _typingListenerUnsub = db.collection('shared_groups').doc(gid)
    .collection('typing')
    .onSnapshot(snap => {
      const now = Date.now();
      const names = [];
      snap.forEach(doc => {
        const d = doc.data();
        if (doc.id !== currentUserId && d.ts && (now - d.ts < 4000)) names.push(d.name);
      });
      const el = document.getElementById('groupTypingIndicator');
      if (!el) return;
      if (names.length === 0) {
        el.style.opacity = '0';
        el.innerHTML = '';
      } else {
        const txt = names.length === 1 ? names[0] + ' is typing' : names.slice(0,-1).join(', ') + ' and ' + names.slice(-1) + ' are typing';
        el.innerHTML = `<div class="msng-typing-dots"><div class="msng-typing-dot"></div><div class="msng-typing-dot"></div><div class="msng-typing-dot"></div></div><span style="margin-left:6px;">${txt}</span>`;
        el.style.opacity = '1';
      }
    }, ()=>{});
}
</script>

</body>
</html>
