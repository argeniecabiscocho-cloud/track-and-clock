<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Track & Clock</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client"></script>
<style>
:root{
  --lav:#c9b3e8;--mint:#b8f0c8;--lilac:#d8c4f0;--white:#f8f6ff;
  --dark:#3d3260;--mid:#7a6fa0;--card:rgba(255,255,255,0.72);
  --shadow:0 8px 32px rgba(160,130,210,0.18);--accent:#8b5cf6;--accent2:#5eead4;
  --sidebar-w:268px;--bg1:#d4c8f0;--bg2:#c8ecd4;--bg3:#e0d0f8;
  --base-font:16px;--text-on-theme:var(--dark);--text-mid-theme:var(--mid);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Quicksand',sans-serif;font-size:var(--base-font);min-height:100vh;overflow:hidden;background:#e8e0f5;color:var(--text-on-theme);}

/* ===== ANIMATED BG ===== */
.bg-anim{position:fixed;inset:0;z-index:0;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3),#b8f0d4,var(--bg1));background-size:400% 400%;animation:bgShift 12s ease infinite;}
.blob{position:fixed;border-radius:60% 40% 70% 30%/50% 60% 40% 70%;filter:blur(60px);opacity:0.45;animation:blobMove 18s ease-in-out infinite;z-index:0;}
.blob1{width:500px;height:400px;background:var(--lav);top:-100px;left:-100px;}
.blob2{width:400px;height:350px;background:var(--mint);bottom:-80px;right:-80px;animation-delay:-6s;}
.blob3{width:350px;height:300px;background:var(--lilac);top:40%;left:40%;animation-delay:-3s;}
@keyframes bgShift{0%,100%{background-position:0% 50%;}50%{background-position:100% 50%;}}
@keyframes blobMove{0%,100%{border-radius:60% 40% 70% 30%/50% 60% 40% 70%;transform:translate(0,0);}33%{border-radius:40% 60% 30% 70%/60% 40% 70% 50%;transform:translate(30px,-20px);}66%{border-radius:70% 30% 60% 40%/40% 70% 30% 60%;transform:translate(-20px,30px);}}

/* ===== THEME DECORATIONS ===== */
.theme-deco{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;}
.deco-el{position:absolute;font-size:1.8rem;opacity:0.12;animation:decoFloat 8s ease-in-out infinite;user-select:none;}
@keyframes decoFloat{0%,100%{transform:translateY(0) rotate(0deg);}50%{transform:translateY(-18px) rotate(8deg);}}

/* ===== INTRO ===== */
#introScreen{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#d4c8f0,#c8ecd4,#e0d0f8);background-size:300% 300%;animation:bgShift 6s ease infinite;}
#introScreen.gone{display:none;}
.intro-clock{position:relative;width:200px;height:200px;animation:clockZoom 3.8s ease-in-out forwards;}
@keyframes clockZoom{0%{transform:scale(0.1) rotate(-720deg);opacity:0;}40%{transform:scale(1.18) rotate(0deg);opacity:1;}55%{transform:scale(0.9);}70%{transform:scale(1.1);}85%{transform:scale(0.96);}100%{transform:scale(1);}}
.intro-clock-body{width:176px;height:176px;border-radius:50%;background:linear-gradient(135deg,#d8c4f0,#c9b3e8);border:7px solid #b89fd4;position:absolute;top:12px;left:12px;box-shadow:0 12px 44px rgba(140,100,220,0.32);display:flex;align-items:center;justify-content:center;}
.intro-clock-face{width:142px;height:142px;border-radius:50%;background:rgba(255,255,255,0.9);position:relative;display:flex;align-items:center;justify-content:center;}
.clock-center{width:12px;height:12px;border-radius:50%;background:#5eead4;position:absolute;z-index:3;}
.hand-h{position:absolute;bottom:50%;left:50%;transform-origin:bottom center;width:5px;height:42px;border-radius:4px;background:#8b5cf6;transform:translateX(-50%);animation:spinH 3s linear infinite;}
.hand-m{position:absolute;bottom:50%;left:50%;transform-origin:bottom center;width:3.5px;height:54px;border-radius:3px;background:#5eead4;transform:translateX(-50%) rotate(90deg);animation:spinM 9s linear infinite;}
.hand-s{position:absolute;bottom:50%;left:50%;transform-origin:bottom center;width:2px;height:58px;border-radius:2px;background:#e87878;transform:translateX(-50%) rotate(180deg);animation:spinH 1s linear infinite;}
@keyframes spinH{to{transform:translateX(-50%) rotate(360deg);}}
@keyframes spinM{to{transform:translateX(-50%) rotate(360deg);}}
.clock-ring{position:absolute;width:200px;height:200px;border-radius:50%;border:3px solid rgba(200,180,240,0.5);top:0;left:0;animation:ringPulse 2s ease-in-out infinite;}
.clock-ring2{position:absolute;width:228px;height:228px;border-radius:50%;border:2px solid rgba(180,240,200,0.3);top:-14px;left:-14px;animation:ringPulse 2.6s ease-in-out infinite 0.5s;}
@keyframes ringPulse{0%,100%{transform:scale(1);opacity:0.6;}50%{transform:scale(1.08);opacity:0.12;}}
.intro-btn-top{position:absolute;top:3px;left:50%;transform:translateX(-50%);width:24px;height:14px;background:#5eead4;border-radius:5px;}
/* tick marks */
.tick{position:absolute;width:2px;background:#c9b3e8;border-radius:1px;top:6px;left:50%;transform-origin:bottom center;transform:translateX(-50%);}
.intro-brand{font-family:'Nunito',sans-serif;font-size:2.6rem;font-weight:900;background:linear-gradient(135deg,#8b5cf6,#5eead4,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:28px;opacity:0;animation:fadeUp 0.7s 3.2s ease forwards;}
.intro-subtitle{font-family:'Nunito',sans-serif;font-size:1.05rem;font-weight:700;color:#7a6fa0;opacity:0;animation:fadeUp 0.7s 3.8s ease forwards;margin-top:6px;}
.sparkle{position:absolute;font-size:1.4rem;animation:sparklePop 0.8s ease forwards;pointer-events:none;}
@keyframes sparklePop{0%{transform:scale(0);opacity:1;}100%{transform:scale(1.7);opacity:0;}}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:none;}}
@keyframes fadeDown{from{opacity:0;transform:translateY(-18px);}to{opacity:1;transform:none;}}
@keyframes cardPop{from{opacity:0;transform:scale(0.7) translateY(28px);}to{opacity:1;transform:none;}}

/* ===== MOBILE: simplified intro to prevent stalling ===== */
@media (max-width: 768px) {
  /* Simple fade+scale instead of 3.8s spin — much lighter */
  .intro-clock { animation: clockZoomMobile 0.8s ease-out forwards !important; }
  @keyframes clockZoomMobile {
    0%  { transform: scale(0.6); opacity: 0; }
    100%{ transform: scale(1);   opacity: 1; }
  }
  /* Stop the pulsing rings on mobile */
  .clock-ring, .clock-ring2 { animation: none !important; }
  /* Slow down second hand — 1s spin is heavy on mobile */
  .hand-s { animation: spinH 2s linear infinite !important; }
  /* Show brand and tagline sooner since clock appears faster */
  .intro-brand   { animation: fadeUp 0.6s 1.0s ease forwards !important; }
  .intro-subtitle{ animation: fadeUp 0.6s 1.6s ease forwards !important; }
  /* Stop intro bg animation */
  #introScreen { animation: none !important; background: linear-gradient(135deg,#d4c8f0,#c8ecd4,#e0d0f8) !important; }
}

/* ===== INVITE MODAL ===== */
.invite-modal-overlay{position:fixed;inset:0;z-index:220;background:rgba(60,40,100,0.35);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;transition:opacity 0.3s;}
.invite-modal-overlay.hidden{opacity:0;pointer-events:none;}
.invite-modal{background:rgba(255,255,255,0.97);border-radius:28px;padding:30px 28px 24px;width:420px;max-width:95vw;box-shadow:0 28px 70px rgba(100,80,150,0.26);border:2px solid rgba(200,180,240,0.45);animation:cardPop 0.38s cubic-bezier(.34,1.56,.64,1) both;display:flex;flex-direction:column;gap:0;}
.invite-modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.invite-modal-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.18rem;color:var(--dark);}
.invite-modal-close{width:32px;height:32px;border-radius:50%;border:none;background:rgba(200,180,240,0.3);cursor:pointer;font-size:1rem;color:var(--mid);display:flex;align-items:center;justify-content:center;transition:background 0.2s;}
.invite-modal-close:hover{background:rgba(200,180,240,0.6);}
.invite-group-badge{display:inline-flex;align-items:center;gap:7px;padding:7px 16px;border-radius:20px;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;margin-bottom:20px;margin-top:8px;border:2px solid rgba(200,180,240,0.3);}
.invite-field-label{font-size:0.74rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;margin-top:14px;}
.invite-field{width:100%;padding:12px 15px;border-radius:14px;border:2px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.85);font-family:'Quicksand',sans-serif;font-size:0.95rem;color:var(--dark);outline:none;transition:border 0.2s;}
.invite-field:focus{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.12);}
.invite-preview{background:linear-gradient(135deg,rgba(200,180,240,0.15),rgba(180,240,200,0.12));border:1.5px dashed rgba(200,180,240,0.5);border-radius:14px;padding:14px 16px;margin-top:14px;font-size:0.82rem;color:var(--mid);font-weight:600;line-height:1.7;display:none;}
.invite-preview.show{display:block;}
.invite-preview b{color:var(--dark);}
.invite-preview .invite-link-preview{font-size:0.73rem;color:#8b5cf6;word-break:break-all;margin-top:4px;}
.invite-actions{display:flex;gap:10px;margin-top:20px;}
.invite-send-btn{flex:1;padding:13px;border-radius:15px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:900;font-size:0.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform 0.15s,box-shadow 0.15s;box-shadow:0 4px 16px rgba(139,92,246,0.2);}
.invite-send-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(139,92,246,0.28);}
.invite-copy-btn{padding:13px 18px;border-radius:15px;border:2px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);color:var(--mid);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;cursor:pointer;transition:all 0.15s;}
.invite-copy-btn:hover{border-color:var(--lav);background:rgba(200,180,240,0.2);}
/* Members list inside chat header */
.group-members-row{display:flex;align-items:center;gap:6px;padding:8px 0 4px;flex-wrap:wrap;}
.member-chip{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;background:rgba(200,180,240,0.2);border:1.5px solid rgba(200,180,240,0.3);font-size:0.74rem;font-weight:700;color:var(--dark);}
.member-chip .member-dot{width:7px;height:7px;border-radius:50%;background:#5eead4;flex-shrink:0;}
.invite-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:12px;border:2px solid rgba(139,92,246,0.3);background:linear-gradient(135deg,rgba(200,180,240,0.3),rgba(180,240,200,0.2));color:#5a3ea0;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.8rem;cursor:pointer;transition:all 0.18s;flex-shrink:0;}
.invite-btn:hover{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.55),rgba(180,240,200,0.4));transform:scale(1.04);}
/* Joined banner */
.join-banner{background:linear-gradient(135deg,rgba(180,240,200,0.4),rgba(200,180,240,0.3));border:2px solid rgba(94,234,212,0.4);border-radius:16px;padding:14px 18px;display:flex;align-items:center;gap:13px;animation:cardPop 0.4s ease both;margin-bottom:8px;}
.join-banner-icon{font-size:1.8rem;flex-shrink:0;}
.join-banner-text{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.92rem;color:var(--dark);}
.join-banner-sub{font-size:0.78rem;color:var(--mid);font-weight:600;margin-top:2px;}

/* ===== NOTIFICATION BELL ===== */
.notif-bell-btn{position:fixed;top:14px;right:68px;z-index:160;width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,255,255,0.82);backdrop-filter:blur(16px);box-shadow:0 4px 16px rgba(140,100,220,0.18);cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:transform 0.2s;}
.notif-bell-btn:hover{transform:scale(1.12);}
.notif-badge{position:absolute;top:6px;right:6px;width:16px;height:16px;border-radius:50%;background:#e05050;color:#fff;font-size:0.62rem;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid white;}
.notif-badge.hidden{display:none;}
.notif-panel{position:fixed;top:62px;right:18px;z-index:170;width:320px;max-height:480px;background:rgba(255,255,255,0.95);backdrop-filter:blur(24px);border-radius:22px;box-shadow:0 12px 48px rgba(140,100,220,0.22);border:1.5px solid rgba(200,180,240,0.35);display:flex;flex-direction:column;transition:opacity 0.25s,transform 0.25s;transform-origin:top right;}
.notif-panel.hidden{opacity:0;pointer-events:none;transform:scale(0.92) translateY(-8px);}
.notif-panel-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;border-bottom:1px solid rgba(200,180,240,0.2);}
.notif-panel-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;color:var(--dark);}
.notif-clear-btn{font-size:0.72rem;font-weight:800;color:var(--mid);cursor:pointer;padding:4px 9px;border-radius:9px;border:none;background:rgba(200,180,240,0.25);}
.notif-list{flex:1;overflow-y:auto;padding:8px 10px;display:flex;flex-direction:column;gap:7px;}
.notif-item{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:14px;border:1.5px solid rgba(200,180,240,0.25);background:rgba(255,255,255,0.7);animation:cardPop 0.3s ease both;}
.notif-item.unread{background:linear-gradient(135deg,rgba(200,180,240,0.2),rgba(180,240,200,0.15));border-color:rgba(139,92,246,0.3);}
.notif-item.login{border-color:rgba(94,234,212,0.5);background:linear-gradient(135deg,rgba(180,240,200,0.2),rgba(200,240,255,0.15));}
.notif-item.warning{border-color:rgba(251,191,36,0.4);background:linear-gradient(135deg,rgba(255,240,180,0.25),rgba(255,220,150,0.15));}
.notif-icon{font-size:1.4rem;flex-shrink:0;margin-top:1px;}
.notif-body{flex:1;min-width:0;}
.notif-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.83rem;color:var(--dark);}
.notif-msg{font-size:0.75rem;color:var(--mid);font-weight:600;margin-top:2px;}
.notif-time{font-size:0.68rem;color:var(--mid);margin-top:4px;font-weight:600;}
.notif-dismiss{background:none;border:none;cursor:pointer;font-size:0.8rem;color:var(--mid);padding:2px;opacity:0.6;}
.notif-dismiss:hover{opacity:1;}
.notif-empty{text-align:center;padding:28px;font-size:0.88rem;color:var(--mid);font-weight:600;}
.notif-add-section{padding:10px 12px;border-top:1px solid rgba(200,180,240,0.2);}
.notif-add-title{font-size:0.72rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.notif-add-row{display:flex;flex-direction:column;gap:6px;}
.notif-input{padding:7px 10px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);font-family:'Quicksand',sans-serif;font-size:0.78rem;color:var(--dark);outline:none;width:100%;}
.notif-add-btn{padding:8px;border-radius:11px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.78rem;cursor:pointer;}
.toast-notif{position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:300;background:rgba(255,255,255,0.96);backdrop-filter:blur(20px);border-radius:18px;padding:14px 22px;box-shadow:0 8px 32px rgba(140,100,220,0.22);border:1.5px solid rgba(200,180,240,0.4);display:flex;align-items:center;gap:12px;min-width:280px;max-width:380px;animation:fadeDown 0.4s ease both;}
.toast-notif.hide{animation:fadeUp 0.3s ease forwards;opacity:0;}
.toast-notif-icon{font-size:1.6rem;flex-shrink:0;}
.toast-notif-body{flex:1;}
.toast-notif-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:0.88rem;color:var(--dark);}
.toast-notif-msg{font-size:0.78rem;color:var(--mid);font-weight:600;margin-top:2px;}
/* ===== AVATAR STYLE TEMPLATES ===== */
.style-chips{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:8px;}
.style-chip{display:flex;align-items:center;gap:5px;padding:7px 12px;border-radius:14px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.6);cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.77rem;color:var(--mid);transition:all 0.18s;}
.style-chip:hover{border-color:var(--lav);background:rgba(200,180,240,0.2);}
.style-chip.active{background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.4));border-color:#8b5cf6;color:var(--dark);transform:scale(1.04);}
.style-preview-box{background:rgba(255,255,255,0.6);border-radius:16px;border:1.5px solid rgba(200,180,240,0.3);padding:11px 14px;font-size:0.79rem;color:var(--dark);font-weight:600;line-height:1.75;display:none;margin-top:6px;}
.style-preview-box.show{display:block;}
.style-preview-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:0.88rem;color:var(--dark);margin-bottom:6px;}
/* MUSIC PLAYER */
#musicPlayer{position:fixed;bottom:18px;right:18px;z-index:150;background:rgba(255,255,255,0.86);backdrop-filter:blur(20px);border-radius:22px;padding:13px 16px;box-shadow:0 8px 28px rgba(140,100,220,0.18);border:1.5px solid rgba(200,180,240,0.35);width:305px;transition:all 0.3s;}
#musicPlayer.mini{width:auto!important;min-width:160px;}
#musicPlayer.mini .mp-full{display:none!important;}
.mp-header{display:flex;align-items:center;gap:9px;}
.mp-note{font-size:1.15rem;}
.mp-track-name{font-family:'Nunito',sans-serif;font-size:0.79rem;font-weight:800;color:var(--dark);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mp-min-btn{background:none;border:none;cursor:pointer;font-size:0.9rem;color:var(--mid);padding:2px 5px;border-radius:6px;}
.mp-min-btn:hover{background:rgba(200,180,240,0.3);}
.mp-full{margin-top:9px;display:flex;flex-direction:column;gap:8px;}
.mp-controls-row{display:flex;align-items:center;gap:7px;}
.mp-btn{width:30px;height:30px;border-radius:50%;border:none;background:rgba(200,180,240,0.35);cursor:pointer;font-size:0.88rem;display:flex;align-items:center;justify-content:center;transition:background 0.2s;color:var(--dark);}
.mp-btn:hover{background:var(--lav);}
.mp-vol{-webkit-appearance:none;width:72px;height:4px;border-radius:2px;background:rgba(200,180,240,0.4);cursor:pointer;outline:none;}
.mp-vol::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#8b5cf6;cursor:pointer;}
.mp-mood-row{display:flex;gap:5px;flex-wrap:wrap;}
.mp-mood-chip{padding:4px 10px;border-radius:12px;border:1.5px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-size:0.73rem;font-weight:700;color:var(--mid);transition:all 0.15s;font-family:'Nunito',sans-serif;}
.mp-mood-chip:hover,.mp-mood-chip.active{background:var(--lilac);border-color:var(--lav);color:var(--dark);}
.mp-search-row{display:flex;gap:6px;}
.mp-search-input{flex:1;padding:7px 10px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.79rem;color:var(--dark);outline:none;}
.mp-search-input::placeholder{color:rgba(120,100,160,0.5);}
.mp-search-btn{padding:7px 10px;border-radius:10px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.76rem;cursor:pointer;}
.mp-genre-row{display:flex;gap:5px;flex-wrap:wrap;margin-top:2px;}
.mp-genre-chip{padding:4px 9px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-size:0.7rem;font-weight:700;color:var(--mid);transition:all 0.15s;font-family:'Nunito',sans-serif;}
.mp-genre-chip:hover,.mp-genre-chip.active{background:var(--lilac);border-color:var(--lav);color:var(--dark);}
.mp-now-playing{display:flex;align-items:center;gap:8px;padding:8px 10px;background:linear-gradient(135deg,rgba(200,180,240,0.25),rgba(180,240,200,0.2));border-radius:12px;border:1.5px solid rgba(200,180,240,0.3);margin-top:4px;}
.mp-now-playing.hidden{display:none;}
.mp-np-art{width:38px;height:38px;border-radius:8px;object-fit:cover;background:var(--lilac);flex-shrink:0;}
.mp-np-info{flex:1;min-width:0;}
.mp-np-title{font-size:0.74rem;font-weight:800;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mp-np-artist{font-size:0.67rem;color:var(--mid);font-weight:600;}
.mp-np-stop{background:none;border:none;cursor:pointer;font-size:1rem;color:var(--mid);padding:2px;}
.mp-np-stop:hover{color:#e87878;}
.mp-results{max-height:120px;overflow-y:auto;display:flex;flex-direction:column;gap:4px;}
.mp-result-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:9px;cursor:pointer;transition:background 0.14s;}
.mp-result-item:hover{background:rgba(200,180,240,0.25);}
.mp-result-thumb{width:30px;height:30px;border-radius:6px;object-fit:cover;flex-shrink:0;background:var(--lilac);display:flex;align-items:center;justify-content:center;font-size:1rem;}
.mp-result-info{flex:1;min-width:0;}
.mp-result-title{font-size:0.75rem;font-weight:700;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mp-result-channel{font-size:0.67rem;color:var(--mid);font-weight:600;}
.mp-yt-player{margin-top:6px;border-radius:10px;overflow:hidden;display:none;}
.mp-yt-player iframe{width:100%;height:135px;border:none;border-radius:10px;}

/* ===== SCREENS ===== */
.screen{position:fixed;inset:0;z-index:5;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.45s,transform 0.45s;}
.screen.hidden{display:none!important;}

/* ===== LANDING ===== */
#landing{padding:18px;}
.logo-wrap{display:flex;align-items:center;gap:14px;margin-bottom:14px;animation:fadeDown 0.8s ease both;}
.brand-name{font-family:'Nunito',sans-serif;font-size:2.8rem;font-weight:900;background:linear-gradient(135deg,#8b5cf6,#5eead4,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-1px;}
.logo-img{width:72px;height:72px;border-radius:50%;background:var(--card);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;animation:spinIn 0.9s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes spinIn{from{opacity:0;transform:rotate(-180deg) scale(0.4);}to{opacity:1;transform:none;}}
.welcome-text{font-family:'Nunito',sans-serif;font-size:2rem;font-weight:800;color:var(--dark);animation:fadeDown 0.8s 0.12s ease both;text-align:center;}
.tagline{font-size:1rem;color:var(--mid);font-weight:600;margin-top:4px;margin-bottom:18px;animation:fadeDown 0.8s 0.22s ease both;text-align:center;}
.occ-label{font-size:0.96rem;font-weight:700;color:var(--mid);margin-bottom:10px;text-align:center;animation:fadeDown 0.8s 0.3s ease both;}
.occ-grid{display:flex;flex-wrap:wrap;gap:9px;justify-content:center;margin-bottom:20px;animation:fadeUp 0.8s 0.35s ease both;max-width:500px;}
.occ-btn{display:flex;flex-direction:column;align-items:center;gap:5px;padding:11px 16px;border-radius:18px;border:2.5px solid rgba(200,180,240,0.35);background:rgba(255,255,255,0.6);cursor:pointer;font-family:'Nunito',sans-serif;font-size:0.85rem;font-weight:700;color:var(--dark);transition:all 0.2s;backdrop-filter:blur(10px);min-width:88px;}
.occ-btn .occ-icon{font-size:1.7rem;}
.occ-btn:hover{border-color:var(--lav);background:rgba(200,180,240,0.3);transform:translateY(-2px);}
.occ-btn.active{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.45),rgba(180,240,200,0.3));transform:translateY(-3px);box-shadow:0 6px 20px rgba(139,92,246,0.18);}
.start-btn{padding:14px 44px;border-radius:50px;border:none;background:linear-gradient(135deg,#c9b3e8,#a3d9b1);color:var(--dark);font-family:'Nunito',sans-serif;font-size:1.12rem;font-weight:800;cursor:pointer;box-shadow:0 6px 24px rgba(160,130,210,0.30);transition:transform 0.2s,box-shadow 0.2s;animation:fadeUp 0.8s 0.45s ease both;}
.start-btn:hover{transform:translateY(-3px) scale(1.04);}

/* Google Sign-In */
.google-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:13px 28px;border-radius:50px;border:2px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);cursor:pointer;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:800;color:var(--dark);transition:all 0.2s;animation:fadeUp 0.8s 0.55s ease both;margin-top:10px;box-shadow:0 4px 16px rgba(0,0,0,0.08);}
.google-btn:hover{background:rgba(255,255,255,0.95);border-color:var(--lav);transform:translateY(-2px);}
.google-icon{width:22px;height:22px;}

/* ===== APP ===== */
#appLayout{position:fixed;inset:0;z-index:2;display:flex;transition:opacity 0.45s;}
#appLayout.hidden{display:none!important;}

/* ===== SIDEBAR ===== */
.sidebar{width:var(--sidebar-w);background:rgba(255,255,255,0.68);backdrop-filter:blur(24px);border-right:1.5px solid rgba(200,180,240,0.28);display:flex;flex-direction:column;z-index:10;transition:transform 0.3s;flex-shrink:0;}
.sidebar-logo{padding:18px 16px 12px;font-family:'Nunito',sans-serif;font-weight:900;font-size:1.2rem;background:linear-gradient(135deg,#8b5cf6,#5eead4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;border-bottom:1px solid rgba(200,180,240,0.2);display:flex;align-items:center;gap:9px;}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto;}
.nav-item{display:flex;align-items:center;gap:11px;padding:12px 18px;cursor:pointer;font-weight:700;font-size:0.92rem;color:var(--text-mid-theme);transition:all 0.2s;border-radius:0 22px 22px 0;margin-right:10px;}
.nav-item:hover{background:rgba(200,180,240,0.25);color:var(--text-on-theme);}
.nav-item.active{background:linear-gradient(135deg,rgba(200,180,240,0.4),rgba(180,240,200,0.3));color:var(--text-on-theme);font-weight:800;}
.nav-item .nav-icon{font-size:1.2rem;width:24px;text-align:center;}
.nav-section-label{padding:12px 18px 3px;font-size:0.68rem;font-weight:800;color:var(--text-mid-theme);text-transform:uppercase;letter-spacing:1.5px;}
.nav-divider{height:1px;background:rgba(200,180,240,0.2);margin:7px 14px;}
.sidebar-footer{padding:12px 16px;border-top:1px solid rgba(200,180,240,0.2);}
.sidebar-user{display:flex;align-items:center;gap:9px;cursor:pointer;padding:8px;border-radius:14px;transition:background 0.2s;margin-bottom:7px;}
.sidebar-user:hover{background:rgba(200,180,240,0.2);}
.sidebar-avatar{width:40px;height:40px;border-radius:50%;border:2.5px solid var(--lav);display:flex;align-items:center;justify-content:center;font-size:1.3rem;background:var(--white);flex-shrink:0;overflow:hidden;}
.sidebar-avatar img{width:100%;height:100%;object-fit:cover;}
.sidebar-username{font-weight:800;font-size:0.9rem;color:var(--text-on-theme);}
.sidebar-occ{font-size:0.7rem;color:#8b5cf6;font-weight:700;}
.sidebar-status{font-size:0.7rem;color:var(--text-mid-theme);}
.auth-btn{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:12px;border:none;background:transparent;cursor:pointer;font-family:'Quicksand',sans-serif;font-weight:700;font-size:0.86rem;color:var(--text-mid-theme);width:100%;transition:all 0.2s;}
.auth-btn:hover{background:rgba(200,180,240,0.25);color:var(--text-on-theme);}
.auth-btn.logout{color:#e05050;}
.auth-btn.logout:hover{background:rgba(220,80,80,0.1);}

/* ===== MAIN ===== */
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 22px;background:rgba(255,255,255,0.6);backdrop-filter:blur(18px);border-bottom:1px solid rgba(200,180,240,0.25);flex-shrink:0;}
.hamburger-btn{width:36px;height:36px;border-radius:10px;border:none;background:rgba(200,180,240,0.3);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;transition:background 0.2s;}
.hamburger-btn:hover{background:var(--lav);}
.hamburger-btn span{width:17px;height:2.5px;background:var(--text-on-theme);border-radius:2px;display:block;}
.top-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.15rem;color:var(--text-on-theme);}
.avatar-btn{width:42px;height:42px;border-radius:50%;border:2.5px solid var(--lav);cursor:pointer;background:var(--white);box-shadow:0 2px 12px rgba(160,130,210,0.25);display:flex;align-items:center;justify-content:center;font-size:1.4rem;transition:transform 0.2s;flex-shrink:0;overflow:hidden;}
.avatar-btn:hover{transform:scale(1.1);}
.avatar-btn img{width:100%;height:100%;object-fit:cover;border-radius:50%;}

/* ===== DASHBOARD ===== */
#dashPanel{flex:1;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:20px;padding:22px;overflow-y:auto;}
.subsection-card{background:var(--card);backdrop-filter:blur(18px);border-radius:26px;width:225px;height:255px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;cursor:pointer;border:2px solid rgba(200,180,240,0.3);box-shadow:var(--shadow);transition:transform 0.25s,box-shadow 0.25s;animation:cardPop 0.5s cubic-bezier(.34,1.56,.64,1) both;}
.subsection-card:hover{transform:translateY(-7px) scale(1.03);box-shadow:0 20px 48px rgba(160,130,210,0.25);}
.card-icon{width:66px;height:66px;border-radius:19px;display:flex;align-items:center;justify-content:center;font-size:2.1rem;}
.card-title{font-family:'Nunito',sans-serif;font-size:1.15rem;font-weight:800;color:var(--text-on-theme);}
.card-desc{font-size:0.82rem;color:var(--text-mid-theme);text-align:center;padding:0 14px;font-weight:600;}

/* ===== FULL PANELS ===== */
.full-panel{position:fixed;inset:0;z-index:50;display:flex;flex-direction:column;transition:opacity 0.4s,transform 0.4s;}
.full-panel.hidden{opacity:0;pointer-events:none;transform:translateY(26px);}
.full-panel .fp-bg{position:absolute;inset:0;z-index:-1;}
.fp-bg .bg-anim{position:absolute;inset:0;}
.fp-header{display:flex;align-items:center;gap:13px;padding:13px 22px;background:rgba(255,255,255,0.68);backdrop-filter:blur(18px);border-bottom:1px solid rgba(200,180,240,0.25);flex-shrink:0;}
.back-btn{width:36px;height:36px;border-radius:50%;border:none;background:rgba(200,180,240,0.35);color:var(--text-on-theme);cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:background 0.2s,transform 0.2s;flex-shrink:0;}
.back-btn:hover{background:var(--lav);transform:scale(1.1);}
.fp-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.22rem;color:var(--text-on-theme);}
.fp-content{flex:1;overflow-y:auto;padding:22px;display:flex;flex-direction:column;gap:16px;}

/* CARDS */
.panel-card{background:var(--card);backdrop-filter:blur(18px);border-radius:20px;padding:20px;box-shadow:var(--shadow);border:1.5px solid rgba(200,180,240,0.25);}
.panel-card h3{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.05rem;margin-bottom:13px;color:var(--text-on-theme);}

/* ===== CALENDAR - SMALLER CELLS ===== */
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.cal-nav button{background:rgba(200,180,240,0.3);border:none;border-radius:10px;width:32px;height:32px;cursor:pointer;font-size:1.1rem;color:var(--text-on-theme);transition:background 0.2s;}
.cal-nav button:hover{background:var(--lav);}
.cal-month{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.08rem;color:var(--text-on-theme);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:0;border:1.5px solid rgba(200,180,240,0.35);border-radius:14px;overflow:hidden;}
.cal-day-name{text-align:center;font-size:0.8rem;font-weight:800;color:var(--text-mid-theme);padding:8px 0;background:rgba(200,180,240,0.14);border-bottom:1.5px solid rgba(200,180,240,0.28);}
.cal-day{
  min-height:46px;
  display:flex;align-items:center;justify-content:center;
  font-size:0.92rem;font-weight:700;cursor:pointer;
  transition:background 0.13s;
  position:relative;color:var(--text-on-theme);
  border-right:1px solid rgba(200,180,240,0.22);
  border-bottom:1px solid rgba(200,180,240,0.22);
}
.cal-day:nth-child(7n){border-right:none;}
.cal-day:hover{background:rgba(200,180,240,0.38);}
.cal-day.today{background:linear-gradient(135deg,rgba(200,176,232,0.5),rgba(184,240,200,0.5));font-weight:900;}
.cal-day.has-task::after{content:'';position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:#8b5cf6;}
.cal-day.other-month{color:rgba(120,100,160,0.3);}
.cal-day.selected{background:linear-gradient(135deg,#b89fd4,#a3d9b1)!important;color:#fff;font-weight:900;}

/* INPUTS */
.task-input-row{display:flex;gap:8px;margin-bottom:11px;}
.task-input{flex:1;padding:10px 14px;border-radius:13px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.93rem;color:var(--text-on-theme);outline:none;transition:border 0.2s;}
.task-input:focus{border-color:var(--lav);}
.add-btn{padding:10px 16px;border-radius:13px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;cursor:pointer;transition:transform 0.15s;font-size:0.88rem;}
.add-btn:hover{transform:scale(1.06);}
.task-item{display:flex;align-items:center;gap:9px;padding:10px 13px;background:rgba(255,255,255,0.5);border-radius:11px;margin-bottom:7px;animation:fadeUp 0.3s ease;}
.task-item input[type=checkbox]{accent-color:#8b5cf6;width:16px;height:16px;cursor:pointer;}
.task-item span{flex:1;font-size:0.92rem;font-weight:600;}
.task-item span.done{text-decoration:line-through;color:var(--text-mid-theme);}
.task-item .del-btn{background:none;border:none;color:#d0a0c0;cursor:pointer;font-size:0.95rem;}

/* CHAT */
.chat-area{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:9px;margin-bottom:11px;max-height:300px;min-height:150px;}
.msg{max-width:72%;padding:10px 14px;border-radius:16px;font-size:0.91rem;line-height:1.48;animation:fadeUp 0.22s ease;}
.msg.me{align-self:flex-end;background:linear-gradient(135deg,#c9b3e8,#ddd0f8);color:var(--dark);border-bottom-right-radius:4px;}
.msg.other{align-self:flex-start;background:rgba(255,255,255,0.82);color:#3d3260;border-bottom-left-radius:4px;box-shadow:0 2px 8px rgba(160,130,210,0.1);}
.msg.system{align-self:center;background:rgba(200,180,240,0.2);color:var(--text-mid-theme);border-radius:12px;font-size:0.78rem;padding:6px 12px;}
.msg .sender{font-size:0.7rem;font-weight:800;color:var(--text-mid-theme);margin-bottom:3px;}
.msg-input-row{display:flex;gap:8px;}
.msg-input{flex:1;padding:10px 14px;border-radius:16px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.91rem;color:var(--text-on-theme);outline:none;}
.send-btn{padding:10px 18px;border-radius:16px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:800;cursor:pointer;transition:transform 0.15s;}
.send-btn:hover{transform:scale(1.05);}

/* GROUPS */
.gtask-badge{padding:3px 10px;border-radius:20px;font-size:0.73rem;font-weight:800;}
.gtask-badge.pending{background:#f0e0ff;color:#8b5cf6;}
.gtask-badge.done{background:#d4f5e0;color:#2d9c5e;}
.gtask-badge.late{background:#ffe0e0;color:#c05050;}
.gtask-item{display:flex;align-items:center;gap:11px;padding:11px 14px;background:var(--card);border-radius:13px;margin-bottom:7px;border:1.5px solid rgba(200,180,240,0.2);}
.groups-layout{display:flex;gap:16px;flex:1;min-height:0;}
.groups-chat-side{flex:1;display:flex;flex-direction:column;gap:13px;}
.groups-task-side{width:265px;flex-shrink:0;display:flex;flex-direction:column;gap:11px;}
.group-tab{display:flex;align-items:center;gap:9px;padding:11px 14px;background:rgba(255,255,255,0.6);border-radius:13px;cursor:pointer;border:1.5px solid rgba(200,180,240,0.25);transition:all 0.2s;}
.group-tab:hover,.group-tab.active{background:linear-gradient(135deg,rgba(200,180,240,0.35),rgba(180,240,200,0.25));border-color:var(--lav);}
.group-tab .g-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.group-tab .g-name{font-weight:800;font-size:0.9rem;color:var(--text-on-theme);}
.group-tab .g-count{font-size:0.73rem;color:var(--text-mid-theme);}
.g-task-card{background:var(--card);border-radius:14px;padding:14px;border:1.5px solid rgba(200,180,240,0.2);margin-bottom:9px;}
.g-task-card .g-task-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.9rem;margin-bottom:9px;}
.g-task-item{padding:8px 0;border-bottom:1px solid rgba(200,180,240,0.15);font-size:0.84rem;}
.g-task-item:last-child{border-bottom:none;}
.g-task-item .g-task-name{font-weight:700;color:var(--text-on-theme);}
.g-task-item .g-task-meta{color:var(--text-mid-theme);font-size:0.74rem;margin-top:2px;}

/* PROFILE */
.profile-hero{background:linear-gradient(135deg,#d8c4f0,#b8f0c8);border-radius:20px;padding:26px;text-align:center;}
.profile-avatar-big{width:88px;height:88px;border-radius:50%;border:4px solid rgba(255,255,255,0.7);margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:2.8rem;background:rgba(255,255,255,0.5);overflow:hidden;}
.profile-avatar-big img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.profile-name{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.4rem;color:#3d3260;}
.profile-tag{color:#7a6fa0;font-size:0.87rem;font-weight:600;margin-top:4px;}
.streak-badge{display:inline-flex;align-items:center;gap:7px;margin-top:11px;padding:7px 18px;background:rgba(255,255,255,0.6);border-radius:30px;font-weight:800;font-size:0.88rem;color:#3d3260;}
.info-row{display:flex;align-items:center;gap:13px;padding:12px 0;border-bottom:1px solid rgba(200,180,240,0.2);}
.info-row:last-child{border-bottom:none;}
.info-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.info-label{font-size:0.74rem;color:var(--text-mid-theme);font-weight:700;}
.info-val{font-size:0.93rem;font-weight:700;color:var(--text-on-theme);}
.group-chip{display:inline-flex;align-items:center;gap:5px;padding:5px 13px;background:linear-gradient(135deg,rgba(200,180,240,0.3),rgba(180,240,200,0.2));border-radius:20px;font-size:0.82rem;font-weight:700;margin:3px;}

/* ===== LEGAL DOCS ===== */
.legal-accordion{border-radius:16px;border:1.5px solid rgba(200,180,240,0.28);overflow:hidden;transition:box-shadow 0.2s;}
.legal-accordion:hover{box-shadow:0 4px 18px rgba(139,92,246,0.1);}
.legal-accordion-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;background:rgba(255,255,255,0.5);transition:background 0.2s;user-select:none;}
.legal-accordion-header:hover{background:rgba(200,180,240,0.15);}
.legal-chevron{font-size:1.3rem;color:var(--mid);transition:transform 0.3s;font-weight:700;line-height:1;}
.legal-chevron.open{transform:rotate(90deg);}
.legal-doc-body{display:none;border-top:1px solid rgba(200,180,240,0.2);background:rgba(255,255,255,0.35);}
.legal-doc-body.open{display:block;}
.legal-doc-scroll{max-height:420px;overflow-y:auto;padding:20px 22px;display:flex;flex-direction:column;gap:10px;scrollbar-width:thin;scrollbar-color:rgba(200,180,240,0.5) transparent;}
.legal-doc-scroll::-webkit-scrollbar{width:5px;}
.legal-doc-scroll::-webkit-scrollbar-track{background:transparent;}
.legal-doc-scroll::-webkit-scrollbar-thumb{background:rgba(200,180,240,0.55);border-radius:10px;}
.legal-doc-scroll p{font-size:0.86rem;color:var(--text-mid-theme);line-height:1.78;font-weight:600;margin:0;}
.legal-section-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:0.97rem;color:var(--dark);padding:10px 0 2px;border-bottom:1.5px solid rgba(200,180,240,0.25);margin-top:6px;}
.legal-section-title:first-child{margin-top:0;padding-top:0;}
.legal-subsection{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;color:var(--mid);margin-top:4px;}
.legal-list{padding-left:18px;display:flex;flex-direction:column;gap:5px;margin:0;}
.legal-list li{font-size:0.84rem;color:var(--text-mid-theme);line-height:1.65;font-weight:600;}
.legal-list li strong{color:var(--dark);}
.legal-disclaimer{background:rgba(200,180,240,0.15);border-left:3px solid rgba(139,92,246,0.4);border-radius:0 10px 10px 0;padding:12px 15px;font-size:0.8rem;color:var(--mid);font-weight:700;line-height:1.7;}
.legal-contact-badge{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;background:linear-gradient(135deg,rgba(200,180,240,0.3),rgba(180,240,200,0.2));border:1.5px solid rgba(200,180,240,0.4);border-radius:14px;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;color:var(--dark);margin-top:4px;cursor:pointer;transition:background 0.2s;}
.legal-contact-badge:hover{background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.35));}

/* SECURITY */
.sec-item{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:rgba(255,255,255,0.5);border-radius:13px;margin-bottom:8px;cursor:pointer;transition:background 0.2s;}
.sec-item:hover{background:rgba(200,180,240,0.2);}
.sec-item .sec-left{display:flex;align-items:center;gap:12px;}
.sec-item .sec-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;}
.sec-item .sec-title{font-weight:800;font-size:0.93rem;color:var(--text-on-theme);}
.sec-item .sec-sub{font-size:0.74rem;color:var(--text-mid-theme);font-weight:600;}
.sec-item .sec-arrow{color:var(--text-mid-theme);}

/* APPEARANCE */
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;}
.theme-opt{border-radius:15px;padding:14px;cursor:pointer;border:2.5px solid rgba(200,180,240,0.25);transition:all 0.22s;display:flex;flex-direction:column;align-items:center;gap:7px;position:relative;user-select:none;}
.theme-opt:hover{transform:scale(1.06);box-shadow:0 8px 22px rgba(139,92,246,0.2);border-color:rgba(139,92,246,0.4);}
.theme-opt.active{border-color:#8b5cf6;box-shadow:0 6px 20px rgba(139,92,246,0.3);transform:scale(1.04);}
.theme-opt.active::after{content:'✓';position:absolute;top:6px;right:8px;font-size:0.78rem;font-weight:900;color:#8b5cf6;background:rgba(255,255,255,0.9);width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.theme-preview{width:48px;height:36px;border-radius:9px;}
.theme-name{font-size:0.8rem;font-weight:800;}
.mood-btn{padding:10px 20px;border-radius:13px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-family:'Quicksand',sans-serif;font-weight:700;font-size:0.88rem;color:var(--text-on-theme);transition:all 0.2s;}
.mood-btn:hover,.mood-btn.active{border-color:var(--lav);background:var(--lilac);}
.font-btn{padding:10px 16px;border-radius:13px;border:2.5px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-family:'Quicksand',sans-serif;font-weight:700;color:var(--text-on-theme);transition:all 0.22s;line-height:1;}
.font-btn:hover{border-color:var(--lav);background:rgba(200,180,240,0.2);transform:scale(1.05);}
.font-btn.active{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.3));box-shadow:0 4px 14px rgba(139,92,246,0.2);}

/* ABOUT */
.about-hero{background:linear-gradient(135deg,#d8c4f0,#b8f0c8);border-radius:20px;padding:30px;text-align:center;}
.about-logo{font-size:3.6rem;margin-bottom:8px;}
.about-name{font-family:'Nunito',sans-serif;font-size:1.9rem;font-weight:900;background:linear-gradient(135deg,#8b5cf6,#5eead4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.about-tagline{color:#7a6fa0;margin-top:6px;font-size:0.92rem;font-weight:600;}
.feature-item{display:flex;gap:13px;align-items:flex-start;padding:13px 0;border-bottom:1px solid rgba(200,180,240,0.2);}
.feature-item:last-child{border-bottom:none;}
.feat-icon{width:40px;height:40px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.feat-title{font-weight:800;font-size:0.93rem;color:var(--text-on-theme);}
.feat-desc{font-size:0.82rem;color:var(--text-mid-theme);margin-top:3px;font-weight:600;}

/* ACTIVITY */
.score-card{background:linear-gradient(135deg,#d8c4f0,#b8f0c8);border-radius:19px;padding:22px;text-align:center;}
.score-num{font-family:'Nunito',sans-serif;font-size:3rem;font-weight:900;color:#3d3260;}
.score-label{font-size:0.87rem;color:#7a6fa0;font-weight:700;}
.private-toggle{display:flex;align-items:center;gap:8px;margin-top:10px;font-size:0.84rem;color:#7a6fa0;justify-content:center;font-weight:600;}
.private-toggle input{accent-color:#8b5cf6;}
.act-item{display:flex;align-items:center;gap:13px;padding:12px 0;border-bottom:1px solid rgba(200,180,240,0.18);}
.act-item:last-child{border-bottom:none;}
.act-icon{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.act-info .act-name{font-weight:800;font-size:0.93rem;color:var(--text-on-theme);}
.act-info .act-date{font-size:0.75rem;color:var(--text-mid-theme);font-weight:600;}
.act-score{font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;color:#8b5cf6;}

/* ===== LIBRARY ===== */
.lib-tabs{display:flex;gap:9px;margin-bottom:18px;}
.lib-tab{padding:9px 20px;border-radius:19px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.5);cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.88rem;color:var(--text-mid-theme);transition:all 0.2s;}
.lib-tab.active{background:linear-gradient(135deg,rgba(200,180,240,0.5),rgba(180,240,200,0.3));color:var(--text-on-theme);border-color:var(--lav);}
.lib-upload-zone{border:2.5px dashed rgba(180,150,230,0.5);border-radius:18px;padding:32px;text-align:center;cursor:pointer;background:rgba(255,255,255,0.4);transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:11px;margin-bottom:16px;}
.lib-upload-zone:hover{border-color:var(--lav);background:rgba(200,180,240,0.15);}
.lib-upload-zone input[type=file]{display:none;}
.lib-upload-zone .up-icon{font-size:2.5rem;}
.lib-upload-zone .up-label{font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;color:var(--text-on-theme);}
.lib-upload-zone .up-sub{font-size:0.84rem;color:var(--text-mid-theme);font-weight:600;}
.lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:13px;}
.lib-item{background:rgba(255,255,255,0.65);border-radius:15px;padding:14px;border:1.5px solid rgba(200,180,240,0.25);display:flex;flex-direction:column;align-items:center;gap:9px;position:relative;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;animation:cardPop 0.33s ease;}
.lib-item:hover{transform:translateY(-3px);box-shadow:0 9px 26px rgba(160,130,210,0.18);}
.lib-thumb{width:100%;height:96px;object-fit:cover;border-radius:9px;background:linear-gradient(135deg,#d8c4f0,#b8f0c8);display:flex;align-items:center;justify-content:center;font-size:2.4rem;overflow:hidden;}
.lib-thumb img,.lib-thumb video{width:100%;height:100%;object-fit:cover;}
.lib-name{font-size:0.79rem;font-weight:700;color:var(--text-on-theme);text-align:center;word-break:break-word;max-width:100%;}
.lib-meta{font-size:0.7rem;color:var(--text-mid-theme);font-weight:600;}
.lib-del{position:absolute;top:7px;right:7px;width:22px;height:22px;border-radius:50%;border:none;background:rgba(220,80,80,0.15);color:#c05050;cursor:pointer;font-size:0.72rem;display:flex;align-items:center;justify-content:center;transition:background 0.15s;}
.lib-del:hover{background:rgba(220,80,80,0.3);}
.lib-empty{text-align:center;padding:38px;color:var(--text-mid-theme);font-size:0.92rem;font-weight:600;}
.lib-empty .lib-empty-icon{font-size:2.8rem;margin-bottom:11px;}

/* Undo toast */
.undo-toast{
  position:fixed;bottom:90px;left:50%;transform:translateX(-50%);
  background:rgba(60,40,100,0.88);color:#fff;
  padding:12px 22px;border-radius:30px;
  display:flex;align-items:center;gap:14px;
  font-size:0.9rem;font-weight:700;font-family:'Nunito',sans-serif;
  z-index:300;box-shadow:0 8px 28px rgba(60,40,100,0.3);
  animation:slideUp 0.3s ease;
  backdrop-filter:blur(10px);
}
.undo-toast.hide{animation:slideDown 0.3s ease forwards;}
.undo-btn-toast{background:rgba(255,255,255,0.22);border:1.5px solid rgba(255,255,255,0.4);color:#fff;padding:6px 16px;border-radius:20px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;transition:background 0.2s;}
.undo-btn-toast:hover{background:rgba(255,255,255,0.35);}
@keyframes slideUp{from{transform:translate(-50%,40px);opacity:0;}to{transform:translate(-50%,0);opacity:1;}}
@keyframes slideDown{from{transform:translate(-50%,0);opacity:1;}to{transform:translate(-50%,40px);opacity:0;}}

/* FILE PREVIEW */
.file-modal{position:fixed;inset:0;z-index:200;background:rgba(60,40,100,0.4);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;}
.file-modal.hidden{display:none;}
.file-modal-inner{background:rgba(255,255,255,0.94);border-radius:22px;padding:22px;max-width:85vw;max-height:88vh;display:flex;flex-direction:column;gap:13px;box-shadow:0 24px 60px rgba(100,80,150,0.22);}
.file-modal-inner img,.file-modal-inner video{max-width:100%;max-height:58vh;border-radius:11px;}

/* AVATAR */
.modal-overlay{position:fixed;inset:0;z-index:100;background:rgba(100,80,150,0.2);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;transition:opacity 0.3s;}
.modal-overlay.hidden{opacity:0;pointer-events:none;}
.avatar-modal{background:rgba(255,255,255,0.92);border-radius:26px;padding:22px;width:435px;max-width:95vw;max-height:92vh;overflow-y:auto;box-shadow:0 24px 60px rgba(100,80,150,0.22);border:2px solid rgba(200,180,240,0.4);animation:cardPop 0.4s cubic-bezier(.34,1.56,.64,1) both;}
.modal-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.12rem;margin-bottom:14px;color:#3d3260;}
.avatar-builder{display:flex;gap:16px;align-items:flex-start;}
.avatar-canvas{width:125px;height:180px;flex-shrink:0;border-radius:18px;border:2.5px solid rgba(200,180,240,0.4);position:relative;overflow:hidden;background:var(--white);}
.av-bg{position:absolute;inset:0;transition:background 0.3s;}
.avatar-options{flex:1;display:flex;flex-direction:column;gap:9px;}
.opt-group{display:flex;flex-direction:column;gap:5px;}
.opt-label{font-size:0.7rem;font-weight:800;color:#7a6fa0;text-transform:uppercase;letter-spacing:1px;}
.opt-row{display:flex;gap:5px;flex-wrap:wrap;}
.opt-btn{padding:6px 12px;border-radius:9px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.6);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:0.78rem;font-weight:700;color:#3d3260;transition:all 0.15s;}
.opt-btn:hover,.opt-btn.active{border-color:var(--lav);background:var(--lilac);transform:scale(1.04);}
.color-swatch{width:24px;height:24px;border-radius:50%;border:2.5px solid transparent;cursor:pointer;transition:transform 0.15s,border-color 0.15s;}
.color-swatch:hover,.color-swatch.active{transform:scale(1.25);border-color:#3d3260;}
.modal-close{width:100%;margin-top:12px;padding:11px;border-radius:13px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:#3d3260;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.96rem;cursor:pointer;transition:transform 0.15s;}
.modal-close:hover{transform:scale(1.02);}
.av-char{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:90px;height:160px;}

/* LOGIN */
.login-modal{background:rgba(255,255,255,0.94);border-radius:26px;padding:30px;width:375px;max-width:94vw;box-shadow:0 24px 60px rgba(100,80,150,0.22);border:2px solid rgba(200,180,240,0.4);animation:cardPop 0.4s cubic-bezier(.34,1.56,.64,1) both;}
.login-modal h2{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.45rem;margin-bottom:5px;color:#3d3260;text-align:center;}
.login-modal p{color:#7a6fa0;font-size:0.87rem;text-align:center;margin-bottom:20px;font-weight:600;}
.login-field{width:100%;padding:12px 15px;border-radius:13px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.96rem;color:#3d3260;outline:none;margin-bottom:11px;transition:border 0.2s;}
.login-field:focus{border-color:var(--lav);}
.login-btn{width:100%;padding:12px;border-radius:13px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:#3d3260;font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;transition:transform 0.15s;margin-top:3px;}
.login-btn:hover{transform:scale(1.02);}
.google-login-btn{width:100%;padding:12px;border-radius:13px;border:2px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);color:#3d3260;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.96rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:9px;margin-top:10px;}
.google-login-btn:hover{background:#fff;border-color:var(--lav);transform:scale(1.02);}
.login-divider{text-align:center;color:#7a6fa0;font-size:0.82rem;font-weight:700;margin:10px 0;position:relative;}
.login-divider::before,.login-divider::after{content:'';position:absolute;top:50%;width:38%;height:1px;background:rgba(200,180,240,0.4);}
.login-divider::before{left:0;}
.login-divider::after{right:0;}
.login-switch{text-align:center;margin-top:11px;font-size:0.85rem;color:#7a6fa0;font-weight:600;}
.login-switch span{color:#8b5cf6;cursor:pointer;font-weight:800;}
.login-switch span:hover{text-decoration:underline;}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:rgba(180,150,230,0.3);border-radius:10px;}
::-webkit-scrollbar-thumb:hover{background:rgba(180,150,230,0.6);}

/* OCCUPATION FLOATING ELEMENTS */
.occ-float-wrap{position:fixed;inset:0;pointer-events:none;z-index:2;overflow:hidden;}
.occ-float{position:absolute;font-size:2.8rem;opacity:0;filter:drop-shadow(0 4px 10px rgba(0,0,0,0.1));pointer-events:none;}
@keyframes floatIn{0%{opacity:0;transform:translateY(60px) scale(0.4) rotate(-15deg);}50%{opacity:0.9;transform:translateY(-10px) scale(1.08) rotate(4deg);}100%{opacity:0.72;transform:translateY(0) scale(1) rotate(0deg);}}
@keyframes floatBobble{0%,100%{transform:translateY(0) rotate(0deg);}40%{transform:translateY(-14px) rotate(6deg);}70%{transform:translateY(5px) rotate(-4deg);}}

/* AVATAR PHOTO + WIDER MODAL */
.avatar-modal{background:rgba(255,255,255,0.92);border-radius:26px;padding:22px;width:580px;max-width:97vw;max-height:92vh;overflow-y:auto;box-shadow:0 24px 60px rgba(100,80,150,0.22);border:2px solid rgba(200,180,240,0.4);animation:cardPop 0.4s cubic-bezier(.34,1.56,.64,1) both;}
.avatar-canvas{width:150px;height:200px;flex-shrink:0;border-radius:18px;border:2.5px solid rgba(200,180,240,0.4);position:relative;overflow:hidden;background:var(--white);}
.av-char{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:120px;height:195px;}
.photo-upload-zone{width:148px;margin-top:8px;padding:9px;border-radius:12px;border:2px dashed rgba(180,150,230,0.5);background:rgba(255,255,255,0.5);cursor:pointer;text-align:center;font-family:'Nunito',sans-serif;font-size:0.75rem;font-weight:700;color:var(--mid);transition:all 0.2s;}
.photo-upload-zone:hover{border-color:var(--lav);background:rgba(200,180,240,0.15);}
.photo-upload-zone input{display:none;}
.pose-selector{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;width:148px;}
.pose-btn{flex:1;min-width:35px;padding:5px 3px;border-radius:9px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.6);cursor:pointer;font-size:1rem;text-align:center;transition:all 0.15s;}
.pose-btn:hover,.pose-btn.active{border-color:var(--lav);background:var(--lilac);}

/* ===== PREMIUM / PRICING ===== */
.billing-btn{padding:7px 20px;border-radius:26px;border:none;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.86rem;cursor:pointer;transition:all 0.22s;background:transparent;color:var(--mid);}
.billing-btn.active{background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);box-shadow:0 3px 12px rgba(139,92,246,0.18);}
.plans-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;width:100%;max-width:820px;margin-top:22px;}
@media(max-width:680px){.plans-grid{grid-template-columns:1fr;max-width:360px;}}
.plan-card{background:var(--card);backdrop-filter:blur(18px);border-radius:26px;padding:28px 22px 22px;border:2px solid rgba(200,180,240,0.25);box-shadow:var(--shadow);display:flex;flex-direction:column;position:relative;transition:transform 0.22s,box-shadow 0.22s;animation:cardPop 0.4s ease both;}
.plan-card:hover{transform:translateY(-5px);box-shadow:0 22px 50px rgba(139,92,246,0.18);}
.plan-card.pro-highlight{border-color:#8b5cf6;box-shadow:0 8px 38px rgba(139,92,246,0.22);}
.plan-popular-tag{position:absolute;top:-13px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#8b5cf6,#c9b3e8);color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.74rem;padding:5px 18px;border-radius:20px;white-space:nowrap;box-shadow:0 4px 16px rgba(139,92,246,0.32);}
.plan-icon{font-size:2.2rem;margin-bottom:10px;}
.plan-name{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.12rem;color:var(--dark);}
.plan-desc{font-size:0.78rem;color:var(--mid);font-weight:600;margin-top:3px;}
.plan-price{font-family:'Nunito',sans-serif;font-weight:900;font-size:2.4rem;color:var(--dark);line-height:1;margin:14px 0 4px;}
.plan-price-period{font-size:0.8rem;color:var(--mid);font-weight:600;margin-top:2px;}
.plan-annual-note{font-size:0.72rem;color:#8b5cf6;font-weight:700;min-height:16px;margin-bottom:2px;}
.plan-divider{height:1px;background:rgba(200,180,240,0.22);margin:14px 0;}
.plan-features{display:flex;flex-direction:column;gap:8px;flex:1;margin-bottom:18px;}
.pf{display:flex;align-items:flex-start;gap:8px;font-size:0.82rem;font-weight:600;color:var(--text-mid-theme);line-height:1.45;}
.pf.dim{opacity:0.35;}
.plan-cta{width:100%;padding:13px;border-radius:15px;border:none;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.93rem;cursor:pointer;transition:all 0.2s;}
.cta-free{background:rgba(200,180,240,0.2);color:var(--dark);border:2px solid rgba(200,180,240,0.38);}
.cta-free:hover{background:rgba(200,180,240,0.4);}
.cta-pro{background:linear-gradient(135deg,#8b5cf6,#c9b3e8);color:#fff;box-shadow:0 6px 20px rgba(139,92,246,0.28);}
.cta-pro:hover{transform:scale(1.03);box-shadow:0 10px 28px rgba(139,92,246,0.4);}
.cta-team{background:linear-gradient(135deg,#1f2937,#4a3f6b);color:#fff;box-shadow:0 6px 20px rgba(30,20,70,0.22);}
.cta-team:hover{transform:scale(1.03);}
.cta-current{background:rgba(94,234,212,0.18);color:#0d9488;border:2px solid rgba(94,234,212,0.35);cursor:default;pointer-events:none;}
/* Pay modal */
.pay-overlay{position:fixed;inset:0;z-index:400;background:rgba(30,15,70,0.48);backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;transition:opacity 0.28s;}
.pay-overlay.hidden{opacity:0;pointer-events:none;}
.pay-modal{background:rgba(255,255,255,0.98);border-radius:28px;width:490px;max-width:96vw;max-height:96vh;overflow-y:auto;box-shadow:0 32px 80px rgba(80,40,160,0.28);border:2px solid rgba(200,180,240,0.4);animation:cardPop 0.38s cubic-bezier(.34,1.56,.64,1) both;scrollbar-width:thin;}
.pay-cycle-btn{padding:11px 10px;border-radius:13px;border:2px solid rgba(200,180,240,0.32);background:rgba(255,255,255,0.7);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.82rem;cursor:pointer;color:var(--mid);transition:all 0.18s;text-align:center;width:100%;}
.pay-cycle-btn.active{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.32),rgba(180,240,200,0.2));color:var(--dark);}
.pay-cycle-save{font-size:0.67rem;color:#8b5cf6;font-weight:700;display:block;margin-top:2px;}
.pay-method{border-radius:13px;border:2px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.7);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;padding:11px 6px;transition:all 0.18s;}
.pay-method:hover{border-color:var(--lav);}
.pay-method.active{border-color:#8b5cf6;background:linear-gradient(135deg,rgba(200,180,240,0.28),rgba(180,240,200,0.18));color:var(--dark);}
.pay-field{width:100%;padding:12px 14px;border-radius:13px;border:2px solid rgba(200,180,240,0.32);background:rgba(255,255,255,0.85);font-family:'Quicksand',sans-serif;font-size:0.92rem;color:var(--dark);outline:none;transition:border 0.2s;box-sizing:border-box;}
.pay-field:focus{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.1);}
.pay-submit{width:100%;padding:14px;border-radius:16px;border:none;background:linear-gradient(135deg,#8b5cf6,#c9b3e8,#5eead4);color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.98rem;cursor:pointer;box-shadow:0 8px 26px rgba(139,92,246,0.3);transition:all 0.22s;}
.pay-submit:hover{transform:translateY(-2px);box-shadow:0 14px 34px rgba(139,92,246,0.4);}

/* ===== MOBILE PERFORMANCE: disable all heavy GPU effects ===== */
@media (max-width: 768px) {

  /* Kill animated blobs entirely */
  .blob { display: none !important; }

  /* Stop background gradient animation - use static gradient instead */
  .bg-anim {
    animation: none !important;
    background: linear-gradient(135deg, #d4c8f0, #c8ecd4) !important;
    background-size: 100% 100% !important;
  }

  /* Stop floating emoji decorations */
  .deco-el { animation: none !important; }

  /* Replace all backdrop-filter blurs with solid semi-transparent backgrounds */
  .sidebar,
  .top-bar,
  .fp-header,
  .panel-card,
  .subsection-card,
  .notif-bell-btn,
  .notif-panel,
  .toast-notif,
  #musicPlayer,
  .occ-btn,
  .invite-modal-overlay,
  .file-modal,
  .modal-overlay,
  .pay-overlay,
  .plan-card,
  #sidebarOverlay {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Give them solid opaque backgrounds so they still look good */
  .sidebar { background: rgba(248, 246, 255, 0.98) !important; }
  .top-bar { background: rgba(245, 242, 255, 0.98) !important; }
  .fp-header { background: rgba(245, 242, 255, 0.98) !important; }
  .panel-card { background: rgba(255, 255, 255, 0.96) !important; }
  .subsection-card { background: rgba(255, 255, 255, 0.95) !important; }
  .notif-bell-btn { background: rgba(255, 255, 255, 0.95) !important; }
  .notif-panel { background: rgba(255, 255, 255, 0.98) !important; }
  .toast-notif { background: rgba(255, 255, 255, 0.99) !important; }
  #musicPlayer { background: rgba(255, 255, 255, 0.97) !important; }

  /* Reduce card hover animations - simpler on mobile */
  .subsection-card { transition: transform 0.15s !important; }
  .subsection-card:hover { transform: none !important; box-shadow: var(--shadow) !important; }

  /* Disable card pop animations on dashboard to speed up rendering */
  .subsection-card { animation: none !important; }

  /* Simplify full panel transition */
  .full-panel { transition: opacity 0.2s !important; }

  /* Stop intro screen bg animation */
  #introScreen { animation: none !important; background: linear-gradient(135deg, #d4c8f0, #c8ecd4, #e0d0f8) !important; }

  /* Disable canvas theme bg */
  #themeBgCanvas { display: none !important; }

  /* Use will-change only on actively animating elements to hint GPU layers correctly */
  .sidebar { will-change: transform; }
  #musicPlayer { will-change: auto; }
}

#musicPlayer.intro-hidden,
.notif-bell-btn.intro-hidden,
#notifPanel.intro-hidden{
  opacity:0!important;
  pointer-events:none!important;
  visibility:hidden!important;
}
.sidebar-hidden{transform:translateX(-100%)!important;margin-left:calc(-1 * var(--sidebar-w));}

/* ===== MOBILE OVERLAY (for closing sidebar by tapping outside) ===== */
#sidebarOverlay{display:none;position:fixed;inset:0;z-index:9;background:rgba(60,40,100,0.32);backdrop-filter:blur(2px);}
#sidebarOverlay.show{display:block;}

/* ===== RESPONSIVE: TABLET & MOBILE ===== */
@media (max-width: 768px) {

  /* Sidebar: hidden off-screen by default on mobile */
  .sidebar{
    position:fixed;
    left:0;top:0;bottom:0;
    transform:translateX(-100%);
    z-index:100;
    box-shadow:4px 0 32px rgba(140,100,220,0.22);
  }
  .sidebar.mobile-open{
    transform:translateX(0)!important;
  }
  /* Override desktop sidebar-hidden behaviour on mobile */
  .sidebar-hidden{
    transform:translateX(-100%)!important;
    margin-left:0!important;
  }

  /* Main area fills full width */
  #appLayout{flex-direction:column;}
  .main-area{width:100%;min-width:0;}

  /* Top bar */
  .top-bar{padding:10px 14px;}

  /* Dashboard cards: 2-per-row */
  #dashPanel{padding:14px;gap:12px;justify-content:center;}
  .subsection-card{width:calc(50% - 6px);height:auto;min-height:160px;padding:18px 10px;}
  .card-icon{width:52px;height:52px;font-size:1.7rem;}
  .card-title{font-size:1rem;}
  .card-desc{font-size:0.75rem;}

  /* Full panels */
  .fp-content{padding:14px;}
  .fp-header{padding:10px 14px;}

  /* Music player: full width */
  #musicPlayer{
    width:calc(100% - 28px);
    left:14px;
    right:14px;
    bottom:10px;
  }

  /* Notification panel: full width */
  .notif-panel{
    width:calc(100vw - 32px);
    right:16px;
    left:16px;
  }
  .notif-bell-btn{right:58px;}

  /* Modals */
  .invite-modal{width:95vw;max-height:90vh;overflow-y:auto;}
  .pay-modal{width:95vw;max-height:90vh;}

  /* Calendar: tighter */
  .cal-day{min-height:36px;font-size:0.8rem;}
  .cal-day-name{font-size:0.7rem;padding:6px 0;}

  /* Bigger touch targets */
  .mp-btn{width:40px;height:40px;}
  .back-btn{width:40px;height:40px;}
  .cal-nav button{width:38px;height:38px;}
  .nav-item{padding:14px 18px;}

  /* Landing screen */
  .brand-name{font-size:2rem;}
  .welcome-text{font-size:1.6rem;}
  .occ-btn{min-width:76px;padding:9px 12px;font-size:0.8rem;}

  /* Intro clock */
  .intro-brand{font-size:2rem;}
}

@media (max-width: 480px) {
  .brand-name{font-size:1.6rem;}
  .welcome-text{font-size:1.3rem;}
  .fp-title{font-size:1rem;}
  .intro-brand{font-size:1.7rem;}
  .subsection-card{width:calc(50% - 6px);}
  /* Stack dashboard to single column on very small screens */
  #dashPanel{gap:10px;}
}
</style>
</head>
<body>
<!-- Mobile sidebar overlay -->
<div id="sidebarOverlay" onclick="closeSidebarMobile()"></div>
<!-- Google Sign-In overlay -->
<div id="_gisOverlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(60,40,100,0.45);backdrop-filter:blur(8px);align-items:center;justify-content:center;">
  <div style="background:rgba(255,255,255,0.97);border-radius:24px;padding:36px 32px;box-shadow:0 24px 60px rgba(100,80,150,0.25);display:flex;flex-direction:column;align-items:center;gap:18px;min-width:320px;">
    <div style="font-family:'Nunito',sans-serif;font-size:1.3rem;font-weight:900;color:#3d3260;">Sign in to Track & Clock</div>
    <div style="font-size:0.88rem;color:#7a6fa0;font-weight:600;text-align:center;">Choose your Google account to continue</div>
    <div id="_gisButtonContainer"></div>
    <button onclick="document.getElementById('_gisOverlay').style.display='none'" style="background:none;border:none;color:#7a6fa0;font-family:'Nunito',sans-serif;font-weight:700;font-size:0.85rem;cursor:pointer;margin-top:-6px;">Cancel</button>
  </div>
</div>
<!-- Animated theme scene canvas (renders behind everything) -->
<canvas id="themeBgCanvas" style="position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;opacity:0;transition:opacity 0.9s ease;"></canvas>
<div class="bg-anim" id="bgAnim"></div>
<div class="blob blob1" id="blob1"></div>
<div class="blob blob2" id="blob2"></div>
<div class="blob blob3" id="blob3"></div>
<div class="theme-deco" id="themeDeco"></div>
<div class="occ-float-wrap" id="occFloatWrap"></div>

<!-- ===== MUSIC PLAYER ===== -->
<div id="musicPlayer">
  <div class="mp-header">
    <span class="mp-note">🎵</span>
    <span class="mp-track-name" id="mpTrack">Select mood or search a song…</span>
    <button class="mp-min-btn" onclick="toggleMiniPlayer()" title="Minimize/Expand">—</button>
  </div>
  <div class="mp-full" id="mpFull">
    <div class="mp-controls-row">
      <button class="mp-btn" id="mpPlayBtn" onclick="toggleMusic()">▶</button>
      <input type="range" class="mp-vol" id="mpVol" min="0" max="1" step="0.05" value="0.3" oninput="setVolume(this.value)" title="Volume"/>
      <span style="font-size:0.7rem;color:var(--mid);font-weight:700;">🔊</span>
    </div>
    <div class="mp-mood-row">
      <div class="mp-mood-chip" onclick="setMoodChip('calm',this)">🌿 Calm</div>
      <div class="mp-mood-chip" onclick="setMoodChip('focus',this)">🎯 Focus</div>
      <div class="mp-mood-chip" onclick="setMoodChip('energetic',this)">⚡ Energy</div>
      <div class="mp-mood-chip" onclick="setMoodChip('cozy',this)">🧸 Cozy</div>
      <div class="mp-mood-chip" onclick="setMoodChip('nature',this)">🌳 Nature</div>
      <div class="mp-mood-chip" onclick="setMoodChip('off',this)">🔇 Off</div>
    </div>
    <div class="mp-search-row">
      <input class="mp-search-input" id="mpSearchInput" placeholder="Search any song or artist… 🎵" onkeydown="if(event.key==='Enter')searchMusic()"/>
      <button class="mp-search-btn" onclick="searchMusic()">🔍</button>
    </div>
    <div class="mp-genre-row">
      <button class="mp-genre-chip active" onclick="searchGenre('pop',this)">🎤 Pop</button>
      <button class="mp-genre-chip" onclick="searchGenre('k-pop',this)">💜 K-Pop</button>
      <button class="mp-genre-chip" onclick="searchGenre('r&b',this)">🎷 R&amp;B</button>
      <button class="mp-genre-chip" onclick="searchGenre('hip-hop',this)">🎤 Hip-Hop</button>
      <button class="mp-genre-chip" onclick="searchGenre('lofi',this)">🎧 Lofi</button>
      <button class="mp-genre-chip" onclick="searchGenre('classical',this)">🎻 Classical</button>
    </div>
    <div class="mp-results" id="mpResults"></div>
    <div class="mp-now-playing hidden" id="mpNowPlaying">
      <img class="mp-np-art" id="mpNpArt" src="" onerror="this.style.display='none'"/>
      <div class="mp-np-info">
        <div class="mp-np-title" id="mpNpTitle">—</div>
        <div class="mp-np-artist" id="mpNpArtist">—</div>
      </div>
      <button class="mp-np-stop" onclick="stopMusic2()" title="Stop">⏹</button>
    </div>
    <audio id="musicAudio" onended="onTrackEnded()"></audio>
  </div>
</div>

<!-- ===== NOTIFICATION BELL ===== -->
<button class="notif-bell-btn" onclick="toggleNotifPanel()" id="notifBellBtn" title="Notifications">
  🔔
  <span class="notif-badge hidden" id="notifBadge">0</span>
</button>

<!-- ===== NOTIFICATION PANEL ===== -->
<div class="notif-panel hidden" id="notifPanel">
  <div class="notif-panel-hdr">
    <span class="notif-panel-title">🔔 Notifications</span>
    <button class="notif-clear-btn" onclick="clearAllNotifs()">Clear all</button>
  </div>
  <div class="notif-list" id="notifList">
    <div class="notif-empty" id="notifEmpty">No notifications yet ✨</div>
  </div>
  <div class="notif-add-section">
    <div class="notif-add-title">⏰ Set a Reminder</div>
    <div class="notif-add-row">
      <input class="notif-input" id="notifTaskName" placeholder="Task name or reminder..."/>
      <input class="notif-input" type="datetime-local" id="notifDateTime"/>
      <button class="notif-add-btn" onclick="addReminder()">+ Set Reminder</button>
    </div>
  </div>
</div>

<!-- ===== INTRO ===== -->
<div id="introScreen">
  <div style="position:relative;">
    <div class="clock-ring2"></div>
    <div class="clock-ring"></div>
    <div class="intro-clock">
      <div class="intro-clock-body">
        <div class="intro-clock-face" id="clockFace">
          <div class="hand-s"></div>
          <div class="hand-h"></div>
          <div class="hand-m"></div>
          <div class="clock-center"></div>
          <svg style="position:absolute;inset:0;width:100%;height:100%;" viewBox="0 0 142 142">
            <g fill="#c9b3e8">
              <rect x="69" y="6" width="4" height="12" rx="2"/>
              <rect x="69" y="124" width="4" height="12" rx="2"/>
              <rect x="6" y="69" width="12" height="4" rx="2"/>
              <rect x="124" y="69" width="12" height="4" rx="2"/>
              <rect x="24" y="20" width="3.5" height="9" rx="1.7" transform="rotate(-45 26 24)"/>
              <rect x="108" y="20" width="3.5" height="9" rx="1.7" transform="rotate(45 110 24)"/>
              <rect x="24" y="112" width="3.5" height="9" rx="1.7" transform="rotate(45 26 116)"/>
              <rect x="108" y="112" width="3.5" height="9" rx="1.7" transform="rotate(-45 110 116)"/>
            </g>
          </svg>
        </div>
      </div>
      <div class="intro-btn-top"></div>
    </div>
  </div>
  <div class="intro-brand">Track &amp; Clock</div>
  <div class="intro-subtitle">Your time. Your tasks. Your world. ✨</div>
  <div id="tapToSkip" style="margin-top:28px;font-size:0.75rem;color:rgba(100,80,160,0.5);font-weight:600;letter-spacing:1px;animation:fadeUp 1s 4.6s ease both;opacity:0;">tap anywhere to skip</div>
</div>

<!-- ===== LANDING ===== -->
<div class="screen hidden" id="landing">
  <div class="logo-wrap">
    <div class="logo-img">
      <svg viewBox="0 0 100 100" width="54" height="54">
        <circle cx="50" cy="52" r="36" fill="#d8c4f0" stroke="#c9b3e8" stroke-width="5"/>
        <circle cx="50" cy="52" r="28" fill="white" opacity="0.85"/>
        <rect x="48" y="30" width="3.5" height="16" rx="1.5" fill="#8b5cf6" transform="rotate(-30 50 52)"/>
        <rect x="48" y="30" width="3" height="20" rx="1.5" fill="#5eead4" transform="rotate(70 50 52)"/>
        <circle cx="50" cy="52" r="3.5" fill="#5eead4"/>
        <rect x="46" y="13" width="8" height="6" rx="2" fill="#5eead4"/>
      </svg>
    </div>
    <div class="brand-name">Track &amp; Clock</div>
  </div>
  <div class="welcome-text">Welcome Back, Tracker! 👋</div>
  <div class="tagline">Stay on time. Stay on track. Your tasks, your pace.</div>
  <div class="occ-label">I am a...</div>
  <div class="occ-grid">
    <button class="occ-btn" onclick="pickOcc('Student',this)"><span class="occ-icon">🎒</span>Student</button>
    <button class="occ-btn" onclick="pickOcc('Teacher',this)"><span class="occ-icon">👩‍🏫</span>Teacher</button>
    <button class="occ-btn" onclick="pickOcc('Office Worker',this)"><span class="occ-icon">💼</span>Office Worker</button>
    <button class="occ-btn" onclick="pickOcc('Organizer',this)"><span class="occ-icon">📋</span>Organizer</button>
    <button class="occ-btn" onclick="pickOcc('Freelancer',this)"><span class="occ-icon">💻</span>Freelancer</button>
    <button class="occ-btn" onclick="pickOcc('Creator',this)"><span class="occ-icon">🎨</span>Creator</button>
    <button class="occ-btn" onclick="pickOcc('Healthcare',this)"><span class="occ-icon">🏥</span>Healthcare</button>
    <button class="occ-btn" onclick="pickOcc('Other',this)"><span class="occ-icon">✨</span>Other</button>
  </div>
  <div id="googleSignInBtn" style="animation:fadeUp 0.8s 0.55s ease both;margin-top:10px;min-height:44px;display:flex;align-items:center;justify-content:center;"></div>
  <div style="margin-top:8px;font-size:0.8rem;color:var(--mid);font-weight:600;animation:fadeUp 0.8s 0.65s ease both;">or</div>
  <button class="start-btn" style="margin-top:6px;" onclick="goToApp()">Continue as Guest ✨</button>
</div>

<!-- ===== APP LAYOUT ===== -->
<div id="appLayout" class="hidden">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <svg width="26" height="26" viewBox="0 0 60 60"><circle cx="30" cy="32" r="22" fill="#d8c4f0" stroke="#c9b3e8" stroke-width="3"/><circle cx="30" cy="32" r="16" fill="white" opacity="0.85"/><rect x="29" y="18" width="2.5" height="10" rx="1.2" fill="#8b5cf6" transform="rotate(-30 30 32)"/><rect x="29" y="18" width="2" height="13" rx="1.2" fill="#5eead4" transform="rotate(70 30 32)"/><circle cx="30" cy="32" r="2.5" fill="#5eead4"/><rect x="27" y="8" width="6" height="4" rx="1.5" fill="#5eead4"/></svg>
      Track &amp; Clock
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-label">Main</div>
      <div class="nav-item active" onclick="setActiveNav(this)"><span class="nav-icon">🏠</span>Dashboard</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('calPanel')"><span class="nav-icon">📅</span>Calendar</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('taskPanel')"><span class="nav-icon">✅</span>Task List</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('actPanel')"><span class="nav-icon">📊</span>Activity</div>
      <div class="nav-section-label">Resources</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('libraryPanel')"><span class="nav-icon">📚</span>Library</div>
      <div class="nav-section-label">Social</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('groupsPanel')"><span class="nav-icon">👥</span>Groups</div>
      <div class="nav-section-label">Account</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('profilePanel')"><span class="nav-icon">👤</span>Profile</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('secPanel')"><span class="nav-icon">🔒</span>Security</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('appearPanel')"><span class="nav-icon">🎨</span>Appearance</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('aboutPanel')"><span class="nav-icon">ℹ️</span>About</div>
      <div class="nav-item" onclick="setActiveNav(this);openFP('pricingPanel')"><span class="nav-icon">👑</span>Plans &amp; Pricing</div>
    </div>
    <div id="sidebarProStrip" onclick="openFP('pricingPanel')" style="margin:6px 10px 4px;padding:11px 13px;background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(249,168,212,0.09));border-radius:14px;border:1.5px solid rgba(200,180,240,0.3);cursor:pointer;display:flex;align-items:center;gap:9px;transition:all 0.2s;">
      <span id="sidebarProIcon" style="font-size:1.25rem;">👑</span>
      <div><div id="sidebarProTitle" style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.8rem;color:var(--dark);">Upgrade to Pro</div><div id="sidebarProSub" style="font-size:0.68rem;color:var(--mid);font-weight:600;margin-top:1px;">Unlock Library, AI tools &amp; more ✨</div></div>
    </div>
    <div class="sidebar-footer">
      <div class="sidebar-user" onclick="openFP('profilePanel')">
        <div class="sidebar-avatar" id="sidebarAvatar"><span id="sidebarAvatarInner">🐣</span></div>
        <div>
          <div class="sidebar-username" id="sidebarName">Tracker</div>
          <div class="sidebar-occ" id="sidebarOcc">Student</div>
          <div class="sidebar-status" id="sidebarStreak">🔥 Day 1 streak</div>
        </div>
      </div>
      <div class="nav-divider" style="height:1px;background:rgba(200,180,240,0.2);margin:7px 0;"></div>
      <button class="auth-btn" onclick="openLoginModal('switch')">🔄 &nbsp;Switch Account</button>
      <button class="auth-btn logout" onclick="handleLogout()">🚪 &nbsp;Log Out</button>
    </div>
  </div>

  <div class="main-area">
    <div class="top-bar">
      <button class="hamburger-btn" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
      <div class="top-title" id="topTitle">Dashboard</div>
      <div id="syncBadge" style="display:flex;align-items:center;gap:5px;font-size:0.7rem;font-weight:700;color:var(--mid);opacity:0;transition:opacity 0.5s;padding:4px 9px;border-radius:10px;background:rgba(255,255,255,0.5);"><span id="syncDot" style="width:6px;height:6px;border-radius:50%;background:#5eead4;flex-shrink:0;"></span><span id="syncLabel">Synced</span></div>
      <div class="avatar-btn" onclick="openAvatarModal()" id="avatarBtn"><span id="avatarBtnInner">🐣</span></div>
    </div>
    <div id="dashPanel">
      <div class="subsection-card" style="animation-delay:.05s" onclick="openFP('calPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#d8c4f0,#e8d8ff);">📅</div><div class="card-title">Calendar</div><div class="card-desc">Manage tasks & deadlines</div></div>
      <div class="subsection-card" style="animation-delay:.12s" onclick="openFP('taskPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#b8f0c8,#d4f5e0);">✅</div><div class="card-title">Task List</div><div class="card-desc">Group tasks & team chat</div></div>
      <div class="subsection-card" style="animation-delay:.19s" onclick="openFP('actPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#c9b3e8,#ddd0f8);">📊</div><div class="card-title">Activity</div><div class="card-desc">Track progress & scores</div></div>
      <div class="subsection-card" style="animation-delay:.26s" onclick="openFP('libraryPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#fde68a,#fef3c7);">📚</div><div class="card-title">Library</div><div class="card-desc">Upload study materials</div></div>
      <div class="subsection-card" style="animation-delay:.33s" onclick="openFP('groupsPanel')"><div class="card-icon" style="background:linear-gradient(135deg,#ffd6e0,#ffecf3);">👥</div><div class="card-title">Groups</div><div class="card-desc">Group chats & shared tasks</div></div>
      <div class="subsection-card" style="animation-delay:.40s;border:2px solid rgba(139,92,246,0.25);background:linear-gradient(135deg,rgba(200,180,240,0.35),rgba(180,240,200,0.2));position:relative;overflow:hidden;" onclick="openFP('pricingPanel')">
        <div style="position:absolute;top:9px;right:12px;font-family:'Nunito',sans-serif;font-size:0.6rem;font-weight:900;color:#8b5cf6;background:rgba(200,180,240,0.4);padding:2px 8px;border-radius:10px;">✨ UPGRADE</div>
        <div class="card-icon" style="background:linear-gradient(135deg,#f9a8d4,#c9b3e8);">👑</div>
        <div class="card-title">Go Pro</div>
        <div class="card-desc">Unlock all premium features</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PANELS ===== -->
<!-- CALENDAR -->
<div class="full-panel hidden" id="calPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('calPanel')">←</button><span class="fp-title">📅 Calendar</span></div>
  <div class="fp-content">
    <div class="panel-card">
      <div class="cal-nav"><button onclick="changeMonth(-1)">‹</button><div class="cal-month" id="calMonthLabel"></div><button onclick="changeMonth(1)">›</button></div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
    <div class="panel-card"><h3 id="taskPanelTitle">Select a date to view tasks</h3>
      <div class="task-input-row" id="taskInputRow" style="display:none"><input class="task-input" id="calTaskInput" placeholder="Add task or deadline..." onkeydown="if(event.key==='Enter')addCalTask()"/><button class="add-btn" onclick="addCalTask()">+ Add</button></div>
      <div id="calTaskList"></div></div>
  </div>
</div>

<!-- TASK LIST -->
<div class="full-panel hidden" id="taskPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('taskPanel')">←</button><span class="fp-title">✅ All Tasks</span></div>
  <div class="fp-content">
    <div class="panel-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <h3 style="margin:0;">📋 Calendar Tasks</h3>
        <select id="taskFilterStatus" onchange="renderTaskPanel()" style="padding:6px 10px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.82rem;color:var(--dark);outline:none;">
          <option value="all">All</option><option value="pending">Pending</option><option value="done">Done</option>
        </select>
      </div>
      <div id="taskPanelList"><div style="color:var(--mid);font-size:0.88rem;font-weight:600;text-align:center;padding:22px 0;">No tasks yet — add them via Calendar 📅</div></div>
    </div>
    <div class="panel-card">
      <h3>👥 My Group Tasks</h3>
      <div id="groupTaskList"></div>
      <div class="task-input-row" style="margin-top:9px;">
        <input class="task-input" id="gtaskInput" placeholder="Add a task..." onkeydown="if(event.key==='Enter')addGroupTask()"/>
        <select id="gtaskStatus" style="padding:9px 10px;border-radius:13px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.82rem;color:var(--dark);outline:none;">
          <option value="pending">Pending</option><option value="done">Done</option><option value="late">Late</option>
        </select>
        <button class="add-btn" onclick="addGroupTask()">+ Add</button>
      </div>
    </div>
    <div class="panel-card" style="display:flex;flex-direction:column;"><h3>💬 Team Chat</h3>
      <div class="chat-area" id="chatArea">
        <div class="msg other"><div class="sender">Alex 🐱</div>Hey team! Wireframes are ready 🎉</div>
        <div class="msg me"><div class="sender">You</div>Great! I'll review them today.</div>
        <div class="msg other"><div class="sender">Sam 🐸</div>Can we move the deadline to Friday?</div>
      </div>
      <div class="msg-input-row"><input class="msg-input" id="msgInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMsg()"/><button class="send-btn" onclick="sendMsg()">Send ➤</button></div>
    </div>
  </div>
</div>

<!-- Add/Edit Score Modal -->
<div class="modal-overlay hidden" id="addScoreModal" onclick="if(event.target===this)closeAddScoreModal()">
  <div class="avatar-modal" style="max-width:370px;">
    <div class="modal-title" id="scoreModalTitle">➕ Add Activity Entry</div>
    <div style="display:flex;flex-direction:column;gap:9px;margin-top:10px;">
      <input class="task-input" id="scoreTaskName" placeholder="Task name..." style="width:100%;"/>
      <input class="task-input" id="scoreTaskDate" type="date" style="width:100%;"/>
      <select id="scoreTaskStatus" style="width:100%;padding:10px 14px;border-radius:13px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);font-family:'Quicksand',sans-serif;font-size:0.92rem;color:var(--dark);outline:none;">
        <option value="Pending">Pending</option><option value="Submitted">Submitted</option><option value="Late">Late</option>
      </select>
      <input class="task-input" id="scoreTaskScore" placeholder="Score (e.g. 95/100) — optional" style="width:100%;"/>
    </div>
    <div style="display:flex;gap:9px;margin-top:13px;">
      <button class="add-btn" onclick="saveScoreEntry()" style="flex:1;">💾 Save</button>
      <button class="add-btn" onclick="closeAddScoreModal()" style="flex:1;background:rgba(200,180,240,0.3);color:var(--dark);">Cancel</button>
    </div>
  </div>
</div>

<!-- ACTIVITY -->
<div class="full-panel hidden" id="actPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('actPanel')">←</button><span class="fp-title">📊 Activity</span></div>
  <div class="fp-content">
    <div class="score-card"><div class="score-num" id="overallScore">—</div><div class="score-label">Overall Score</div><div class="private-toggle"><input type="checkbox" id="scorePrivate" onchange="togglePrivate()"/><label for="scorePrivate">Make my score private</label></div></div>
    <div class="panel-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;flex-wrap:wrap;gap:8px;">
        <h3 style="margin:0;">My Tasks &amp; Scores</h3>
        <button class="add-btn" onclick="openAddScoreModal()" style="font-size:0.8rem;">+ Add Entry</button>
      </div>
      <div id="activityList"><div style="color:var(--mid);font-size:0.88rem;font-weight:600;text-align:center;padding:22px 0;">No activity yet — tasks added from Calendar appear here 📊</div></div>
    </div>
  </div>
</div>

<!-- LIBRARY -->
<div class="full-panel hidden" id="libraryPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('libraryPanel')">←</button><span class="fp-title">📚 Library</span></div>
  <div class="fp-content">
    <div class="panel-card" style="position:relative;">
      <!-- Free trial / Pro gate -->
      <div id="libGate" style="display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px;text-align:center;">
        <div style="font-size:2.8rem;">📚</div>
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.1rem;color:var(--dark);">Try Library Free — 1GB Included</div>
        <div style="font-size:0.84rem;color:var(--mid);font-weight:600;max-width:280px;line-height:1.65;">Upload photos, videos, and audio for your studies. Free users get <strong>1GB</strong> to try it out. Pro users get <strong>5GB</strong>.</div>
        <button onclick="activateLibrary()" style="padding:11px 28px;border-radius:28px;border:none;background:linear-gradient(135deg,#8b5cf6,#c9b3e8);color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.92rem;cursor:pointer;box-shadow:0 5px 18px rgba(139,92,246,0.28);">Start Free (1GB) 🎉</button>
        <div style="font-size:0.74rem;color:var(--mid);font-weight:600;">or <span style="color:#8b5cf6;cursor:pointer;font-weight:800;" onclick="openFP('pricingPanel')">Upgrade to Pro for 5GB →</span></div>
      </div>
      <!-- Library content (hidden until activated) -->
      <div id="libContent" style="display:none;">
        <div style="margin-bottom:11px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
          <div><div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.15rem;color:var(--text-on-theme);">Your Study Library</div>
          <div style="color:var(--text-mid-theme);font-size:0.87rem;font-weight:600;margin-top:3px;" id="libStorageLabel2">Upload photos, videos, and audio 📖</div></div>
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:110px;height:7px;border-radius:10px;background:rgba(200,180,240,0.25);overflow:hidden;"><div id="libStorageFill" style="height:100%;width:0%;background:linear-gradient(90deg,#8b5cf6,#5eead4);border-radius:10px;transition:width 0.4s;"></div></div>
            <span id="libStorageLabel" style="font-size:0.72rem;color:var(--mid);font-weight:700;white-space:nowrap;">0 MB used</span>
          </div>
        </div>
        <div class="lib-tabs">
          <div class="lib-tab active" onclick="switchLibTab('all',this)">All Files</div>
          <div class="lib-tab" onclick="switchLibTab('image',this)">📸 Photos</div>
          <div class="lib-tab" onclick="switchLibTab('video',this)">🎬 Videos</div>
          <div class="lib-tab" onclick="switchLibTab('audio',this)">🎵 Audio</div>
        </div>
        <div class="lib-upload-zone" onclick="document.getElementById('libFileInput').click()">
          <div class="up-icon">☁️</div>
          <div class="up-label">Click to Upload Files</div>
          <div class="up-sub" id="libUploadSub">Images, Videos, Audio · 1GB Free</div>
          <input type="file" id="libFileInput" multiple accept="image/*,video/*,audio/*" onchange="handleLibUpload(event)"/>
        </div>
        <div id="libGrid" class="lib-grid"></div>
        <div id="libEmpty" class="lib-empty"><div class="lib-empty-icon">📂</div>No files yet. Upload something to get started!</div>
      </div>
    </div>
  </div>
</div>
<div class="file-modal hidden" id="fileModal" onclick="if(event.target===this)closeFileModal()">
  <div class="file-modal-inner"><div style="display:flex;align-items:center;justify-content:space-between;"><div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;color:#3d3260;" id="fileModalTitle">Preview</div><button onclick="closeFileModal()" style="border:none;background:rgba(200,180,240,0.3);border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:0.95rem;">✕</button></div><div id="fileModalContent"></div></div>
</div>

<!-- GROUPS -->
<div class="full-panel hidden" id="groupsPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('groupsPanel')">←</button><span class="fp-title">👥 Groups</span></div>
  <div class="fp-content" style="flex-direction:column;">
    <div style="margin-bottom:3px;"><div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.4rem;color:var(--text-on-theme);">Group Tab</div><div style="color:var(--text-mid-theme);font-size:0.88rem;font-weight:600;margin-top:2px;">Where teamwork actually works — most of the time. 🤝</div></div>
    <!-- Join banner shown when arriving via invite link -->
    <div class="join-banner" id="joinBanner" style="display:none;">
      <span class="join-banner-icon">🎉</span>
      <div><div class="join-banner-text" id="joinBannerText">You've joined the group!</div><div class="join-banner-sub" id="joinBannerSub">You can now chat and collaborate with the team.</div></div>
    </div>
    <div class="groups-layout" style="flex:1;min-height:0;">
      <div class="groups-chat-side">
        <div class="panel-card" style="display:flex;flex-direction:column;gap:8px;"><h3>Your Groups</h3>
          <div id="groupTabList"></div>
          <div style="margin-top:4px;">
            <div style="font-family:'Nunito',sans-serif;font-size:0.72rem;font-weight:800;color:var(--text-mid-theme);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;">Create New Group</div>
            <div class="task-input-row"><input class="task-input" id="newGroupInput" placeholder="Group name..."/><button class="add-btn" onclick="createGroup()">+ Create</button></div>
          </div>
        </div>
        <div class="panel-card" style="flex:1;display:flex;flex-direction:column;">
          <!-- Chat header: title + invite btn -->
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
            <h3 id="groupChatTitle" style="margin:0;">💬 English Group Chat</h3>
            <button class="invite-btn" onclick="openInviteModal()" id="inviteBtn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
              Invite
            </button>
          </div>
          <!-- Members row -->
          <div class="group-members-row" id="groupMembersRow"></div>
          <div class="chat-area" id="groupChatArea" style="margin-top:8px;"></div>
          <div class="msg-input-row"><input class="msg-input" id="groupMsgInput" placeholder="Type in group..." onkeydown="if(event.key==='Enter')sendGroupMsg()"/><button class="send-btn" onclick="sendGroupMsg()">Send ➤</button></div>
        </div>
      </div>
      <div class="groups-task-side">
        <div class="panel-card" style="overflow-y:auto;"><h3>📋 Group Tasks</h3>
          <div id="groupTasksDisplay"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== INVITE MODAL ===== -->
<div class="invite-modal-overlay hidden" id="inviteModal" onclick="if(event.target===this)closeInviteModal()">
  <div class="invite-modal">
    <div class="invite-modal-header">
      <span class="invite-modal-title">✉️ Invite to Group</span>
      <button class="invite-modal-close" onclick="closeInviteModal()">✕</button>
    </div>
    <div id="inviteGroupBadge" class="invite-group-badge"></div>
    <div class="invite-field-label">Invitee's Gmail Address</div>
    <input class="invite-field" id="inviteEmailInput" type="email" placeholder="friend@gmail.com" oninput="updateInvitePreview()"/>
    <div class="invite-field-label" style="margin-top:12px;">Personal Message <span style="font-weight:600;color:var(--mid);text-transform:none;font-size:0.72rem;">(optional)</span></div>
    <input class="invite-field" id="inviteMessageInput" type="text" placeholder="Hey! Join our study group 🎉" oninput="updateInvitePreview()"/>
    <!-- Live preview -->
    <div class="invite-preview" id="invitePreview">
      <div style="margin-bottom:6px;">📧 <b>Email preview:</b></div>
      <div id="invitePreviewBody"></div>
      <div class="invite-link-preview" id="invitePreviewLink"></div>
    </div>
    <div class="invite-actions">
      <button class="invite-send-btn" onclick="sendInviteEmail()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4 20-7z"/><path d="M22 2 11 13"/></svg>
        Open Gmail to Send
      </button>
      <button class="invite-copy-btn" onclick="copyInviteLink()" id="inviteCopyBtn">🔗 Copy Link</button>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div class="full-panel hidden" id="profilePanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('profilePanel')">←</button><span class="fp-title">👤 Profile</span></div>
  <div class="fp-content">
    <div class="profile-hero"><div class="profile-avatar-big" id="profileAvatarBig"><span id="profileAvatarInner">🐣</span></div><div class="profile-name" id="profileNameDisplay">Tracker</div><div class="profile-tag" id="profileOccDisplay">Student · Active Member</div><div class="streak-badge">🔥 <span id="streakCount">1</span> Day Streak</div></div>
    <div class="panel-card"><h3>Personal Info</h3>
      <div class="info-row"><div class="info-icon" style="background:#f0e8ff;">👤</div><div><div class="info-label">Full Name</div><div class="info-val" id="profileNameVal">Tracker User</div></div></div>
      <div class="info-row"><div class="info-icon" style="background:#e0f8e8;">🎒</div><div><div class="info-label">Occupation</div><div class="info-val" id="profileOccVal">Student</div></div></div>
      <div class="info-row"><div class="info-icon" style="background:#fff0e0;">📧</div><div><div class="info-label">Email</div><div class="info-val" id="profileEmail">—</div></div></div>
      <div class="info-row"><div class="info-icon" style="background:#e8f0ff;">📅</div><div><div class="info-label">Member Since</div><div class="info-val">February 19, 2026</div></div></div>
      <div class="info-row"><div class="info-icon" style="background:#f5f0ff;">🔥</div><div><div class="info-label">Current Streak</div><div class="info-val"><span id="streakVal">1</span> day(s) active</div></div></div>
    </div>
    <div class="panel-card"><h3>My Groups</h3><div><span class="group-chip">📘 English Group</span><span class="group-chip">📗 Math Group</span><span class="group-chip">🔬 Science Group</span></div></div>
    <div class="panel-card"><h3>Edit Profile</h3><div class="task-input-row"><input class="task-input" id="editNameInput" placeholder="Update display name..." value="Tracker"/><button class="add-btn" onclick="saveProfileName()">Save</button></div></div>
  </div>
</div>

<!-- SECURITY -->
<div class="full-panel hidden" id="secPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('secPanel')">←</button><span class="fp-title">🔒 Security</span></div>
  <div class="fp-content">

    <!-- Account Security -->
    <div class="panel-card"><h3>Account Security</h3>
      <div class="sec-item"><div class="sec-left"><div class="sec-icon" style="background:#f0e8ff;">🔑</div><div><div class="sec-title">Change Password</div><div class="sec-sub">Last changed: Never</div></div></div><span class="sec-arrow">›</span></div>
      <div class="sec-item"><div class="sec-left"><div class="sec-icon" style="background:#e0f8e8;">📱</div><div><div class="sec-title">Two-Factor Authentication</div><div class="sec-sub">Add extra security via SMS or app</div></div></div><span class="sec-arrow">›</span></div>
      <div class="sec-item"><div class="sec-left"><div class="sec-icon" style="background:#fff0e0;">🔗</div><div><div class="sec-title">Linked Google Account</div><div class="sec-sub" id="googleLinkedStatus">Not linked</div></div></div><button onclick="signInWithGoogle()" style="padding:7px 14px;border-radius:10px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.7);cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.8rem;color:#3d3260;">Link</button></div>
    </div>

    <!-- Update Password -->
    <div class="panel-card"><h3>Update Password</h3>
      <div style="display:flex;flex-direction:column;gap:9px;">
        <input class="task-input" placeholder="Current password..." type="password" style="width:100%"/>
        <input class="task-input" placeholder="New password..." type="password" style="width:100%"/>
        <input class="task-input" placeholder="Confirm new password..." type="password" style="width:100%"/>
        <button class="add-btn" style="width:100%;padding:12px;">Update Password</button>
      </div>
    </div>

    <!-- Privacy & Terms -->
    <div class="panel-card">
      <h3>Privacy &amp; Terms</h3>

      <!-- Privacy Policy accordion -->
      <div class="legal-accordion" id="privacyAccordion">
        <div class="legal-accordion-header" onclick="toggleLegal('privacyBody','privacyChevron')">
          <div class="sec-left">
            <div class="sec-icon" style="background:#e8f0ff;">📄</div>
            <div>
              <div class="sec-title">Privacy Policy</div>
              <div class="sec-sub">Last Updated: February 21, 2026 · How we handle your data</div>
            </div>
          </div>
          <span class="legal-chevron" id="privacyChevron">›</span>
        </div>
        <div class="legal-doc-body" id="privacyBody">
          <div class="legal-doc-scroll">

            <div class="legal-section-title">1. Introduction</div>
            <p>Welcome to Track &amp; Clock. We are committed to protecting your privacy and ensuring the security of your personal information. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our task management and productivity platform.</p>
            <p>By accessing or using Track &amp; Clock, you agree to the terms of this Privacy Policy. If you do not agree with our policies and practices, please do not use our Service.</p>

            <div class="legal-section-title">2. Information We Collect</div>
            <div class="legal-subsection">2.1 Personal Information</div>
            <p>We may collect personal information that you voluntarily provide to us when you:</p>
            <ul class="legal-list">
              <li>Register for an account</li>
              <li>Create tasks, calendar events, or activity entries</li>
              <li>Use our chat and messaging features</li>
              <li>Upload files, photos, videos, or audio to the Library</li>
              <li>Contact our support team</li>
            </ul>
            <p>This information may include:</p>
            <ul class="legal-list">
              <li>Name and email address</li>
              <li>Profile information and preferences</li>
              <li>Task data, calendar entries, and productivity metrics</li>
              <li>Chat messages and group communications</li>
              <li>Files and media uploaded to your Library</li>
            </ul>
            <div class="legal-subsection">2.2 Automatically Collected Information</div>
            <p>When you access our Service, we automatically collect certain information about your device and usage, including:</p>
            <ul class="legal-list">
              <li>IP address and device identifiers</li>
              <li>Browser type and operating system</li>
              <li>Usage patterns and feature interactions</li>
              <li>Log data and error reports</li>
            </ul>

            <div class="legal-section-title">3. How We Use Your Information</div>
            <p>We use the information we collect to:</p>
            <ul class="legal-list">
              <li>Provide, maintain, and improve our Service</li>
              <li>Process and display your tasks, calendar events, and activity data</li>
              <li>Enable chat functionality and group communications</li>
              <li>Store and manage your files in the Library</li>
              <li>Send notifications and updates about your tasks</li>
              <li>Respond to your inquiries and provide customer support</li>
              <li>Analyze usage trends to enhance user experience</li>
              <li>Detect and prevent fraud, abuse, or security incidents</li>
            </ul>

            <div class="legal-section-title">4. Data Storage and Security</div>
            <p>We implement appropriate technical and organizational measures to protect your personal information:</p>
            <ul class="legal-list">
              <li>Encryption of data in transit (TLS/SSL) and at rest</li>
              <li>Regular security assessments and vulnerability testing</li>
              <li>Access controls and authentication mechanisms</li>
              <li>Secure data backup and disaster recovery procedures</li>
            </ul>
            <p>While we strive to protect your information, no method of transmission over the internet or electronic storage is 100% secure. We cannot guarantee absolute security.</p>

            <div class="legal-section-title">5. Data Sharing and Disclosure</div>
            <p>We do not sell your personal information. We may share your information only in the following circumstances:</p>
            <ul class="legal-list">
              <li>With your explicit consent</li>
              <li>With service providers who assist us in operating our Service</li>
              <li>To comply with legal obligations or court orders</li>
              <li>To protect our rights, property, or safety, or that of our users</li>
              <li>In connection with a merger, acquisition, or sale of assets</li>
            </ul>

            <div class="legal-section-title">6. Your Rights and Choices</div>
            <p>Depending on your location, you may have the following rights regarding your personal information:</p>
            <ul class="legal-list">
              <li><strong>Access:</strong> Request a copy of your personal data</li>
              <li><strong>Correction:</strong> Update or correct inaccurate information</li>
              <li><strong>Deletion:</strong> Request deletion of your personal data</li>
              <li><strong>Portability:</strong> Receive your data in a structured format</li>
              <li><strong>Restriction:</strong> Limit how we process your data</li>
            </ul>
            <p>To exercise these rights, please contact us using the information provided in Section 10.</p>

            <div class="legal-section-title">7. Chat and Communication Data</div>
            <p>Our Service includes chat functionality that allows you to communicate with other users and create groups. Please be aware that:</p>
            <ul class="legal-list">
              <li>Chat messages are stored on our servers to enable the service</li>
              <li>Group administrators may have access to group member information</li>
              <li>We do not monitor private conversations but may review reports of abuse</li>
              <li>You are responsible for the content you share in chats</li>
            </ul>

            <div class="legal-section-title">8. Library Content</div>
            <p>The Library feature allows you to upload and store files, photos, videos, and audio. Please note:</p>
            <ul class="legal-list">
              <li>You retain ownership of content you upload</li>
              <li>You grant us a license to store and display your content as necessary to provide the Service</li>
              <li>We may impose storage limits based on your account type</li>
              <li>Prohibited content will be removed and may result in account termination</li>
            </ul>

            <div class="legal-section-title">9. Cookies and Tracking Technologies</div>
            <p>We use cookies and similar tracking technologies to enhance your experience, remember your preferences, and analyze usage patterns. You can control cookie settings through your browser preferences.</p>

            <div class="legal-section-title">10. Children's Privacy</div>
            <p>Our Service is not intended for children under 13 years of age. We do not knowingly collect personal information from children under 13. If you believe we have collected information from a child under 13, please contact us immediately.</p>

            <div class="legal-section-title">11. Changes to This Privacy Policy</div>
            <p>We may update this Privacy Policy from time to time. We will notify you of any changes by posting the new policy on this page and updating the "Last Updated" date. Your continued use of the Service after such changes constitutes acceptance of the updated policy.</p>

            <div class="legal-section-title">12. Contact Us</div>
            <p>If you have any questions, concerns, or requests regarding this Privacy Policy or our data practices, please contact us at:</p>
            <div class="legal-contact-badge">📧 <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6a1e180b09010b040e09060509012a0d070b030644090507">[email&#160;protected]</a></div>

          </div>
        </div>
      </div>

      <div style="height:10px;"></div>

      <!-- Terms of Service accordion -->
      <div class="legal-accordion" id="tosAccordion">
        <div class="legal-accordion-header" onclick="toggleLegal('tosBody','tosChevron')">
          <div class="sec-left">
            <div class="sec-icon" style="background:#f5e8ff;">📋</div>
            <div>
              <div class="sec-title">Terms of Service</div>
              <div class="sec-sub">Last Updated: February 21, 2026 · Rules for using Track &amp; Clock</div>
            </div>
          </div>
          <span class="legal-chevron" id="tosChevron">›</span>
        </div>
        <div class="legal-doc-body" id="tosBody">
          <div class="legal-doc-scroll">

            <div class="legal-section-title">1. Agreement to Terms</div>
            <p>Welcome to Track &amp; Clock. These Terms of Service constitute a legally binding agreement between you and Track &amp; Clock regarding your use of our task management and productivity platform.</p>
            <p>By accessing or using our Service, you agree to be bound by these Terms. If you do not agree to these Terms, you may not access or use the Service.</p>

            <div class="legal-section-title">2. Description of Service</div>
            <p>Track &amp; Clock is a productivity platform that provides the following features:</p>
            <div class="legal-subsection">2.1 Calendar</div>
            <p>A calendar feature that displays tasks and events you input, helping you organize and visualize your schedule.</p>
            <div class="legal-subsection">2.2 Task List</div>
            <p>A task management system that shows your list of tasks and tracks their progress status.</p>
            <div class="legal-subsection">2.3 Activity Tab</div>
            <p>A feature that displays task intensity and priority levels to help you focus on what matters most.</p>
            <div class="legal-subsection">2.4 Chat</div>
            <p>A messaging platform that allows you to communicate with other users and create groups for collaborative work.</p>
            <div class="legal-subsection">2.5 Library</div>
            <p>A storage system that compiles and organizes files, photos, videos, and audio that you upload.</p>

            <div class="legal-section-title">3. Account Registration</div>
            <p>To use certain features of the Service, you must create an account. You agree to:</p>
            <ul class="legal-list">
              <li>Provide accurate, current, and complete information during registration</li>
              <li>Maintain and promptly update your account information</li>
              <li>Keep your password secure and confidential</li>
              <li>Notify us immediately of any unauthorized access to your account</li>
              <li>Be responsible for all activities that occur under your account</li>
            </ul>

            <div class="legal-section-title">4. User Conduct</div>
            <p>You agree not to use the Service to:</p>
            <ul class="legal-list">
              <li>Violate any applicable laws or regulations</li>
              <li>Infringe upon the rights of others</li>
              <li>Upload or transmit viruses, malware, or harmful code</li>
              <li>Interfere with or disrupt the Service or servers</li>
              <li>Harvest or collect user information without consent</li>
              <li>Send unsolicited communications or spam</li>
              <li>Impersonate any person or entity</li>
              <li>Upload content that is illegal, harmful, threatening, or offensive</li>
            </ul>

            <div class="legal-section-title">5. Content and Intellectual Property</div>
            <div class="legal-subsection">5.1 Your Content</div>
            <p>You retain ownership of all content you create, upload, or store on the Service, including tasks, calendar entries, chat messages, and Library files. By using the Service, you grant us a limited license to use, store, and display your content solely for the purpose of providing and improving the Service.</p>
            <div class="legal-subsection">5.2 Prohibited Content</div>
            <p>You may not upload, store, or share content that:</p>
            <ul class="legal-list">
              <li>Infringes on intellectual property rights</li>
              <li>Contains malware or malicious code</li>
              <li>Is illegal, defamatory, or harassing</li>
              <li>Contains hate speech or promotes violence</li>
              <li>Is sexually explicit or pornographic</li>
            </ul>
            <div class="legal-subsection">5.3 Our Intellectual Property</div>
            <p>The Service and its original content, features, and functionality are owned by Track &amp; Clock and are protected by international copyright, trademark, and other intellectual property laws.</p>

            <div class="legal-section-title">6. Chat and Group Features</div>
            <p>When using our chat and group communication features:</p>
            <ul class="legal-list">
              <li>You are solely responsible for the content you share</li>
              <li>Group creators and administrators have additional responsibilities for managing group content</li>
              <li>We reserve the right to remove content that violates these Terms</li>
              <li>We may suspend or terminate accounts for repeated violations</li>
              <li>Chat messages may be retained as necessary for service operation</li>
            </ul>

            <div class="legal-section-title">7. Library Storage</div>
            <p>The Library feature is subject to the following terms:</p>
            <ul class="legal-list">
              <li>Storage limits may apply based on your account type</li>
              <li>We reserve the right to remove content that violates these Terms</li>
              <li>You are responsible for maintaining backups of important files</li>
              <li>We do not guarantee permanent storage of any content</li>
              <li>Large or inactive accounts may be subject to storage management policies</li>
            </ul>

            <div class="legal-section-title">8. Payment and Subscription</div>
            <p>Certain features of the Service may require payment. If you purchase a subscription:</p>
            <ul class="legal-list">
              <li>You agree to pay all applicable fees</li>
              <li>Subscriptions automatically renew unless cancelled</li>
              <li>Refunds are provided in accordance with our refund policy</li>
              <li>We may change pricing with advance notice</li>
            </ul>

            <div class="legal-section-title">9. Termination</div>
            <p>We may terminate or suspend your account immediately, without prior notice or liability, for any reason, including if you breach these Terms. Upon termination, your right to use the Service will immediately cease.</p>
            <p>You may terminate your account at any time by following the instructions in your account settings or contacting us.</p>

            <div class="legal-section-title">10. Disclaimer of Warranties</div>
            <div class="legal-disclaimer">THE SERVICE IS PROVIDED "AS IS" AND "AS AVAILABLE" WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. WE DO NOT WARRANT THAT THE SERVICE WILL BE UNINTERRUPTED, TIMELY, SECURE, OR ERROR-FREE, OR THAT ANY DEFECTS WILL BE CORRECTED.</div>

            <div class="legal-section-title">11. Limitation of Liability</div>
            <div class="legal-disclaimer">TO THE MAXIMUM EXTENT PERMITTED BY LAW, IN NO EVENT SHALL TRACK AND CLOCK BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES ARISING OUT OF OR RELATING TO YOUR USE OF THE SERVICE. OUR TOTAL LIABILITY FOR ANY CLAIM ARISING FROM OR RELATING TO THESE TERMS OR THE SERVICE SHALL NOT EXCEED THE AMOUNT YOU PAID US, IF ANY, DURING THE TWELVE (12) MONTHS PRIOR TO THE EVENT GIVING RISE TO LIABILITY.</div>

            <div class="legal-section-title">12. Indemnification</div>
            <p>You agree to indemnify, defend, and hold harmless Track &amp; Clock and its officers, directors, employees, and agents from and against any claims, liabilities, damages, losses, and expenses arising out of or in any way connected with your access to or use of the Service, your content, or your violation of these Terms.</p>

            <div class="legal-section-title">13. Governing Law</div>
            <p>These Terms shall be governed by and construed in accordance with applicable laws, without regard to conflict of law provisions. Any legal action arising out of these Terms shall be brought exclusively in the applicable courts of jurisdiction.</p>

            <div class="legal-section-title">14. Changes to Terms</div>
            <p>We reserve the right to modify or replace these Terms at any time. We will provide notice of significant changes by posting the updated Terms on our website and updating the "Last Updated" date. Your continued use of the Service after such changes constitutes acceptance of the updated Terms.</p>

            <div class="legal-section-title">15. Severability</div>
            <p>If any provision of these Terms is found to be unenforceable or invalid, that provision shall be limited or eliminated to the minimum extent necessary, and the remaining provisions shall remain in full force and effect.</p>

            <div class="legal-section-title">16. Entire Agreement</div>
            <p>These Terms constitute the entire agreement between you and Track &amp; Clock regarding the Service and supersede all prior agreements and understandings.</p>

            <div class="legal-section-title">17. Contact Us</div>
            <p>If you have any questions about these Terms, please contact us at:</p>
            <div class="legal-contact-badge">📧 <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="77030516141c161913141b18141c37101a161e1b5914181a">[email&#160;protected]</a></div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- APPEARANCE -->
<div class="full-panel hidden" id="appearPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('appearPanel')">←</button><span class="fp-title">🎨 Appearance</span></div>
  <div class="fp-content">
    <div class="panel-card"><h3>Choose a Theme</h3>
      <div class="theme-grid">
        <div class="theme-opt active" onclick="setTheme('lavender',this)" style="background:linear-gradient(135deg,#d4c8f0,#e8d8ff);"><div class="theme-preview" style="background:linear-gradient(135deg,#c9b3e8,#b8f0c8);"></div><div class="theme-name" style="color:#3d3260;">Lavender Dream</div></div>
        <div class="theme-opt" onclick="setTheme('ocean',this)" style="background:linear-gradient(135deg,#b3d8f0,#d8f0e8);"><div class="theme-preview" style="background:linear-gradient(135deg,#67b8e8,#5eead4);"></div><div class="theme-name" style="color:#1a4a6a;">Ocean Breeze</div></div>
        <div class="theme-opt" onclick="setTheme('sunset',this)" style="background:linear-gradient(135deg,#f0d4c8,#f0e8b3);"><div class="theme-preview" style="background:linear-gradient(135deg,#f8a4a4,#f8d48c);"></div><div class="theme-name" style="color:#6a2a1a;">Sunset Glow</div></div>
        <div class="theme-opt" onclick="setTheme('forest',this)" style="background:linear-gradient(135deg,#c8f0d4,#f0f0b3);"><div class="theme-preview" style="background:linear-gradient(135deg,#6dbf7e,#b8e868);"></div><div class="theme-name" style="color:#1a4a2a;">Forest Fresh</div></div>
        <div class="theme-opt" onclick="setTheme('rose',this)" style="background:linear-gradient(135deg,#f0c8d4,#f0c8f0);"><div class="theme-preview" style="background:linear-gradient(135deg,#f48fb1,#ce93d8);"></div><div class="theme-name" style="color:#5a1a3a;">Rose Garden</div></div>
        <div class="theme-opt" onclick="setTheme('night',this)" style="background:linear-gradient(135deg,#2a2540,#1a3a4a);"><div class="theme-preview" style="background:linear-gradient(135deg,#4a3f6b,#1a3a4a);"></div><div class="theme-name" style="color:#d0c8f0;">Midnight</div></div>
      </div>
    </div>
    <div class="panel-card"><h3>Mood / Vibe</h3>
      <div style="display:flex;gap:9px;flex-wrap:wrap;">
        <button class="mood-btn active" onclick="setMood(this)">🧸 Cozy</button>
        <button class="mood-btn" onclick="setMood(this)">🎯 Focused</button>
        <button class="mood-btn" onclick="setMood(this)">🎉 Playful</button>
        <button class="mood-btn" onclick="setMood(this)">🌿 Calm</button>
        <button class="mood-btn" onclick="setMood(this)">⚡ Energetic</button>
      </div>
    </div>
    <div class="panel-card"><h3>Font Size</h3>
      <div style="display:flex;gap:9px;align-items:center;">
        <button class="font-btn active" onclick="setFont('15px',this)" style="font-size:0.82rem;">Aa Small</button>
        <button class="font-btn" onclick="setFont('17px',this)" style="font-size:0.96rem;">Aa Medium</button>
        <button class="font-btn" onclick="setFont('20px',this)" style="font-size:1.12rem;">Aa Large</button>
        <button class="font-btn" onclick="setFont('23px',this)" style="font-size:1.3rem;">Aa Extra Large</button>
      </div>
      <div style="margin-top:11px;padding:11px 14px;background:rgba(200,180,240,0.15);border-radius:12px;font-weight:600;color:var(--text-on-theme);" id="fontPreviewText">
        This is a preview of how your text will look. Track &amp; Clock helps you stay on time! ✨
      </div>
    </div>
  </div>
</div>

<!-- ABOUT -->
<div class="full-panel hidden" id="aboutPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('aboutPanel')">←</button><span class="fp-title">ℹ️ About</span></div>
  <div class="fp-content">
    <div class="about-hero"><div class="about-logo">⏱</div><div class="about-name">Track &amp; Clock</div><div class="about-tagline">Stay on time. Stay on track. Your tasks, your pace.</div><div style="margin-top:13px;display:flex;justify-content:center;gap:13px;flex-wrap:wrap;"><span style="background:rgba(255,255,255,0.5);padding:5px 15px;border-radius:19px;font-size:0.82rem;font-weight:800;">Version 2.0</span><span style="background:rgba(255,255,255,0.5);padding:5px 15px;border-radius:19px;font-size:0.82rem;font-weight:800;">Feb 2026</span></div></div>
    <div class="panel-card"><h3>What is Track & Clock?</h3><p style="font-size:0.92rem;color:var(--text-mid-theme);line-height:1.75;font-weight:600;">Track & Clock is a collaborative productivity platform for students, teachers, and teams. Manage your time, coordinate group tasks, study with your own media library, and stay on top of deadlines — all in one customizable space.</p></div>
    <div class="panel-card"><h3>Features</h3>
      <div class="feature-item"><div class="feat-icon" style="background:#f0e8ff;">📅</div><div><div class="feat-title">Smart Calendar</div><div class="feat-desc">Click any date to add tasks and deadlines.</div></div></div>
      <div class="feature-item"><div class="feat-icon" style="background:#e0f8e8;">✅</div><div><div class="feat-title">Task List & Team Chat</div><div class="feat-desc">Group tasks and real-time team communication.</div></div></div>
      <div class="feature-item"><div class="feat-icon" style="background:#fef3c7;">📚</div><div><div class="feat-title">Library</div><div class="feat-desc">Upload photos, videos, and audio for studying.</div></div></div>
      <div class="feature-item"><div class="feat-icon" style="background:#e8f0ff;">👥</div><div><div class="feat-title">Groups</div><div class="feat-desc">Create and join groups for shared tasks and chat.</div></div></div>
      <div class="feature-item"><div class="feat-icon" style="background:#f5e8ff;">🎨</div><div><div class="feat-title">Customization</div><div class="feat-desc">Themes, moods, avatars — make it yours.</div></div></div>
    </div>
    <div class="panel-card" style="text-align:center;"><div style="font-size:0.88rem;color:var(--text-mid-theme);font-weight:600;">Made with 💜 for productive people everywhere</div><div style="font-size:0.79rem;color:var(--text-mid-theme);margin-top:6px;font-weight:600;">© 2026 Track & Clock. All rights reserved.</div></div>
  </div>
</div>

<!-- ===== PRICING PANEL ===== -->
<div class="full-panel hidden" id="pricingPanel">
  <div class="fp-bg"><div class="bg-anim"></div><div class="blob blob1"></div><div class="blob blob2"></div></div>
  <div class="fp-header"><button class="back-btn" onclick="closeFP('pricingPanel')">←</button><span class="fp-title">👑 Plans &amp; Pricing</span></div>
  <div class="fp-content" style="align-items:center;padding-bottom:40px;">
    <div style="text-align:center;max-width:620px;width:100%;padding:8px 0 4px;">
      <div style="font-size:0.74rem;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:var(--mid);margin-bottom:9px;">Simple, transparent pricing</div>
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:2rem;line-height:1.15;margin-bottom:9px;background:linear-gradient(135deg,#8b5cf6,#f9a8d4,#5eead4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Level up your productivity 🚀</div>
      <div style="font-size:0.92rem;color:var(--mid);font-weight:600;">Start free. Upgrade when you're ready. Cancel anytime.</div>
      <div style="display:flex;align-items:center;gap:10px;margin:18px auto 0;width:fit-content;">
        <div style="display:flex;background:rgba(255,255,255,0.55);border-radius:30px;padding:4px;border:1.5px solid rgba(200,180,240,0.3);gap:4px;">
          <button class="billing-btn active" id="billMonthly" onclick="setBilling('monthly')">Monthly</button>
          <button class="billing-btn" id="billAnnual" onclick="setBilling('annual')">Annual</button>
        </div>
        <span style="background:linear-gradient(135deg,#f9a8d4,#c9b3e8);color:#5a1a6a;padding:4px 11px;border-radius:20px;font-size:0.72rem;font-weight:900;font-family:'Nunito',sans-serif;">Save 20%</span>
      </div>
    </div>
    <div class="plans-grid">
      <!-- FREE -->
      <div class="plan-card" style="animation-delay:.05s">
        <div class="plan-icon">🌱</div><div class="plan-name">Free</div><div class="plan-desc">Perfect to get started</div>
        <div class="plan-price">₱<span>0</span></div><div class="plan-price-period">forever free</div><div class="plan-annual-note"> </div>
        <div class="plan-divider"></div>
        <div class="plan-features">
          <div class="pf"><span>✅</span>Calendar & task management</div>
          <div class="pf"><span>✅</span>Task list & team chat</div>
          <div class="pf"><span>✅</span>Up to 10 groups</div>
          <div class="pf"><span>✅</span>Basic activity tracking</div>
          <div class="pf"><span>✅</span>Avatar customization</div>
          <div class="pf"><span>✅</span>Deadline notifications</div>
          <div class="pf"><span>✅</span>Library — 1GB free trial</div>
          <div class="pf dim"><span>🔒</span>AI study assistant</div>
          <div class="pf dim"><span>🔒</span>Advanced analytics</div>
          <div class="pf dim"><span>🔒</span>Unlimited groups</div>
        </div>
        <button class="plan-cta cta-current" id="freeCta">Current Plan</button>
      </div>
      <!-- PRO -->
      <div class="plan-card pro-highlight" style="animation-delay:.12s">
        <div class="plan-popular-tag">⭐ Most Popular</div>
        <div class="plan-icon">✨</div><div class="plan-name">Pro</div><div class="plan-desc">For serious students & teams</div>
        <div class="plan-price">₱<span id="proPrice">149</span></div><div class="plan-price-period">per month</div><div class="plan-annual-note" id="proAnnualNote"> </div>
        <div class="plan-divider"></div>
        <div class="plan-features">
          <div class="pf"><span>✅</span>Everything in Free</div>
          <div class="pf"><span>📚</span>Library uploads — 5GB storage</div>
          <div class="pf"><span>🤖</span>AI study assistant & quiz gen</div>
          <div class="pf"><span>📊</span>Advanced analytics dashboard</div>
          <div class="pf"><span>⏰</span>Priority smart reminders</div>
          <div class="pf"><span>🎨</span>Exclusive Pro themes & avatars</div>
          <div class="pf"><span>👥</span>Unlimited groups</div>
          <div class="pf"><span>📅</span>Recurring tasks & templates</div>
          <div class="pf"><span>📤</span>Export tasks as PDF/CSV</div>
          <div class="pf"><span>🔔</span>Cross-device push notifications</div>
        </div>
        <button class="plan-cta cta-pro" id="proCta" onclick="openPayModal('pro')">Get Pro ✨</button>
      </div>
      <!-- TEAM -->
      <div class="plan-card" style="animation-delay:.20s">
        <div class="plan-icon">🏫</div><div class="plan-name">Team</div><div class="plan-desc">For classrooms & organizations</div>
        <div class="plan-price">₱<span id="teamPrice">399</span></div><div class="plan-price-period">per month · up to 30 users</div><div class="plan-annual-note" id="teamAnnualNote"> </div>
        <div class="plan-divider"></div>
        <div class="plan-features">
          <div class="pf"><span>✅</span>Everything in Pro</div>
          <div class="pf"><span>🏫</span>Admin dashboard & controls</div>
          <div class="pf"><span>👑</span>30GB shared team storage</div>
          <div class="pf"><span>📋</span>Assign tasks to members</div>
          <div class="pf"><span>📈</span>Team performance reports</div>
          <div class="pf"><span>🔒</span>Advanced privacy controls</div>
          <div class="pf"><span>📞</span>Priority support</div>
          <div class="pf"><span>🔗</span>LMS integrations</div>
          <div class="pf"><span>🎓</span>Bulk invite students</div>
          <div class="pf"><span>📊</span>Grade & submission tracking</div>
        </div>
        <button class="plan-cta cta-team" id="teamCta" onclick="openPayModal('team')">Get Team 🏫</button>
      </div>
    </div>
    <!-- Payment methods row -->
    <div style="margin-top:28px;text-align:center;max-width:620px;width:100%;">
      <div style="font-size:0.72rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;">Accepted Payment Methods</div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <div style="background:rgba(255,255,255,0.7);border:1.5px solid rgba(200,180,240,0.3);border-radius:12px;padding:9px 16px;font-size:0.82rem;font-weight:800;color:var(--dark);">💳 Credit / Debit Card</div>
        <div style="background:rgba(255,255,255,0.7);border:1.5px solid rgba(200,180,240,0.3);border-radius:12px;padding:9px 16px;font-size:0.82rem;font-weight:800;color:var(--dark);">📱 GCash</div>
        <div style="background:rgba(255,255,255,0.7);border:1.5px solid rgba(200,180,240,0.3);border-radius:12px;padding:9px 16px;font-size:0.82rem;font-weight:800;color:var(--dark);">🔵 Maya</div>
        <div style="background:rgba(255,255,255,0.7);border:1.5px solid rgba(200,180,240,0.3);border-radius:12px;padding:9px 16px;font-size:0.82rem;font-weight:800;color:var(--dark);">🏦 Bank Transfer</div>
      </div>
      <div style="margin-top:12px;font-size:0.78rem;color:var(--mid);font-weight:600;">🔒 Secure checkout · Cancel anytime · Philippine Peso (₱)</div>
    </div>
    <!-- FAQ -->
    <div class="panel-card" style="max-width:620px;width:100%;margin-top:6px;">
      <h3>Common Questions</h3>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div><div style="font-weight:800;font-size:0.88rem;color:var(--dark);">Can I cancel anytime?</div><div style="font-size:0.82rem;color:var(--mid);font-weight:600;margin-top:3px;">Yes! Cancel at any time. You keep your Pro features until the billing period ends.</div></div>
        <div style="height:1px;background:rgba(200,180,240,0.2);"></div>
        <div><div style="font-weight:800;font-size:0.88rem;color:var(--dark);">What happens to my Library files if I downgrade?</div><div style="font-size:0.82rem;color:var(--mid);font-weight:600;margin-top:3px;">Your files are kept safe for 60 days so you can download them.</div></div>
        <div style="height:1px;background:rgba(200,180,240,0.2);"></div>
        <div><div style="font-weight:800;font-size:0.88rem;color:var(--dark);">Is there a student discount?</div><div style="font-size:0.82rem;color:var(--mid);font-weight:600;margin-top:3px;">Yes! Students get 15% off. Email <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="67131506040c060903040b08040c27000a060e0b4904080a">[email&#160;protected]</a> with your school email.</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAYMENT MODAL ===== -->
<div class="pay-overlay hidden" id="payOverlay" onclick="if(event.target===this)closePayModal()">
  <div class="pay-modal">
    <div id="payFormSection">
      <div style="padding:24px 26px 0;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <span style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.18rem;color:var(--dark);">💳 Checkout</span>
        <button onclick="closePayModal()" style="width:32px;height:32px;border-radius:50%;border:none;background:rgba(200,180,240,0.28);cursor:pointer;font-size:1rem;color:var(--mid);">✕</button>
      </div>
      <div style="padding:0 26px 26px;display:flex;flex-direction:column;gap:15px;">
        <!-- Summary -->
        <div style="background:linear-gradient(135deg,rgba(139,92,246,0.07),rgba(180,240,200,0.1));border:1.5px solid rgba(200,180,240,0.32);border-radius:16px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:11px;">
            <span id="paySummaryIcon" style="font-size:1.8rem;">✨</span>
            <div><div id="paySummaryName" style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.95rem;color:var(--dark);">Pro Plan</div>
            <div id="paySummaryCycle" style="font-size:0.76rem;color:var(--mid);font-weight:600;margin-top:2px;">Monthly billing</div></div>
          </div>
          <div id="paySummaryPrice" style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.5rem;color:#8b5cf6;">₱149</div>
        </div>
        <!-- Billing -->
        <div>
          <div style="font-size:0.7rem;font-weight:900;color:var(--mid);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:7px;">Billing Cycle</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <button class="pay-cycle-btn active" id="cycleMonthly" onclick="selectCycle('monthly')">Monthly<span class="pay-cycle-save" id="payCycleMonthLabel">₱149/mo</span></button>
            <button class="pay-cycle-btn" id="cycleAnnual" onclick="selectCycle('annual')">Annual<span class="pay-cycle-save" id="payCycleAnnualLabel">₱119/mo · Save 20%</span></button>
          </div>
        </div>
        <!-- Payment method -->
        <div>
          <div style="font-size:0.7rem;font-weight:900;color:var(--mid);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:7px;">Payment Method</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
            <div class="pay-method active" onclick="selectPayMethod('card',this)"><span style="font-size:1.5rem;">💳</span><span style="font-size:0.7rem;font-weight:800;">Card</span></div>
            <div class="pay-method" onclick="selectPayMethod('gcash',this)"><span style="font-size:1.5rem;">📱</span><span style="font-size:0.7rem;font-weight:800;">GCash</span></div>
            <div class="pay-method" onclick="selectPayMethod('maya',this)"><span style="font-size:1.5rem;">🔵</span><span style="font-size:0.7rem;font-weight:800;">Maya</span></div>
            <div class="pay-method" onclick="selectPayMethod('bank',this)"><span style="font-size:1.5rem;">🏦</span><span style="font-size:0.7rem;font-weight:800;">Bank</span></div>
          </div>
        </div>
        <!-- Fields -->
        <div id="payFieldsCard">
          <div style="font-size:0.7rem;font-weight:900;color:var(--mid);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:7px;">Card Details</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <input class="pay-field" placeholder="Cardholder Name" id="cardName"/>
            <input class="pay-field" placeholder="Card Number  •••• •••• •••• ••••" maxlength="19" id="cardNum" oninput="formatCardNum(this)"/>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <input class="pay-field" placeholder="MM / YY" maxlength="7" id="cardExp" oninput="formatExpiry(this)"/>
              <input class="pay-field" placeholder="CVV" maxlength="4" type="password" id="cardCvv"/>
            </div>
          </div>
        </div>
        <div id="payFieldsGcash" style="display:none;background:rgba(0,180,100,0.06);border:1.5px dashed rgba(0,180,100,0.25);border-radius:13px;padding:14px 16px;font-size:0.83rem;color:var(--mid);font-weight:600;line-height:1.8;">
          <div style="text-align:center;font-size:2.5rem;margin-bottom:4px;">📱</div>
          <b style="color:var(--dark);">Pay via GCash</b><br>GCash number: <b style="color:var(--dark);">0917-TRACK-CLK</b><br>Account name: <b style="color:var(--dark);">Track and Clock Inc.</b>
          <input class="pay-field" placeholder="Your GCash number (09xx-xxx-xxxx)" id="gcashNum" style="margin-top:10px;"/>
        </div>
        <div id="payFieldsMaya" style="display:none;background:rgba(0,100,220,0.06);border:1.5px dashed rgba(0,100,220,0.2);border-radius:13px;padding:14px 16px;font-size:0.83rem;color:var(--mid);font-weight:600;line-height:1.8;">
          <div style="text-align:center;font-size:2.5rem;margin-bottom:4px;">🔵</div>
          <b style="color:var(--dark);">Pay via Maya</b><br>Maya number: <b style="color:var(--dark);">0915-TRACK-CLK</b><br>Account name: <b style="color:var(--dark);">Track and Clock Inc.</b>
          <input class="pay-field" placeholder="Your Maya number (09xx-xxx-xxxx)" id="mayaNum" style="margin-top:10px;"/>
        </div>
        <div id="payFieldsBank" style="display:none;background:rgba(139,92,246,0.05);border:1.5px dashed rgba(200,180,240,0.5);border-radius:13px;padding:14px 16px;font-size:0.83rem;color:var(--mid);font-weight:600;line-height:1.85;">
          <div style="text-align:center;font-size:2.5rem;margin-bottom:4px;">🏦</div>
          <b style="color:var(--dark);">BDO Bank Transfer</b><br>Account: <b style="color:var(--dark);">1234-5678-9012</b><br>Name: <b style="color:var(--dark);">Track and Clock Inc.</b><br>Ref: <b style="color:#8b5cf6;" id="bankRef">TC-0000</b>
          <input class="pay-field" placeholder="Transaction / Reference Number" id="bankTxn" style="margin-top:10px;"/>
        </div>
        <div style="text-align:center;font-size:0.74rem;color:var(--mid);font-weight:600;">🔒 Secured by 256-bit SSL · PCI DSS compliant</div>
        <button class="pay-submit" onclick="submitPayment()"><span id="paySubmitLabel">Complete Purchase — ₱149</span></button>
      </div>
    </div>
    <!-- Success -->
    <div id="paySuccessSection" style="display:none;flex-direction:column;align-items:center;gap:14px;padding:40px 26px;text-align:center;">
      <div style="width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,#b8f0c8,#c9b3e8);display:flex;align-items:center;justify-content:center;font-size:2.8rem;animation:cardPop 0.5s cubic-bezier(.34,1.56,.64,1) both;box-shadow:0 10px 32px rgba(139,92,246,0.2);">🎉</div>
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1.5rem;color:var(--dark);">You're now Pro! ✨</div>
      <div style="font-size:0.88rem;color:var(--mid);font-weight:600;line-height:1.7;max-width:320px;">All premium features are now unlocked. Welcome to Track & Clock Pro!</div>
      <div style="background:linear-gradient(135deg,rgba(200,180,240,0.18),rgba(180,240,200,0.14));border-radius:18px;padding:16px 18px;width:100%;text-align:left;border:1.5px solid rgba(200,180,240,0.28);">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:0.85rem;color:var(--dark);margin-bottom:10px;">🎁 Your Pro Features</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);border-bottom:1px solid rgba(200,180,240,0.15);">📚 Library — 5GB storage</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);border-bottom:1px solid rgba(200,180,240,0.15);">🤖 AI study assistant</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);border-bottom:1px solid rgba(200,180,240,0.15);">📊 Advanced analytics</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);border-bottom:1px solid rgba(200,180,240,0.15);">🎨 Exclusive Pro themes</div>
        <div style="padding:7px 0;font-size:0.84rem;font-weight:700;color:var(--dark);">👥 Unlimited groups</div>
      </div>
      <button onclick="closePayModal();closeFP('pricingPanel');" style="width:100%;padding:13px;border-radius:15px;border:none;background:linear-gradient(135deg,#c9b3e8,#b8f0c8);color:var(--dark);font-family:'Nunito',sans-serif;font-weight:900;font-size:0.95rem;cursor:pointer;">Start Exploring Pro 🚀</button>
    </div>
  </div>
</div>

<!-- AVATAR MODAL (Enhanced Chibi with photo) -->
<div class="modal-overlay hidden" id="avatarModal" onclick="if(event.target===this)closeAvatarModal()">
  <div class="avatar-modal">
    <div class="modal-title">🎨 Build Your Chibi Avatar</div>
    <div class="avatar-builder">
      <!-- Left: canvas + photo + pose -->
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px;flex-shrink:0;">
        <div class="avatar-canvas" id="avatarCanvas">
          <div class="av-bg" id="avBg" style="background:radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0);"></div>
          <!-- Floor shadow -->
          <div style="position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:80px;height:10px;background:rgba(120,90,180,0.1);border-radius:50%;"></div>
          <svg class="av-char" viewBox="0 0 120 200" id="avSvg" style="filter:drop-shadow(0 6px 12px rgba(100,80,180,0.18));">
            <!-- Shoes -->
            <g id="avShoeGroup">
              <ellipse cx="38" cy="191" rx="17" ry="9" fill="#c9b3e8" id="avShoeL"/>
              <ellipse cx="78" cy="191" rx="17" ry="9" fill="#c9b3e8" id="avShoeR"/>
              <ellipse cx="36" cy="187" rx="14" ry="7" fill="#e0d0f8"/>
              <ellipse cx="80" cy="187" rx="14" ry="7" fill="#e0d0f8"/>
            </g>
            <!-- Legs -->
            <g id="avLegs">
              <rect x="37" y="152" width="20" height="40" rx="10" fill="#f5c9a0" id="avLegL"/>
              <rect x="63" y="152" width="20" height="40" rx="10" fill="#f5c9a0" id="avLegR"/>
            </g>
            <!-- Outfit/Bottom -->
            <g id="avBottom"><rect x="28" y="122" width="64" height="38" rx="14" fill="#7a6fa0" id="avBottomShape"/></g>
            <!-- Arms -->
            <ellipse cx="17" cy="112" rx="10" ry="24" fill="#f5c9a0" id="avArmL" transform="rotate(-18 17 112)"/>
            <ellipse cx="103" cy="112" rx="10" ry="24" fill="#f5c9a0" id="avArmR" transform="rotate(18 103 112)"/>
            <!-- Hands -->
            <circle cx="12" cy="130" r="8" fill="#f5c9a0"/>
            <circle cx="108" cy="130" r="8" fill="#f5c9a0"/>
            <!-- Body -->
            <g id="avShirt"><rect x="26" y="90" width="68" height="40" rx="16" fill="#c9b3e8" id="avShirtShape"/></g>
            <!-- Neck -->
            <rect x="50" y="76" width="20" height="18" rx="8" fill="#f5c9a0" id="avNeck"/>
            <!-- Ears -->
            <ellipse cx="20" cy="58" rx="9" ry="11" fill="#f5c9a0" id="avEarL"/>
            <ellipse cx="100" cy="58" rx="9" ry="11" fill="#f5c9a0" id="avEarR"/>
            <ellipse cx="20" cy="58" rx="6" ry="7.5" fill="#f0b090" opacity="0.45"/>
            <ellipse cx="100" cy="58" rx="6" ry="7.5" fill="#f0b090" opacity="0.45"/>
            <!-- Big chibi head -->
            <ellipse cx="60" cy="52" rx="40" ry="44" fill="#f5c9a0" id="avHead"/>
            <!-- Hair (on top of head) -->
            <g id="avHair">
              <ellipse cx="60" cy="18" rx="38" ry="28" fill="#5c3d2e"/>
              <ellipse cx="60" cy="13" rx="30" ry="16" fill="#5c3d2e"/>
              <rect x="20" y="18" width="16" height="44" rx="8" fill="#5c3d2e"/>
              <rect x="84" y="18" width="16" height="44" rx="8" fill="#5c3d2e"/>
              <circle cx="20" cy="16" r="15" fill="#5c3d2e"/>
              <circle cx="100" cy="16" r="15" fill="#5c3d2e"/>
            </g>
            <!-- Eyes (big sparkly chibi) -->
            <ellipse cx="44" cy="55" rx="11" ry="13" fill="white" id="avEyeWL"/>
            <ellipse cx="76" cy="55" rx="11" ry="13" fill="white" id="avEyeWR"/>
            <ellipse cx="45" cy="57" rx="8" ry="9.5" fill="#2d1f14" id="avIrisL"/>
            <ellipse cx="77" cy="57" rx="8" ry="9.5" fill="#2d1f14" id="avIrisR"/>
            <!-- Iris color overlay -->
            <ellipse cx="45" cy="57" rx="6" ry="7.5" fill="#5b8dee" id="avIrisColorL" opacity="0.7"/>
            <ellipse cx="77" cy="57" rx="6" ry="7.5" fill="#5b8dee" id="avIrisColorR" opacity="0.7"/>
            <!-- Eye shines -->
            <circle cx="50" cy="52" r="3.5" fill="white"/>
            <circle cx="82" cy="52" r="3.5" fill="white"/>
            <circle cx="41" cy="60" r="1.8" fill="white" opacity="0.75"/>
            <circle cx="73" cy="60" r="1.8" fill="white" opacity="0.75"/>
            <!-- Eyebrows -->
            <path d="M33 44 Q44 39 55 44" stroke="#5c3d2e" stroke-width="3" fill="none" stroke-linecap="round" id="avBrowL"/>
            <path d="M65 44 Q76 39 87 44" stroke="#5c3d2e" stroke-width="3" fill="none" stroke-linecap="round" id="avBrowR"/>
            <!-- Nose -->
            <ellipse cx="60" cy="67" rx="4" ry="3" fill="#e0a070" opacity="0.5"/>
            <!-- Mouth -->
            <path d="M50 76 Q60 85 70 76" stroke="#c07050" stroke-width="2.8" fill="none" stroke-linecap="round" id="avMouth"/>
            <!-- Blush -->
            <ellipse cx="30" cy="68" rx="11" ry="7" fill="#ff9eb5" opacity="0.35" id="avBlushL"/>
            <ellipse cx="90" cy="68" rx="11" ry="7" fill="#ff9eb5" opacity="0.35" id="avBlushR"/>
            <!-- Accessories -->
            <g id="avAccLayer"></g>
          </svg>
        </div>
        <!-- Photo upload -->
        <div class="photo-upload-zone" onclick="document.getElementById('avPhotoInput').click()" title="Upload your photo as reference">
          📷 Use My Photo
          <input type="file" id="avPhotoInput" accept="image/*" onchange="loadAvatarPhoto(event)" style="display:none"/>
        </div>
        <!-- Pose -->
        <div style="font-size:0.67rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:1px;margin-top:2px;">Pose</div>
        <div class="pose-selector">
          <button class="pose-btn active" onclick="setPose('stand',this)" title="Standing">🧍</button>
          <button class="pose-btn" onclick="setPose('wave',this)" title="Waving">👋</button>
          <button class="pose-btn" onclick="setPose('sit',this)" title="Sitting">🪑</button>
          <button class="pose-btn" onclick="setPose('peace',this)" title="Peace">✌️</button>
        </div>
      </div>
      <!-- Right: options -->
      <div class="avatar-options">
        <!-- STYLE TEMPLATES -->
        <div class="opt-group">
          <div class="opt-label">✨ Style Template</div>
          <div class="style-chips" id="styleChipsRow">
            <button class="style-chip" onclick="applyStyle('coquette',this)">🎀 Coquette</button>
            <button class="style-chip" onclick="applyStyle('y2k',this)">💿 Y2K</button>
            <button class="style-chip" onclick="applyStyle('emo',this)">🖤 Emo</button>
            <button class="style-chip" onclick="applyStyle('cottagecore',this)">🌿 Cottagecore</button>
            <button class="style-chip" onclick="applyStyle('darkacademia',this)">📖 Dark Academia</button>
            <button class="style-chip" onclick="applyStyle('streetwear',this)">🧢 Streetwear</button>
            <button class="style-chip" onclick="applyStyle('kawaii',this)">🌸 Kawaii</button>
            <button class="style-chip" onclick="applyStyle('baddie',this)">💅 Baddie</button>
            <button class="style-chip" onclick="applyStyle('boho',this)">🍂 Boho</button>
            <button class="style-chip" onclick="applyStyle('pastelgoth',this)">🕸️ Pastel Goth</button>
          </div>
          <div class="style-preview-box" id="stylePreviewBox">
            <div class="style-preview-title" id="stylePreviewTitle"></div>
            <div id="stylePreviewDesc"></div>
          </div>
        </div>
        <div class="opt-group"><div class="opt-label">Skin Tone</div><div class="opt-row">
          <div class="color-swatch active" style="background:#f9e4d4;" onclick="setSkin('#f9e4d4',this)"></div>
          <div class="color-swatch" style="background:#f5c9a0;" onclick="setSkin('#f5c9a0',this)"></div>
          <div class="color-swatch" style="background:#e8a87c;" onclick="setSkin('#e8a87c',this)"></div>
          <div class="color-swatch" style="background:#c68642;" onclick="setSkin('#c68642',this)"></div>
          <div class="color-swatch" style="background:#8d5524;" onclick="setSkin('#8d5524',this)"></div>
          <div class="color-swatch" style="background:#5c3317;" onclick="setSkin('#5c3317',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Eye Color</div><div class="opt-row" id="eyeColorRow">
          <div class="color-swatch active" style="background:#5b8dee;" onclick="setEyeColor('#5b8dee',this)"></div>
          <div class="color-swatch" style="background:#4caf50;" onclick="setEyeColor('#4caf50',this)"></div>
          <div class="color-swatch" style="background:#a78bfa;" onclick="setEyeColor('#a78bfa',this)"></div>
          <div class="color-swatch" style="background:#f59e0b;" onclick="setEyeColor('#f59e0b',this)"></div>
          <div class="color-swatch" style="background:#ef4444;" onclick="setEyeColor('#ef4444',this)"></div>
          <div class="color-swatch" style="background:#2d1f14;" onclick="setEyeColor('#2d1f14',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Hair Style</div><div class="opt-row" id="hairStyleRow">
          <button class="opt-btn active" onclick="setHair('twin',this)">Twin Buns</button>
          <button class="opt-btn" onclick="setHair('short',this)">Short Bob</button>
          <button class="opt-btn" onclick="setHair('ponytail',this)">Ponytail</button>
          <button class="opt-btn" onclick="setHair('long',this)">Long Wavy</button>
          <button class="opt-btn" onclick="setHair('pixie',this)">Pixie</button>
          <button class="opt-btn" onclick="setHair('braids',this)">Braids</button>
          <button class="opt-btn" onclick="setHair('curly',this)">Curly</button>
          <button class="opt-btn" onclick="setHair('sidetail',this)">Side Tail</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Hair Color</div><div class="opt-row" id="hairColorRow">
          <div class="color-swatch active" style="background:#5c3d2e;" onclick="setHairColor('#5c3d2e',this)"></div>
          <div class="color-swatch" style="background:#1a1a2e;" onclick="setHairColor('#1a1a2e',this)"></div>
          <div class="color-swatch" style="background:#f5d060;" onclick="setHairColor('#f5d060',this)"></div>
          <div class="color-swatch" style="background:#e87878;" onclick="setHairColor('#e87878',this)"></div>
          <div class="color-swatch" style="background:#c9b3e8;" onclick="setHairColor('#c9b3e8',this)"></div>
          <div class="color-swatch" style="background:#b8f0c8;" onclick="setHairColor('#b8f0c8',this)"></div>
          <div class="color-swatch" style="background:#f97316;" onclick="setHairColor('#f97316',this)"></div>
          <div class="color-swatch" style="background:#e0e0e0;" onclick="setHairColor('#e0e0e0',this)"></div>
          <div class="color-swatch" style="background:#f9a8d4;" onclick="setHairColor('#f9a8d4',this)"></div>
          <div class="color-swatch" style="background:#67e8f9;" onclick="setHairColor('#67e8f9',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Top / Dress</div><div class="opt-row" id="shirtStyleRow">
          <button class="opt-btn active" onclick="setShirt('tshirt',this)">T-Shirt</button>
          <button class="opt-btn" onclick="setShirt('hoodie',this)">Hoodie</button>
          <button class="opt-btn" onclick="setShirt('uniform',this)">Uniform</button>
          <button class="opt-btn" onclick="setShirt('dress',this)">Dress</button>
          <button class="opt-btn" onclick="setShirt('sundress',this)">Sundress</button>
          <button class="opt-btn" onclick="setShirt('kitty',this)">🐱 Kitty</button>
          <button class="opt-btn" onclick="setShirt('bear',this)">🐻 Bear</button>
          <button class="opt-btn" onclick="setShirt('stripes',this)">Stripes</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Top Color</div><div class="opt-row" id="shirtColorRow">
          <div class="color-swatch active" style="background:#c9b3e8;" onclick="setShirtColor('#c9b3e8',this)"></div>
          <div class="color-swatch" style="background:#b8f0c8;" onclick="setShirtColor('#b8f0c8',this)"></div>
          <div class="color-swatch" style="background:#f9a8d4;" onclick="setShirtColor('#f9a8d4',this)"></div>
          <div class="color-swatch" style="background:#fde68a;" onclick="setShirtColor('#fde68a',this)"></div>
          <div class="color-swatch" style="background:#7dd3fc;" onclick="setShirtColor('#7dd3fc',this)"></div>
          <div class="color-swatch" style="background:#1f2937;" onclick="setShirtColor('#1f2937',this)"></div>
          <div class="color-swatch" style="background:#ffffff;" onclick="setShirtColor('#ffffff',this)"></div>
          <div class="color-swatch" style="background:#dc2626;" onclick="setShirtColor('#dc2626',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Bottom</div><div class="opt-row" id="pantsRow">
          <button class="opt-btn active" onclick="setPants('pants',this)">Pants</button>
          <button class="opt-btn" onclick="setPants('jeans',this)">Jeans</button>
          <button class="opt-btn" onclick="setPants('skirt',this)">Skirt</button>
          <button class="opt-btn" onclick="setPants('miniskirt',this)">Mini Skirt</button>
          <button class="opt-btn" onclick="setPants('shorts',this)">Shorts</button>
          <button class="opt-btn" onclick="setPants('plaid',this)">Plaid</button>
          <button class="opt-btn" onclick="setPants('leggings',this)">Leggings</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Shoes</div><div class="opt-row" id="shoeRow">
          <button class="opt-btn active" onclick="setShoes('sneakers',this)">Sneakers</button>
          <button class="opt-btn" onclick="setShoes('heels',this)">Heels</button>
          <button class="opt-btn" onclick="setShoes('boots',this)">Boots</button>
          <button class="opt-btn" onclick="setShoes('loafers',this)">Loafers</button>
          <button class="opt-btn" onclick="setShoes('barefoot',this)">Barefoot</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Shoe Color</div><div class="opt-row" id="shoeColorRow">
          <div class="color-swatch active" style="background:#c9b3e8;" onclick="setShoeColor('#c9b3e8',this)"></div>
          <div class="color-swatch" style="background:#1f2937;" onclick="setShoeColor('#1f2937',this)"></div>
          <div class="color-swatch" style="background:#ef4444;" onclick="setShoeColor('#ef4444',this)"></div>
          <div class="color-swatch" style="background:#ffffff;" onclick="setShoeColor('#ffffff',this)"></div>
          <div class="color-swatch" style="background:#92400e;" onclick="setShoeColor('#92400e',this)"></div>
          <div class="color-swatch" style="background:#fde68a;" onclick="setShoeColor('#fde68a',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Accessory</div><div class="opt-row" id="accRow">
          <button class="opt-btn active" onclick="setAcc('none',this)">None</button>
          <button class="opt-btn" onclick="setAcc('bow',this)">🎀 Bow</button>
          <button class="opt-btn" onclick="setAcc('crown',this)">👑 Crown</button>
          <button class="opt-btn" onclick="setAcc('catears',this)">🐱 Cat Ears</button>
          <button class="opt-btn" onclick="setAcc('flower',this)">🌸 Flower</button>
          <button class="opt-btn" onclick="setAcc('headphones',this)">🎧 Phones</button>
          <button class="opt-btn" onclick="setAcc('halo',this)">😇 Halo</button>
          <button class="opt-btn" onclick="setAcc('glasses',this)">👓 Glasses</button>
          <button class="opt-btn" onclick="setAcc('wings',this)">🦋 Wings</button>
        </div></div>
        <div class="opt-group"><div class="opt-label">Background</div><div class="opt-row" id="bgColorRow">
          <div class="color-swatch active" style="background:#d8c4f0;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0)',this)"></div>
          <div class="color-swatch" style="background:#b8f0c8;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#d0f8e8,#c0f0ff)',this)"></div>
          <div class="color-swatch" style="background:#ffd6e0;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#ffe8f0,#ffd6c8)',this)"></div>
          <div class="color-swatch" style="background:#ffe8b0;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#fff8d0,#ffe0a0)',this)"></div>
          <div class="color-swatch" style="background:#b0d8ff;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#c8e8ff,#d0f0ff)',this)"></div>
          <div class="color-swatch" style="background:#2d2050;" onclick="setAvBg('radial-gradient(circle at 50% 70%,#3a2a70,#1a1040)',this)"></div>
        </div></div>
        <div class="opt-group"><div class="opt-label">Display Name</div>
          <input class="task-input" id="avatarNameInput" value="Tracker" style="font-size:0.84rem;padding:8px 11px;width:100%;"/>
        </div>
      </div>
    </div>
    <button class="modal-close" onclick="saveAvatar()">✓ Save My Look</button>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal-overlay hidden" id="loginModal" onclick="if(event.target===this)closeLoginModal()">
  <div class="login-modal">
    <div style="font-size:2.4rem;text-align:center;margin-bottom:11px;">⏱</div>
    <h2 id="loginModalTitle">Welcome Back!</h2>
    <p id="loginModalSub">Log in to continue your tracking journey</p>
    <button class="google-login-btn" onclick="signInWithGoogle()">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <div class="login-divider">or email</div>
    <input class="login-field" type="text" placeholder="Username or Email" id="loginUsername"/>
    <input class="login-field" type="password" placeholder="Password" id="loginPassword"/>
    <div id="loginRegExtra" style="display:none;"><input class="login-field" type="password" placeholder="Confirm Password"/></div>
    <button class="login-btn" onclick="handleLogin()" id="loginSubmitBtn">Log In</button>
    <div class="login-switch" id="loginSwitchText">Don't have an account? <span onclick="toggleLoginMode()">Sign up</span></div>
    <button onclick="closeLoginModal()" style="width:100%;margin-top:9px;padding:10px;border-radius:11px;border:1.5px solid rgba(200,180,240,0.3);background:transparent;cursor:pointer;font-family:'Quicksand',sans-serif;font-weight:700;color:#7a6fa0;font-size:0.88rem;">Cancel</button>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
let occFloatEls=[];
// ===== FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyDw6A77JECtzvl6dITNcLRtet5Ce3c8sTA",
  authDomain: "track-and-clock.firebaseapp.com",
  databaseURL: "https://track-and-clock-default-rtdb.firebaseio.com",
  projectId: "track-and-clock",
  storageBucket: "track-and-clock.firebasestorage.app",
  messagingSenderId: "308165362298",
  appId: "1:308165362298:web:52c0183c3fd2480f31f1c3",
  measurementId: "G-FG10CRHQN8"
};
let db=null,auth=null,storage=null,firebaseReady=false;
let currentUserId=null;
try{
  firebase.initializeApp(firebaseConfig);
  auth=firebase.auth();
  db=firebase.firestore();
  storage=firebase.storage();
  firebaseReady=true;
  console.log('Firebase connected');
}catch(e){console.warn('Firebase init failed:',e);}

// ===== FIRESTORE SYNC LAYER =====
function _fsPath(sub){ return 'users/'+currentUserId+'/'+sub; }
function fsDoc(p){ return db.doc(_fsPath(p)); }
function fsColl(p){ return db.collection(_fsPath(p)); }

function fsSet(path,data){
  if(!firebaseReady||!currentUserId)return;
  fsDoc(path).set(data,{merge:true}).catch(e=>console.warn('fsSet',e));
}
function fsGet(path){
  if(!firebaseReady||!currentUserId)return Promise.resolve(null);
  return fsDoc(path).get().then(s=>s.exists?s.data():null).catch(()=>null);
}
function fsSetIn(coll,id,data){
  if(!firebaseReady||!currentUserId)return;
  fsColl(coll).doc(id).set(data,{merge:true}).catch(e=>console.warn('fsSetIn',e));
}
function fsDelFrom(coll,id){
  if(!firebaseReady||!currentUserId)return;
  fsColl(coll).doc(id).delete().catch(e=>console.warn('fsDelFrom',e));
}

// ── Shared group helpers (top-level collection, not under any user path) ──
function fsSharedGroupDoc(gid){ return db.collection('shared_groups').doc(gid); }
function fsSaveSharedGroup(gid){
  const g=groupsData[gid]; if(!g||!firebaseReady)return;
  const msgs=(g.messages||[]).slice(-200);
  fsSharedGroupDoc(gid).set({...g,messages:msgs,tasks:g.tasks||[],members:g.members||[],updatedAt:Date.now()},{merge:true})
    .catch(e=>console.warn('fsSaveSharedGroup',e));
  // Also record this group ID in the user's personal list so they reconnect after reload
  if(currentUserId){
    db.doc('users/'+currentUserId+'/meta/myGroups').get().then(s=>{
      const ids=s.exists?(s.data().ids||[]):[];
      if(!ids.includes(gid)){
        ids.push(gid);
        db.doc('users/'+currentUserId+'/meta/myGroups').set({ids},{merge:true}).catch(()=>{});
      }
    }).catch(()=>{});
  }
}
function listenToSharedGroups(groupIds){
  if(!firebaseReady||!groupIds||!groupIds.length)return;
  groupIds.forEach(gid=>{
    const unsub=db.collection('shared_groups').doc(gid).onSnapshot(snap=>{
      if(!snap.exists)return;
      const g=snap.data();
      if(!g||!g.id)return;
      groupsData[g.id]={...g};
      const gp=document.getElementById('groupsPanel');
      if(gp&&!gp.classList.contains('hidden')){
        renderGroupTabs();
        if(currentGroup===g.id) renderGroupChat(g.id);
      }
    },e=>console.warn('sharedGroup listener',gid,e));
    _unsubs.push(unsub);
  });
}

let _unsubs=[];
function stopSync(){ _unsubs.forEach(u=>{try{u();}catch(e){}}); _unsubs=[]; }

function startSync(){
  if(!firebaseReady||!currentUserId)return;
  stopSync();
  setSyncBadge('syncing');

  // ── profile/plan ──
  fsGet('meta/profile').then(d=>{
    if(!d)return;
    if(d.name)onUserSignedIn(d.name,d.email||null,d.photo||null);
    if(d.plan&&d.plan!=='free'){userPlan=d.plan;applyPlanUI();}
    if(d.occ){selectedOcc=d.occ;}
  });

  // ── calendar tasks (real-time) ──
  _unsubs.push(fsColl('tasks').onSnapshot(snap=>{
    const rebuilt={};
    const ae=[];
    snap.forEach(doc=>{
      const t=doc.data();
      if(!t.dateKey)return;
      if(!rebuilt[t.dateKey])rebuilt[t.dateKey]=[];
      rebuilt[t.dateKey].push({id:t.id,text:t.text,done:!!t.done});
      ae.push({id:t.id,name:t.text,date:t.dateLabel||t.dateKey,dateKey:t.dateKey,
        status:t.done?'Submitted':'Pending',score:t.score||'—',icon:t.icon||'📝'});
    });
    calTasks=rebuilt; activityEntries=ae;
    if(selectedDate)renderCalTasks();
    renderCalendar(); renderTaskPanel(); renderActivityPanel();
    setSyncBadge('synced');
  },e=>{ console.warn('tasks listener:',e); setSyncBadge('offline'); }));

  // ── group tasks (real-time) ──
  _unsubs.push(fsColl('groupTasks').onSnapshot(snap=>{
    groupTasksStore=[];
    snap.forEach(doc=>groupTasksStore.push(doc.data()));
    renderGroupTaskList();
    setSyncBadge('synced');
  },e=>console.warn('groupTasks listener:',e)));

  // ── activity extras (real-time) ──
  _unsubs.push(fsColl('activityExtra').onSnapshot(snap=>{
    snap.forEach(doc=>{
      const e=doc.data();
      if(!activityEntries.find(a=>a.id===e.id)) activityEntries.push(e);
      else { const i=activityEntries.findIndex(a=>a.id===e.id); if(i>=0) activityEntries[i]={...activityEntries[i],...e}; }
    });
    renderActivityPanel();
  },e=>console.warn('activityExtra listener:',e)));

  // ── groups (shared, real-time) ──
  // Load the user's group ID list, then listen to each shared group doc
  db.doc('users/'+currentUserId+'/meta/myGroups').get().then(s=>{
    const ids=s.exists?(s.data().ids||[]):[];
    // Also include any groups already in local memory (e.g. demo groups)
    const localIds=Object.keys(groupsData).filter(id=>id.startsWith('group_'));
    const allIds=[...new Set([...ids,...localIds])];
    listenToSharedGroups(allIds);
    // Migrate any existing local demo groups to shared path on first load
    localIds.forEach(gid=>{ if(!ids.includes(gid)) fsSaveSharedGroup(gid); });
  }).catch(()=>{
    // Fallback: just listen to whatever is already in groupsData
    const localIds=Object.keys(groupsData);
    listenToSharedGroups(localIds);
  });

  // ── library metadata (real-time) ──
  _unsubs.push(fsColl('library').onSnapshot(snap=>{
    libFiles=[];
    snap.forEach(doc=>{
      const m=doc.data();
      libFiles.push({id:m.id,name:m.name,type:m.type,mime:m.mime,
        size:m.size,bytes:m.bytes||0,date:m.date,data:m.cloudUrl||'',cloudUrl:m.cloudUrl||''});
    });
    renderLib(); updateLibStorageBar();
  },e=>console.warn('library listener:',e)));
}

// ── sync badge in top bar ──
function setSyncBadge(state){
  const dot=document.getElementById('syncDot');
  const lbl=document.getElementById('syncLabel');
  const wrap=document.getElementById('syncBadge');
  if(!wrap)return;
  const map={synced:['#5eead4','☁️ Synced'],syncing:['#fbbf24','⏳ Syncing...'],offline:['#f87171','⚠️ Offline']};
  const [col,text]=map[state]||map.synced;
  if(dot)dot.style.background=col;
  if(lbl)lbl.textContent=text;
  wrap.style.opacity='1';
  if(state==='synced') setTimeout(()=>{if(wrap)wrap.style.opacity='0';},3000);
}

// ── save helpers ──
function fsSaveTask(id,text,done,dateKey){
  if(!firebaseReady||!currentUserId)return;
  const[y,m,d]=dateKey.split('-');
  fsSetIn('tasks',id,{id,text,done:!!done,dateKey,dateLabel:'Due '+m+'/'+d+'/'+y,icon:'📝',score:'—',updatedAt:Date.now()});
}
function fsDelTask(id){ fsDelFrom('tasks',id); fsDelFrom('activityExtra',id); }
function fsSaveGroupTask(t){ fsSetIn('groupTasks',t.id,{...t,updatedAt:Date.now()}); }
function fsDelGroupTask(id){ fsDelFrom('groupTasks',id); }
function fsSaveExtra(e){ fsSetIn('activityExtra',e.id,{...e,updatedAt:Date.now()}); }
function fsDelExtra(id){ fsDelFrom('activityExtra',id); fsDelFrom('tasks',id); }
function fsSaveProfile(){
  if(!firebaseReady||!currentUserId)return;
  const name=document.getElementById('sidebarName')?.textContent||'Tracker';
  const email=document.getElementById('profileEmail')?.textContent||'';
  fsSet('meta/profile',{name,email,occ:selectedOcc||'Student',plan:userPlan,streak:currentStreak||0,updatedAt:Date.now()});
}
function fsSaveGroup(gid){
  fsSaveSharedGroup(gid);
}

// ===== GOOGLE IDENTITY SERVICES (GIS) SIGN-IN =====
const GOOGLE_CLIENT_ID = '731869460805-5h6iernb17fnpi59151be85jaq3cubc1.apps.googleusercontent.com';
// Parse the JWT credential returned by Google
function parseJwt(token){
  try{
    const base64Url=token.split('.')[1];
    const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');
    const json=decodeURIComponent(atob(base64).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(json);
  }catch(e){return null;}
}

// Called by GIS after the user picks a Google account
function handleGoogleCredential(response){
  document.getElementById('_gisOverlay').style.display = 'none';
  const payload = parseJwt(response.credential);
  if(!payload){showToast('❌ Google sign-in failed. Please try again.',3500);return;}
  const name  = payload.name  || payload.given_name || 'Tracker';
  const email = payload.email || '';
  const photo = payload.picture || null;
  localStorage.setItem('tc_google_user', JSON.stringify({name, email, photo}));
  onUserSignedIn(name, email, photo);
  closeLoginModal();
  if(!document.getElementById('landing').classList.contains('hidden')) goToApp();
  showToast('✅ Signed in as ' + name + '!', 3000);
  // Fire login notification
  setTimeout(()=>addNotification('login','✅','Signed In with Google',`Welcome back, ${name}! (${email})`),1200);
}

// Initialise GIS and render button directly on the landing page
function initGIS(){
  if(!window.google || !window.google.accounts) return false;
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleGoogleCredential,
    auto_select: false,
    cancel_on_tap_outside: true
  });
  // Render the real Google button directly into the landing page container
  const container = document.getElementById('googleSignInBtn');
  if(container){
    google.accounts.id.renderButton(container, {
      type: 'standard',
      theme: 'outline',
      size: 'large',
      text: 'continue_with',
      width: 280,
      logo_alignment: 'left'
    });
  }
  return true;
}
// Run immediately (script is synchronous) and again on window load as safety net
let _gisInited = initGIS();
window.addEventListener('load', ()=>{ if(!_gisInited) _gisInited = initGIS(); });

// signInWithGoogle kept for other buttons (login modal etc)
function signInWithGoogle(){
  if(!_gisInited) _gisInited = initGIS();
  if(!window.google || !window.google.accounts){
    showToast('⏳ Google Sign-In is still loading, please try again.',3000);
    return;
  }
  const container = document.getElementById('_gisButtonContainer');
  container.innerHTML = '';
  google.accounts.id.renderButton(container, {
    type: 'standard',
    theme: 'outline',
    size: 'large',
    text: 'signin_with',
    width: 280,
    logo_alignment: 'left'
  });
  document.getElementById('_gisOverlay').style.display = 'flex';
}

// Restore Google session on page reload
(function restoreGoogleSession(){
  const saved = localStorage.getItem('tc_google_user');
  if(saved){
    try{
      const u=JSON.parse(saved);
      // Will be applied once the app layout is ready (after goToApp)
      window._pendingGoogleUser = u;
    }catch(e){}
  }
})();

function simulateGoogleLogin(){onUserSignedIn('Demo Tracker','tracker@gmail.com',null);closeLoginModal();if(!document.getElementById('landing').classList.contains('hidden'))goToApp();}
function onUserSignedIn(name,email,photoURL){
  const n=name||'Tracker';
  document.getElementById('sidebarName').textContent=n;
  document.getElementById('profileNameDisplay').textContent=n;
  document.getElementById('profileNameVal').textContent=n;
  document.getElementById('profileEmail').textContent=email||'—';
  document.getElementById('editNameInput').value=n;
  document.getElementById('avatarNameInput').value=n;
  document.getElementById('googleLinkedStatus').textContent=email||'Linked';
  if(photoURL){
    ['avatarBtnInner','sidebarAvatarInner','profileAvatarInner'].forEach(id=>{
      const el=document.getElementById(id);
      if(el)el.outerHTML=`<img src="${photoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" id="${id}">`;
    });
  }
  // Set userId — always prefer email so same Gmail = same data on any device
  if(firebaseReady && (email||name)){
    currentUserId = email
      ? email.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase()
      : name.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase();
    startSync();
  }
}

// Apply a restored Google session once the app is visible
function applyPendingGoogleUser(){
  if(window._pendingGoogleUser){
    const u=window._pendingGoogleUser;
    delete window._pendingGoogleUser;
    onUserSignedIn(u.name,u.email,u.photo);
  }
}

// ===== AUDIO CONTEXT =====
let audioCtx=null;
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}

// ===== VOICE INTRO (expressive, human-like) =====
function speakIntro(){
  if(!window.speechSynthesis)return;
  const loadVoicesAndSpeak=()=>{
    const voices=speechSynthesis.getVoices();
    // Warmly excited female voice phrases
    const phrases=[
      {text:"Oh my goodness — welcome!",rate:1.05,pitch:1.35,volume:1},
      {text:"You've arrived at Track and Clock.",rate:0.9,pitch:1.2,volume:0.95},
      {text:"Your ultimate hub for staying on time, on task, and totally in control.",rate:0.92,pitch:1.15,volume:0.9},
      {text:"Let's make today amazing!",rate:1.1,pitch:1.3,volume:1},
    ];
    const femaleVoice=voices.find(v=>
      /samantha|karen|victoria|zira|google us|ava|susan|fiona/i.test(v.name)
    )||voices.find(v=>v.lang==='en-US')||voices[0];
    let delay=1200;
    phrases.forEach((p,i)=>{
      setTimeout(()=>{
        if(!speechSynthesis.speaking||i===0){
          const u=new SpeechSynthesisUtterance(p.text);
          u.rate=p.rate;u.pitch=p.pitch;u.volume=p.volume;
          if(femaleVoice)u.voice=femaleVoice;
          speechSynthesis.speak(u);
        }
      },delay);
      delay+=p.text.length*75;
    });
  };
  if(speechSynthesis.getVoices().length===0)speechSynthesis.addEventListener('voiceschanged',loadVoicesAndSpeak,{once:true});
  else loadVoicesAndSpeak();
}

// ===== TICK SOUNDS =====
function playTickSounds(){
  try{
    const ctx=getAudioCtx();
    // Realistic clock tick: sharp transient attack, quick decay
    for(let i=0;i<12;i++){
      const buf=ctx.createBuffer(1,ctx.sampleRate*0.06,ctx.sampleRate);
      const data=buf.getChannelData(0);
      for(let s=0;s<data.length;s++){
        data[s]=(Math.random()*2-1)*Math.exp(-s/(ctx.sampleRate*0.008));
      }
      const src=ctx.createBufferSource();
      const g=ctx.createGain();
      const filter=ctx.createBiquadFilter();
      filter.type='bandpass';filter.frequency.value=2200+(i%2)*800;filter.Q.value=2;
      src.buffer=buf;
      src.connect(filter);filter.connect(g);g.connect(ctx.destination);
      const t=ctx.currentTime+0.42+i*0.42;
      g.gain.setValueAtTime(i%2===0?0.28:0.18,t);
      src.start(t);
    }
    // Chime fanfare when brand appears
    const chordNotes=[523.25,659.25,783.99,1046.5];
    chordNotes.forEach((f,i)=>{
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(ctx.destination);
      o.type='sine';o.frequency.value=f;
      const t=ctx.currentTime+3.6+i*0.09;
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(0.18,t+0.08);
      g.gain.exponentialRampToValueAtTime(0.001,t+2.2);
      o.start(t);o.stop(t+2.3);
    });
  }catch(e){}
}

// ===== MUSIC PLAYER =====
let musicInterval=null,musicOn=false,musicVol=0.3,currentMood='calm';
const moodDefs={
  calm:{notes:[261.6,293.6,329.6,392,440,349.2],tempo:2.0,type:'sine',vol:0.055,label:'🌿 Calm — Gentle Rain'},
  focus:{notes:[220,246.9,261.6,293.6,329.6,311.1],tempo:1.3,type:'triangle',vol:0.048,label:'🎯 Focus — Lo-Fi Study'},
  energetic:{notes:[392,440,523.3,587.3,659.3,783.9],tempo:0.6,type:'sawtooth',vol:0.038,label:'⚡ Energetic — Upbeat'},
  cozy:{notes:[261.6,311.1,349.2,392,415.3,440],tempo:2.4,type:'sine',vol:0.052,label:'🧸 Cozy — Warm Tones'},
  nature:{notes:[196,220,246.9,261.6,293.6,220],tempo:2.8,type:'sine',vol:0.042,label:'🌳 Nature — Forest Calm'},
  off:{notes:[],tempo:1,type:'sine',vol:0,label:'🔇 Music Off'}
};
function startMusic(mood){
  stopMusic();
  const d=moodDefs[mood]||moodDefs.calm;
  document.getElementById('mpTrack').textContent=d.label;
  if(mood==='off'||!d.notes.length)return;
  try{
    const ctx=getAudioCtx();let ni=0;
    const play=()=>{
      if(!musicOn)return;
      const o=ctx.createOscillator(),g1=ctx.createGain(),g2=ctx.createGain();
      o.connect(g1);g1.connect(g2);g2.connect(ctx.destination);
      o.type=d.type;o.frequency.value=d.notes[ni%d.notes.length];ni++;
      g2.gain.value=d.vol*musicVol*3.5;
      const t=ctx.currentTime;
      g1.gain.setValueAtTime(0,t);g1.gain.linearRampToValueAtTime(1,t+0.18);
      g1.gain.linearRampToValueAtTime(0,t+d.tempo*0.88);
      o.start(t);o.stop(t+d.tempo);
    };
    play();musicInterval=setInterval(play,d.tempo*1000);
  }catch(e){}
}
function stopMusic(){if(musicInterval){clearInterval(musicInterval);musicInterval=null;}}
function toggleMusic(){
  musicOn=!musicOn;
  document.getElementById('mpPlayBtn').textContent=musicOn?'⏸':'▶';
  if(musicOn)startMusic(currentMood);else stopMusic();
}
function setMoodChip(mood,btn){
  currentMood=mood;
  document.querySelectorAll('.mp-mood-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  if(musicOn)startMusic(mood);else document.getElementById('mpTrack').textContent=(moodDefs[mood]||moodDefs.calm).label;
  // Stop YouTube if switching to generated music
  if(mood!=='off'){const a=document.getElementById('musicAudio');if(a){a.pause();a.src='';}document.getElementById('mpNowPlaying').classList.add('hidden');}
}
function setVolume(v){musicVol=parseFloat(v);if(musicOn){stopMusic();startMusic(currentMood);}const a=document.getElementById('musicAudio');if(a&&a.src)a.volume=musicVol;}
function toggleMiniPlayer(){
  const p=document.getElementById('musicPlayer');
  const f=document.getElementById('mpFull');
  const mini=p.classList.toggle('mini');
  f.style.display=mini?'none':'flex';
  document.getElementById('mpPlayBtn').parentElement.parentElement.style.display=mini?'none':'flex';
  document.querySelector('.mp-full').style.display=mini?'none':'flex';
}

// ===== YOUTUBE SONG SEARCH =====
// ===== JAMENDO MUSIC API =====
// ===== iTunes Search API — finds ANY famous song, free, no key needed =====
let musicQueue=[],musicQueueIdx=0;

// iTunes Search — uses JSONP callback (works from local file:// with no CORS issues)
function iTunesFetch(term, limit=8){
  return new Promise((resolve)=>{
    const cbName='itcb_'+Date.now()+'_'+Math.floor(Math.random()*9999);
    const script=document.createElement('script');
    let done=false;
    window[cbName]=function(data){
      done=true;
      delete window[cbName];
      script.remove();
      resolve(data.results||[]);
    };
    // iTunes supports JSONP via the callback param
    script.src='https://itunes.apple.com/search?term='+encodeURIComponent(term)
      +'&media=music&limit='+limit+'&entity=song&callback='+cbName;
    script.onerror=function(){
      if(!done){done=true;delete window[cbName];script.remove();resolve([]);}
    };
    // Timeout after 8s
    setTimeout(function(){
      if(!done){done=true;delete window[cbName];script.remove();resolve([]);}
    },8000);
    document.head.appendChild(script);
  });
}

async function searchMusic(){
  const q=document.getElementById('mpSearchInput').value.trim();
  if(!q)return;
  document.getElementById('mpResults').innerHTML='<div style="padding:8px;font-size:0.75rem;color:var(--mid);font-weight:600;">🔍 Searching…</div>';
  const results=await iTunesFetch(q);
  if(results.length){
    musicQueue=results;renderMusicResults(results);
  }else{
    document.getElementById('mpResults').innerHTML='<div style="padding:8px;font-size:0.75rem;color:var(--mid);font-weight:600;">No results. Check your connection and try again! 🎵</div>';
  }
}

async function searchGenre(genre,btn){
  document.querySelectorAll('.mp-genre-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('mpResults').innerHTML='<div style="padding:8px;font-size:0.75rem;color:var(--mid);font-weight:600;">🎵 Loading '+genre+' hits…</div>';
  // Search top songs for each genre using representative artists/terms
  const genreTerms={
    'pop':'top pop hits 2024','k-pop':'BTS blackpink kpop','r&b':'r&b soul 2024',
    'hip-hop':'hip hop rap 2024','lofi':'lofi chill beats study','classical':'classical piano orchestra'
  };
  const results=await iTunesFetch(genreTerms[genre]||genre, 10);
  if(results.length){
    musicQueue=results;renderMusicResults(results);
  }else{
    document.getElementById('mpResults').innerHTML='<div style="padding:8px;font-size:0.75rem;color:var(--mid);">Could not load. Check your internet connection.</div>';
  }
}

function renderMusicResults(tracks){
  const el=document.getElementById('mpResults');
  el.innerHTML='';
  tracks.forEach((t,i)=>{
    const item=document.createElement('div');item.className='mp-result-item';
    const art=t.artworkUrl60||'';
    const thumb=art
      ? `<img class="mp-result-thumb" src="${art.replace('60x60','100x100')}" onerror="this.style.background='var(--lilac)'">`
      : `<div class="mp-result-thumb" style="display:flex;align-items:center;justify-content:center;background:var(--lilac);font-size:1.1rem;">🎵</div>`;
    const dur=t.trackTimeMillis?Math.floor(t.trackTimeMillis/1000):0;
    const durStr=dur?Math.floor(dur/60)+':'+(dur%60<10?'0':'')+dur%60:'';
    item.innerHTML=`${thumb}<div class="mp-result-info"><div class="mp-result-title">${t.trackName||'Unknown'}</div><div class="mp-result-channel">${t.artistName||''} · ${t.collectionName||''}</div></div><div style="font-size:0.68rem;color:var(--mid);font-weight:700;flex-shrink:0;">${durStr}<br/>▶ 30s</div>`;
    item.onclick=()=>{musicQueueIdx=i;playTrack(t);};
    el.appendChild(item);
  });
}

function playTrack(track){
  stopMusic();musicOn=false;
  document.getElementById('mpPlayBtn').textContent='▶';
  const preview=track.previewUrl;
  if(!preview){showToast('No preview available for this track.',2200);return;}
  const audio=document.getElementById('musicAudio');
  audio.src=preview;audio.volume=musicVol;
  audio.play().catch(()=>showToast('Tap again to play — browser needs a click first.',2500));
  // Now playing bar
  const title=track.trackName||'Unknown';
  const artist=track.artistName||'';
  const art=track.artworkUrl100||(track.artworkUrl60||'').replace('60x60','100x100');
  document.getElementById('mpNpTitle').textContent=title;
  document.getElementById('mpNpArtist').textContent=artist;
  const artEl=document.getElementById('mpNpArt');
  if(art){artEl.src=art;artEl.style.display='block';}else{artEl.style.display='none';}
  document.getElementById('mpNowPlaying').classList.remove('hidden');
  document.getElementById('mpTrack').textContent=(title+' — '+artist).slice(0,36)+'…';
  document.getElementById('mpResults').innerHTML='';
  document.getElementById('mpSearchInput').value='';
  showToast('🎵 '+title+' — '+artist,2200);
}

function stopMusic2(){
  const audio=document.getElementById('musicAudio');
  if(audio){audio.pause();audio.src='';}
  document.getElementById('mpNowPlaying').classList.add('hidden');
  document.getElementById('mpTrack').textContent='Search a song or artist 🎵';
}

function onTrackEnded(){
  if(musicQueue.length>1){
    musicQueueIdx=(musicQueueIdx+1)%musicQueue.length;
    playTrack(musicQueue[musicQueueIdx]);
  }else{
    document.getElementById('mpNowPlaying').classList.add('hidden');
    document.getElementById('mpTrack').textContent='Search a song or artist 🎵';
  }
}

// ===== INTRO — auto-redirect after animation =====================
function goToLanding(){
  var intro=document.getElementById('introScreen');
  var landing=document.getElementById('landing');
  if(!intro||!landing)return;
  if(intro.classList.contains('gone'))return;
  intro.classList.add('gone');
  landing.classList.remove('hidden');
  var mp=document.getElementById('musicPlayer');
  var bell=document.getElementById('notifBellBtn');
  if(mp){mp.classList.remove('intro-hidden');}
  if(bell){bell.classList.remove('intro-hidden');}
}
// Run intro logic as soon as DOM is ready — don't wait for full page load
(function initIntro(){
  function run(){
    var intro=document.getElementById('introScreen');
    if(!intro){ setTimeout(run,50); return; }
    // Hide music/bell during intro
    var mp=document.getElementById('musicPlayer');
    var bell=document.getElementById('notifBellBtn');
    if(mp)mp.classList.add('intro-hidden');
    if(bell)bell.classList.add('intro-hidden');
    // Tap/click anywhere to skip
    intro.addEventListener('click', goToLanding);
    intro.addEventListener('touchend', function(e){ e.preventDefault(); goToLanding(); });
    // Mobile: short delay; Desktop: longer
    var delay = window.innerWidth <= 768 ? 3500 : 7000;
    setTimeout(goToLanding, delay);
    // Shorten "tap to skip" on mobile
    if(window.innerWidth<=768){
      var skip=document.getElementById('tapToSkip');
      if(skip) skip.style.animation='fadeUp 0.5s 1.8s ease both';
    }
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();

// ===== OCCUPATION =====
let selectedOcc='Student';
const occItems={
  Student:['📓','✏️','📐','🎒','📚','✏️','📝','🖊️'],
  Teacher:['🏫','📋','📏','🖊️','🔭','📌','🎓','📖'],
  'Office Worker':['💼','☕','💻','📊','📎','🖥️','📁','⌨️'],
  Organizer:['📋','🗂️','📌','🗓️','✅','🗃️','📊','🖊️'],
  Freelancer:['💻','🎧','☕','📱','💡','🖥️','⚡','🌐'],
  Creator:['🎨','✏️','🎬','🎤','🖌️','📷','🎭','🌈'],
  Healthcare:['🏥','💊','🩺','❤️','💉','🧬','🌡️','🩹'],
  Other:['✨','💫','🌟','⭐','🎯','🔑','🌈','💎'],
};

function pickOcc(occ,btn){
  selectedOcc=occ;
  document.querySelectorAll('.occ-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  spawnOccItems(occ,btn);
}
function spawnOccItems(occ,btn){
  occFloatEls.forEach(function(el){el.remove();});occFloatEls=[];
  // Skip floating elements entirely on mobile — too heavy
  if(window.innerWidth<=768) return;
  var container=document.getElementById('occFloatWrap');
  var icons=occItems[occ]||occItems.Other;
  var W=window.innerWidth, H=window.innerHeight;
  // Edge-only safe zones: 16 zones around the perimeter, away from center content
  var zones=[
    {x:[0.01,0.14],y:[0.03,0.20]},{x:[0.01,0.14],y:[0.22,0.42]},
    {x:[0.01,0.14],y:[0.55,0.75]},{x:[0.01,0.14],y:[0.78,0.95]},
    {x:[0.85,0.98],y:[0.03,0.20]},{x:[0.85,0.98],y:[0.22,0.42]},
    {x:[0.85,0.98],y:[0.55,0.75]},{x:[0.85,0.98],y:[0.78,0.95]},
    {x:[0.18,0.38],y:[0.02,0.12]},{x:[0.42,0.58],y:[0.02,0.12]},
    {x:[0.62,0.82],y:[0.02,0.12]},{x:[0.18,0.38],y:[0.88,0.97]},
    {x:[0.42,0.58],y:[0.88,0.97]},{x:[0.62,0.82],y:[0.88,0.97]},
    {x:[0.02,0.18],y:[0.44,0.54]},{x:[0.82,0.98],y:[0.44,0.54]}
  ];
  // Shuffle zones
  for(var i=zones.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=zones[i];zones[i]=zones[j];zones[j]=tmp;}
  // 2 copies per icon placed in separate zones
  icons.forEach(function(icon,ii){
    for(var copy=0;copy<2;copy++){
      var zone=zones[(ii*2+copy)%zones.length];
      var px=(zone.x[0]+Math.random()*(zone.x[1]-zone.x[0]))*W;
      var py=(zone.y[0]+Math.random()*(zone.y[1]-zone.y[0]))*H;
      var size=(1.8+Math.random()*1.2);
      var delay=(ii*2+copy)*0.08;
      var el=document.createElement('div');
      el.textContent=icon;
      el.style.cssText='position:absolute;left:'+px+'px;top:'+py+'px;font-size:'+size+'rem;opacity:0;pointer-events:none;z-index:1;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.10));';
      container.appendChild(el);
      occFloatEls.push(el);
      // Animate in then bobble
      (function(elem, d){
        setTimeout(function(){
          elem.style.transition='opacity 0.4s, transform 0.5s';
          elem.style.opacity='0.65';
          elem.style.transform='translateY(-8px) scale(1.05)';
          setTimeout(function(){
            elem.style.transition='';
            elem.style.transform='';
            // Bobble via keyframe-like loop
            var up=true;
            setInterval(function(){
              elem.style.transition='transform '+(1.5+Math.random())+'s ease-in-out';
              elem.style.transform=up?'translateY(-'+(6+Math.random()*6)+'px) rotate('+(Math.random()*6-3)+'deg)':'translateY(0) rotate(0deg)';
              up=!up;
            },2000+Math.random()*1500);
          },500);
        }, d*1000);
      })(el, delay);
    }
  });
}

// ===== NAV =====
function goToApp(){
  // Hide landing completely
  const landing=document.getElementById('landing');
  landing.classList.add('hidden');
  landing.style.display='none';
  // Clear all floating items
  occFloatEls.forEach(el=>el.remove());occFloatEls=[];
  document.getElementById('occFloatWrap').innerHTML='';
  // Show app
  const app=document.getElementById('appLayout');
  app.classList.remove('hidden');
  app.style.display='flex';
  app.style.opacity='1';
  app.style.pointerEvents='all';
  // Update occupation displays
  document.getElementById('sidebarOcc').textContent=selectedOcc;
  document.getElementById('profileOccDisplay').textContent=selectedOcc+' · Active Member';
  document.getElementById('profileOccVal').textContent=selectedOcc;
  renderCalendar();
  initStreak();
  // Apply restored Google session if any
  applyPendingGoogleUser();
  // Handle invite link from URL params
  handleInviteLink();
}
function openFP(id){
  document.querySelectorAll('.full-panel').forEach(p=>p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='calPanel')renderCalendar();
  if(id==='libraryPanel'){applyLibraryGate();renderLib();}
  if(id==='groupsPanel')initGroupsPanel();
  if(id==='taskPanel'){renderTaskPanel();renderGroupTaskList();}
  if(id==='actPanel')renderActivityPanel();
}
function closeFP(id){document.getElementById(id).classList.add('hidden');}
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  if(window.innerWidth<=768){
    const isOpen=sb.classList.toggle('mobile-open');
    if(ov){ov.classList.toggle('show',isOpen);}
  } else {
    sb.classList.toggle('sidebar-hidden');
  }
}
function closeSidebarMobile(){
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  sb.classList.remove('mobile-open');
  if(ov)ov.classList.remove('show');
}
function setActiveNav(el){document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}

// ===== UNIFIED TASK SYSTEM =====
let _taskSeq = 1;
function _tid() { return 't'+(++_taskSeq); }
const TASK_ICONS = ['📝','🎨','📊','💻','📚','🔬','🎯','✏️','📐','🖥️','📋','🏆'];
let activityEntries = []; // {id, name, date, dateKey, status, score, icon}
let groupTasksStore = []; // {id, name, status}
let _editingScoreId = null;
let _libActivated = false; // free trial activated?
let _libMaxBytes = 1024*1024*1024; // 1GB default (free trial)

// ===== CALENDAR =====
let calDate=new Date(),selectedDate=null,calTasks={};
function renderCalendar(){
  const y=calDate.getFullYear(),m=calDate.getMonth();
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthLabel').textContent=months[m]+' '+y;
  const today=new Date(),grid=document.getElementById('calGrid');
  grid.innerHTML='';
  ['S','M','T','W','T','F','S'].forEach(d=>{const el=document.createElement('div');el.className='cal-day-name';el.textContent=d;grid.appendChild(el);});
  const firstDay=new Date(y,m,1).getDay(),daysInMonth=new Date(y,m+1,0).getDate(),prevDays=new Date(y,m,0).getDate();
  for(let i=0;i<firstDay;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=prevDays-firstDay+1+i;grid.appendChild(d);}
  for(let day=1;day<=daysInMonth;day++){
    const d=document.createElement('div');d.className='cal-day';d.textContent=day;
    const key=`${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    if(today.getFullYear()===y&&today.getMonth()===m&&today.getDate()===day)d.classList.add('today');
    if(calTasks[key]&&calTasks[key].length)d.classList.add('has-task');
    if(selectedDate===key)d.classList.add('selected');
    d.onclick=()=>selectDate(key);
    grid.appendChild(d);
  }
  const rem=(firstDay+daysInMonth)%7===0?0:7-(firstDay+daysInMonth)%7;
  for(let i=1;i<=rem;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=i;grid.appendChild(d);}
}
function changeMonth(dir){calDate.setMonth(calDate.getMonth()+dir);renderCalendar();}
function selectDate(key){
  selectedDate=key;const[y,m,d]=key.split('-');
  document.getElementById('taskPanelTitle').textContent=`Tasks for ${m}/${d}/${y}`;
  document.getElementById('taskInputRow').style.display='flex';
  renderCalTasks();renderCalendar();
}
function renderCalTasks(){
  if(!selectedDate)return;
  const list=document.getElementById('calTaskList');list.innerHTML='';
  const tasks=calTasks[selectedDate]||[];
  if(!tasks.length){list.innerHTML='<div style="color:var(--text-mid-theme);font-size:0.88rem;padding:6px 0;font-weight:600;">No tasks yet — add one above! 📌</div>';return;}
  tasks.forEach((t,i)=>{
    const el=document.createElement('div');el.className='task-item';
    el.innerHTML=`<input type="checkbox" ${t.done?'checked':''} onchange="toggleCalTask(${i})"/><span class="${t.done?'done':''}">${t.text}</span><button class="del-btn" onclick="delCalTask(${i})">✕</button>`;
    list.appendChild(el);
  });
}
function addCalTask(){
  if(!selectedDate)return;
  const inp=document.getElementById('calTaskInput');
  const v=inp.value.trim();if(!v)return;
  const id=_tid();
  if(!calTasks[selectedDate])calTasks[selectedDate]=[];
  calTasks[selectedDate].push({id,text:v,done:false});
  inp.value='';
  // Sync → activity
  const[y,m,d]=selectedDate.split('-');
  activityEntries.push({id,name:v,date:`Due ${m}/${d}/${y}`,dateKey:selectedDate,status:'Pending',score:'—',icon:TASK_ICONS[activityEntries.length%TASK_ICONS.length]});
  fsSaveTask(id,v,false,selectedDate);
  renderCalTasks();renderCalendar();
  _refreshTaskActivity();
  showToast('📌 Task added to Calendar, Tasks & Activity!',1800);
}
function toggleCalTask(i){
  const t=calTasks[selectedDate][i]; t.done=!t.done;
  const entry=activityEntries.find(e=>e.id===t.id);
  if(entry)entry.status=t.done?'Submitted':'Pending';
  fsSaveTask(t.id,t.text,t.done,selectedDate);
  renderCalTasks();_refreshTaskActivity();
}
function delCalTask(i){
  const t=calTasks[selectedDate][i];
  activityEntries=activityEntries.filter(e=>e.id!==t.id);
  fsDelTask(t.id);
  calTasks[selectedDate].splice(i,1);
  if(!calTasks[selectedDate].length)delete calTasks[selectedDate];
  renderCalTasks();renderCalendar();_refreshTaskActivity();
}
function _refreshTaskActivity(){renderTaskPanel();renderActivityPanel();}

// ===== TASK PANEL — synced view =====
function renderTaskPanel(){
  const list=document.getElementById('taskPanelList');if(!list)return;
  const filter=(document.getElementById('taskFilterStatus')||{}).value||'all';
  let all=[];
  Object.entries(calTasks).forEach(([key,tasks])=>tasks.forEach((t,i)=>all.push({...t,dateKey:key,calIdx:i})));
  if(filter==='pending')all=all.filter(t=>!t.done);
  if(filter==='done')all=all.filter(t=>t.done);
  all.sort((a,b)=>a.dateKey.localeCompare(b.dateKey));
  if(!all.length){list.innerHTML='<div style="color:var(--mid);font-size:0.88rem;font-weight:600;text-align:center;padding:18px 0;">No tasks found 📭</div>';return;}
  list.innerHTML='';
  all.forEach(t=>{
    const[y,mo,d]=t.dateKey.split('-');
    const el=document.createElement('div');el.className='task-item';el.style.flexWrap='wrap';el.style.gap='6px';
    el.innerHTML=`<input type="checkbox" ${t.done?'checked':''} onchange="toggleTaskPanel('${t.dateKey}',${t.calIdx})"/>
      <span style="flex:1;min-width:100px;" class="${t.done?'done':''}">${t.text}</span>
      <span style="font-size:0.72rem;color:var(--mid);font-weight:700;">${mo}/${d}/${y}</span>
      <span class="gtask-badge ${t.done?'done':'pending'}">${t.done?'Done':'Pending'}</span>
      <button class="del-btn" onclick="delTaskPanel('${t.dateKey}',${t.calIdx})">✕</button>`;
    list.appendChild(el);
  });
}
function toggleTaskPanel(dateKey,idx){
  if(!calTasks[dateKey]||!calTasks[dateKey][idx])return;
  const t=calTasks[dateKey][idx];t.done=!t.done;
  const entry=activityEntries.find(e=>e.id===t.id);
  if(entry)entry.status=t.done?'Submitted':'Pending';
  fsSaveTask(t.id,t.text,t.done,dateKey);
  if(dateKey===selectedDate)renderCalTasks();
  renderCalendar();_refreshTaskActivity();
}
function delTaskPanel(dateKey,idx){
  if(!calTasks[dateKey]||!calTasks[dateKey][idx])return;
  const t=calTasks[dateKey][idx];
  activityEntries=activityEntries.filter(e=>e.id!==t.id);
  fsDelTask(t.id);
  calTasks[dateKey].splice(idx,1);
  if(!calTasks[dateKey].length)delete calTasks[dateKey];
  if(dateKey===selectedDate)renderCalTasks();
  renderCalendar();_refreshTaskActivity();
}

// ===== GROUP TASKS — editable =====
function renderGroupTaskList(){
  const list=document.getElementById('groupTaskList');if(!list)return;
  if(!groupTasksStore.length){
    list.innerHTML='<div style="color:var(--mid);font-size:0.85rem;font-weight:600;padding:8px 0;">No tasks yet!</div>';return;
  }
  list.innerHTML='';
  groupTasksStore.forEach((t,i)=>{
    const el=document.createElement('div');el.className='gtask-item';el.style.gap='7px';
    el.innerHTML=`<span style="flex:1;font-weight:700;font-size:0.9rem;">${t.name}</span>
      <select onchange="editGroupTaskStatus(${i},this.value)" style="padding:4px 7px;border-radius:8px;border:1.5px solid rgba(200,180,240,0.4);background:rgba(255,255,255,0.8);font-size:0.77rem;color:var(--dark);outline:none;font-family:'Quicksand',sans-serif;">
        <option value="pending" ${t.status==='pending'?'selected':''}>Pending</option>
        <option value="done" ${t.status==='done'?'selected':''}>Done</option>
        <option value="late" ${t.status==='late'?'selected':''}>Late</option>
      </select>
      <button onclick="delGroupTask(${i})" style="background:none;border:none;color:#d0a0c0;cursor:pointer;font-size:0.88rem;">✕</button>`;
    list.appendChild(el);
  });
}
function addGroupTask(){
  const inp=document.getElementById('gtaskInput');
  const statusEl=document.getElementById('gtaskStatus');
  const v=inp.value.trim();if(!v)return;
  const id=_tid();const status=statusEl?statusEl.value:'pending';
  const _newgt={id,name:v,status};
  groupTasksStore.push(_newgt);
  fsSaveGroupTask(_newgt);
  inp.value='';
  // Sync to activity
  activityEntries.push({id:_tid(),name:v+' (Group)',date:'Group Task',dateKey:null,status:status==='done'?'Submitted':'Pending',score:'—',icon:'👥'});
  renderGroupTaskList();renderActivityPanel();
}
function editGroupTaskStatus(i,status){groupTasksStore[i].status=status;fsSaveGroupTask(groupTasksStore[i]);}
function delGroupTask(i){const _gt=groupTasksStore[i];fsDelGroupTask(_gt.id);groupTasksStore.splice(i,1);renderGroupTaskList();}

// ===== ACTIVITY PANEL =====
function renderActivityPanel(){
  const list=document.getElementById('activityList');if(!list)return;
  if(!activityEntries.length){list.innerHTML='<div style="color:var(--mid);font-size:0.88rem;font-weight:600;text-align:center;padding:22px 0;">No activity yet — add a calendar task or click "+ Add Entry" 📊</div>';updateOverallScore();return;}
  const iconBgs=['#f0e8ff','#e0f8e8','#fff0e0','#e8f0ff','#fef3c7','#ffd6e0'];
  list.innerHTML='';
  activityEntries.forEach((entry,i)=>{
    const el=document.createElement('div');el.className='act-item';el.style.flexWrap='wrap';el.style.alignItems='flex-start';
    el.innerHTML=`<div class="act-icon" style="background:${iconBgs[i%iconBgs.length]};flex-shrink:0;">${entry.icon||'📝'}</div>
      <div class="act-info" style="flex:1;min-width:110px;">
        <div class="act-name">${entry.name} <button onclick="editActivityEntry('${entry.id}')" style="background:none;border:none;cursor:pointer;font-size:0.72rem;color:var(--mid);" title="Edit">✏️</button></div>
        <div class="act-date">${entry.date} · ${entry.status}</div>
      </div>
      <div style="display:flex;align-items:center;gap:5px;flex-shrink:0;">
        <div class="act-score">${entry.score}</div>
        <button onclick="delActivityEntry('${entry.id}')" style="background:none;border:none;cursor:pointer;font-size:0.82rem;color:#d0a0c0;" title="Delete">✕</button>
      </div>`;
    list.appendChild(el);
  });
  updateOverallScore();
}
function updateOverallScore(){
  const el=document.getElementById('overallScore');if(!el)return;
  if(document.getElementById('scorePrivate').checked){el.textContent='🔒';return;}
  const scored=activityEntries.filter(e=>e.score&&e.score!=='—');
  if(!scored.length){el.textContent='—';return;}
  let total=0,count=0;
  scored.forEach(e=>{const m=String(e.score).match(/(\d+)/);if(m){total+=parseInt(m[1]);count++;}});
  el.textContent=count?Math.round(total/count):'—';
}
function togglePrivate(){updateOverallScore();}
function openAddScoreModal(){
  _editingScoreId=null;
  document.getElementById('scoreModalTitle').textContent='➕ Add Activity Entry';
  document.getElementById('scoreTaskName').value='';
  document.getElementById('scoreTaskDate').value='';
  document.getElementById('scoreTaskStatus').value='Pending';
  document.getElementById('scoreTaskScore').value='';
  document.getElementById('addScoreModal').classList.remove('hidden');
}
function closeAddScoreModal(){document.getElementById('addScoreModal').classList.add('hidden');}
function editActivityEntry(id){
  const entry=activityEntries.find(e=>e.id===id);if(!entry)return;
  _editingScoreId=id;
  document.getElementById('scoreModalTitle').textContent='✏️ Edit Activity Entry';
  document.getElementById('scoreTaskName').value=entry.name;
  document.getElementById('scoreTaskDate').value=entry.dateKey||'';
  document.getElementById('scoreTaskStatus').value=entry.status||'Pending';
  document.getElementById('scoreTaskScore').value=entry.score==='—'?'':entry.score;
  document.getElementById('addScoreModal').classList.remove('hidden');
}
function delActivityEntry(id){
  const entry=activityEntries.find(e=>e.id===id);
  if(entry&&entry.dateKey&&calTasks[entry.dateKey]){
    calTasks[entry.dateKey]=calTasks[entry.dateKey].filter(t=>t.id!==id);
    if(!calTasks[entry.dateKey].length)delete calTasks[entry.dateKey];
    if(selectedDate===entry.dateKey)renderCalTasks();
    renderCalendar();renderTaskPanel();
  }
  fsDelExtra(id);
  activityEntries=activityEntries.filter(e=>e.id!==id);
  renderActivityPanel();
}
function saveScoreEntry(){
  const name=document.getElementById('scoreTaskName').value.trim();
  if(!name){showToast('⚠️ Please enter a task name.',2000);return;}
  const dateVal=document.getElementById('scoreTaskDate').value;
  const status=document.getElementById('scoreTaskStatus').value;
  const score=document.getElementById('scoreTaskScore').value.trim()||'—';
  if(_editingScoreId){
    const entry=activityEntries.find(e=>e.id===_editingScoreId);
    if(entry){
      entry.name=name;entry.status=status;entry.score=score;
      if(dateVal){const[y,m,d]=dateVal.split('-');entry.date=`Due ${m}/${d}/${y}`;entry.dateKey=dateVal;}
      // Sync to cal task if linked
      if(entry.dateKey&&calTasks[entry.dateKey]){
        const ct=calTasks[entry.dateKey].find(t=>t.id===_editingScoreId);
        if(ct){ct.text=name;ct.done=status==='Submitted';}
        if(selectedDate===entry.dateKey)renderCalTasks();
        renderCalendar();renderTaskPanel();
      }
    }
  } else {
    const id=_tid();
    let dateStr='Manual entry',dk=null;
    if(dateVal){const[y,m,d]=dateVal.split('-');dateStr=`Due ${m}/${d}/${y}`;dk=dateVal;}
    activityEntries.push({id,name,date:dateStr,dateKey:dk,status,score,icon:TASK_ICONS[activityEntries.length%TASK_ICONS.length]});
    if(dk){
      if(!calTasks[dk])calTasks[dk]=[];
      calTasks[dk].push({id,text:name,done:status==='Submitted'});
      if(selectedDate===dk)renderCalTasks();
      renderCalendar();renderTaskPanel();
    }
  }
  closeAddScoreModal();renderActivityPanel();
  if(_editingScoreId){const _e=activityEntries.find(x=>x.id===_editingScoreId);if(_e)fsSaveExtra(_e);}
  else if(activityEntries.length){fsSaveExtra(activityEntries[activityEntries.length-1]);}
  showToast('✅ Entry saved!',1800);
}

// ===== LIBRARY GATE (free trial / pro) =====
function applyLibraryGate(){
  const gate=document.getElementById('libGate');
  const content=document.getElementById('libContent');
  if(!gate||!content)return;
  const proUnlocked=typeof userPlan!=='undefined'&&(userPlan==='pro'||userPlan==='team');
  if(_libActivated||proUnlocked){
    gate.style.display='none';content.style.display='block';
    _libMaxBytes=proUnlocked?5*1024*1024*1024:1024*1024*1024;
    const subEl=document.getElementById('libUploadSub');
    if(subEl)subEl.textContent=proUnlocked?'Images, Videos, Audio · 5GB Pro':'Images, Videos, Audio · 1GB Free Trial';
    updateLibStorageBar();
  } else {gate.style.display='flex';content.style.display='none';}
}
function activateLibrary(){
  _libActivated=true;
  showToast('🎉 Library unlocked! 1GB free storage ready.',2500);
  applyLibraryGate();renderLib();
}
function updateLibStorageBar(){
  const totalBytes=libFiles.reduce((s,f)=>s+(f.bytes||0),0);
  const pct=Math.min((totalBytes/_libMaxBytes)*100,100);
  const fill=document.getElementById('libStorageFill');
  const label=document.getElementById('libStorageLabel');
  if(fill)fill.style.width=pct+'%';
  if(label){
    const used=totalBytes<1024*1024?(totalBytes/1024).toFixed(0)+' KB':(totalBytes/(1024*1024)).toFixed(1)+' MB';
    const max=_libMaxBytes>2e9?'5 GB':'1 GB';
    label.textContent=`${used} / ${max}`;
  }
  if(fill)fill.style.background=pct>85?'linear-gradient(90deg,#f59e0b,#ef4444)':'linear-gradient(90deg,#8b5cf6,#5eead4)';
}

// ===== CHAT =====
function sendMsg(){const inp=document.getElementById('msgInput');const v=inp.value.trim();if(!v)return;const myName=document.getElementById('sidebarName')?.textContent||'You';const c=document.getElementById('chatArea');const el=document.createElement('div');el.className='msg me';el.innerHTML=`<div class="sender">${myName}</div>${v}`;c.appendChild(el);c.scrollTop=c.scrollHeight;inp.value='';}
// ===== GROUPS SYSTEM =====
// Group data store
let groupsData = {
  english: {
    id:'english', name:'English Group', dot:'#a78bfa',
    accentBg:'rgba(167,139,250,0.2)', accentColor:'#7c3aed',
    emoji:'📘',
    members:[
      {name:'You', emoji:'🌟', isMe:true},
      {name:'Lia', emoji:'🌸'},
      {name:'Marco', emoji:'🦁'},
      {name:'Jake', emoji:'📚'}
    ],
    messages:[
      {sender:'Lia 🌸', me:false, text:'Did everyone read chapter 5?'},
      {sender:'You', me:true, text:'Yes! Ready for discussion 📚'},
      {sender:'Marco 🦁', me:false, text:'Almost done, 10 mins!'}
    ],
    tasks:[
      {name:'Arrange seating', meta:'Maria · 21/02/26'},
      {name:'Submit essay draft', meta:'Jake · 22/02/26'},
      {name:'Chapter summary', meta:'All members · 23/02/26'}
    ]
  },
  math: {
    id:'math', name:'Math Group', dot:'#5eead4',
    accentBg:'rgba(94,234,212,0.2)', accentColor:'#0d9488',
    emoji:'📗',
    members:[
      {name:'You', emoji:'🌟', isMe:true},
      {name:'Sam', emoji:'🐸'},
      {name:'Leo', emoji:'🦊'},
      {name:'Mia', emoji:'⭐'},
      {name:'Chris', emoji:'🔢'}
    ],
    messages:[
      {sender:'Sam 🐸', me:false, text:'Problem set 4 is tricky 😅'},
      {sender:'You', me:true, text:'Let me share my notes!'},
      {sender:'Leo 🦊', me:false, text:'Thanks! Can we meet Thursday?'}
    ],
    tasks:[
      {name:'Problem set #4', meta:'Sam · 20/02/26'},
      {name:'Graph the functions', meta:'Leo · 21/02/26'}
    ]
  },
  science: {
    id:'science', name:'Science Group', dot:'#f9a8d4',
    accentBg:'rgba(249,168,212,0.2)', accentColor:'#be185d',
    emoji:'🔬',
    members:[
      {name:'You', emoji:'🌟', isMe:true},
      {name:'Alex', emoji:'🧪'},
      {name:'Jordan', emoji:'🌿'}
    ],
    messages:[
      {sender:'Alex 🧪', me:false, text:'Lab report deadline is Friday!'},
      {sender:'You', me:true, text:'Already started mine 🧬'},
      {sender:'Jordan 🌿', me:false, text:'Can we split the sections?'}
    ],
    tasks:[
      {name:'Lab report write-up', meta:'All members · 25/02/26'}
    ]
  }
};

let currentGroup = 'english';

function renderGroupTabs() {
  const container = document.getElementById('groupTabList');
  if (!container) return;
  container.innerHTML = '';
  Object.values(groupsData).forEach(g => {
    const div = document.createElement('div');
    div.className = 'group-tab' + (g.id === currentGroup ? ' active' : '');
    div.setAttribute('data-gid', g.id);
    div.innerHTML = `
      <div class="g-dot" style="background:${g.dot};"></div>
      <div style="flex:1">
        <div class="g-name">${g.name}</div>
        <div class="g-count">${g.members.length} member${g.members.length!==1?'s':''}</div>
      </div>
      <span style="font-size:0.72rem;background:${g.accentBg};color:${g.accentColor};padding:3px 9px;border-radius:18px;font-weight:800;">${g.tasks.length} task${g.tasks.length!==1?'s':''}</span>
    `;
    div.onclick = () => switchGroup(g.id, div);
    container.appendChild(div);
  });
}

function renderGroupChat(gid) {
  const g = groupsData[gid];
  if (!g) return;
  // Title
  document.getElementById('groupChatTitle').textContent = '💬 ' + g.name + ' Chat';
  // Members row
  const mRow = document.getElementById('groupMembersRow');
  mRow.innerHTML = '';
  g.members.forEach(m => {
    const chip = document.createElement('span');
    chip.className = 'member-chip';
    chip.innerHTML = `<span class="member-dot"></span>${m.emoji} ${m.name}${m.isMe?' <span style="font-size:0.65rem;color:var(--mid);">(you)</span>':''}`;
    mRow.appendChild(chip);
  });
  // Messages — determine me vs other using senderId compared to currentUserId
  const chatArea = document.getElementById('groupChatArea');
  // Remember if user was already at the bottom before re-render
  const wasAtBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 60;
  chatArea.innerHTML = '';
  g.messages.forEach(msg => {
    const el = document.createElement('div');
    // Use senderId if present (new messages), fall back to legacy me flag
    const isMe = msg.senderId ? msg.senderId === currentUserId : !!msg.me;
    el.className = 'msg ' + (msg.system ? 'system' : isMe ? 'me' : 'other');
    el.innerHTML = msg.system ? msg.text : `<div class="sender">${msg.sender}</div>${msg.text}`;
    chatArea.appendChild(el);
  });
  if (wasAtBottom) chatArea.scrollTop = chatArea.scrollHeight;
  // Tasks side panel
  renderAllGroupTasks();
}

function renderAllGroupTasks() {
  const display = document.getElementById('groupTasksDisplay');
  if (!display) return;
  display.innerHTML = '';
  Object.values(groupsData).forEach(g => {
    const card = document.createElement('div');
    card.className = 'g-task-card';
    const taskRows = g.tasks.map((t,ti) => `
      <div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid rgba(200,180,240,0.14);">
        <div style="flex:1"><div class="g-task-name">${t.name}</div><div class="g-task-meta">${t.meta||''}</div></div>
        <button onclick="delGroupChatTask('${g.id}',${ti})" style="background:none;border:none;cursor:pointer;color:#d0a0c0;font-size:0.8rem;flex-shrink:0;" title="Remove">✕</button>
      </div>`).join('');
    card.innerHTML = `<div class="g-task-title" style="color:${g.accentColor};display:flex;justify-content:space-between;">
      <span>${g.emoji} ${g.name}</span><span style="font-size:0.7rem;color:var(--mid);font-weight:600;">${g.tasks.length} task${g.tasks.length!==1?'s':''}</span></div>
      ${taskRows||'<div style="color:var(--mid);font-size:0.8rem;padding:6px 0;">No tasks yet</div>'}
      <div style="display:flex;gap:5px;margin-top:8px;">
        <input class="task-input" id="gInp_${g.id}" placeholder="Add task..." style="font-size:0.8rem;padding:7px 9px;" onkeydown="if(event.key==='Enter')addGroupChatTask('${g.id}')"/>
        <button class="add-btn" onclick="addGroupChatTask('${g.id}')" style="font-size:0.78rem;padding:7px 11px;">+</button>
      </div>`;
    display.appendChild(card);
  });
}
function addGroupChatTask(gid){
  const g=groupsData[gid];if(!g)return;
  const inp=document.getElementById('gInp_'+gid);
  const v=inp?inp.value.trim():'';if(!v)return;
  const myName=document.getElementById('sidebarName')?.textContent||'You';
  const today=new Date();
  g.tasks.push({id:'gct_'+Date.now(),name:v,meta:`${myName} · ${today.getDate()}/${today.getMonth()+1}/${String(today.getFullYear()).slice(-2)}`});
  g.messages.push({sender:'Track & Clock',me:false,system:true,text:`📋 <b>${myName}</b> added task: "${v}"`});
  inp.value='';
  renderAllGroupTasks();
  if(currentGroup===gid)renderGroupChat(gid);
}
function delGroupChatTask(gid,idx){
  const g=groupsData[gid];if(!g)return;
  const task=g.tasks[idx];
  g.tasks.splice(idx,1);
  g.messages.push({sender:'Track & Clock',me:false,system:true,text:`🗑️ Task "${task.name}" removed.`});
  fsSaveGroup(gid);
  renderAllGroupTasks();
  if(currentGroup===gid)renderGroupChat(gid);
}

function switchGroup(gid, btn) {
  currentGroup = gid;
  document.querySelectorAll('.group-tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderGroupChat(gid);
}

function sendGroupMsg() {
  const inp = document.getElementById('groupMsgInput');
  const v = inp.value.trim(); if (!v) return;
  const myName = document.getElementById('sidebarName')?.textContent || 'You';
  const g = groupsData[currentGroup];
  if (!g) return;
  // Store senderId so every user can independently determine me vs other
  const msg = {sender: myName, senderId: currentUserId, text: v, ts: Date.now()};
  g.messages.push(msg);
  fsSaveGroup(currentGroup);
  inp.value = '';
  // Re-render so the new message appears immediately for the sender
  renderGroupChat(currentGroup);
}

function createGroup() {
  const inp = document.getElementById('newGroupInput');
  const v = inp.value.trim(); if (!v) return;
  const groupCount = Object.keys(groupsData).length;
  const isPaid = typeof userPlan!=='undefined' && (userPlan==='pro'||userPlan==='team');
  const limit = isPaid ? Infinity : 10;
  if (groupCount >= limit) {
    showToast('⚠️ Free plan: up to 10 groups. Upgrade for unlimited!', 3500);
    setTimeout(()=>openFP('pricingPanel'),1800); return;
  }
  const id = 'group_' + Date.now();
  const colors = ['#a78bfa','#5eead4','#f9a8d4','#fde68a','#67e8f9','#b8f0c8'];
  const accColors = ['#7c3aed','#0d9488','#be185d','#d97706','#0891b2','#2d9c5e'];
  const emojis = ['💬','🌟','🎯','💡','🌈','🔥'];
  const myName = document.getElementById('sidebarName')?.textContent || 'You';
  const idx = Object.keys(groupsData).length % colors.length;
  groupsData[id] = {
    id, name: v, dot: colors[idx],
    accentBg: colors[idx]+'33', accentColor: accColors[idx],
    emoji: emojis[idx],
    members: [{name: myName, emoji:'🌟', isMe:true, uid: currentUserId}],
    messages: [{sender:'Track & Clock', me:false, system:true, text:`🎉 ${myName} created <b>${v}</b>. Invite friends to get started!`}],
    tasks: []
  };
  inp.value = '';
  fsSaveGroup(id);
  renderGroupTabs();
  switchGroup(id, null);
  // Re-select the new tab
  document.querySelectorAll('.group-tab').forEach(t => { if(t.getAttribute('data-gid')===id) t.classList.add('active'); });
  showToast(`✅ Group "${v}" created!`, 2500);
}

// ===================================================
// INVITE SYSTEM
// ===================================================
function buildInviteLink(groupId) {
  // Use the current page URL as base so invite links work wherever the file is hosted
  const base = window.location.href.split('?')[0].split('#')[0];
  const token = btoa(groupId + ':' + Date.now()).replace(/=/g,'');
  return `${base}?join=${encodeURIComponent(groupId)}&token=${token}`;
}

function openInviteModal() {
  const g = groupsData[currentGroup];
  if (!g) return;
  // Set badge
  const badge = document.getElementById('inviteGroupBadge');
  badge.style.background = g.accentBg;
  badge.style.color = g.accentColor;
  badge.style.borderColor = g.dot + '66';
  badge.textContent = g.emoji + '  ' + g.name;
  document.getElementById('inviteEmailInput').value = '';
  document.getElementById('inviteMessageInput').value = '';
  document.getElementById('invitePreview').classList.remove('show');
  document.getElementById('inviteModal').classList.remove('hidden');
}

function closeInviteModal() {
  document.getElementById('inviteModal').classList.add('hidden');
}

function updateInvitePreview() {
  const email = document.getElementById('inviteEmailInput').value.trim();
  const msg = document.getElementById('inviteMessageInput').value.trim();
  const g = groupsData[currentGroup];
  const preview = document.getElementById('invitePreview');
  const previewBody = document.getElementById('invitePreviewBody');
  const previewLink = document.getElementById('invitePreviewLink');
  const myName = document.getElementById('sidebarName')?.textContent || 'Your friend';
  const link = buildInviteLink(currentGroup);

  if (!email) { preview.classList.remove('show'); return; }
  preview.classList.add('show');
  previewBody.innerHTML = `<b>To:</b> ${email}<br><b>Subject:</b> ${myName} invited you to join ${g.name} on Track & Clock 🎉<br><br>${msg ? '<b>Message:</b> ' + msg + '<br><br>' : ''}Hi! You've been invited to join <b>${g.name}</b> on Track & Clock. Click the link below to join the group chat and start collaborating!`;
  previewLink.textContent = '🔗 ' + link;
}

function sendInviteEmail() {
  const email = document.getElementById('inviteEmailInput').value.trim();
  const customMsg = document.getElementById('inviteMessageInput').value.trim();
  const g = groupsData[currentGroup];
  if (!email) { showToast('⚠️ Please enter an email address.', 2500); return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('⚠️ Please enter a valid email.', 2500); return; }

  const myName = document.getElementById('sidebarName')?.textContent || 'A friend';
  const link = buildInviteLink(currentGroup);

  const subject = encodeURIComponent(`${myName} invited you to join ${g.name} on Track & Clock 🎉`);
  const body = encodeURIComponent(
`Hi there! 👋

${myName} has invited you to join ${g.emoji} ${g.name} on Track & Clock — a collaborative task and study platform.
${customMsg ? '\n"' + customMsg + '"\n' : ''}
👉 Click the link below to join the group chat instantly:
${link}

Once you open the link, you'll be taken directly into ${g.name} where you can:
• 💬 Chat with the group in real time
• ✅ See and manage group tasks
• 📅 Coordinate deadlines together

See you there! ✨
— Track & Clock`
  );

  // Open Gmail compose in new tab
  const gmailURL = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${subject}&body=${body}`;
  window.open(gmailURL, '_blank');

  // Record the pending invite in the group
  if (!groupsData[currentGroup].pendingInvites) groupsData[currentGroup].pendingInvites = [];
  groupsData[currentGroup].pendingInvites.push({email, sentAt: new Date().toLocaleString()});

  // Add a system message in chat
  const g2 = groupsData[currentGroup];
  const sysMsg = {sender:'Track & Clock', me:false, system:true, text:`📩 Invite sent to <b>${email}</b>. Waiting for them to join...`};
  g2.messages.push(sysMsg);
  renderGroupChat(currentGroup);

  // Fire a notification
  addNotification('login', '📩', 'Invite Sent!', `Invite email opened for ${email} → ${g.name}`);

  closeInviteModal();
  showToast(`✅ Gmail opened to invite ${email}!`, 3000);
}

function copyInviteLink() {
  const link = buildInviteLink(currentGroup);
  navigator.clipboard.writeText(link).then(() => {
    const btn = document.getElementById('inviteCopyBtn');
    btn.textContent = '✅ Copied!';
    setTimeout(() => { btn.textContent = '🔗 Copy Link'; }, 2000);
    showToast('🔗 Invite link copied to clipboard!', 2200);
  }).catch(() => {
    // Fallback: show the link
    prompt('Copy this invite link:', link);
  });
}

// ===== HANDLE INVITE LINK ON PAGE LOAD =====
function handleInviteLink() {
  const params = new URLSearchParams(window.location.search);
  const joinGroup = params.get('join');
  if (!joinGroup) return;

  const tryJoin = () => {
    const myName = document.getElementById('sidebarName')?.textContent || 'New Member';

    // Wait until both Firebase AND the user session are ready
    if (!firebaseReady || !currentUserId) { setTimeout(tryJoin, 800); return; }

    db.collection('shared_groups').doc(joinGroup).get().then(snap => {
      if (!snap.exists) {
        showToast('⚠️ This invite link may have expired or the group no longer exists.', 4000);
        return;
      }
      const g = snap.data();
      groupsData[g.id] = g;

      // Add user to members if not already in
      const alreadyIn = g.members.some(m => m.uid === currentUserId || m.name === myName);
      if (!alreadyIn) {
        g.members.push({name: myName, emoji: '✨', isMe: true, uid: currentUserId});
        g.messages.push({sender:'Track & Clock', system:true, text:`🎉 <b>${myName}</b> joined the group!`, ts: Date.now()});
        groupsData[g.id] = g;
        fsSaveGroup(g.id);
      }

      // Start listening to this group in real time
      listenToSharedGroups([g.id]);

      // Open the groups panel and switch to this group
      openFP('groupsPanel');
      setTimeout(() => {
        renderGroupTabs();
        switchGroup(joinGroup, null);
        document.querySelectorAll('.group-tab').forEach(t => { if(t.getAttribute('data-gid')===joinGroup) t.classList.add('active'); });
        const banner = document.getElementById('joinBanner');
        document.getElementById('joinBannerText').textContent = `🎉 Welcome to ${g.name}!`;
        document.getElementById('joinBannerSub').textContent = `You've successfully joined. Start chatting with the team!`;
        banner.style.display = 'flex';
        setTimeout(() => { banner.style.display = 'none'; }, 8000);
        addNotification('login', '🎉', 'Joined a Group!', `You joined ${g.emoji} ${g.name} via invite link.`);
      }, 400);
    }).catch(e => {
      console.warn('handleInviteLink fetch error', e);
      showToast('⚠️ Could not load group. Check your connection.', 3500);
    });
  };
  setTimeout(tryJoin, 1500);
}

// Init groups on panel open — patched into closeFP/openFP via direct call in the existing openFP function
// (We call initGroupsPanel directly from the existing openFP body below)
function initGroupsPanel() {
  renderGroupTabs();
  renderGroupChat(currentGroup);
}

// ===== ACTIVITY =====
function togglePrivate(){document.getElementById('overallScore').textContent=document.getElementById('scorePrivate').checked?'🔒':'87';}

// ===== LIBRARY =====
let libFiles=[],libFilter='all',lastDeleted=null,undoTimer=null;
function switchLibTab(filter,btn){libFilter=filter;document.querySelectorAll('.lib-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderLib();}
function handleLibUpload(e){
  const curBytes=libFiles.reduce((s,f)=>s+(f.bytes||0),0);
  const maxB=typeof _libMaxBytes!=='undefined'?_libMaxBytes:1073741824;
  Array.from(e.target.files).forEach(file=>{
    if(curBytes+file.size>maxB){showToast('⚠️ Storage limit reached! Upgrade to Pro for more.',3000);return;}
    const r=new FileReader();
    r.onload=ev=>{
      const fid='lib_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
      const fobj={id:fid,name:file.name,type:file.type.split('/')[0],mime:file.type,
        data:ev.target.result,size:fmtSize(file.size),bytes:file.size,date:new Date().toLocaleDateString()};
      libFiles.push(fobj);renderLib();updateLibStorageBar();
      // Upload to Firebase Storage + save metadata
      if(firebaseReady&&currentUserId&&storage){
        const ref=storage.ref('users/'+currentUserId+'/library/'+fid);
        ref.put(file).then(s=>s.ref.getDownloadURL()).then(url=>{
          fobj.cloudUrl=url;fobj.data=url;
          fsSetIn('library',fid,{id:fid,name:file.name,type:fobj.type,mime:fobj.mime,
            size:fobj.size,bytes:file.size,date:fobj.date,cloudUrl:url,updatedAt:Date.now()});
          setSyncBadge('synced');
          showToast('☁️ "'+file.name+'" synced to cloud!',2000);
        }).catch(err=>console.warn('Storage upload:',err));
      }
    };
    r.readAsDataURL(file);
  });e.target.value='';
}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}
function renderLib(){
  const grid=document.getElementById('libGrid'),empty=document.getElementById('libEmpty');
  const filtered=libFilter==='all'?libFiles:libFiles.filter(f=>f.type===libFilter);
  grid.innerHTML='';
  if(!filtered.length){empty.style.display='block';return;}
  empty.style.display='none';
  filtered.forEach(f=>{
    const idx=libFiles.indexOf(f);
    const el=document.createElement('div');el.className='lib-item';
    let thumb=f.type==='image'?`<img src="${f.data}"/>`
      :f.type==='video'?`<video src="${f.data}" muted></video>`
      :`<div style="font-size:2.4rem;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${f.type==='audio'?'🎵':'📄'}</div>`;
    el.innerHTML=`<div class="lib-thumb">${thumb}</div><div class="lib-name">${f.name}</div><div class="lib-meta">${f.size} · ${f.date}</div><button class="lib-del" onclick="delLib(${idx},event)">✕</button>`;
    el.onclick=()=>previewFile(idx);grid.appendChild(el);
  });
}
function delLib(idx,e){
  e.stopPropagation();lastDeleted={file:libFiles[idx],idx};libFiles.splice(idx,1);renderLib();showUndoToast();
}
let toastEl=null;
function showUndoToast(){
  if(toastEl){toastEl.remove();if(undoTimer)clearTimeout(undoTimer);}
  toastEl=document.createElement('div');toastEl.className='undo-toast';
  toastEl.innerHTML='<span>🗑 File removed</span><button class="undo-btn-toast" onclick="undoDelete()">↩ Undo</button>';
  document.body.appendChild(toastEl);
  undoTimer=setTimeout(()=>{if(toastEl){toastEl.classList.add('hide');setTimeout(()=>{if(toastEl){toastEl.remove();toastEl=null;}},300);}},5000);
}
function undoDelete(){
  if(lastDeleted){libFiles.splice(lastDeleted.idx,0,lastDeleted.file);lastDeleted=null;renderLib();if(toastEl){toastEl.remove();toastEl=null;}if(undoTimer)clearTimeout(undoTimer);showToast('✅ File restored!',2000);}
}
function showToast(msg,dur=2500){const t=document.createElement('div');t.className='undo-toast';t.innerHTML=`<span>${msg}</span>`;document.body.appendChild(t);setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.remove(),300);},dur);}
function previewFile(idx){
  const f=libFiles[idx];document.getElementById('fileModalTitle').textContent=f.name;
  const c=document.getElementById('fileModalContent');
  if(f.type==='image')c.innerHTML=`<img src="${f.data}" style="max-width:100%;max-height:62vh;border-radius:11px;"/>`;
  else if(f.type==='video')c.innerHTML=`<video src="${f.data}" controls style="max-width:100%;max-height:62vh;border-radius:11px;"></video>`;
  else if(f.type==='audio')c.innerHTML=`<audio src="${f.data}" controls style="width:100%;margin-top:10px;"></audio>`;
  else c.innerHTML=`<div style="padding:20px;text-align:center;color:#7a6fa0;">No preview available</div>`;
  document.getElementById('fileModal').classList.remove('hidden');
}
function closeFileModal(){document.getElementById('fileModal').classList.add('hidden');}

// ===== PROFILE =====
function saveProfileName(){const v=document.getElementById('editNameInput').value.trim();if(!v)return;document.getElementById('profileNameDisplay').textContent=v;document.getElementById('profileNameVal').textContent=v;document.getElementById('sidebarName').textContent=v;}

// ===== STREAK =====
function initStreak(){
  const today=new Date().toDateString();let streak=parseInt(localStorage.getItem('tc_streak')||'1'),lastDay=localStorage.getItem('tc_lastday')||'';
  if(lastDay&&lastDay!==today){streak++;localStorage.setItem('tc_streak',streak);localStorage.setItem('tc_lastday',today);}
  else if(!lastDay)localStorage.setItem('tc_lastday',today);
  document.getElementById('streakCount').textContent=streak;document.getElementById('streakVal').textContent=streak;document.getElementById('sidebarStreak').textContent=`🔥 Day ${streak} streak`;
}

// ===== THEMES =====
const themes={
  lavender:{bg1:'#d4c8f0',bg2:'#c8ecd4',bg3:'#e0d0f8',dark:'#3d3260',mid:'#7a6fa0',card:'rgba(255,255,255,0.72)',decos:['🌸','💜','🌷','✨','🦋','💐','🌺','🍇'],music:'cozy'},
  ocean:{bg1:'#b3d8f0',bg2:'#d8f0e8',bg3:'#c8ecf8',dark:'#1a3a5c',mid:'#3a6a8a',card:'rgba(235,248,255,0.72)',decos:['🌊','🐚','🐠','🐋','⛵','🦀','🐙','🌊'],music:'calm'},
  sunset:{bg1:'#f0d4c8',bg2:'#f0e8b3',bg3:'#f8d0c0',dark:'#5a2a18',mid:'#8a5a38',card:'rgba(255,248,235,0.72)',decos:['🌅','🌴','☀️','🌇','🔥','🍊','🌻','🦜'],music:'energetic'},
  forest:{bg1:'#c8f0d4',bg2:'#e8f0c0',bg3:'#d8f8c8',dark:'#1a3a22',mid:'#3a6a42',card:'rgba(235,255,240,0.72)',decos:['🌲','🍃','🦋','🌿','🍄','🌱','🦔','🌾'],music:'nature'},
  rose:{bg1:'#f0c8d4',bg2:'#f0c8f0',bg3:'#f8d8e8',dark:'#5a1a3a',mid:'#8a4a6a',card:'rgba(255,235,245,0.72)',decos:['🌹','💗','🌺','🏵️','💝','🌸','🦢','💮'],music:'cozy'},
  night:{bg1:'#2a2540',bg2:'#1a3a4a',bg3:'#2a1a4a',dark:'#e0d8f8',mid:'#a090c0',card:'rgba(35,28,70,0.72)',decos:['🌙','⭐','🔮','✨','🌌','💫','🌠','🦉'],music:'focus'}
};
function setTheme(name,btn){
  document.querySelectorAll('.theme-opt').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const t=themes[name];if(!t)return;
  const r=document.documentElement.style;
  r.setProperty('--bg1',t.bg1);r.setProperty('--bg2',t.bg2);r.setProperty('--bg3',t.bg3);
  r.setProperty('--dark',t.dark);r.setProperty('--mid',t.mid);r.setProperty('--card',t.card);
  r.setProperty('--text-on-theme',t.dark);r.setProperty('--text-mid-theme',t.mid);
  // Theme emoji decorations — skip on mobile
  const deco=document.getElementById('themeDeco');deco.innerHTML='';
  if(window.innerWidth>768){
    t.decos.forEach((icon,i)=>{
      const el=document.createElement('div');el.className='deco-el';el.textContent=icon;
      el.style.cssText=`left:${5+i*12+Math.random()*5}%;top:${4+Math.random()*86}%;animation-delay:${i*0.7}s;font-size:${1.4+Math.random()*1.3}rem;`;
      deco.appendChild(el);
    });
  }
  // Music
  if(t.music){document.querySelectorAll('.mp-mood-chip').forEach(c=>c.classList.remove('active'));const chip=document.querySelector(`.mp-mood-chip[onclick*="${t.music}"]`);if(chip)chip.classList.add('active');setMoodChip(t.music,chip||document.querySelector('.mp-mood-chip'));}
  // Canvas animated scene
  if(window.TC)TC.setScene(name);
}
function setMood(btn){document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function setFont(size,btn){
  // Only reset font-size buttons, not mood buttons
  document.querySelectorAll('.font-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.documentElement.style.setProperty('--base-font',size);
  // Apply font size visually to everything
  document.body.style.fontSize=size;
  // Update preview
  const prev=document.getElementById('fontPreviewText');
  if(prev)prev.style.fontSize=size;
}
(function initDecos(){
  if(window.innerWidth<=768) return; // skip on mobile
  const deco=document.getElementById('themeDeco');
  ['🌸','💜','🌷','✨','🦋','💐','🌺'].forEach((icon,i)=>{
    const el=document.createElement('div');el.className='deco-el';el.textContent=icon;
    el.style.cssText=`left:${5+i*13+Math.random()*5}%;top:${4+Math.random()*86}%;animation-delay:${i*0.7}s;font-size:${1.4+Math.random()*1.2}rem;`;
    deco.appendChild(el);
  });
})();

// ===== AUTH =====
let loginMode='login';
function openLoginModal(mode){
  loginMode=mode||'login';document.getElementById('loginModal').classList.remove('hidden');
  if(mode==='switch'){document.getElementById('loginModalTitle').textContent='Switch Account';document.getElementById('loginModalSub').textContent='Sign in with a different account';}
  else{document.getElementById('loginModalTitle').textContent='Welcome Back!';document.getElementById('loginModalSub').textContent='Log in to continue your journey';}
  document.getElementById('loginRegExtra').style.display='none';
  document.getElementById('loginSubmitBtn').textContent='Log In';
  document.getElementById('loginSwitchText').innerHTML="Don't have an account? <span onclick='toggleLoginMode()'>Sign up</span>";
}
function closeLoginModal(){document.getElementById('loginModal').classList.add('hidden');}
function toggleLoginMode(){
  if(loginMode==='login'){loginMode='register';document.getElementById('loginModalTitle').textContent='Create Account';document.getElementById('loginModalSub').textContent='Join Track & Clock today';document.getElementById('loginRegExtra').style.display='block';document.getElementById('loginSubmitBtn').textContent='Sign Up';document.getElementById('loginSwitchText').innerHTML="Already have an account? <span onclick='toggleLoginMode()'>Log in</span>";}
  else{loginMode='login';document.getElementById('loginModalTitle').textContent='Welcome Back!';document.getElementById('loginModalSub').textContent='';document.getElementById('loginRegExtra').style.display='none';document.getElementById('loginSubmitBtn').textContent='Log In';document.getElementById('loginSwitchText').innerHTML="Don't have an account? <span onclick='toggleLoginMode()'>Sign up</span>";}
}
function handleLogin(){const v=document.getElementById('loginUsername').value.trim();if(v)onUserSignedIn(v,null,null);closeLoginModal();}
function handleLogout(){if(confirm('Are you sure you want to log out?')){
  stopSync();currentUserId=null;
  calTasks={};activityEntries=[];groupTasksStore=[];libFiles=[];selectedDate=null;
  if(firebaseReady&&auth)auth.signOut().catch(()=>{});
  localStorage.removeItem('tc_google_user');
  if(window.google&&window.google.accounts)google.accounts.id.revoke('',()=>{});
  document.getElementById('appLayout').classList.add('hidden');
  document.getElementById('landing').classList.remove('hidden');
}}

// ===== LEGAL DOC TOGGLES =====
function toggleLegal(bodyId, chevronId) {
  const body = document.getElementById(bodyId);
  const chevron = document.getElementById(chevronId);
  const isOpen = body.classList.contains('open');
  // Close all others first
  document.querySelectorAll('.legal-doc-body').forEach(b => b.classList.remove('open'));
  document.querySelectorAll('.legal-chevron').forEach(c => c.classList.remove('open'));
  // Toggle the clicked one
  if (!isOpen) {
    body.classList.add('open');
    chevron.classList.add('open');
    // Smooth scroll to it
    setTimeout(() => body.scrollIntoView({behavior:'smooth', block:'nearest'}), 60);
  }
}

// ===== AVATAR =====
let avState={skin:'#f5c9a0',eyeColor:'#5b8dee',hair:'twin',hairColor:'#5c3d2e',shirt:'tshirt',shirtColor:'#c9b3e8',pants:'pants',shoes:'sneakers',shoeColor:'#c9b3e8',acc:'none',bg:'radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0)',pose:'stand'};
function openAvatarModal(){document.getElementById('avatarModal').classList.remove('hidden');}
function closeAvatarModal(){document.getElementById('avatarModal').classList.add('hidden');}
function clearRow(id){document.querySelectorAll('#'+id+' .opt-btn,.opt-btn.active').forEach(b=>{if(b.closest('#'+id))b.classList.remove('active');});}
function clearSwatches(row){document.querySelectorAll('.'+row+' .color-swatch').forEach(s=>s.classList.remove('active'));}
function setSkin(c,sw){avState.skin=c;document.querySelectorAll('#avHead,#avNeck,#avEarL,#avEarR,#avArmL,#avArmR,#avLegL,#avLegR').forEach(el=>{if(el)el.setAttribute('fill',c);});document.querySelectorAll('[id="avShoeGroup"] ellipse:not(:nth-child(-n+2)),circle').forEach(el=>{const id=el.id;if(!id&&el.closest('#avShoeGroup'))return;if(['avHead','avNeck','avEarL','avEarR'].includes(id))el.setAttribute('fill',c);});document.getElementById('avSvg').querySelectorAll('circle[fill="#f5c9a0"],circle[fill="#f9e4d4"],circle[fill="#e8a87c"],circle[fill="#c68642"],circle[fill="#8d5524"],circle[fill="#5c3317"]').forEach(el=>el.setAttribute('fill',c));sw.classList.add('active');updateAvatar();}
function setEyeColor(c,sw){avState.eyeColor=c;['avIrisColorL','avIrisColorR'].forEach(id=>{const el=document.getElementById(id);if(el)el.setAttribute('fill',c);});sw.classList.add('active');}
function setHair(s,btn){avState.hair=s;document.querySelectorAll('#hairStyleRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setHairColor(c,sw){avState.hairColor=c;document.querySelectorAll('#hairColorRow .color-swatch').forEach(s=>s.classList.remove('active'));sw.classList.add('active');updateAvatar();}
function setShirt(s,btn){avState.shirt=s;document.querySelectorAll('#shirtStyleRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setShirtColor(c,sw){avState.shirtColor=c;document.querySelectorAll('#shirtColorRow .color-swatch').forEach(s=>s.classList.remove('active'));sw.classList.add('active');updateAvatar();}
function setPants(s,btn){avState.pants=s;document.querySelectorAll('#pantsRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setShoes(s,btn){avState.shoes=s;document.querySelectorAll('#shoeRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setShoeColor(c,sw){avState.shoeColor=c;document.querySelectorAll('#shoeColorRow .color-swatch').forEach(s=>s.classList.remove('active'));sw.classList.add('active');updateAvatar();}
function setAcc(a,btn){avState.acc=a;document.querySelectorAll('#accRow .opt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}
function setAvBg(g,sw){avState.bg=g;document.getElementById('avBg').style.background=g;document.querySelectorAll('#bgColorRow .color-swatch').forEach(s=>s.classList.remove('active'));sw.classList.add('active');}
function setPose(p,btn){avState.pose=p;document.querySelectorAll('.pose-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');updateAvatar();}

function loadAvatarPhoto(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    // Show photo as face overlay hint
    showToast('📸 Photo loaded! We used your skin tone & style as inspiration.',3000);
    // Simple: set the canvas bg to a blurred version of the photo
    const img=new Image();img.onload=()=>{
      const canvas=document.createElement('canvas');canvas.width=150;canvas.height=200;
      const ctx=canvas.getContext('2d');ctx.filter='blur(8px) opacity(0.25)';
      ctx.drawImage(img,0,0,150,200);
      const dataUrl=canvas.toDataURL();
      document.getElementById('avBg').style.background=`url(${dataUrl}) center/cover`;
    };img.src=ev.target.result;
  };r.readAsDataURL(file);
}

function updateAvatar(){
  const svg=document.getElementById('avSvg'),s=avState;
  const hc=s.hairColor;
  const hairStyles={
    twin:`<ellipse cx="60" cy="18" rx="38" ry="28" fill="${hc}"/><ellipse cx="60" cy="13" rx="30" ry="16" fill="${hc}"/><rect x="20" y="18" width="16" height="44" rx="8" fill="${hc}"/><rect x="84" y="18" width="16" height="44" rx="8" fill="${hc}"/><circle cx="20" cy="16" r="15" fill="${hc}"/><circle cx="100" cy="16" r="15" fill="${hc}"/>`,
    short:`<ellipse cx="60" cy="22" rx="40" ry="24" fill="${hc}"/><rect x="18" y="28" width="14" height="26" rx="7" fill="${hc}"/><rect x="88" y="28" width="14" height="26" rx="7" fill="${hc}"/>`,
    ponytail:`<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><ellipse cx="60" cy="12" rx="28" ry="14" fill="${hc}"/><rect x="80" y="8" width="12" height="55" rx="6" fill="${hc}"/><ellipse cx="86" cy="64" rx="10" ry="7" fill="${hc}"/>`,
    long:`<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><rect x="18" y="22" width="15" height="72" rx="7" fill="${hc}"/><rect x="87" y="22" width="15" height="72" rx="7" fill="${hc}"/>`,
    pixie:`<ellipse cx="60" cy="18" rx="38" ry="22" fill="${hc}"/><ellipse cx="60" cy="8" rx="26" ry="12" fill="${hc}"/><rect x="19" y="24" width="12" height="18" rx="6" fill="${hc}"/>`,
    braids:`<ellipse cx="60" cy="16" rx="37" ry="25" fill="${hc}"/><rect x="16" y="24" width="12" height="80" rx="6" fill="${hc}"/><rect x="92" y="24" width="12" height="80" rx="6" fill="${hc}"/><ellipse cx="22" cy="108" rx="9" ry="7" fill="${hc}"/><ellipse cx="98" cy="108" rx="9" ry="7" fill="${hc}"/>`,
    curly:`<ellipse cx="60" cy="14" rx="42" ry="28" fill="${hc}"/><circle cx="18" cy="42" r="14" fill="${hc}"/><circle cx="102" cy="42" r="14" fill="${hc}"/><circle cx="24" cy="18" r="12" fill="${hc}"/><circle cx="96" cy="18" r="12" fill="${hc}"/><circle cx="60" cy="6" r="12" fill="${hc}"/>`,
    sidetail:`<ellipse cx="60" cy="18" rx="38" ry="26" fill="${hc}"/><rect x="90" y="14" width="14" height="70" rx="7" fill="${hc}"/><ellipse cx="97" cy="86" rx="11" ry="8" fill="${hc}"/><rect x="18" y="22" width="12" height="22" rx="6" fill="${hc}"/>`,
  };
  svg.getElementById('avHair').innerHTML=hairStyles[s.hair]||hairStyles.twin;

  const sc=s.shirtColor;
  const shirtStyles={
    tshirt:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/>`,
    hoodie:`<rect x="24" y="88" width="72" height="44" rx="18" fill="${sc}" id="avShirtShape"/><rect x="44" y="88" width="32" height="16" rx="6" fill="${sc==='#1f2937'?'#374151':'rgba(0,0,0,0.12)'}" opacity="0.6"/>`,
    uniform:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/><rect x="54" y="90" width="12" height="40" fill="rgba(255,255,255,0.25)"/>`,
    dress:`<rect x="26" y="90" width="68" height="50" rx="16" fill="${sc}" id="avShirtShape"/><path d="M26 120 Q60 148 94 120 L94 140 Q60 165 26 140Z" fill="${sc}" opacity="0.8"/>`,
    sundress:`<rect x="28" y="90" width="64" height="48" rx="18" fill="${sc}" id="avShirtShape"/><path d="M22 118 Q60 152 98 118 L98 148 Q60 178 22 148Z" fill="${sc}"/>`,
    kitty:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/><text x="60" y="116" text-anchor="middle" font-size="18">🐱</text>`,
    bear:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/><text x="60" y="116" text-anchor="middle" font-size="18">🐻</text>`,
    stripes:`<rect x="26" y="90" width="68" height="40" rx="16" fill="${sc}" id="avShirtShape"/><line x1="26" y1="98" x2="94" y2="98" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="108" x2="94" y2="108" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="118" x2="94" y2="118" stroke="rgba(255,255,255,0.35)" stroke-width="4"/><line x1="26" y1="128" x2="94" y2="128" stroke="rgba(255,255,255,0.35)" stroke-width="4"/>`,
  };
  svg.getElementById('avShirt').innerHTML=shirtStyles[s.shirt]||shirtStyles.tshirt;

  const pc=s.pants==='jeans'?'#4a74a8':s.pantsColor||'#7a6fa0';
  const pantsStyles={
    pants:`<rect x="28" y="122" width="64" height="38" rx="14" fill="${pc}" id="avBottomShape"/>`,
    jeans:`<rect x="28" y="122" width="64" height="38" rx="14" fill="#4a74a8" id="avBottomShape"/><line x1="60" y1="122" x2="60" y2="160" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>`,
    skirt:`<path d="M22 122 Q60 162 98 122Z" fill="${pc}" id="avBottomShape"/><rect x="28" y="118" width="64" height="12" rx="6" fill="${pc}" opacity="0.8"/>`,
    miniskirt:`<path d="M26 122 Q60 148 94 122Z" fill="${pc}" id="avBottomShape"/><rect x="28" y="118" width="64" height="10" rx="5" fill="${pc}" opacity="0.8"/>`,
    shorts:`<rect x="28" y="122" width="28" height="22" rx="10" fill="${pc}" id="avBottomShape"/><rect x="64" y="122" width="28" height="22" rx="10" fill="${pc}"/>`,
    plaid:`<rect x="28" y="122" width="64" height="38" rx="14" fill="${pc}" id="avBottomShape"/><line x1="36" y1="122" x2="36" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="48" y1="122" x2="48" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="72" y1="122" x2="72" y2="160" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"/><line x1="28" y1="132" x2="92" y2="132" stroke="rgba(255,255,255,0.3)" stroke-width="2"/><line x1="28" y1="144" x2="92" y2="144" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>`,
    leggings:`<rect x="37" y="122" width="20" height="48" rx="10" fill="${pc}" id="avBottomShape"/><rect x="63" y="122" width="20" height="48" rx="10" fill="${pc}"/>`,
  };
  svg.getElementById('avBottom').innerHTML=pantsStyles[s.pants]||pantsStyles.pants;

  const shc=s.shoeColor;
  const shoeStyles={
    sneakers:`<ellipse cx="38" cy="191" rx="17" ry="9" fill="${shc}" id="avShoeL"/><ellipse cx="78" cy="191" rx="17" ry="9" fill="${shc}" id="avShoeR"/><ellipse cx="36" cy="187" rx="14" ry="7" fill="rgba(255,255,255,0.4)"/><ellipse cx="80" cy="187" rx="14" ry="7" fill="rgba(255,255,255,0.4)"/>`,
    heels:`<ellipse cx="40" cy="190" rx="14" ry="7" fill="${shc}"/><ellipse cx="76" cy="190" rx="14" ry="7" fill="${shc}"/><rect x="44" y="191" width="4" height="10" rx="2" fill="${shc}"/><rect x="72" y="191" width="4" height="10" rx="2" fill="${shc}"/>`,
    boots:`<rect x="24" y="176" width="24" height="20" rx="8" fill="${shc}"/><rect x="72" y="176" width="24" height="20" rx="8" fill="${shc}"/><ellipse cx="36" cy="196" rx="14" ry="6" fill="${shc}"/><ellipse cx="84" cy="196" rx="14" ry="6" fill="${shc}"/>`,
    loafers:`<ellipse cx="38" cy="191" rx="17" ry="8" fill="${shc}"/><ellipse cx="78" cy="191" rx="17" ry="8" fill="${shc}"/><rect x="26" y="184" width="22" height="7" rx="3" fill="${shc}" opacity="0.7"/><rect x="72" y="184" width="22" height="7" rx="3" fill="${shc}" opacity="0.7"/>`,
    barefoot:`<ellipse cx="38" cy="191" rx="14" ry="7" fill="${s.skin}"/><ellipse cx="78" cy="191" rx="14" ry="7" fill="${s.skin}"/>`,
  };
  svg.getElementById('avShoeGroup').innerHTML=shoeStyles[s.shoes]||shoeStyles.sneakers;

  const accStyles={
    none:'',
    bow:`<ellipse cx="36" cy="28" rx="12" ry="7" fill="#f9a8d4" transform="rotate(-25 36 28)"/><ellipse cx="62" cy="22" rx="12" ry="7" fill="#f9a8d4" transform="rotate(15 62 22)"/><circle cx="48" cy="25" r="6" fill="#f9a8d4"/>`,
    crown:`<polygon points="20,42 30,20 48,32 66,20 80,42" fill="#ffd700" stroke="#f0a500" stroke-width="1.5"/><circle cx="30" cy="22" r="4" fill="#ff6b6b"/><circle cx="48" cy="32" r="4" fill="#6bcfff"/><circle cx="66" cy="22" r="4" fill="#98f59a"/>`,
    catears:`<polygon points="16,50 20,28 34,44" fill="${hc}"/><polygon points="86,44 100,28 104,50" fill="${hc}"/><polygon points="18,48 21,34 31,44" fill="#ffd6e7" opacity="0.7"/><polygon points="89,44 99,34 102,48" fill="#ffd6e7" opacity="0.7"/>`,
    flower:`<circle cx="72" cy="30" r="10" fill="#f9a8d4" opacity="0.8"/><circle cx="80" cy="22" r="8" fill="#fde68a" opacity="0.8"/><circle cx="64" cy="22" r="8" fill="#f9a8d4" opacity="0.8"/><circle cx="72" cy="30" r="5" fill="#fde68a"/>`,
    headphones:`<rect x="14" y="50" width="10" height="20" rx="5" fill="#2d2050"/><rect x="96" y="50" width="10" height="20" rx="5" fill="#2d2050"/><path d="M19 55 Q60 30 101 55" stroke="#2d2050" stroke-width="5" fill="none"/><rect x="12" y="54" width="14" height="20" rx="7" fill="${hc}"/><rect x="94" y="54" width="14" height="20" rx="7" fill="${hc}"/>`,
    halo:`<ellipse cx="60" cy="5" rx="26" ry="8" fill="none" stroke="#ffd700" stroke-width="4" opacity="0.85"/>`,
    glasses:`<circle cx="44" cy="58" r="12" fill="none" stroke="#5c3d2e" stroke-width="3"/><circle cx="76" cy="58" r="12" fill="none" stroke="#5c3d2e" stroke-width="3"/><line x1="56" y1="58" x2="64" y2="58" stroke="#5c3d2e" stroke-width="3"/><line x1="20" y1="56" x2="32" y2="57" stroke="#5c3d2e" stroke-width="2.5"/><line x1="88" y1="57" x2="100" y2="56" stroke="#5c3d2e" stroke-width="2.5"/>`,
    wings:`<path d="M14 100 Q-10 80 5 60 Q20 50 30 72Z" fill="${hc}" opacity="0.7"/><path d="M106 100 Q130 80 115 60 Q100 50 90 72Z" fill="${hc}" opacity="0.7"/>`,
  };
  svg.getElementById('avAccLayer').innerHTML=accStyles[s.acc]||'';

  // Pose transform on arms
  if(s.pose==='wave'){svg.getElementById('avArmR').setAttribute('transform','rotate(-55 103 90)');svg.getElementById('avArmR').setAttribute('ry','22');}
  else if(s.pose==='sit'){svg.getElementById('avLegL').setAttribute('transform','rotate(75 47 152)');svg.getElementById('avLegR').setAttribute('transform','rotate(-75 73 152)');}
  else if(s.pose==='peace'){svg.getElementById('avArmR').setAttribute('transform','rotate(-45 103 95)');}
  else{svg.getElementById('avArmR').setAttribute('transform','rotate(18 103 112)');svg.getElementById('avArmR').setAttribute('ry','24');if(svg.getElementById('avLegL')){svg.getElementById('avLegL').removeAttribute('transform');svg.getElementById('avLegR').removeAttribute('transform');}}
}

function saveAvatar(){
  const name=document.getElementById('avatarNameInput').value||'Tracker';
  const em={'twin':'🐣','short':'🐱','ponytail':'🦊','long':'👧','pixie':'🌟','braids':'👱','curly':'💫','sidetail':'🌸'}[avState.hair]||'🐣';
  ['avatarBtnInner','sidebarAvatarInner','profileAvatarInner'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=em;});
  document.getElementById('sidebarName').textContent=name;
  document.getElementById('profileNameDisplay').textContent=name;
  document.getElementById('editNameInput').value=name;
  closeAvatarModal();showToast('💜 Avatar saved!',2000);
}

renderCalendar();

// ===================================================
// NOTIFICATION SYSTEM
// ===================================================
let notifications=[];let reminders=[];let notifPanelOpen=false;let unreadCount=0;

function addNotification(type,icon,title,msg){
  const now=new Date();const timeStr=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const notif={id:Date.now()+Math.random(),type,icon,title,msg,time:timeStr,read:false};
  notifications.unshift(notif);unreadCount++;updateNotifBadge();renderNotifList();showToastNotif(icon,title,msg);
}
function updateNotifBadge(){
  const badge=document.getElementById('notifBadge');if(!badge)return;
  if(unreadCount>0){badge.textContent=unreadCount>9?'9+':unreadCount;badge.classList.remove('hidden');
    const btn=document.getElementById('notifBellBtn');if(btn){btn.style.animation='none';setTimeout(()=>{btn.style.animation='bellShake 0.5s ease';},10);}
  }else{badge.classList.add('hidden');}
}
function renderNotifList(){
  const list=document.getElementById('notifList');if(!list)return;list.innerHTML='';
  if(!notifications.length){list.innerHTML='<div class="notif-empty">No notifications yet ✨</div>';return;}
  notifications.forEach(n=>{
    const el=document.createElement('div');el.className=`notif-item ${n.type} ${n.read?'':'unread'}`;
    el.innerHTML=`<span class="notif-icon">${n.icon}</span><div class="notif-body"><div class="notif-title">${n.title}</div><div class="notif-msg">${n.msg}</div><div class="notif-time">${n.time}</div></div><button class="notif-dismiss" onclick="dismissNotif('${n.id}')">✕</button>`;
    list.appendChild(el);
  });
}
function dismissNotif(id){
  const idx=notifications.findIndex(n=>String(n.id)===String(id));
  if(idx!==-1){if(!notifications[idx].read)unreadCount=Math.max(0,unreadCount-1);notifications.splice(idx,1);}
  updateNotifBadge();renderNotifList();
}
function clearAllNotifs(){notifications=[];unreadCount=0;updateNotifBadge();renderNotifList();}
function toggleNotifPanel(){
  notifPanelOpen=!notifPanelOpen;
  document.getElementById('notifPanel').classList.toggle('hidden',!notifPanelOpen);
  if(notifPanelOpen){notifications.forEach(n=>n.read=true);unreadCount=0;updateNotifBadge();renderNotifList();}
}
document.addEventListener('click',function(e){
  if(notifPanelOpen&&!e.target.closest('#notifPanel')&&!e.target.closest('#notifBellBtn')){
    notifPanelOpen=false;document.getElementById('notifPanel').classList.add('hidden');
  }
});
function showToastNotif(icon,title,msg){
  const t=document.createElement('div');t.className='toast-notif';
  t.innerHTML=`<span class="toast-notif-icon">${icon}</span><div class="toast-notif-body"><div class="toast-notif-title">${title}</div><div class="toast-notif-msg">${msg}</div></div>`;
  document.body.appendChild(t);
  setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.remove(),350);},4500);
}
function addReminder(){
  const name=document.getElementById('notifTaskName').value.trim();
  const dt=document.getElementById('notifDateTime').value;
  if(!name||!dt){showToast('⚠️ Please enter a task name and date/time.',2500);return;}
  const fireAt=new Date(dt).getTime();const now2=Date.now();
  if(fireAt<=now2){showToast('⚠️ Please pick a future date and time!',2500);return;}
  const delay=fireAt-now2;
  const label=new Date(dt).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
  reminders.push({name,dt,timer:setTimeout(()=>{addNotification('warning','⏰','Task Reminder!',`Time to work on: "${name}"`);},delay)});
  document.getElementById('notifTaskName').value='';document.getElementById('notifDateTime').value='';
  showToast(`⏰ Reminder set for ${label}!`,3000);
  addNotification('unread','📌','Reminder Scheduled',`"${name}" — ${label}`);
}
function checkDeadlineAlerts(){
  const now=new Date();const tomorrow=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1);
  const tKey=`${tomorrow.getFullYear()}-${String(tomorrow.getMonth()+1).padStart(2,'0')}-${String(tomorrow.getDate()).padStart(2,'0')}`;
  if(calTasks[tKey]&&calTasks[tKey].length){
    const pending=calTasks[tKey].filter(t=>!t.done);
    if(pending.length)addNotification('warning','⚠️','Deadline Tomorrow!',`You have ${pending.length} task(s) due tomorrow. Don't forget!`);
  }
}
setTimeout(checkDeadlineAlerts,3000);setInterval(checkDeadlineAlerts,3600000);
const bellStyle=document.createElement('style');
bellStyle.textContent=`@keyframes bellShake{0%,100%{transform:rotate(0)}20%{transform:rotate(-15deg) scale(1.15)}40%{transform:rotate(15deg)}60%{transform:rotate(-10deg)}80%{transform:rotate(8deg)}}`;
document.head.appendChild(bellStyle);

// ===================================================
// AVATAR STYLE TEMPLATES
// ===================================================
const styleTemplates={
  coquette:{label:'🎀 Coquette',desc:'🎀 <b>Coquette</b> — Soft, romantic & feminine.<br>💗 Sundress · Mini Skirt · Ballet Heels · Bow · Long Wavy hair',state:{shirt:'sundress',shirtColor:'#ffd6e0',pants:'miniskirt',pantsColor:'#f9a8d4',shoes:'heels',shoeColor:'#ffd6e0',acc:'bow',hair:'long',hairColor:'#f5d060',eyeColor:'#5b8dee',bg:'radial-gradient(circle at 50% 70%,#ffe8f0,#ffd6c8)'}},
  y2k:{label:'💿 Y2K',desc:'💿 <b>Y2K</b> — Chrome, bold & futuristic 2000s energy.<br>✨ Stripes · Mini Skirt · White Sneakers · Headphones · Twin Buns',state:{shirt:'stripes',shirtColor:'#e0e0e0',pants:'miniskirt',pantsColor:'#c9b3e8',shoes:'sneakers',shoeColor:'#ffffff',acc:'headphones',hair:'twin',hairColor:'#e0e0e0',eyeColor:'#67e8f9',bg:'radial-gradient(circle at 50% 70%,#c8e8ff,#d0f0ff)'}},
  emo:{label:'🖤 Emo',desc:'🖤 <b>Emo</b> — Dark, expressive & unapologetically emotional.<br>🖤 Black Hoodie · Plaid · Combat Boots · Wings · Sidetail',state:{shirt:'hoodie',shirtColor:'#1f2937',pants:'plaid',pantsColor:'#1f2937',shoes:'boots',shoeColor:'#1f2937',acc:'wings',hair:'sidetail',hairColor:'#1a1a2e',eyeColor:'#a78bfa',bg:'radial-gradient(circle at 50% 70%,#3a2a70,#1a1040)'}},
  cottagecore:{label:'🌿 Cottagecore',desc:'🌿 <b>Cottagecore</b> — Dreamy, nature-inspired & cozy.<br>🌸 Sundress · Long Skirt · Loafers · Flower Crown · Braids',state:{shirt:'sundress',shirtColor:'#b8f0c8',pants:'skirt',pantsColor:'#fde68a',shoes:'loafers',shoeColor:'#92400e',acc:'flower',hair:'braids',hairColor:'#e87878',eyeColor:'#4caf50',bg:'radial-gradient(circle at 50% 70%,#d0f8e8,#c0f0ff)'}},
  darkacademia:{label:'📖 Dark Academia',desc:'📖 <b>Dark Academia</b> — Scholarly, moody & intellectual.<br>📚 Uniform · Plaid · Loafers · Glasses · Short Bob',state:{shirt:'uniform',shirtColor:'#92400e',pants:'plaid',pantsColor:'#5c3d2e',shoes:'loafers',shoeColor:'#5c3d2e',acc:'glasses',hair:'short',hairColor:'#5c3d2e',eyeColor:'#f59e0b',bg:'radial-gradient(circle at 50% 70%,#fff8d0,#ffe0a0)'}},
  streetwear:{label:'🧢 Streetwear',desc:'🧢 <b>Streetwear</b> — Urban, bold & effortlessly cool.<br>🔥 Hoodie · Jeans · Chunky Sneakers · Headphones · Curly hair',state:{shirt:'hoodie',shirtColor:'#1f2937',pants:'jeans',pantsColor:'#4a74a8',shoes:'sneakers',shoeColor:'#ffffff',acc:'headphones',hair:'curly',hairColor:'#1a1a2e',eyeColor:'#2d1f14',bg:'radial-gradient(circle at 50% 70%,#e8e0ff,#d0f8e0)'}},
  kawaii:{label:'🌸 Kawaii',desc:'🌸 <b>Kawaii</b> — Super cute, pastel & adorable overload!<br>🍓 Bear Top · Mini Skirt · Mary Janes · Cat Ears · Pink Twin Buns',state:{shirt:'bear',shirtColor:'#f9a8d4',pants:'miniskirt',pantsColor:'#c9b3e8',shoes:'heels',shoeColor:'#ffd6e0',acc:'catears',hair:'twin',hairColor:'#f9a8d4',eyeColor:'#a78bfa',bg:'radial-gradient(circle at 50% 70%,#ffe8f0,#ffd6c8)'}},
  baddie:{label:'💅 Baddie',desc:'💅 <b>Baddie</b> — Confident, fierce & glamorous.<br>🔥 Crop Top · Leggings · Stilettos · Crown · Sleek Ponytail',state:{shirt:'tshirt',shirtColor:'#dc2626',pants:'leggings',pantsColor:'#1f2937',shoes:'heels',shoeColor:'#1f2937',acc:'crown',hair:'ponytail',hairColor:'#1a1a2e',eyeColor:'#ef4444',bg:'radial-gradient(circle at 50% 70%,#3a2a70,#1a1040)'}},
  boho:{label:'🍂 Boho',desc:'🍂 <b>Boho</b> — Free-spirited, earthy & effortlessly chic.<br>🌻 Sundress · Flowy Skirt · Barefoot · Flower · Wavy Auburn hair',state:{shirt:'sundress',shirtColor:'#f97316',pants:'skirt',pantsColor:'#92400e',shoes:'barefoot',shoeColor:'#e8a87c',acc:'flower',hair:'long',hairColor:'#e87878',eyeColor:'#f59e0b',bg:'radial-gradient(circle at 50% 70%,#fff8d0,#ffe0a0)'}},
  pastelgoth:{label:'🕸️ Pastel Goth',desc:'🕸️ <b>Pastel Goth</b> — Soft meets dark, adorably edgy.<br>💜 Stripes · Purple Plaid · Platform Boots · Wings · Lavender Bob',state:{shirt:'stripes',shirtColor:'#c9b3e8',pants:'plaid',pantsColor:'#a78bfa',shoes:'boots',shoeColor:'#c9b3e8',acc:'wings',hair:'short',hairColor:'#c9b3e8',eyeColor:'#a78bfa',bg:'radial-gradient(circle at 50% 70%,#3a2a70,#1a1040)'}}
};

function applyStyle(styleName,btn){
  const s=styleTemplates[styleName];if(!s)return;
  document.querySelectorAll('.style-chip').forEach(c=>c.classList.remove('active'));btn.classList.add('active');
  const box=document.getElementById('stylePreviewBox');
  document.getElementById('stylePreviewDesc').innerHTML=s.desc;box.classList.add('show');
  const st=s.state;avState={...avState,...st};
  if(st.shirt)document.querySelectorAll('#shirtStyleRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.shirt}'`)));
  if(st.pants)document.querySelectorAll('#pantsRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.pants}'`)));
  if(st.shoes)document.querySelectorAll('#shoeRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.shoes}'`)));
  if(st.acc)document.querySelectorAll('#accRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.acc}'`)));
  if(st.hair)document.querySelectorAll('#hairStyleRow .opt-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${st.hair}'`)));
  if(st.bg)document.getElementById('avBg').style.background=st.bg;
  if(st.eyeColor){avState.eyeColor=st.eyeColor;['avIrisColorL','avIrisColorR'].forEach(id=>{const el=document.getElementById(id);if(el)el.setAttribute('fill',st.eyeColor);});}
  updateAvatar();showToast(`${s.label} style applied! ✨`,2200);
}

// ===================================================
// ANIMATED THEME BACKGROUND CANVAS ENGINE
// ===================================================
const TC = window.themePainter = (() => {
  const canvas = document.getElementById('themeBgCanvas');
  const ctx = canvas.getContext('2d');
  let W, H, frame = 0, animId = null, currentScene = null;

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // ---- Shared helpers ----
  function lerp(a,b,t){return a+(b-a)*t;}
  function easeInOut(t){return t<0.5?2*t*t:1-Math.pow(-2*t+2,2)/2;}
  function rand(a,b){return a+Math.random()*(b-a);}
  function hsl(h,s,l,a=1){return `hsla(${h},${s}%,${l}%,${a})`;}

  // ---- Star helper ----
  function drawStar(x,y,r,t,col){
    ctx.save();ctx.beginPath();ctx.arc(x,y,r*(0.7+0.3*Math.sin(t)),0,Math.PI*2);
    ctx.fillStyle=col||'rgba(255,255,255,0.9)';ctx.shadowBlur=r*4;ctx.shadowColor=col||'white';ctx.fill();ctx.restore();
  }

  // ============================================================
  // SCENES
  // ============================================================

  // ------ LAVENDER DREAM: rolling lavender hills, floating petals, soft auroras ------
  const lavScene = (()=>{
    const petals = Array.from({length:28},(_,i)=>({x:rand(0,1),y:rand(0,1),r:rand(0.5,1.4),a:rand(0,Math.PI*2),va:rand(-0.01,0.01),vx:rand(-0.00015,0.00015),vy:rand(0.00008,0.00022),op:rand(0.35,0.75)}));
    const fireflies = Array.from({length:18},(_,i)=>({x:rand(0.2,0.8),y:rand(0.3,0.7),px:rand(0.2,0.8),py:rand(0.3,0.7),ph:rand(0,1),sp:rand(0.002,0.006)}));
    return function(){
      const t = frame/160;
      // Sky gradient — soft dusk lavender
      const sky = ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(270,45,82));sky.addColorStop(0.5,hsl(280,50,75));sky.addColorStop(1,hsl(290,40,65));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Aurora wisps
      for(let i=0;i<3;i++){
        const ax=W*(0.2+i*0.3+0.04*Math.sin(t*0.7+i));const aw=W*(0.28+0.08*Math.sin(t*0.5+i));
        const ag=ctx.createLinearGradient(ax-aw/2,0,ax+aw/2,0);
        ag.addColorStop(0,'transparent');ag.addColorStop(0.5,hsl(280+i*15,60,80,0.12));ag.addColorStop(1,'transparent');
        ctx.fillStyle=ag;ctx.fillRect(ax-aw/2,H*0.05,aw,H*0.5);
      }

      // Rolling hills
      [[hsl(280,35,58),0.72],[hsl(285,40,52),0.82],[hsl(275,45,62),0.88]].forEach(([col,hy],i)=>{
        ctx.beginPath();ctx.moveTo(0,H);
        for(let x=0;x<=W;x+=4){
          const wv = Math.sin(x/W*Math.PI*3+t*0.3+i*1.2)*H*0.035+Math.sin(x/W*Math.PI*5+t*0.2+i)*H*0.018;
          ctx.lineTo(x,H*hy+wv);
        }
        ctx.lineTo(W,H);ctx.closePath();ctx.fillStyle=col;ctx.fill();
      });

      // Lavender flower patches on hills
      for(let i=0;i<40;i++){
        const px=(i/40+0.01*Math.sin(t*0.5+i))*W;
        const py=H*0.83+Math.sin(px/W*Math.PI*4+t*0.3)*H*0.03;
        const bob=Math.sin(t*2+i)*2;
        ctx.fillStyle=hsl(280,60,68,0.7);
        ctx.beginPath();ctx.arc(px,py+bob,3.5,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(px,py+bob-7,2.5,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle=hsl(300,20,45,0.5);ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(px,py+bob+3);ctx.lineTo(px,py+bob+11);ctx.stroke();
      }

      // Floating petals
      petals.forEach(p=>{
        p.x+=p.vx;p.y+=p.vy;p.a+=p.va;
        if(p.y>1.05)p.y=-.05;if(p.x<-.05)p.x=1.05;if(p.x>1.05)p.x=-.05;
        ctx.save();ctx.translate(p.x*W,p.y*H);ctx.rotate(p.a);
        ctx.fillStyle=hsl(300,60,82,p.op);
        ctx.beginPath();ctx.ellipse(0,0,p.r*6,p.r*10,0,0,Math.PI*2);ctx.fill();
        ctx.restore();
      });

      // Fireflies
      fireflies.forEach(f=>{
        f.ph+=f.sp;
        const fx=lerp(f.px,f.x,easeInOut(f.ph));const fy=lerp(f.py,f.y,easeInOut(f.ph));
        if(f.ph>=1){f.px=f.x;f.py=f.y;f.x=rand(0.1,0.9);f.y=rand(0.3,0.75);f.ph=0;f.sp=rand(0.002,0.006);}
        const glow=0.4+0.6*Math.sin(frame*0.08+f.px*10);
        drawStar(fx*W,fy*H,2.2,frame*0.07,hsl(60,100,85,glow));
      });
    };
  })();

  // ------ OCEAN BREEZE: deep sea with waves, fish, bubbles, caustic light ------
  const oceanScene = (()=>{
    const bubbles = Array.from({length:30},()=>({x:rand(0,1),y:rand(0,1),r:rand(1.5,4.5),sp:rand(0.0004,0.0014)}));
    const fish = Array.from({length:12},()=>({x:rand(0,1),y:rand(0.3,0.75),sp:rand(0.0005,0.0018),dir:Math.random()>0.5?1:-1,vy:rand(-.0003,.0003),col:['#ffa07a','#ffec8b','#f0a8d0','#a0d8ef'][Math.floor(rand(0,4))]}));
    const caustics = Array.from({length:18},()=>({x:rand(0,1),y:rand(0.1,0.6),r:rand(20,60),t:rand(0,Math.PI*2)}));
    return function(){
      const t=frame/120;
      // Ocean gradient
      const sky=ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(200,70,55));sky.addColorStop(0.35,hsl(200,65,42));sky.addColorStop(0.65,hsl(210,70,30));sky.addColorStop(1,hsl(220,70,18));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Sun/moon reflection on water surface
      const sunX=W*0.62;const sunY=H*0.13;
      const sunGrad=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,80);
      sunGrad.addColorStop(0,hsl(50,100,92,0.95));sunGrad.addColorStop(0.3,hsl(45,90,72,0.6));sunGrad.addColorStop(1,'transparent');
      ctx.fillStyle=sunGrad;ctx.fillRect(0,0,W,H);

      // Sun shimmer on horizon
      const refl=ctx.createLinearGradient(sunX-80,H*0.36,sunX+80,H*0.36);
      refl.addColorStop(0,'transparent');refl.addColorStop(0.5,hsl(50,90,80,0.35+0.15*Math.sin(t*1.8)));refl.addColorStop(1,'transparent');
      ctx.fillStyle=refl;ctx.fillRect(sunX-W*0.15,H*0.34,W*0.3,H*0.35);

      // Caustic light patches
      caustics.forEach(c=>{
        c.t+=0.018;const cx=c.x*W+30*Math.sin(c.t);const cy=c.y*H+20*Math.cos(c.t*0.7);
        const cg=ctx.createRadialGradient(cx,cy,0,cx,cy,c.r);
        cg.addColorStop(0,hsl(190,70,80,0.06+0.04*Math.sin(c.t)));cg.addColorStop(1,'transparent');
        ctx.fillStyle=cg;ctx.fillRect(cx-c.r,cy-c.r,c.r*2,c.r*2);
      });

      // Bubbles
      bubbles.forEach(b=>{
        b.y-=b.sp;b.x+=Math.sin(b.y*50+t)*0.0004;
        if(b.y<-.02){b.y=1.05;b.x=rand(0,1);}
        ctx.save();ctx.globalAlpha=0.35;ctx.strokeStyle='rgba(180,230,255,0.8)';ctx.lineWidth=1.2;
        ctx.beginPath();ctx.arc(b.x*W,b.y*H,b.r,0,Math.PI*2);ctx.stroke();
        ctx.restore();
      });

      // Fish
      fish.forEach(f=>{
        f.x+=f.sp*f.dir;f.y+=f.vy;
        if(f.x>1.08){f.x=-.08;f.dir=1;}if(f.x<-.08){f.x=1.08;f.dir=-1;}
        if(f.y<.2)f.vy=Math.abs(f.vy);if(f.y>.8)f.vy=-Math.abs(f.vy);
        const fx=f.x*W,fy=f.y*H;
        ctx.save();ctx.translate(fx,fy);ctx.scale(f.dir,1);
        ctx.fillStyle=f.col;ctx.beginPath();ctx.ellipse(0,0,14,7,0,0,Math.PI*2);ctx.fill();
        ctx.fillStyle=f.col;ctx.beginPath();ctx.moveTo(-12,0);ctx.lineTo(-20,-6);ctx.lineTo(-20,6);ctx.closePath();ctx.fill();
        ctx.fillStyle='rgba(0,0,0,0.6)';ctx.beginPath();ctx.arc(10,0,2,0,Math.PI*2);ctx.fill();
        ctx.restore();
      });

      // Wave layers at surface
      [[hsl(200,65,45,0.6),0.36],[hsl(195,70,38,0.7),0.38],[hsl(190,60,30,0.8),0.4]].forEach(([col,hy],i)=>{
        ctx.beginPath();ctx.moveTo(0,H);
        for(let x=0;x<=W;x+=6){
          const w=Math.sin(x/W*Math.PI*4+t*1.2+i*1.4)*H*0.012+Math.sin(x/W*Math.PI*7+t*0.8)*H*0.006;
          ctx.lineTo(x,H*hy+w);
        }
        ctx.lineTo(W,H);ctx.closePath();ctx.fillStyle=col;ctx.fill();
      });

      // Kelp/seaweed at bottom
      for(let i=0;i<16;i++){
        const kx=W*(0.04+i*0.062);const kh=H*(0.12+Math.random()*0.06);
        ctx.strokeStyle=hsl(155,50,25,0.65);ctx.lineWidth=3;
        ctx.beginPath();ctx.moveTo(kx,H);
        for(let j=0;j<6;j++){const jy=H-j*(kh/6);ctx.quadraticCurveTo(kx+15*Math.sin(t*1.2+i+j),jy-kh/12,kx,jy);}
        ctx.stroke();
      }
    };
  })();

  // ------ SUNSET SEA: golden sun sinking into ocean, waves, birds ------
  const sunsetScene = (()=>{
    const birds = Array.from({length:9},(_,i)=>({x:rand(0,1),y:rand(0.1,0.35),sp:rand(0.0006,0.0014),fl:rand(0,Math.PI*2),flsp:rand(0.04,0.09)}));
    const waves = Array.from({length:7},(_,i)=>({phase:rand(0,Math.PI*2),speed:rand(0.3,0.9),amp:rand(0.008,0.022),freq:rand(2.5,5)}));
    const clouds = Array.from({length:5},(_,i)=>({x:rand(0.05,0.9),y:rand(0.05,0.28),w:rand(0.12,0.25),spd:rand(0.00008,0.0002)}));
    return function(){
      const t=frame/100;
      const sunY=0.38+0.04*Math.sin(t*0.08); // slowly rising/setting

      // Sky gradient — warm sunset oranges/pinks
      const sky=ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(225,60,28));
      sky.addColorStop(0.25,hsl(270,50,45));
      sky.addColorStop(0.45,hsl(15,85,60));
      sky.addColorStop(0.55,hsl(35,95,62));
      sky.addColorStop(0.7,hsl(40,90,55));
      sky.addColorStop(1,hsl(200,60,35));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Atmospheric haze bands
      [[hsl(330,70,55,0.12),0.3,0.08],[hsl(20,80,60,0.1),0.42,0.06]].forEach(([col,cy,h])=>{
        ctx.fillStyle=col;ctx.fillRect(0,H*(cy-h/2),W,H*h);
      });

      // Sun
      const sunX=W*0.52;const sy=H*sunY;
      const suns=ctx.createRadialGradient(sunX,sy,0,sunX,sy,W*0.12);
      suns.addColorStop(0,hsl(50,100,96));suns.addColorStop(0.3,hsl(40,100,72));suns.addColorStop(0.7,hsl(20,90,55,0.5));suns.addColorStop(1,'transparent');
      ctx.fillStyle=suns;ctx.fillRect(0,0,W,H);
      // Sun disk
      ctx.fillStyle=hsl(48,100,88);ctx.shadowBlur=60;ctx.shadowColor=hsl(45,100,70);
      ctx.beginPath();ctx.arc(sunX,sy,W*0.038,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;

      // Clouds tinted orange/pink
      clouds.forEach(c=>{
        c.x+=c.spd;if(c.x>1.15)c.x=-.15;
        const cx=c.x*W,cy=c.y*H,cw=c.w*W;
        ctx.save();ctx.globalAlpha=0.55;
        [[0,0,cw*0.5,cw*0.18],[cw*0.25,-cw*0.12,cw*0.4,cw*0.16],[-cw*0.2,-cw*0.06,cw*0.38,cw*0.14]].forEach(([ox,oy,rx,ry])=>{
          const cg=ctx.createRadialGradient(cx+ox,cy+oy,0,cx+ox,cy+oy,Math.max(rx,ry));
          cg.addColorStop(0,hsl(15,90,78));cg.addColorStop(0.6,hsl(340,70,65));cg.addColorStop(1,'transparent');
          ctx.fillStyle=cg;ctx.beginPath();ctx.ellipse(cx+ox,cy+oy,rx,ry,0,0,Math.PI*2);ctx.fill();
        });
        ctx.restore();
      });

      // Sun reflection on water — golden caustic column
      const reflGrad=ctx.createLinearGradient(sunX-W*0.12,H*0.52,sunX+W*0.12,H*0.52);
      reflGrad.addColorStop(0,'transparent');reflGrad.addColorStop(0.5,hsl(45,100,65,0.5+0.15*Math.sin(t)));reflGrad.addColorStop(1,'transparent');
      ctx.fillStyle=reflGrad;
      for(let row=0;row<30;row++){
        const rowY=H*(0.52+row*0.016);const rowW=W*(0.04+row*0.007);
        const ro=0.85-row*0.025;if(ro<=0)break;
        ctx.globalAlpha=ro;ctx.fillRect(sunX-rowW/2,rowY,rowW,H*0.018);
      }
      ctx.globalAlpha=1;

      // Ocean waves
      const horizonY=H*0.55;
      const ocean=ctx.createLinearGradient(0,horizonY,0,H);
      ocean.addColorStop(0,hsl(210,60,35));ocean.addColorStop(0.4,hsl(215,65,28));ocean.addColorStop(1,hsl(220,55,18));
      ctx.fillStyle=ocean;ctx.fillRect(0,horizonY,W,H);

      waves.forEach((wv,i)=>{
        const wOpacity=0.15+i*0.04;
        ctx.save();ctx.globalAlpha=wOpacity;
        ctx.beginPath();ctx.moveTo(0,H);
        for(let x=0;x<=W;x+=5){
          const y=horizonY+H*(0.04+i*0.06)+Math.sin(x/W*Math.PI*wv.freq+t*wv.speed+wv.phase)*H*wv.amp;
          ctx.lineTo(x,y);
        }
        ctx.lineTo(W,H);ctx.closePath();
        ctx.fillStyle=hsl(210,55,28+i*4);ctx.fill();
        ctx.restore();
        // Wave crest foam
        ctx.save();ctx.globalAlpha=0.18;ctx.strokeStyle='rgba(255,255,255,0.7)';ctx.lineWidth=1.5;
        ctx.beginPath();
        for(let x=0;x<=W;x+=5){
          const y=horizonY+H*(0.04+i*0.06)+Math.sin(x/W*Math.PI*wv.freq+t*wv.speed+wv.phase)*H*wv.amp;
          x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        }ctx.stroke();ctx.restore();
      });

      // Silhouette coastline
      ctx.beginPath();ctx.moveTo(0,H);
      ctx.lineTo(0,H*0.82);ctx.quadraticCurveTo(W*0.08,H*0.78,W*0.15,H*0.80);
      ctx.quadraticCurveTo(W*0.22,H*0.83,W*0.28,H*0.79);
      ctx.lineTo(W*0.3,H*0.62);ctx.lineTo(W*0.33,H*0.6);ctx.lineTo(W*0.36,H*0.62);ctx.lineTo(W*0.38,H*0.81);
      ctx.quadraticCurveTo(W*0.5,H*0.84,W*0.62,H*0.83);ctx.lineTo(W,H*0.85);ctx.lineTo(W,H);ctx.closePath();
      ctx.fillStyle='rgba(20,10,5,0.7)';ctx.fill();

      // Palm tree silhouettes
      [[0.28,0.62],[0.33,0.60],[0.36,0.62]].forEach(([px,py])=>{
        const tx=W*px,ty=H*py;
        ctx.save();ctx.strokeStyle='rgba(15,8,3,0.85)';ctx.lineWidth=3;
        // Trunk
        ctx.beginPath();ctx.moveTo(tx,ty);
        ctx.quadraticCurveTo(tx+8,ty-H*0.12,tx+5,ty-H*0.22);ctx.stroke();
        // Fronds
        [[-40,-15,30,-50],[-20,-10,45,-38],[10,-5,50,-30],[-50,-20,-10,-55],[20,-8,60,-25]].forEach(([bx,by,ex,ey])=>{
          ctx.beginPath();ctx.moveTo(tx+5,ty-H*0.22);ctx.quadraticCurveTo(tx+bx,ty-H*0.22+by,tx+ex,ty-H*0.22+ey);ctx.lineWidth=2.5;ctx.stroke();
        });
        ctx.restore();
      });

      // Birds
      birds.forEach(b=>{
        b.x+=b.sp;b.fl+=b.flsp;if(b.x>1.1)b.x=-.1;
        const bx=b.x*W,by=b.y*H,fw=Math.sin(b.fl)*5;
        ctx.save();ctx.strokeStyle='rgba(20,10,5,0.72)';ctx.lineWidth=2;
        ctx.beginPath();ctx.moveTo(bx-10,by);ctx.quadraticCurveTo(bx-5,by-fw,bx,by);ctx.quadraticCurveTo(bx+5,by-fw,bx+10,by);ctx.stroke();
        ctx.restore();
      });
    };
  })();

  // ------ FOREST: misty woodland, fireflies, shafts of light, rain ------
  const forestScene = (()=>{
    const fireflies = Array.from({length:22},()=>({x:rand(0.05,0.95),y:rand(0.35,0.8),tx:rand(0.05,0.95),ty:rand(0.35,0.8),p:0,sp:rand(0.003,0.007)}));
    const leaves = Array.from({length:20},()=>({x:rand(0,1),y:rand(-.1,1),vx:rand(-.0006,.0006),vy:rand(.0003,.0010),a:rand(0,Math.PI*2),va:rand(-.02,.02),op:rand(0.4,.8)}));
    return function(){
      const t=frame/130;
      // Sky through canopy
      const sky=ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(125,40,22));sky.addColorStop(0.4,hsl(130,45,32));sky.addColorStop(0.7,hsl(120,50,38));sky.addColorStop(1,hsl(115,45,28));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Mist layers
      for(let i=0;i<4;i++){
        const my=H*(0.55+i*0.12);const mg=ctx.createLinearGradient(0,my,0,my+H*0.1);
        mg.addColorStop(0,'transparent');mg.addColorStop(0.5,hsl(130,30,75,0.07+0.03*Math.sin(t*0.5+i)));mg.addColorStop(1,'transparent');
        ctx.fillStyle=mg;ctx.fillRect(0,my,W,H*0.1);
      }

      // Light shafts from canopy
      for(let i=0;i<6;i++){
        const sx=W*(0.1+i*0.16+0.04*Math.sin(t*0.3+i));
        ctx.save();ctx.globalAlpha=0.04+0.025*Math.sin(t*0.6+i);
        ctx.fillStyle=hsl(80,60,85);
        ctx.beginPath();ctx.moveTo(sx-20,0);ctx.lineTo(sx+20,0);ctx.lineTo(sx+60,H*0.7);ctx.lineTo(sx-60,H*0.7);ctx.closePath();ctx.fill();
        ctx.restore();
      }

      // Ground + undergrowth
      ctx.fillStyle=hsl(120,40,18);ctx.fillRect(0,H*0.82,W,H*0.18);
      for(let i=0;i<50;i++){
        const gx=W*(i/50);const gy=H*0.82;const gh=H*(0.04+0.02*Math.sin(i*3.7+t*1.5));
        ctx.strokeStyle=hsl(120,50,28,0.6);ctx.lineWidth=2;
        ctx.beginPath();ctx.moveTo(gx,gy);ctx.quadraticCurveTo(gx+5*Math.sin(t+i),gy-gh/2,gx,gy-gh);ctx.stroke();
      }

      // Tree trunks (back to front)
      const treePositions=[0.05,0.14,0.22,0.36,0.48,0.58,0.7,0.81,0.9,0.97];
      treePositions.forEach((tx2,i)=>{
        const txx=W*tx2;const tw=W*(0.028+0.012*(i%3));const th=H*(0.6+0.15*(i%4));
        const bark=ctx.createLinearGradient(txx-tw/2,0,txx+tw/2,0);
        bark.addColorStop(0,hsl(30,30,14));bark.addColorStop(0.4,hsl(30,35,22));bark.addColorStop(0.7,hsl(30,28,16));bark.addColorStop(1,hsl(30,30,12));
        ctx.fillStyle=bark;ctx.fillRect(txx-tw/2,H-th,tw,th);
        // Moss
        ctx.fillStyle=hsl(120,40,25,0.5);ctx.fillRect(txx-tw/2,H-th,tw*0.3,th*0.6);
      });

      // Foliage canopy
      treePositions.forEach((tx2,i)=>{
        const txx=W*tx2;const fy=H*(0.14+0.06*(i%3));const fr=W*(0.09+0.04*(i%4));
        const sway=5*Math.sin(t*0.8+i);
        ctx.save();ctx.globalAlpha=0.88;
        [[0,0,fr,fr],[sway-fr*0.5,-fr*0.2,fr*0.85,fr*0.85],[sway+fr*0.4,-fr*0.15,fr*0.8,fr*0.8]].forEach(([ox,oy,rr,rrr])=>{
          const fg=ctx.createRadialGradient(txx+ox,fy+oy,0,txx+ox,fy+oy,rr);
          fg.addColorStop(0,hsl(125,55,30));fg.addColorStop(0.6,hsl(120,50,22));fg.addColorStop(1,'transparent');
          ctx.fillStyle=fg;ctx.beginPath();ctx.ellipse(txx+ox,fy+oy,rr,rrr*0.75,0,0,Math.PI*2);ctx.fill();
        });
        ctx.restore();
      });

      // Falling leaves
      leaves.forEach(l=>{
        l.x+=l.vx+0.0003*Math.sin(t+l.y*5);l.y+=l.vy;l.a+=l.va;
        if(l.y>1.05){l.y=-.05;l.x=rand(0,1);}
        ctx.save();ctx.translate(l.x*W,l.y*H);ctx.rotate(l.a);ctx.globalAlpha=l.op;
        ctx.fillStyle=hsl(110+rand(-15,15),50,35);
        ctx.beginPath();ctx.ellipse(0,0,6,3,0,0,Math.PI*2);ctx.fill();
        ctx.restore();
      });

      // Fireflies
      fireflies.forEach(f=>{
        f.p+=f.sp;if(f.p>=1){f.tx=rand(0.05,0.95);f.ty=rand(0.35,0.8);f.p=0;}
        const fx=lerp(f.x,f.tx,f.p)*W;const fy=lerp(f.y,f.ty,f.p)*H;
        const glow=0.3+0.7*Math.sin(frame*0.06+f.x*8);
        drawStar(fx,fy,2.8,frame*0.05,hsl(65,100,75,glow));
      });
    };
  })();

  // ------ ROSE GARDEN: blooming roses, petals, morning light, butterflies ------
  const roseScene = (()=>{
    const petals2 = Array.from({length:35},()=>({x:rand(0,1),y:rand(0,1),vx:rand(-.0003,.0003),vy:rand(.00015,.0006),a:rand(0,Math.PI*2),va:rand(-.018,.018),h:rand(330,360),op:rand(.4,.8)}));
    const butterflies = Array.from({length:6},()=>({x:rand(0.2,0.8),y:rand(0.2,0.6),vx:rand(-.0005,.0005),vy:rand(-.0003,.0003),fl:rand(0,Math.PI*2),flsp:rand(0.06,0.1),col:[hsl(280,60,70),hsl(320,60,68),hsl(20,70,65)][Math.floor(rand(0,3))]}));
    return function(){
      const t=frame/110;
      // Rosy sky
      const sky=ctx.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,hsl(300,45,72));sky.addColorStop(0.4,hsl(330,55,68));sky.addColorStop(0.65,hsl(350,50,62));sky.addColorStop(1,hsl(15,55,60));
      ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

      // Soft morning light bloom
      const bloom=ctx.createRadialGradient(W*0.45,H*0.2,0,W*0.45,H*0.2,W*0.5);
      bloom.addColorStop(0,hsl(50,100,90,0.3));bloom.addColorStop(0.4,hsl(30,80,75,0.12));bloom.addColorStop(1,'transparent');
      ctx.fillStyle=bloom;ctx.fillRect(0,0,W,H);

      // Garden ground
      ctx.fillStyle=hsl(120,30,22);ctx.fillRect(0,H*0.75,W,H*0.25);
      // Garden path (stone)
      ctx.fillStyle=hsl(25,15,50,0.4);
      ctx.beginPath();ctx.ellipse(W*0.5,H*0.95,W*0.12,H*0.12,0,0,Math.PI*2);ctx.fill();

      // Rose bushes
      const bushes=[0.1,0.25,0.42,0.58,0.72,0.88];
      bushes.forEach((bx,i)=>{
        const by=H*(0.72+0.04*(i%2));
        ctx.strokeStyle=hsl(120,35,22,0.7);ctx.lineWidth=3;
        ctx.beginPath();ctx.moveTo(bx*W,by);ctx.quadraticCurveTo(bx*W+15*Math.sin(t+i),by-H*0.16,bx*W+8*Math.sin(t*0.7+i),by-H*0.26);ctx.stroke();
        // Leaves
        [[8,-H*0.1],[-10,-H*0.15]].forEach(([lx,ly])=>{
          ctx.fillStyle=hsl(125,45,28,0.7);ctx.beginPath();ctx.ellipse(bx*W+lx,by+ly,10,5,0.4,0,Math.PI*2);ctx.fill();
        });
        // Rose blooms
        const roseColors=[hsl(345,75,55),hsl(350,80,62),hsl(5,70,55),hsl(320,65,60)];
        const rc=roseColors[i%4];
        [0,1,2].forEach(ring=>{
          const rRad=H*(0.018+ring*0.009);
          for(let p=0;p<5+ring;p++){
            const pa=(p/(5+ring))*Math.PI*2+ring*0.3+t*0.2;
            const px2=bx*W+8*Math.sin(t*0.7+i)+Math.cos(pa)*rRad*0.9;
            const py2=by-H*0.26+Math.sin(pa)*rRad*0.6;
            ctx.fillStyle=ring===0?hsl(50,80,65):rc;
            ctx.beginPath();ctx.ellipse(px2,py2,rRad*(0.9-ring*0.15),rRad*(0.65-ring*0.1),pa,0,Math.PI*2);ctx.fill();
          }
        });
      });

      // Falling petals
      petals2.forEach(p=>{
        p.x+=p.vx+0.0002*Math.sin(t+p.y*6);p.y+=p.vy;p.a+=p.va;
        if(p.y>1.05){p.y=-.05;p.x=rand(0,1);}
        ctx.save();ctx.translate(p.x*W,p.y*H);ctx.rotate(p.a);ctx.globalAlpha=p.op;
        ctx.fillStyle=hsl(p.h,65,70);ctx.beginPath();ctx.ellipse(0,0,5,8,0,0,Math.PI*2);ctx.fill();
        ctx.restore();
      });

      // Butterflies
      butterflies.forEach(b=>{
        b.x+=b.vx;b.y+=b.vy;b.fl+=b.flsp;
        if(b.x<0.05||b.x>0.95)b.vx*=-1;if(b.y<0.1||b.y>0.7)b.vy*=-1;
        const bx2=b.x*W,by2=b.y*H,fw=Math.sin(b.fl)*12;
        ctx.save();ctx.fillStyle=b.col;ctx.globalAlpha=0.75;
        ctx.beginPath();ctx.ellipse(bx2-fw/2,by2-3,Math.abs(fw)*0.6,5,-.3,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.ellipse(bx2+fw/2,by2-3,Math.abs(fw)*0.6,5,.3,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle='rgba(100,20,60,0.4)';ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(bx2,by2-8);ctx.lineTo(bx2,by2+5);ctx.stroke();
        ctx.restore();
      });
    };
  })();

  // ------ MIDNIGHT: deep space, shooting stars, aurora borealis, city silhouette ------
  const nightScene = (()=>{
    const stars2 = Array.from({length:160},()=>({x:rand(0,1),y:rand(0,.7),r:rand(.5,2.2),t:rand(0,Math.PI*2),ts:rand(.01,.05)}));
    const shootingStars = Array.from({length:4},()=>({x:rand(0,1),y:rand(0,.4),vx:rand(-.008,-.002),vy:rand(.002,.005),len:rand(60,140),life:0,maxLife:rand(60,110),wait:rand(0,200)}));
    const auroraPoints = Array.from({length:8},()=>rand(0,1));
    return function(){
      const t=frame/100;
      // Deep space gradient
      const space=ctx.createLinearGradient(0,0,0,H);
      space.addColorStop(0,'hsl(240,60%,6%)');space.addColorStop(0.3,'hsl(250,55%,10%)');
      space.addColorStop(0.6,'hsl(260,50%,14%)');space.addColorStop(1,'hsl(220,40%,8%)');
      ctx.fillStyle=space;ctx.fillRect(0,0,W,H);

      // Milky way glow
      const mw=ctx.createLinearGradient(0,H*0.05,W,H*0.6);
      mw.addColorStop(0,'transparent');mw.addColorStop(0.3,'hsla(220,50%,50%,0.04)');mw.addColorStop(0.5,'hsla(240,60%,60%,0.07)');mw.addColorStop(0.7,'hsla(280,50%,50%,0.04)');mw.addColorStop(1,'transparent');
      ctx.fillStyle=mw;ctx.fillRect(0,0,W,H*0.7);

      // Aurora borealis
      for(let layer=0;layer<3;layer++){
        ctx.save();ctx.globalAlpha=0.12+0.06*Math.sin(t*0.4+layer);
        const aurora=ctx.createLinearGradient(0,H*0.05,0,H*0.4);
        const hues=[170,200,280];
        aurora.addColorStop(0,'transparent');
        aurora.addColorStop(0.3,hsl(hues[layer],80,65,0.6));
        aurora.addColorStop(0.6,hsl(hues[(layer+1)%3],70,55,0.4));
        aurora.addColorStop(1,'transparent');
        ctx.fillStyle=aurora;
        ctx.beginPath();ctx.moveTo(0,H*0.4);
        for(let x=0;x<=W;x+=20){
          const ay=H*(0.1+0.08*Math.sin(x/W*Math.PI*(3+layer)+t*(0.5+layer*0.2)+layer*2));
          ctx.lineTo(x,ay);
        }
        ctx.lineTo(W,H*0.4);ctx.lineTo(0,H*0.4);ctx.closePath();
        ctx.fill();ctx.restore();
      }

      // Stars
      stars2.forEach(s=>{
        s.t+=s.ts;
        const blink=0.5+0.5*Math.sin(s.t);
        drawStar(s.x*W,s.y*H,s.r,s.t,'rgba(200,210,255,'+(0.4+0.6*blink)+')');
      });

      // Shooting stars
      shootingStars.forEach(ss=>{
        if(ss.wait>0){ss.wait--;return;}
        ss.life++;ss.x+=ss.vx;ss.y+=ss.vy;
        if(ss.life>ss.maxLife){ss.x=rand(0.2,1);ss.y=rand(0,0.35);ss.vx=rand(-.008,-.003);ss.vy=rand(.002,.005);ss.life=0;ss.wait=rand(80,250);}
        const progress=ss.life/ss.maxLife;const alpha=Math.sin(progress*Math.PI);
        ctx.save();
        const sg=ctx.createLinearGradient(ss.x*W,ss.y*H,(ss.x-ss.vx*ss.len)*W,(ss.y-ss.vy*ss.len)*H);
        sg.addColorStop(0,'rgba(255,255,255,'+alpha+')');sg.addColorStop(1,'transparent');
        ctx.strokeStyle=sg;ctx.lineWidth=1.8;
        ctx.beginPath();ctx.moveTo(ss.x*W,ss.y*H);ctx.lineTo((ss.x-ss.vx*ss.len)*W,(ss.y-ss.vy*ss.len)*H);ctx.stroke();
        ctx.restore();
      });

      // Moon
      const moonX=W*0.78,moonY=H*0.14;
      const moonGlow=ctx.createRadialGradient(moonX,moonY,0,moonX,moonY,90);
      moonGlow.addColorStop(0,'rgba(200,210,255,0.15)');moonGlow.addColorStop(1,'transparent');
      ctx.fillStyle=moonGlow;ctx.fillRect(moonX-90,moonY-90,180,180);
      ctx.fillStyle='hsl(230,30%,88%)';ctx.shadowBlur=18;ctx.shadowColor='rgba(180,200,255,0.5)';
      ctx.beginPath();ctx.arc(moonX,moonY,W*0.033,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
      ctx.fillStyle='hsl(230,20%,75%)';
      [[-.4,-.3,.12],[.2,.2,.1],[-.1,.4,.08]].forEach(([ox,oy,r])=>{
        ctx.beginPath();ctx.arc(moonX+ox*W*0.033*2,moonY+oy*H*0.033,r*W*0.033,0,Math.PI*2);ctx.fill();
      });

      // City silhouette
      ctx.fillStyle='rgba(4,4,15,0.92)';
      ctx.beginPath();ctx.moveTo(0,H);
      // Random but seeded skyline
      const buildings=[{x:0,w:0.07,h:.22},{x:.06,w:.05,h:.3},{x:.1,w:.08,h:.18},{x:.17,w:.04,h:.35},{x:.2,w:.06,h:.26},{x:.25,w:.1,h:.16},{x:.34,w:.06,h:.28},{x:.39,w:.05,h:.38},{x:.43,w:.08,h:.22},{x:.5,w:.06,h:.3},{x:.55,w:.04,h:.42},{x:.58,w:.07,h:.2},{x:.64,w:.06,h:.32},{x:.69,w:.05,h:.18},{x:.73,w:.09,h:.36},{x:.81,w:.06,h:.24},{x:.86,w:.05,h:.28},{x:.9,w:.07,h:.16},{x:.96,w:.04,h:.22}];
      buildings.forEach(b=>{ctx.lineTo(b.x*W,H*(1-b.h));ctx.lineTo((b.x+b.w/2)*W,H*(1-b.h));ctx.lineTo((b.x+b.w/2)*W,H*(1-b.h-0.015));ctx.lineTo((b.x+b.w)*W,H*(1-b.h));});
      ctx.lineTo(W,H);ctx.closePath();ctx.fill();

      // City lights (windows)
      buildings.forEach(b=>{
        for(let wy=0;wy<6;wy++){for(let wx=0;wx<3;wx++){
          if(Math.random()>0.55){
            ctx.fillStyle=`rgba(255,${200+Math.floor(rand(0,55))},${100+Math.floor(rand(0,80))},${0.5+Math.random()*0.4})`;
            ctx.fillRect((b.x+wx*b.w/3+0.005)*W,H*(1-b.h+wy*b.h/7+0.02),W*b.w*0.18,H*b.h*0.1);
          }
        }}
      });
    };
  })();

  const scenes = {lavender:lavScene, ocean:oceanScene, sunset:sunsetScene, forest:forestScene, rose:roseScene, night:nightScene};

  function loop(){
    if(!currentScene)return;
    frame++;
    ctx.clearRect(0,0,W,H);
    scenes[currentScene]();
    animId=requestAnimationFrame(loop);
  }

  return {
    setScene(name){
      const cvs=document.getElementById('themeBgCanvas');
      if(animId)cancelAnimationFrame(animId);
      if(!name||!scenes[name]){
        currentScene=null;cvs.style.opacity='0';
        // Restore blobs + bg-anim
        ['bgAnim','blob1','blob2','blob3'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='';});
        return;
      }
      currentScene=name;frame=0;
      // Hide gradient blobs when canvas is showing
      ['bgAnim','blob1','blob2','blob3'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
      cvs.style.opacity='1';
      loop();
    }
  };
})();

// ===================================================
// ===== PREMIUM / PAYMENT SYSTEM ===================
// ===================================================
let userPlan = 'free';
let payCurrentPlan = 'pro';
let payCycle = 'monthly';
let payMethod = 'card';
const PRICES = { pro:{monthly:149,annual:119}, team:{monthly:399,annual:319} };

function isPro(){ return userPlan==='pro'||userPlan==='team'; }

function applyPlanUI(){
  // Sidebar strip
  const icon=document.getElementById('sidebarProIcon');
  const title=document.getElementById('sidebarProTitle');
  const sub=document.getElementById('sidebarProSub');
  const strip=document.getElementById('sidebarProStrip');
  if(strip&&isPro()){
    if(icon)icon.textContent='✨';
    if(title)title.textContent="You're on Pro!";
    if(sub)sub.textContent='All features unlocked 🎉';
    strip.style.background='linear-gradient(135deg,rgba(94,234,212,0.15),rgba(180,240,200,0.2))';
    strip.style.borderColor='rgba(94,234,212,0.38)';
  }
  // Pricing CTAs
  const freeCta=document.getElementById('freeCta');
  const proCta=document.getElementById('proCta');
  const teamCta=document.getElementById('teamCta');
  if(freeCta){freeCta.className='plan-cta '+(userPlan==='free'?'cta-current':'cta-free');freeCta.textContent=userPlan==='free'?'Current Plan':'Downgrade';}
  if(proCta){proCta.className='plan-cta '+(userPlan==='pro'?'cta-current':'cta-pro');proCta.textContent=userPlan==='pro'?'✅ Current Plan':'Get Pro ✨';if(userPlan!=='pro')proCta.onclick=()=>openPayModal('pro');}
  if(teamCta){teamCta.className='plan-cta '+(userPlan==='team'?'cta-current':'cta-team');teamCta.textContent=userPlan==='team'?'✅ Current Plan':'Get Team 🏫';if(userPlan!=='team')teamCta.onclick=()=>openPayModal('team');}
  // Update library gate
  if(_libActivated||isPro())applyLibraryGate();
}

function setBilling(mode){
  payCycle=mode;
  document.getElementById('billMonthly').classList.toggle('active',mode==='monthly');
  document.getElementById('billAnnual').classList.toggle('active',mode==='annual');
  document.getElementById('proPrice').textContent=mode==='monthly'?'149':'119';
  document.getElementById('teamPrice').textContent=mode==='monthly'?'399':'319';
  const pn=document.getElementById('proAnnualNote');const tn=document.getElementById('teamAnnualNote');
  if(pn)pn.textContent=mode==='annual'?'Billed ₱1,428/year · Save ₱360':'';
  if(tn)tn.textContent=mode==='annual'?'Billed ₱3,828/year · Save ₱960':'';
}

function openPayModal(plan){
  payCurrentPlan=plan;payCycle='monthly';payMethod='card';
  document.getElementById('payFormSection').style.display='';
  document.getElementById('paySuccessSection').style.display='none';
  const icon=plan==='pro'?'✨':'🏫';const name=plan==='pro'?'Pro Plan':'Team Plan';
  document.getElementById('paySummaryIcon').textContent=icon;
  document.getElementById('paySummaryName').textContent=name;
  document.getElementById('paySummaryCycle').textContent='Monthly billing';
  document.getElementById('paySummaryPrice').textContent='₱'+PRICES[plan].monthly;
  document.getElementById('payCycleMonthLabel').textContent='₱'+PRICES[plan].monthly+'/mo';
  document.getElementById('payCycleAnnualLabel').textContent='₱'+PRICES[plan].annual+'/mo · Save 20%';
  document.getElementById('cycleMonthly').classList.add('active');
  document.getElementById('cycleAnnual').classList.remove('active');
  document.querySelectorAll('.pay-method').forEach(m=>m.classList.remove('active'));
  document.querySelector('.pay-method').classList.add('active');
  showPayFields('card');
  document.getElementById('bankRef').textContent='TC-'+Math.floor(1000+Math.random()*9000);
  document.getElementById('paySubmitLabel').textContent='Complete Purchase — ₱'+PRICES[plan].monthly;
  document.getElementById('payOverlay').classList.remove('hidden');
}
function closePayModal(){document.getElementById('payOverlay').classList.add('hidden');}
function selectCycle(cycle){
  payCycle=cycle;const price=PRICES[payCurrentPlan][cycle];
  document.getElementById('cycleMonthly').classList.toggle('active',cycle==='monthly');
  document.getElementById('cycleAnnual').classList.toggle('active',cycle==='annual');
  document.getElementById('paySummaryCycle').textContent=cycle==='monthly'?'Monthly billing':'Annual billing (20% off)';
  document.getElementById('paySummaryPrice').textContent='₱'+price;
  document.getElementById('paySubmitLabel').textContent='Complete Purchase — ₱'+price;
}
function selectPayMethod(method,el){
  payMethod=method;
  document.querySelectorAll('.pay-method').forEach(m=>m.classList.remove('active'));
  el.classList.add('active');showPayFields(method);
}
function showPayFields(method){
  ['payFieldsCard','payFieldsGcash','payFieldsMaya','payFieldsBank'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
  const map={card:'payFieldsCard',gcash:'payFieldsGcash',maya:'payFieldsMaya',bank:'payFieldsBank'};
  const el=document.getElementById(map[method]);if(el)el.style.display='';
}
function formatCardNum(input){let v=input.value.replace(/\D/g,'').substring(0,16);input.value=v.replace(/(.{4})/g,'$1 ').trim();}
function formatExpiry(input){let v=input.value.replace(/\D/g,'');if(v.length>=2)v=v.substring(0,2)+' / '+v.substring(2,4);input.value=v;}
function submitPayment(){
  if(payMethod==='card'){
    const n=document.getElementById('cardName').value.trim();
    const num=document.getElementById('cardNum').value.replace(/\s/g,'');
    const exp=document.getElementById('cardExp').value.trim();
    const cvv=document.getElementById('cardCvv').value.trim();
    if(!n||num.length<15||exp.length<4||cvv.length<3){showToast('⚠️ Please fill in all card details.',2500);return;}
  } else if(payMethod==='gcash'){if(!document.getElementById('gcashNum').value.trim()){showToast('⚠️ Please enter your GCash number.',2500);return;}
  } else if(payMethod==='maya'){if(!document.getElementById('mayaNum').value.trim()){showToast('⚠️ Please enter your Maya number.',2500);return;}
  } else if(payMethod==='bank'){if(!document.getElementById('bankTxn').value.trim()){showToast('⚠️ Please enter your reference number.',2500);return;}}
  const btn=document.querySelector('.pay-submit');
  btn.textContent='⏳ Processing...';btn.style.opacity='0.7';btn.disabled=true;
  setTimeout(()=>{
    btn.textContent=document.getElementById('paySubmitLabel').textContent;
    btn.style.opacity='';btn.disabled=false;
    userPlan=payCurrentPlan;
    document.getElementById('payFormSection').style.display='none';
    document.getElementById('paySuccessSection').style.display='flex';
    applyPlanUI();applyLibraryGate();fsSaveProfile();
    addNotification('login','👑','You\'renow on '+(payCurrentPlan==='pro'?'Pro':'Team')+'!','All premium features are now unlocked ✨');
    showToast('🎉 Welcome to Pro! All features unlocked.',3500);
  },2000);
}
setTimeout(applyPlanUI,600);

</script>
</body>
</html>
